<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>音読プラス ―音読が読解力を育てる―</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
/* 基本スタイル */
html, body {
  margin: 0;
  padding: 0;
  height: 100%;
  font-family: "Meiryo", sans-serif;
  background: #fefefe;
  -webkit-touch-callout: none;
  -webkit-text-size-adjust: 100%;
  -ms-text-size-adjust: 100%;
}

/* グローバルタッチ対応 */
* {
  -webkit-tap-highlight-color: transparent;
}

/* タッチデバイス用のホバー状態の無効化 */
@media (hover: none) and (pointer: coarse) {
  button:hover,
  .kanji-choice:hover,
  .start-btn:hover,
  .small-btn:hover,
  .audio-btn:hover,
  .buy-btn:hover {
    transform: none !important;
  }
}

/* ダイヤモンド画像スタイル */
img[src="diamond.png"] {
  object-fit: contain !important;
  object-position: center !important;
}

/* 暗記編画像スタイル */
img[src="anki.png"] {
  object-fit: contain !important;
  object-position: center !important;
}

.header {
  background: #00b7f1;
  text-align: center;
  padding: 24px 0;
}
.header h1 {
  color: #fff;
  font-size: 28px;
  margin: 0;
}
.header .bottom-text {
  color: #fff;
  font-size: 14px;
  margin-top: 4px;
}
.container {
  padding: 36px 16px;
  max-width: 900px;
  margin: 0 auto;
}
.box {
  display: none;
  flex-direction: column;
  align-items: center;
  gap: 12px;
  padding: 48px 0;
}
.box.show { display: flex !important; }
input {
  width: 80%;
  max-width: 300px;
  padding: 12px;
  border: 2px solid #cce7f9;
  border-radius: 10px;
  font-size: 15px;
  background: #e6f8ff;
}
button {
  width: 170px;
  height: 44px;
  border-radius: 24px;
  background: #00b7f1;
  color: #fff;
  border: none;
  font-weight: bold;
  cursor: pointer;
  -webkit-tap-highlight-color: transparent;
  touch-action: manipulation;
  -webkit-touch-callout: none;
  -webkit-user-select: none;
  user-select: none;
}
button:hover {
  background: #2f74b5;
}
button:active {
  background: #2f74b5;
  transform: scale(0.98);
}
/* --- ダッシュボード --- */
.dashboard {
  display: flex;
  font-family: Arial;
  align-items: center;
  justify-content: space-between;
  gap: 32px;
  background: #ffffff;
  border-radius: 20px;
  box-shadow: 0 2px 8px rgba(97, 97, 97, 0.25);
  padding: 18px 24px;
  margin-bottom: 30px;
  width: 100%;
  max-width: 800px;
}
.profile { display: flex; align-items: center; gap: 18px;}
.avatar { width: 64px; height: 64px; border-radius: 50%; background: #e6f8ff;}
.username { font-weight: bold; font-size: 18px; }
.level {
  font-size: 15px;
  color: #2c3e50;
  margin-top: 4px;
  display: flex;
  align-items: center;
}

.level span {
  background: #00f160;
  color: white;
  padding: 4px 12px;
  border-radius: 10px;
  font-size: 16px;
}
.stats { display: flex; gap: 22px;}
.stat-num { font-weight: bold; font-size: 28px; color: #2c3e50; text-align: center;}
.stat-label { font-size: 13px; color: #888; text-align: center;}
.challenge { min-width: 200px; }
.challenge-title { color: #2c3e50; font-size: 15px; font-weight: bold;}
.challenge-bar { background: #e0f7fa; border-radius: 8px; height: 14px; width: 100%; margin: 8px 0; }
.challenge-progress { height: 14px; background: #00b7f1; border-radius: 8px 0 0 8px; transition: width 0.4s;}
.challenge-desc {
  font-size: 13px;
  color: #fff;
  background: #ff9800;
  border-radius: 11px;
  padding: 7px 18px;
  margin-top: 12px;
  font-weight: bold;
  display: inline-block;
  letter-spacing: 0.8px;
  box-shadow: 0 2px 12px #ffd18033;
}

.cards {
  display: grid;
  grid-template-columns: repeat(3, 1fr); /* 3列に戻す */
  gap: 36px;
  justify-content: center;
  align-items: flex-end;
  margin: 38px 0 0 0;
  max-width: 1000px; /* 最大幅を増やす */
  margin-left: auto;
  margin-right: auto;
}

@media (max-width: 768px) {
  .cards {
    grid-template-columns: repeat(2, 1fr);
  }
}

@media (max-width: 480px) {
  .cards {
    grid-template-columns: 1fr;
  }
}

.card {
  width: 220px;
  min-height: 320px;
  max-height: 320px;
  background: linear-gradient(110deg, #fff 70%, #e3f2fd 100%);
  border-radius: 4px 8px 8px 4px;
  box-shadow: 0 8px 22px #b6c3d93b, 9px 0 0 #eadec7, 0 16px 36px #90caf94c;
  position: relative;
  display: flex;
  flex-direction: column;
  align-items: stretch;
  justify-content: flex-start;
  transition: transform 0.13s, box-shadow 0.14s;
}

.card:hover {
  transform: scale(1.045) translateY(-5px) rotate(-1deg);
  box-shadow: 0 20px 40px #b3c7ef3a, 0 10px 32px #90caf933, 11px 0 0 #f2dfb9;
}

.title {
  font-size: 15.5px;
  font-weight: bold;
  color: #17416a;
  margin: 32px 15px 5px 20px;
  text-align: left;
  line-height: 1.38;
  min-height: 2.1em;
  letter-spacing: 1.2px;
  z-index: 10;
  position: relative;
  text-shadow: 0 1px 6px #dbe8f84e;
}

.illustration {
  width: 100%;
  height: 140px; /* 画像の高さを増やす */
  margin: 0 0 8px 0;
  background-size: contain;
  background-position: center;
  background-repeat: no-repeat;
  border-radius: 0 4px 4px 0;
}

.author {
  font-size: 12.3px;
  color: #40566a;
  margin: 0 0 3px 20px;
  text-align: left;
  z-index: 10;
  position: relative;
  font-weight: 500;
}

.meta {
  font-size: 12px;
  color: #8499b0;
  margin-left: 20px;
  margin-bottom: 8px;
  text-align: left;
  line-height: 1.32;
  z-index: 10;
  position: relative;
}

.card-buttons {
  display: flex;
  flex-direction: column;
  gap: 4px; /* ボタン間の間隔を小さく */
  margin: 0 15px 12px 20px; /* 下部のマージンを小さく */
}

.small-buttons {
  display: flex;
  gap: 4px; /* 小さいボタン間の間隔を小さく */
  margin-top: 4px; /* 上部のマージンを小さく */
}

.start-btn {
  background: #007bb8;
  color: #fff;
  border: none;
  border-radius: 6px;
  font-size: 12px;
  font-weight: bold;
  margin: 0;
  padding: 3px;
  width: 100%;
  box-shadow: 0 2px 9px #7bc8f320;
  cursor: pointer;
  transition: background 0.16s;
  z-index: 10;
  position: relative;
  letter-spacing: 0.5px;
  line-height: 1;
  height: 40px;
  display: flex;
  align-items: center;
  justify-content: center;
}

.start-btn:hover {
  background: #113f76;
  color: #fff;
}

/* 小さいボタンのスタイル */
.small-btn {
  background: #4CAF50;
  color: #fff;
  border: none;
  border-radius: 4px;
  font-size: 12px;
  font-weight: bold;
  margin: 0;
  padding: 3px;
  width: 50%;
  box-shadow: 0 2px 9px #7bc8f320;
  cursor: pointer;
  transition: background 0.16s;
  z-index: 10;
  position: relative;
  line-height: 1;
  height: 25px;
  display: flex;
  align-items: center;
  justify-content: center;
}

.small-btn:hover {
  background: #388E3C;
  color: #fff;
}

/* 音声ボタンのスタイル */
.audio-btn {
  background: #FF9800;
  color: #fff;
  border: none;
  border-radius: 4px;
  font-size: 16px;
  font-weight: bold;
  margin: 0;
  padding: 3px;
  width: 50%;
  box-shadow: 0 2px 9px #7bc8f320;
  cursor: pointer;
  transition: background 0.16s;
  z-index: 10;
  position: relative;
  display: flex;
  align-items: center;
  justify-content: center;
  line-height: 1;
  height: 25px;
}

.audio-btn:hover {
  background: #F57C00;
  color: #fff;
}

.audio-btn svg {
  width: 18px; /* アイコンサイズを大きく */
  height: 18px; /* アイコンサイズを大きく */
  fill: currentColor;
}

/* 本の背表紙の装飾 */
.card::before {
  content: "";
  position: absolute;
  left: -12px;
  top: 0;
  bottom: 0;
  width: 20px;
  background: var(--spine-color, #435ba3);
  border-radius: 4px 0 0 4px;
  z-index: 2;
}

/* 本のページの装飾 */
.card::after {
  content: "";
  position: absolute;
  left: 0;
  top: 0;
  bottom: 0;
  right: 0;
  background: linear-gradient(90deg, transparent 0%, rgba(255,255,255,0.1) 50%, transparent 100%);
  pointer-events: none;
  z-index: 1;
}

.medal-badge {position:absolute;top:-13px;left:-13px;z-index:2;display:block;width:32px;height:32px;background:none;}


/* --- AI生成UI追加 --- */
#aiGenerateBox {
  display: none;
  flex-direction: column;
  align-items: center;
  gap: 14px;
  padding: 32px 0;
  max-width: 400px;
  margin: 0 auto;
}

#aiGenerateBox select, #aiGenerateBox button {
  font-size: 17px;
  padding: 8px 14px;
  border-radius: 10px;
  border: 1px solid #cce7f9;
  margin-bottom: 8px;
}
#aiLoading {
  color: #00b7f1;
  font-size: 18px;
  text-align: center;
  margin-top: 24px;
}
#aiErr {
  color: #d81b60;
  margin-top: 10px;
}
/* --- 進捗バー --- */
#textDisplay {
  position: relative;
  writing-mode: vertical-rl;
  text-orientation: upright;
  height: 60vh;
  width: 760px;
  margin: 0 auto;
  padding: 18px;
  font-family: "Tsukushi Mincho", "Yu Mincho", "YuMincho", "MS Mincho", serif;
  font-size: 19px;
  line-height: 2;
  border-radius: 12px;
  background: #ffffff;
  border: none;
  color: #2c3e50;
  overflow: hidden;
}

.page-content {
  position: relative;
  z-index: 0;
}

#textDisplay ruby{ruby-position:over}
.page-info {position:absolute;left:8px;bottom:6px;font-size:12px;color:#666}
.highlight {background:#b3e5fc;border-radius:4px}
.progress-container {
  position: relative;
  width: 100%;
  height: 18px;
  background: #ffffff;
  border-radius: 12px;
  margin-top: 18px;
}

.progress-bar {
  position: absolute;
  right: 0;
  top: 0;
  height: 100%;
  width: 0%;
  background: #00b7f1;
  transition: width .3s;
  border-radius: 12px;
}

.progress-text {
  text-align: left;
  font-size: 13px;
  margin-top: 5px;
  color: #333;
}

.reading-label {
  position: absolute;
  background: #e4389f;
  color: #fff;
  padding: 6px 12px;
  border-radius: 8px;
  font-size: 12px;
  font-weight: bold;
  display: none;
  z-index: 2100;
  align-items: center;
  gap: 4px;
}

.eq {
  display: inline-flex;
  align-items: flex-end;
  width: 18px;
  height: 12px;
  gap: 2px;
}

.eq i {
  flex: 1;
  background: #fff;
  border-radius: 1px;
  animation: peak .8s infinite ease-in-out;
}

.eq i:nth-child(2) {
  animation-delay: -.2s;
}

.eq i:nth-child(3) {
  animation-delay: -.4s;
}

.eq i:nth-child(4) {
  animation-delay: -.6s;
}

@keyframes peak {
  0%, 100% { height: 15%; }
  40% { height: 100%; }
  60% { height: 30%; }
}

@keyframes sparkle {
  0%, 100% { 
    transform: rotate(0deg) scale(1);
    opacity: 0.3;
  }
  50% { 
    transform: rotate(180deg) scale(1.1);
    opacity: 0.7;
  }
}

/* レスポンシブ対応 */
@media (max-width: 768px) {
  .gem-exchange-grid {
    grid-template-columns: 1fr !important;
    gap: 16px !important;
  }
}

/* === 宝石交換所プロフェッショナルデザイン === */
.gem-exchange-container {
  background: linear-gradient(135deg, #f5f7fa 0%, #e9ecef 100%);
  border-radius: 24px;
  padding: 40px;
  box-shadow: 
    0 20px 60px rgba(0, 0, 0, 0.08),
    0 0 0 1px rgba(0, 0, 0, 0.04);
  margin: 0 auto;
  max-width: 1200px;
  position: relative;
  overflow: hidden;
}

.gem-exchange-container::before {
  content: '';
  position: absolute;
  top: -50%;
  right: -50%;
  width: 200%;
  height: 200%;
  background: radial-gradient(circle, rgba(8, 145, 178, 0.05) 0%, transparent 70%);
  animation: gem-glow 20s ease-in-out infinite;
}

@keyframes gem-glow {
  0%, 100% { transform: rotate(0deg) scale(1); opacity: 0.5; }
  50% { transform: rotate(180deg) scale(1.1); opacity: 0.8; }
}

.gem-header {
  text-align: center;
  margin-bottom: 40px;
  position: relative;
  z-index: 1;
}

.gem-header h2 {
  font-size: 36px;
  font-weight: 800;
  background: linear-gradient(135deg, #0891b2 0%, #0c4a6e 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  margin: 0 0 12px 0;
  letter-spacing: -0.5px;
  display: inline-block;
}

.gem-header .subtitle {
  font-size: 16px;
  color: #64748b;
  font-weight: 500;
  letter-spacing: 0.5px;
}

.gem-current-promise {
  background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
  border: 2px solid #0891b2;
  border-radius: 20px;
  padding: 32px;
  margin-bottom: 32px;
  box-shadow: 
    0 10px 40px rgba(8, 145, 178, 0.1),
    inset 0 1px 0 rgba(255, 255, 255, 0.9);
  position: relative;
  overflow: hidden;
}

.gem-current-promise::before {
  content: url('diamond.png');
  position: absolute;
  top: -20px;
  right: -20px;
  width: 80px;
  height: 80px;
  opacity: 0.1;
  transform: rotate(-15deg);
}

.gem-promise-title {
  color: #0c4a6e;
  font-size: 20px;
  font-weight: 700;
  margin: 0 0 20px 0;
  display: flex;
  align-items: center;
  gap: 10px;
}

.gem-promise-content {
  background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
  border: 1px solid #7dd3fc;
  border-radius: 16px;
  padding: 20px;
  font-size: 16px;
  line-height: 1.6;
  color: #075985;
  font-weight: 500;
  box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.04);
}

.gem-achievement-section {
  margin-top: 24px;
  padding: 24px;
  background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%);
  border: 2px solid #f87171;
  border-radius: 16px;
  text-align: center;
  box-shadow: 
    0 10px 30px rgba(248, 113, 113, 0.15),
    inset 0 1px 0 rgba(255, 255, 255, 0.9);
}

.gem-achievement-title {
  font-size: 24px;
  font-weight: 800;
  background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  margin-bottom: 8px;
}

.gem-achievement-subtitle {
  font-size: 16px;
  color: #991b1b;
  font-weight: 500;
  margin-bottom: 20px;
}

.gem-claim-btn {
  background: linear-gradient(135deg, #ec4899 0%, #db2777 100%);
  color: white;
  border: none;
  border-radius: 12px;
  padding: 16px 32px;
  font-size: 16px;
  font-weight: 700;
  cursor: pointer;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow: 
    0 4px 14px rgba(236, 72, 153, 0.4),
    0 1px 3px rgba(0, 0, 0, 0.08);
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.gem-claim-btn:hover {
  transform: translateY(-2px);
  box-shadow: 
    0 6px 20px rgba(236, 72, 153, 0.5),
    0 2px 4px rgba(0, 0, 0, 0.08);
}

.gem-claim-btn:active {
  transform: translateY(0);
}

.gem-main-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 32px;
  margin-bottom: 32px;
}

.gem-balance-card {
  background: linear-gradient(135deg, #ffffff 0%, #f0fdff 100%);
  border: 2px solid #0891b2;
  border-radius: 20px;
  padding: 32px;
  box-shadow: 
    0 10px 40px rgba(8, 145, 178, 0.1),
    inset 0 1px 0 rgba(255, 255, 255, 0.9);
  position: relative;
  overflow: hidden;
}

.gem-balance-card::after {
  content: '';
  position: absolute;
  bottom: -30px;
  right: -30px;
  width: 120px;
  height: 120px;
  background: radial-gradient(circle, rgba(8, 145, 178, 0.15) 0%, transparent 70%);
  border-radius: 50%;
}

.gem-card-title {
  color: #0c4a6e;
  font-size: 20px;
  font-weight: 700;
  margin: 0 0 24px 0;
  text-align: center;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 10px;
}

.gem-balance-display {
  text-align: center;
  position: relative;
  z-index: 1;
}

.gem-balance-number {
  font-size: 64px;
  color: #0891b2;
  font-weight: 900;
  line-height: 1;
  margin-bottom: 8px;
  text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
  display: inline-block;
  animation: gem-pulse 2s ease-in-out infinite;
}

@keyframes gem-pulse {
  0%, 100% { transform: scale(1); }
  50% { transform: scale(1.05); }
}

.gem-balance-unit {
  color: #0891b2;
  font-size: 20px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 2px;
}

.gem-target-card {
  background: linear-gradient(135deg, #ffffff 0%, #fdf2f8 100%);
  border: 2px solid #ec4899;
  border-radius: 20px;
  padding: 32px;
  box-shadow: 
    0 10px 40px rgba(236, 72, 153, 0.1),
    inset 0 1px 0 rgba(255, 255, 255, 0.9);
}

.gem-input-group {
  display: flex;
  gap: 12px;
  margin-bottom: 16px;
}

.gem-input {
  flex: 1;
  padding: 14px 16px;
  border: 2px solid #cbd5e1;
  border-radius: 12px;
  font-size: 16px;
  font-weight: 500;
  outline: none;
  transition: all 0.2s;
  background: #ffffff;
}

.gem-input:focus {
  border-color: #ec4899;
  box-shadow: 0 0 0 3px rgba(236, 72, 153, 0.1);
}

.gem-input-unit {
  align-self: center;
  color: #64748b;
  font-weight: 700;
  font-size: 16px;
}

.gem-save-btn {
  width: 100%;
  background: linear-gradient(135deg, #0891b2 0%, #0c4a6e 100%);
  color: white;
  border: none;
  border-radius: 12px;
  padding: 14px;
  font-size: 16px;
  font-weight: 700;
  cursor: pointer;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow: 
    0 4px 14px rgba(8, 145, 178, 0.4),
    0 1px 3px rgba(0, 0, 0, 0.08);
  text-transform: uppercase;
  letter-spacing: 0.5px;
  margin-top: 8px;
}

.gem-save-btn:hover {
  transform: translateY(-2px);
  box-shadow: 
    0 6px 20px rgba(8, 145, 178, 0.5),
    0 2px 4px rgba(0, 0, 0, 0.08);
}

.gem-save-btn:active {
  transform: translateY(0);
}

.gem-details-card {
  background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
  border: 1px solid #e2e8f0;
  border-radius: 20px;
  padding: 32px;
  box-shadow: 
    0 10px 40px rgba(0, 0, 0, 0.08),
    0 2px 4px rgba(0, 0, 0, 0.04);
}

.gem-details-title {
  color: #1e293b;
  font-size: 20px;
  font-weight: 700;
  margin: 0 0 24px 0;
  text-align: center;
}

.gem-textarea-label {
  display: block;
  font-weight: 600;
  color: #475569;
  margin-bottom: 8px;
  font-size: 15px;
}

.gem-textarea {
  width: 100%;
  height: 100px;
  padding: 16px;
  border: 2px solid #cbd5e1;
  border-radius: 12px;
  font-size: 15px;
  resize: vertical;
  outline: none;
  font-family: inherit;
  line-height: 1.5;
  transition: all 0.2s;
  background: #ffffff;
}

.gem-textarea:focus {
  border-color: #0891b2;
  box-shadow: 0 0 0 3px rgba(8, 145, 178, 0.1);
}

/* === アイテムショップスタイル === */
.shop-container {
  background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
  border-radius: 24px;
  padding: 24px;
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12);
  margin: 0 auto;
  max-width: 500px;
  font-family: 'Arial', sans-serif;
}

.shop-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 24px;
  padding: 16px;
  background: linear-gradient(135deg, #4fc3f7 0%, #29b6f6 100%);
  border-radius: 20px;
  box-shadow: 0 4px 16px rgba(79, 195, 247, 0.3);
}

.shop-title {
  color: white;
  font-size: 24px;
  margin: 0;

}

.shop-balance {
  display: flex;
  align-items: center;
  gap: 8px;
  background: rgba(255, 255, 255, 0.2);
  padding: 8px 16px;
  border-radius: 20px;
  color: white;
  font-weight: 700;
  font-size: 18px;
  backdrop-filter: blur(10px);
}

.balance-icon {
  font-size: 20px;
}

.shop-items {
  display: flex;
  flex-direction: column;
  gap: 12px;
  margin-bottom: 24px;
}

.shop-item {
  background: white;
  border-radius: 16px;
  padding: 16px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  transition: all 0.3s ease;
  border: 2px solid transparent;
}

.shop-item:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
  border-color: #29b6f6;
}

.item-info {
  display: flex;
  align-items: center;
  gap: 16px;
}

.item-icon {
  font-size: 32px;
  width: 48px;
  height: 48px;
  display: flex;
  align-items: center;
  justify-content: center;
  background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);
  border-radius: 12px;
  box-shadow: 0 2px 8px rgba(255, 152, 0, 0.2);
}

.item-name {
  font-size: 18px;
  font-weight: 600;
  color: #1565c0;
}

.item-price {
  display: flex;
  align-items: center;
  gap: 12px;
}

.price-gems {
  font-size: 16px;
  font-weight: 700;
  color: #f57c00;
  background: linear-gradient(135deg, #fff8e1 0%, #ffecb3 100%);
  padding: 6px 12px;
  border-radius: 20px;
  border: 2px solid #ffb74d;
}

.buy-btn {
  background: linear-gradient(135deg, #b3e5fc 0%, #87ceeb 50%, #5dccf0 100%);
  color: #fff;
  border: 2px solid #29b6f6;
  border-radius: 20px;
  padding: 12px 24px;
  font-size: 16px;
  font-weight: 700;
  cursor: pointer;
  transition: all 0.15s ease;
  box-shadow: 
    0 6px 0 #039be5,
    0 8px 15px rgba(87, 206, 240, 0.4),
    inset 0 1px 0 rgba(255, 255, 255, 0.5),
    inset 0 -1px 0 rgba(0, 0, 0, 0.1);
  position: relative;
  user-select: none;
  text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
  font-family: 'Arial', sans-serif;
  letter-spacing: 0.5px;
  min-width: 100px;
  text-align: center;
}

.buy-btn:hover:not(:disabled) {
  background: linear-gradient(135deg, #e1f5fe 0%, #b3e5fc 50%, #81d4fa 100%);
  transform: translateY(-2px);
  box-shadow: 
    0 8px 0 #039be5,
    0 12px 20px rgba(87, 206, 240, 0.5),
    inset 0 1px 0 rgba(255, 255, 255, 0.6),
    inset 0 -1px 0 rgba(0, 0, 0, 0.1);
}

.buy-btn:active:not(:disabled) {
  background: linear-gradient(135deg, #b3e5fc 0%, #87ceeb 50%, #4fc3f7 100%);
  transform: translateY(4px);
  box-shadow: 
    0 2px 0 #039be5,
    0 4px 8px rgba(87, 206, 240, 0.3),
    inset 0 1px 0 rgba(255, 255, 255, 0.4),
    inset 0 -1px 0 rgba(0, 0, 0, 0.2);
}

.buy-btn:disabled {
  background: #e0e0e0;
  color: #9e9e9e;
  border-color: #bdbdbd;
  cursor: not-allowed;
  box-shadow: none;
  transform: none;
}

.custom-item-section {
  background: linear-gradient(135deg, #f3e5f5 0%, #e1bee7 100%);
  border-radius: 16px;
  padding: 20px;
  margin-top: 16px;
  border: 2px solid #ce93d8;
}

.custom-title {
  color: #7b1fa2;
  font-size: 18px;
  font-weight: 700;
  margin: 0 0 16px 0;
  text-align: center;
}

.custom-form {
  display: flex;
  gap: 8px;
  margin-bottom: 16px;
}

.custom-input {
  flex: 1;
  padding: 10px 12px;
  border: 2px solid #ce93d8;
  border-radius: 8px;
  font-size: 14px;
  outline: none;
  transition: border-color 0.3s ease;
}

.custom-input:focus {
  border-color: #ab47bc;
  box-shadow: 0 0 0 3px rgba(171, 71, 188, 0.2);
}

.add-custom-btn {
  background: linear-gradient(135deg, #ce93d8 0%, #ba68c8 50%, #ab47bc 100%);
  color: white;
  border: 2px solid #8e24aa;
  border-radius: 20px;
  padding: 12px 24px;
  font-size: 16px;
  font-weight: 700;
  cursor: pointer;
  transition: all 0.15s ease;
  box-shadow: 
    0 6px 0 #6a1b9a,
    0 8px 15px rgba(171, 71, 188, 0.4),
    inset 0 1px 0 rgba(255, 255, 255, 0.5),
    inset 0 -1px 0 rgba(0, 0, 0, 0.1);
  position: relative;
  user-select: none;
  text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
  font-family: 'Arial', sans-serif;
  letter-spacing: 0.5px;
  min-width: 100px;
  text-align: center;
}

.add-custom-btn:hover {
  background: linear-gradient(135deg, #e1bee7 0%, #ce93d8 50%, #ba68c8 100%);
  transform: translateY(-2px);
  box-shadow: 
    0 8px 0 #6a1b9a,
    0 12px 20px rgba(171, 71, 188, 0.5),
    inset 0 1px 0 rgba(255, 255, 255, 0.6),
    inset 0 -1px 0 rgba(0, 0, 0, 0.1);
}

.add-custom-btn:active {
  background: linear-gradient(135deg, #ce93d8 0%, #ba68c8 50%, #9c27b0 100%);
  transform: translateY(4px);
  box-shadow: 
    0 2px 0 #6a1b9a,
    0 4px 8px rgba(171, 71, 188, 0.3),
    inset 0 1px 0 rgba(255, 255, 255, 0.4),
    inset 0 -1px 0 rgba(0, 0, 0, 0.2);
}

.custom-items-container {
  display: flex;
  flex-direction: column;
  gap: 12px;
  margin-bottom: 16px;
}

.remove-btn {
  background: linear-gradient(135deg, #ef9a9a 0%, #e57373 50%, #f44336 100%);
  color: white;
  border: 2px solid #d32f2f;
  border-radius: 20px;
  padding: 8px 16px;
  font-size: 14px;
  font-weight: 700;
  cursor: pointer;
  transition: all 0.15s ease;
  box-shadow: 
    0 4px 0 #b71c1c,
    0 6px 12px rgba(244, 67, 54, 0.4),
    inset 0 1px 0 rgba(255, 255, 255, 0.5),
    inset 0 -1px 0 rgba(0, 0, 0, 0.1);
  position: relative;
  user-select: none;
  text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
  font-family: 'Arial', sans-serif;
  letter-spacing: 0.5px;
  margin-left: 8px;
  min-width: 70px;
  text-align: center;
}

.remove-btn:hover {
  background: linear-gradient(135deg, #ffcdd2 0%, #ef9a9a 50%, #e57373 100%);
  transform: translateY(-1px);
  box-shadow: 
    0 5px 0 #b71c1c,
    0 8px 16px rgba(244, 67, 54, 0.5),
    inset 0 1px 0 rgba(255, 255, 255, 0.6),
    inset 0 -1px 0 rgba(0, 0, 0, 0.1);
}

.remove-btn:active {
  background: linear-gradient(135deg, #ef9a9a 0%, #e57373 50%, #d32f2f 100%);
  transform: translateY(2px);
  box-shadow: 
    0 2px 0 #b71c1c,
    0 4px 8px rgba(244, 67, 54, 0.3),
    inset 0 1px 0 rgba(255, 255, 255, 0.4),
    inset 0 -1px 0 rgba(0, 0, 0, 0.2);
}

.gem-section-title {
  font-size: 24px;
  font-weight: 700;
  color: #0c4a6e;
  margin-bottom: 24px;
  text-align: center;
}





@media (max-width: 768px) {
  .shop-container {
    padding: 16px;
    max-width: 100%;
    margin: 0 16px;
  }
  
  .shop-header {
    padding: 12px;
    flex-direction: column;
    gap: 12px;
    text-align: center;
  }
  
  .shop-title {
    font-size: 20px;
  }
  
  .shop-balance {
    font-size: 16px;
  }
  
  .shop-item {
    flex-direction: column;
    gap: 12px;
    text-align: center;
  }
  
  .item-info {
    flex-direction: column;
    gap: 8px;
  }
  
  .item-price {
    flex-direction: column;
    gap: 8px;
  }
  
  .custom-form {
    flex-direction: column;
  }
  
  .custom-items-container {
    gap: 8px;
  }
}

/* === 正解時の爽快アニメーション === */
.success-animation-container {
  position: fixed;
  top: 0;
  left: 0;
  width: 100vw;
  height: 100vh;
  pointer-events: none;
  z-index: 9999;
  display: none;
}

.success-main-message {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  color: #20B2AA;
  font-size: 4rem;
  font-weight: bold;
  text-align: center;
  opacity: 0;
  animation: successPop 0.8s cubic-bezier(0.68, -0.55, 0.265, 1.55) forwards;
  text-shadow: 
    0 0 5px rgba(255, 255, 255, 1),
    0 0 5px rgba(255, 255, 255, 1),
    0 0 5px rgba(255, 255, 255, 1),
    0 0 5px rgba(255, 255, 255, 1),
    0 0 5px rgba(255, 255, 255, 1),
    0 0 5px rgba(255, 255, 255, 1),
    2px 2px 0px rgba(255, 255, 255, 1),
    -2px -2px 0px rgba(255, 255, 255, 1),
    2px -2px 0px rgba(255, 255, 255, 1),
    -2px 2px 0px rgba(255, 255, 255, 1);
}

.success-particles {
  position: absolute;
  width: 100%;
  height: 100%;
  overflow: hidden;
}

.particle {
  position: absolute;
  width: 8px;
  height: 8px;
  background: linear-gradient(45deg, #20B2AA, #48D1CC, #40E0D0, #66CDAA, #ffd700);
  border-radius: 50%;
  animation: particleFloat 1.2s ease-out forwards;
  box-shadow: 0 0 10px rgba(255, 255, 255, 0.8);
}

.success-burst {
  display: none;
}

.success-ring {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  border: 4px solid;
  border-color: #20B2AA transparent #48D1CC transparent;
  border-radius: 50%;
  opacity: 0;
  animation: ringExpand 1s ease-out forwards;
}

.success-star {
  position: absolute;
  color: #ffd700;
  font-size: 2rem;
  opacity: 0;
  animation: starTwinkle 1s ease-in-out forwards;
}

@keyframes successPop {
  0% {
    opacity: 0;
    transform: translate(-50%, -50%) scale(0.3) rotate(-10deg);
  }
  50% {
    transform: translate(-50%, -50%) scale(1.1) rotate(5deg);
  }
  100% {
    opacity: 1;
    transform: translate(-50%, -50%) scale(1) rotate(0deg);
  }
  }

@keyframes particleFloat {
  0% {
    opacity: 1;
    transform: translateY(0) scale(0);
  }
  10% {
    transform: translateY(-20px) scale(1);
  }
  100% {
    opacity: 0;
    transform: translateY(-300px) scale(0.5);
  }
}

@keyframes burstExpand {
  0% {
    opacity: 0;
    transform: translate(-50%, -50%) scale(0);
  }
  50% {
    opacity: 1;
    transform: translate(-50%, -50%) scale(1);
  }
  100% {
    opacity: 0;
    transform: translate(-50%, -50%) scale(2);
  }
}

@keyframes ringExpand {
  0% {
    opacity: 1;
    transform: translate(-50%, -50%) scale(0);
  }
  100% {
    opacity: 0;
    transform: translate(-50%, -50%) scale(3);
  }
}

/* === 宝石交換ボタンスタイル === */
.gem-exchange-button {
  background: #f06292;
  color: #fff;
  border: 2px solid #e91e63;
  border-radius: 12px;
  padding: 12px 20px;
  font-size: 13px;
  font-weight: 700;
  cursor: pointer;
  margin-top: 8px;
  transition: all 0.15s ease;
  box-shadow: 
    0 6px 0 #c2185b,
    0 8px 15px rgba(233, 30, 99, 0.4),
    inset 0 1px 0 rgba(255, 255, 255, 0.5),
    inset 0 -1px 0 rgba(0, 0, 0, 0.1);
  position: relative;
  user-select: none;
  text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
  font-family: 'Arial', sans-serif;
  letter-spacing: 0.5px;
}

.gem-exchange-button:hover {
  background: #ec407a;
  transform: translateY(-2px);
  box-shadow: 
    0 8px 0 #c2185b,
    0 12px 20px rgba(233, 30, 99, 0.5),
    inset 0 1px 0 rgba(255, 255, 255, 0.6),
    inset 0 -1px 0 rgba(0, 0, 0, 0.1);
}

.gem-exchange-button:active {
  background: #d81b60;
  transform: translateY(4px);
  box-shadow: 
    0 2px 0 #c2185b,
    0 4px 8px rgba(233, 30, 99, 0.3),
    inset 0 1px 0 rgba(255, 255, 255, 0.4),
    inset 0 -1px 0 rgba(0, 0, 0, 0.2);
}

@keyframes starTwinkle {
  0%, 100% {
    opacity: 0;
    transform: scale(0) rotate(0deg);
  }
  50% {
    opacity: 1;
    transform: scale(1.2) rotate(180deg);
  }
}

@media (max-width: 768px) {
  .success-main-message {
    font-size: 2.5rem;
  }
}

/* === 紙吹雪演出 === */
.confetti-container {
  position: fixed;
  top: 0;
  left: 0;
  width: 100vw;
  height: 100vh;
  pointer-events: none;
  z-index: 10000;
  overflow: hidden;
}

.confetti-piece {
  position: absolute;
  width: 10px;
  height: 10px;
  border-radius: 2px;
  animation: confetti-fall 3s linear forwards;
}





.sparkle-effect {
  position: absolute;
  pointer-events: none;
  color: #FFD700;
  font-size: 16px;
  animation: sparkle-twinkle 1.2s ease-in-out forwards;
}

@keyframes sparkle-twinkle {
  0%, 100% {
    opacity: 0;
    transform: scale(0) rotate(0deg);
  }
  10% {
    opacity: 1;
    transform: scale(0.5) rotate(45deg);
  }
  50% {
    opacity: 1;
    transform: scale(1.2) rotate(180deg);
    text-shadow: 0 0 10px #FFD700, 0 0 20px #FFD700, 0 0 30px #FFD700;
  }
  90% {
    opacity: 1;
    transform: scale(0.8) rotate(315deg);
  }
}

@keyframes clearRingExpand {
  0% {
    opacity: 1;
    transform: translate(-50%, -50%) scale(0);
  }
  100% {
    opacity: 0;
    transform: translate(-50%, -50%) scale(3);
  }
}

.confetti-clear-message {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  font-size: 5rem;
  font-weight: bold;
  color: #FF6B35;
  z-index: 10001;
  opacity: 0;
  animation: clear-message-appear 1.5s ease-out forwards;
  pointer-events: none;
  text-shadow: 
    0 0 5px rgba(255, 255, 255, 1),
    0 0 5px rgba(255, 255, 255, 1),
    0 0 5px rgba(255, 255, 255, 1),
    0 0 5px rgba(255, 255, 255, 1),
    0 0 5px rgba(255, 255, 255, 1),
    0 0 5px rgba(255, 255, 255, 1),
    2px 2px 0px rgba(255, 255, 255, 1),
    -2px -2px 0px rgba(255, 255, 255, 1),
    2px -2px 0px rgba(255, 255, 255, 1),
    -2px 2px 0px rgba(255, 255, 255, 1);
}

@keyframes confetti-fall {
  0% {
    transform: translateY(-50px) rotate(0deg);
    opacity: 1;
  }
  100% {
    transform: translateY(110vh) rotate(720deg);
    opacity: 0;
  }
}

@keyframes clear-message-appear {
  0% {
    opacity: 0;
    transform: translate(-50%, -50%) scale(0.5) rotate(-5deg);
  }
  20% {
    opacity: 1;
    transform: translate(-50%, -50%) scale(1.1) rotate(2deg);
  }
  40% {
    opacity: 1;
    transform: translate(-50%, -50%) scale(1) rotate(0deg);
  }
  100% {
    opacity: 0;
    transform: translate(-50%, -50%) scale(0.9) rotate(0deg);
  }
}

@media (max-width: 768px) {
  .confetti-clear-message {
    font-size: 3.5rem;
  }
}

@media (max-width: 480px) {
  .confetti-clear-message {
    font-size: 2.8rem;
  }
}

.reader-toolbar {
  width: 100%;
  display: flex;
  justify-content: flex-end;
  margin-bottom: 0;
}

.home-btn {
  display: flex;
  align-items: center;
  gap: 6px;
  padding: 4px 14px;
  font-size: 14px;
  background: #00b7f1;
  color: #fff;
  border: none;
  border-radius: 20px;
  cursor: pointer;
  justify-content: center;
  box-shadow: 0 2px 4px rgba(0, 0, 0, .15);
}

.home-btn:hover {
  background: #2f74b5;
}

.home-btn svg {
  width: 18px;
  height: 18px;
  fill: #fff;
}

#finishReadingBtn {
  background: #1a5fb3;
  width: 50%;
}

#finishReadingBtn:hover {
  background: #113f76;
}

/* --- カレンダー・宝箱 --- */
.calendar-wrapper {
  margin-top: 32px;
  text-align: center;
}

.calendar-title {
  font-weight: normal;
  margin: 8px;
}

.calendar-week {
  display: grid;
  grid-template-columns: repeat(7, 40px);
  gap: 8px;
  justify-content: center;
  font-size: 12px;
  color: #aaa;
  margin-bottom: 4px;
}

.calendar-week span {
  width: 40px;
  height: 16px;
  line-height: 16px;
}

.calendar {
  display: grid;
  grid-template-columns: repeat(7, 40px);
  gap: 8px;
  justify-content: center;
}

.cal-day {
  width: 40px;
  height: 40px;
  font-size: 14px;
  color: #666;
  border: 1px solid #ffffff;
  border-radius: 6px;
  display: flex;
  align-items: center;
  justify-content: center;
  background: #def8ff;
}

.cal-day.stamp {
  background: #b3e5fc !important;  /* 明るい水色 */
  border: none;
  position: relative;
}

.stamp-img {
  position: absolute;
  top: 2px;
  left: 50%;
  transform: translateX(-50%);
  width: 40px;
  height: 40px;
  pointer-events: none;
  z-index: 2;
}

.cal-day.blank {
  border: none;
  background: transparent;
}

#treasureBox {
  position: fixed;
  right: 40px;
  bottom: 40px;
  z-index: 3000;
  width: 100px;
  height: 72px;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
}

#treasureBox span {
  font-size: 30px;
  display: inline-flex;
  align-items: center;
}

#diamondCount {
  background: #fff8;
  border-radius: 12px;
  padding: 2px 8px;
  font-size: 19px;
  color: #00b7f1;
  box-shadow: 0 2px 6px #00b7f111;
  font-weight: bold;
  margin-right: 2px;
}

.treasures-dashboard-title {
  font-weight: normal;
  font-size: 14px;
  color: #888;
  margin-bottom: 4px;
  letter-spacing: 0.2px;
  text-align: center;
  width: 100%;
  display: block;
}

.treasures-dashboard {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  text-align: center;
}

.treasure-row {
  display: flex;
  flex-direction: row;
  gap: 10px;
  margin-top: 2px;
}

.treasure-card {
  display: flex;
  flex-direction: column;
  align-items: center;
  background: rgba(255, 255, 255, 0.89);
  border-radius: 15px;
  box-shadow: 0 2px 8px #c6d8f618, 0 1px 0 #fff;
  padding: 7px 5px 7px 5px;
  min-width: 46px;
  min-height: 60px;
}

.treasure-icon {
  font-size: 25px;
  font-weight: bold;
  margin-bottom: 2px;
  margin-top: 1px;
}

.treasure-num {
  font-size: 20px;
  font-weight: bold;
  margin: 0;
  letter-spacing: 1px;
  line-height: 1.0;
}

.treasure-diamond {
  color: #00b7f1;
}

@media (max-width: 700px) {
  #treasureBox {
    right: 10px;
    bottom: 10px;
    width: 54px;
    height: 54px;
  }

  #diamondCount {
    font-size: 15px;
    padding: 2px 6px;
  }
}

.quiz-box.shrink {
  width: 220px !important;
  min-width: 0 !important;
  max-width: 230px !important;
  left: 18px !important;
  right: auto !important;
  top: 18px !important;
  bottom: auto !important;
  position: fixed !important;
  transform: none !important;
  background: #fff;
  opacity: 0.97;
  transition: width 0.2s, left 0.2s, bottom 0.2s, box-shadow 0.3s;
  box-shadow: 0 4px 18px 0 rgba(50, 80, 110, 0.18);
  z-index: 99999;
}

#quizOverlay.shrink {
  background: transparent !important;
  backdrop-filter: none !important;
  pointer-events: none;
}

.quiz-box.shrink * {
  pointer-events: auto !important;
}

/* シンプルな〇×表示用のアニメーション */
@keyframes showCircle {
  0% {
    opacity: 0;
    transform: translate(-50%, -50%) scale(0.5);
  }
  50% {
    opacity: 1;
    transform: translate(-50%, -50%) scale(1.1);
  }
  100% {
    opacity: 0;
    transform: translate(-50%, -50%) scale(1);
  }
}

/* styleタグに追加！ */
ruby rt, rt {
  user-select: none;
  -webkit-user-select: none;
  pointer-events: none;
}



/* 評価・クイズ */
#quizOverlay {
  position: fixed;
  inset: 0;
  display: none;
  z-index: 3000;
  background: rgba(0, 0, 0, .55);
  backdrop-filter: blur(2px);
  align-items: center;
  justify-content: center;
}

.quiz-box {
  width: 90%;
  max-width: 700px;
  max-height: 80vh;
  background: #fff;
  border-radius: 14px;
  padding: 24px;
  box-shadow: 0 6px 20px rgba(0, 0, 0, .25);
  overflow-y: auto;
}

.quiz-box h3 {
  margin: 0 0 18px;
  font-size: 20px;
  font-weight: bold;
  color: #00b7f1;
  text-align: center;
}

#quizList {
  list-style: none;
  margin: 12px 0;
  padding: 0;
  display: flex;
  flex-direction: column;
  gap: 10px;
}

#quizList li {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 10px;
  border: 1px solid #cce7f9;
  border-radius: 8px;
  cursor: pointer;
  background: #fff;
  position: relative;
}

#quizList li:hover {
  background: #d8f1ff;
}

.choice-label {
  display: inline-block;
  width: 26px;
  height: 26px;
  line-height: 26px;
  border-radius: 50%;
  background: #00b7f1;
  color: #fff;
  font-weight: bold;
  text-align: center;
}

.choice-mark {
  position: absolute;
  right: 10px;
  font-size: 20px;
  font-weight: bold;
}

.correctMark {
  color: #1b8e3e;
}

.wrongMark {
  color: #d81b60;
}

#feedback {
  font-size: 16px;
  font-weight: bold;
  text-align: center;
  margin-top: 20px;
  color: #2f74b5;
  writing-mode: vertical-rl;
  text-orientation: upright;
  font-family: 'Tsukushi Mincho', 'Yu Mincho', 'YuMincho', 'MS Mincho', serif;
  line-height: 2.2;
  align-self: flex-start;
}

#scoreOverlay {
  position: fixed;
  inset: 0;
  display: none;
  z-index: 5000;
  background: rgba(0, 0, 0, .55);
  backdrop-filter: blur(3px);
  align-items: center;
  justify-content: center;
}

.score-board {
  width: 92%;
  max-width: 440px;
  background: #fff7fd;
  border-radius: 24px;
  padding: 40px 28px;
  text-align: center;
  box-shadow: 0 10px 28px rgba(0, 0, 0, .28);
}

.grade-letter {
  font-size: 84px;
  font-weight: 900;
  margin: 0;
}

.grade-percent {
  font-size: 28px;
  font-weight: bold;
  margin: 8px 0 20px;
}

.grade-comment {
  font-size: 18px;
  margin-bottom: 28px;
}

.close-btn {
  background: #ff5fa1;
  color: #fff;
  border: none;
  border-radius: 16px;
  font-size: 16px;
  font-weight: bold;
  padding: 12px 28px;
  cursor: pointer;
}

.grade-S {
  color: #ff2b51;
}

.grade-A {
  color: #ff5fa1;
}

.grade-B {
  color: #ff9345;
}

.grade-C {
  color: #ffd740;
}

.grade-D {
  color: #42a5ff;
}

.grade-E {
  color: #9e9e9e;
}

.quiz-box {
  background: #fff;
  border-radius: 18px;
  box-shadow: 0 6px 24px rgba(0, 0, 0, 0.15);
  padding: 28px 24px 32px 24px;
  margin: 0 auto;
  writing-mode: vertical-rl;
  text-orientation: upright;
  font-family: 'Tsukushi Mincho', 'Yu Mincho', 'YuMincho', 'MS Mincho', serif;
  font-size: 18px;
  line-height: 2.2;
  color: #2c3e50;
  min-height: 400px;
  display: flex;
  flex-direction: column;
  align-items: flex-start;
}

.quiz-box h3 {
  color: #333;
  font-size: 18px;
  font-weight: bold;
  margin-bottom: 20px;
  letter-spacing: 1px;
  writing-mode: vertical-rl;
  text-orientation: upright;
  font-family: 'Tsukushi Mincho', 'Yu Mincho', 'YuMincho', 'MS Mincho', serif;
  line-height: 2.2;
  align-self: flex-start;
}

#quizList {
  margin: 0;
  padding: 0;
  display: flex;
  flex-direction: column;
  align-items: flex-start;
  width: 100%;
}

/* ---- 問題部（extract型のカード部分） ---- */
#extractMainQuestion {
  background: #e6f8ff;
  color: #1976d2;
  font-weight: normal !important;
  font-size: 18px;
  border-radius: 12px;
  border: 1.5px solid #b3e5fc;
  padding: 16px 16px 12px 16px;
  margin-bottom: 14px;
  margin-top: 0;
}

#selectedTextDisplay {
  background: #f2fafe;
  border: 1px solid #cce7f9;
  border-radius: 9px;
  font-weight: normal !important;
  padding: 10px 14px;
  color: #2c3e50;
  font-size: 16px;
  margin-bottom: 18px;
}

#extractHint {
  margin-top: 10px !important;
  margin-bottom: 0 !important;
}

/* ---- ボタン2つカスタム ---- */
#extractAnsBtn {
  background: #00b7f1;
  color: #fff;
  font-size: 17px;
  border: none;
  border-radius: 25px;
  width: 170px;
  height: 44px;
  margin-bottom: 8px;
  cursor: pointer;
  transition: background 0.2s;
}

#extractAnsBtn:hover {
  background: #007bb8;
}

#shrinkBtn {
  background: #f86098;
  color: #fff;
  font-size: 17px;
  border: none;
  border-radius: 25px;
  width: 170px;
  height: 44px;
  margin-bottom: 12px;
  cursor: pointer;
  transition: background 0.2s;
}

#shrinkBtn:hover {
  background: #d61e6d;
}

/* 戻るボタンも色調整 */
#expandBtn {
  background: #007bb8;
  color: #fff;
  font-size: 15px;
  border: none;
  border-radius: 22px;
  width: 140px;
  height: 38px;
  margin-bottom: 10px;
  cursor: pointer;
}

#goSelectBtn, #goAIGenBtn, #goLogicBtn, #goReadingTrainingBtn, #goGrammarTrainingBtn, #goKanjiVocabBtn {
  display: block;
  margin: 8px auto;
  width: 270px;
  height: 56px;
  font-size: 18px;
  font-weight: bold;
  border: none;
  border-radius: 15px;
  letter-spacing: 0.2px;
  line-height: 1.2;
  color: #fff;
  box-shadow: 0 8px 0 0 rgba(0, 0, 0, 0.10), 0 2px 12px #b3e5fc30;
  position: relative;
  transition: transform 0.13s, box-shadow 0.14s;
  z-index: 1;
}

/* 水色ボタン */
#goSelectBtn {
  background: #f86098;
  box-shadow: 0 8px 0 0 #d8497d, 0 2px 12px #ffd1e7;
}

/* ピンクボタン */
#goAIGenBtn {
  background: #00b7f1;
  box-shadow: 0 8px 0 0 #1a99ca, 0 2px 12px #b3e5fc30;
}

/* 音読トレーニングボタン（青） */
#goReadingTrainingBtn {
  background: #00b7f1;
  box-shadow: 0 8px 0 0 #1a99ca, 0 2px 12px #b3e5fc30;
}

/* 文法トレーニングボタン（オレンジ） */
#goGrammarTrainingBtn {
  background: #ea580c;
  box-shadow: 0 8px 0 0 #c2410c, 0 2px 12px #fed7aa;
}

/* 漢字・語彙トレーニングボタン（紫） */
#goKanjiVocabBtn {
  background: #9C27B0;
  box-shadow: 0 8px 0 0 #7B1FA2, 0 2px 12px #e1bee7;
}

/* 論理トレーニングボタン（緑） */
#goLogicBtn {
  background: #4CAF50;
  box-shadow: 0 8px 0 0 #388E3C, 0 2px 12px #c8e6c9;
}

/* 押したとき沈む効果 */
#goSelectBtn:active {
  transform: translateY(6px);
  box-shadow: 0 2px 0 0 #d8497d, 0 1px 4px #ffd1e7;
}

#goAIGenBtn:active {
  transform: translateY(6px);
  box-shadow: 0 2px 0 0 #1a99ca, 0 1px 4px #b3e5fc30;
}

#goReadingTrainingBtn:active {
  transform: translateY(6px);
  box-shadow: 0 2px 0 0 #1a99ca, 0 1px 4px #b3e5fc30;
}

#goGrammarTrainingBtn:active {
  transform: translateY(6px);
  box-shadow: 0 2px 0 0 #c2410c, 0 1px 4px #fed7aa;
}

#goKanjiVocabBtn:active {
  transform: translateY(6px);
  box-shadow: 0 2px 0 0 #7B1FA2, 0 1px 4px #e1bee7;
}

#goLogicBtn:active {
  transform: translateY(6px);
  box-shadow: 0 2px 0 0 #388E3C, 0 1px 4px #c8e6c9;
}

/* --- 論理トレーニングメニュー --- */
.logic-menu {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
  gap: 24px;
  max-width: 1000px;
  margin: 0 auto;
  padding: 0 20px;
}

.logic-item {
  background: linear-gradient(135deg, #fff 0%, #f8f9fa 100%);
  border-radius: 16px;
  padding: 24px 20px;
  box-shadow: 0 4px 12px rgba(76, 175, 80, 0.15);
  border: 2px solid #e8f5e8;
  transition: all 0.3s ease;
  cursor: pointer;
  position: relative;
  overflow: hidden;
}

.logic-item:hover {
  transform: translateY(-4px);
  box-shadow: 0 8px 20px rgba(76, 175, 80, 0.25);
  border-color: #4CAF50;
}

.logic-item::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 4px;
  background: linear-gradient(90deg, #4CAF50, #66BB6A);
}

.logic-item-title {
  font-size: 18px;
  font-weight: bold;
  color: #2e7d32;
  margin-bottom: 8px;
  display: flex;
  align-items: center;
  gap: 8px;
}

.logic-item-level {
  font-size: 14px;
  color: #66BB6A;
  margin-bottom: 12px;
  display: flex;
  align-items: center;
  gap: 4px;
}

.logic-item-description {
  font-size: 14px;
  color: #666;
  line-height: 1.5;
  margin-bottom: 16px;
}

.logic-item-status {
  display: flex;
  justify-content: space-between;
  align-items: center;
  font-size: 12px;
  color: #888;
}

.logic-item-badge {
  background: #4CAF50;
  color: white;
  padding: 4px 8px;
  border-radius: 12px;
  font-size: 10px;
  font-weight: bold;
}

.logic-item-badge.coming-soon {
  background: #ff9800;
}

.logic-item-badge.locked {
  background: #757575;
}

/* --- 指示語問題のスタイル --- */
.pronoun-reference-game {
  max-width: 800px;
  margin: 0 auto;
  padding: 20px;
}

#pronounText {
  position: relative;
  height: 350px !important;
  overflow: visible !important;
}

.pronoun-highlight {
  text-decoration: underline;
  text-decoration-color: #4CAF50;
  text-decoration-thickness: 2px;
  font-weight: bold;
  cursor: pointer;
  display: inline;
  vertical-align: baseline;
}



.pronoun-option {
  padding: 16px 24px;
  border: 2px solid #e0e0e0;
  border-radius: 12px;
  background: #ffffff;
  cursor: pointer;
  font-size: 18px;
  text-align: center;
  transition: all 0.3s ease;
  position: relative;
}

.pronoun-option:hover {
  border-color: #4CAF50;
  box-shadow: 0 4px 12px rgba(76, 175, 80, 0.2);
  transform: translateY(-2px);
}

.pronoun-option.selected {
  border-color: #4CAF50;
  background: #e8f5e8;
  color: #2e7d32;
  font-weight: bold;
}

.pronoun-option.correct {
  border-color: #20B2AA;
  background: #B2DFDB;
  color: #00695C;
}

.pronoun-option.incorrect {
  border-color: #f44336;
  background: #ffcdd2;
  color: #b71c1c;
}

.pronoun-option.disabled {
  pointer-events: none;
}

/* --- 音読トレーニングメニュー --- */
.reading-training-menu {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
  gap: 24px;
  max-width: 1000px;
  margin: 0 auto;
  padding: 0 20px;
}

.reading-item {
  background: linear-gradient(135deg, #fff 0%, #f3f8ff 100%);
  border-radius: 16px;
  padding: 24px 20px;
  box-shadow: 0 4px 12px rgba(33, 150, 243, 0.15);
  border: 2px solid #e3f2fd;
  transition: all 0.3s ease;
  cursor: pointer;
  position: relative;
  overflow: hidden;
}

.reading-item:hover {
  transform: translateY(-4px);
  box-shadow: 0 8px 20px rgba(33, 150, 243, 0.25);
  border-color: #2196f3;
}

.reading-item::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 4px;
  background: linear-gradient(90deg, #2196f3, #42a5f5);
}

.reading-item.ai-item {
  box-shadow: 0 4px 12px rgba(66, 165, 245, 0.15);
  border: 2px solid #e3f2fd;
}

.reading-item.ai-item:hover {
  box-shadow: 0 8px 20px rgba(66, 165, 245, 0.25);
  border-color: #42a5f5;
}

.reading-item.ai-item::before {
  background: linear-gradient(90deg, #42a5f5, #64b5f6);
}

.reading-item-title {
  font-size: 18px;
  font-weight: bold;
  color: #1976d2;
  margin-bottom: 8px;
  display: flex;
  align-items: center;
  gap: 8px;
}

.reading-item.ai-item .reading-item-title {
  color: #1976d2;
}

.reading-item-level {
  font-size: 14px;
  color: #42a5f5;
  margin-bottom: 12px;
  display: flex;
  align-items: center;
  gap: 4px;
}

.reading-item.ai-item .reading-item-level {
  color: #64b5f6;
}

.reading-item-description {
  font-size: 14px;
  color: #666;
  line-height: 1.5;
  margin-bottom: 16px;
}

.reading-item-status {
  display: flex;
  justify-content: space-between;
  align-items: center;
  font-size: 12px;
  color: #888;
}

.reading-item-badge {
  background: #2196f3;
  color: white;
  padding: 4px 8px;
  border-radius: 12px;
  font-size: 10px;
  font-weight: bold;
}

.reading-item.ai-item .reading-item-badge {
  background: #42a5f5;
}

/* --- 文法トレーニングメニュー --- */
.grammar-menu {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
  gap: 20px;
  max-width: 1000px;
  margin: 0 auto;
  padding: 0 20px;
}

/* --- 問題画面共通ヘッダー --- */
.problem-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 16px 20px;
  margin-bottom: 20px;
}

.problem-header-title {
  font-size: 18px;
  font-weight: bold;
  color: #2c3e50;
}

.problem-header-progress {
  font-size: 16px;
  font-weight: bold;
  color: #666;
}

.grammar-item {
  background: #ffffff !important;
  border-radius: 12px !important;
  padding: 24px !important;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08) !important;
  border: 1px solid #e5e7eb !important;
  transition: all 0.2s ease !important;
  cursor: pointer !important;
  position: relative !important;
  overflow: visible !important;
}

.grammar-item::before {
  display: none !important;
  content: none !important;
}

.grammar-item::after {
  display: none !important;
  content: none !important;
}

.grammar-item:hover {
  box-shadow: 0 4px 16px rgba(0, 0, 0, 0.12) !important;
  border-color: #ea580c !important;
  transform: none !important;
  background: #ffffff !important;
}

.grammar-item:hover::before {
  display: none !important;
  content: none !important;
}

.grammar-item:hover::after {
  display: none !important;
  content: none !important;
}

.grammar-item-title {
  font-size: 18px !important;
  font-weight: 600 !important;
  color: #1f2937 !important;
  margin-bottom: 8px !important;
  display: flex !important;
  align-items: center !important;
  gap: 8px !important;
}



.grammar-item-progress {
  margin-bottom: 16px;
  display: flex;
  align-items: center;
  gap: 12px;
  width: 100%;
}

.progress-text {
  font-size: 12px;
  color: #6b7280;
  font-weight: 500;
  white-space: nowrap;
  flex-shrink: 0;
}

.progress-numbers {
  font-size: 12px;
  color: #374151;
  font-weight: 600;
  white-space: nowrap;
  flex-shrink: 0;
  min-width: 50px;
  background: #f9fafb;
  padding: 4px 8px;
  border-radius: 6px;
  border: 1px solid #e5e7eb;
  text-align: center;
}

.progress-numbers.high-progress {
  background: #fef3f2;
  color: #ea580c;
  border-color: #fed7aa;
}

.progress-numbers.medium-progress {
  background: #eff6ff;
  color: #2563eb;
  border-color: #dbeafe;
}

.progress-numbers.low-progress {
  background: #f9fafb;
  color: #6b7280;
  border-color: #e5e7eb;
}

.progress-bar {
  flex: 1;
  height: 8px;
  background: #f3f4f6;
  border-radius: 4px;
  overflow: hidden;
  position: relative;
}

.progress-fill {
  height: 100%;
  background: #ea580c;
  border-radius: 4px;
  transition: width 0.3s ease;
  min-width: 2px;
  position: relative;
}

/* 0%進捗の特別なスタイル */
.progress-fill.empty {
  background: transparent;
}

.grammar-item-description {
  font-size: 14px;
  color: #6b7280;
  line-height: 1.6;
  margin-bottom: 16px;
}

/* --- 文章タップ問題のスタイル --- */
.sentence-tap-container {
  max-width: 800px;
  margin: 0 auto;
  padding: 20px;
}

.sentence-tap-text {
  font-size: 20px;
  line-height: 2;
  margin-bottom: 32px;
  padding: 24px;
  background: #ffffff;
  border-radius: 12px;
  border: 2px solid #e0e0e0;
  font-family: 'UD Digi Kyokasho N-R', 'UD デジタル 教科書体 N-R', 'Klee', 'HiraMinProN-W3', serif;
}

.sentence-tap-text p {
  margin: 0 0 16px 0;
  cursor: pointer;
  padding: 8px 12px;
  border-radius: 8px;
  transition: all 0.3s ease;
  border: 2px solid transparent;
}

.sentence-tap-text p:hover {
  background: #f5f5f5;
  border-color: #ccc;
}

.sentence-tap-text p.claim {
  background: #ffebee;
  border-color: #f44336;
  color: #d32f2f;
  font-weight: bold;
}

.sentence-tap-text p.concrete {
  background: #e3f2fd;
  border-color: #2196f3;
  color: #1976d2;
  font-weight: bold;
}

.sentence-tap-text p.claim:hover {
  background: #ffcdd2;
  border-color: #f44336;
}

.sentence-tap-text p.concrete:hover {
  background: #bbdefb;
  border-color: #2196f3;
}

.sentence-tap-instructions {
  background: #f8f9fa;
  border: 1px solid #dee2e6;
  border-radius: 8px;
  padding: 16px;
  margin-bottom: 24px;
  font-size: 14px;
  color: #495057;
  text-align: center;
}

.sentence-tap-legend {
  display: flex;
  justify-content: center;
  gap: 32px;
  margin-bottom: 24px;
  flex-wrap: wrap;
}

.legend-item {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 14px;
  color: #666;
}

.legend-color {
  width: 20px;
  height: 20px;
  border-radius: 4px;
  border: 2px solid;
}

.legend-color.claim {
  background: #ffebee;
  border-color: #f44336;
}

.legend-color.concrete {
  background: #e3f2fd;
  border-color: #2196f3;
}

.grammar-item-status {
  display: flex;
  justify-content: space-between;
  align-items: center;
  font-size: 12px;
  color: #888;
}

.grammar-item-badge {
  background: #16a34a;
  color: white;
  padding: 4px 8px;
  border-radius: 12px;
  font-size: 10px;
  font-weight: bold;
}

.grammar-item-badge.coming-soon {
  background: #22c55e;
}

.grammar-item-badge.locked {
  background: #757575;
}

/* --- 文法トレーニング下位メニュー --- */
.grammar-submenu {
  display: flex;
  flex-wrap: wrap;
  justify-content: center;
  gap: 20px;
  max-width: 1000px;
  margin: 0 auto;
  padding: 0 20px;
}

.grammar-submenu-item {
  width: 140px;
  height: 140px;
  background: #ffffff;
  border-radius: 12px;
  cursor: pointer;
  position: relative;
  transition: all 0.2s ease;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  text-align: center;
  padding: 16px;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
  border: 1px solid #e5e7eb;
}

/* レベル別の色分け */
.grammar-submenu-item[data-level="intro"] {
  background: #ffffff;
  border-left: 4px solid #ea580c;
  color: #1f2937;
}

.grammar-submenu-item[data-level="basic"] {
  background: #ffffff;
  border-left: 4px solid #2563eb;
  color: #1f2937;
}

.grammar-submenu-item[data-level="advanced"] {
  background: #ffffff;
  border-left: 4px solid #f59e0b;
  color: #1f2937;
}

.grammar-submenu-item[data-level="expert"] {
  background: #ffffff;
  border-left: 4px solid #ec4899;
  color: #1f2937;
}

.grammar-submenu-item[data-level="exam"] {
  background: #ffffff;
  border-left: 4px solid #8b5cf6;
  color: #1f2937;
}

.grammar-submenu-item:hover {
  box-shadow: 0 4px 16px rgba(0, 0, 0, 0.12);
  transform: translateY(-2px);
}

.grammar-submenu-item-icon {
  font-size: 28px;
  margin-bottom: 8px;
  display: block;
  animation: bounce 2s infinite;
}



.grammar-submenu-item-title {
  font-size: 13px;
  font-weight: bold;
  margin-bottom: 4px;
  line-height: 1.2;
  text-shadow: 0 1px 2px rgba(0,0,0,0.2);
}

.grammar-submenu-item-description {
  font-size: 10px;
  line-height: 1.3;
  opacity: 0.9;
  text-shadow: 0 1px 2px rgba(0,0,0,0.2);
}

/* レベル別アイコンの装飾 */
.grammar-submenu-item[data-level="intro"] .grammar-submenu-item-icon::after {
  content: '';
  position: absolute;
  top: -5px;
  right: -5px;
  font-size: 14px;
}

.grammar-submenu-item[data-level="basic"] .grammar-submenu-item-icon::after {
  content: '';
  position: absolute;
  top: -5px;
  right: -5px;
  font-size: 14px;
}

.grammar-submenu-item[data-level="advanced"] .grammar-submenu-item-icon::after {
  content: '';
  position: absolute;
  top: -5px;
  right: -5px;
  font-size: 14px;
}

.grammar-submenu-item[data-level="expert"] .grammar-submenu-item-icon::after {
  content: '';
  position: absolute;
  top: -5px;
  right: -5px;
  font-size: 14px;
}

.grammar-submenu-item[data-level="exam"] .grammar-submenu-item-icon::after {
  content: '';
  position: absolute;
  top: -5px;
  right: -5px;
  font-size: 14px;
}

/* 完了済みアイテムのスタイル */
.grammar-submenu-item.completed {
  background: linear-gradient(135deg, #20B2AA 0%, #48D1CC 100%);
  border-color: #00695C;
}

.grammar-submenu-item.completed .grammar-submenu-item-icon::after {
  content: '';
}

/* ロックされたアイテム */
.grammar-submenu-item.locked {
  background: linear-gradient(135deg, #B0BEC5 0%, #CFD8DC 100%);
  border-color: #78909C;
  color: #546E7A;
  cursor: not-allowed;
}

.grammar-submenu-item.locked .grammar-submenu-item-icon::after {
  content: '';
}

.grammar-submenu-item.locked:hover {
  transform: none;
  box-shadow: 0 8px 32px rgba(0,0,0,0.12);
}

.grammar-submenu-item-badge {
  position: absolute;
  top: -8px;
  right: -8px;
  background: #FF5722;
  color: white;
  border-radius: 50%;
  width: 24px;
  height: 24px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 10px;
  font-weight: bold;
  border: 2px solid white;
  box-shadow: 0 2px 8px rgba(0,0,0,0.2);
}

.grammar-submenu-item-badge.coming-soon {
  background: #ffa726;
}

.grammar-submenu-item-badge.locked {
  background: #757575;
}

/* --- 漢字・語彙トレーニングメニュー --- */
.kanji-vocab-menu {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
  gap: 24px;
  max-width: 1000px;
  margin: 0 auto;
  padding: 0 20px;
}

.kanji-vocab-item {
  background: linear-gradient(135deg, #fff 0%, #faf4ff 100%);
  border-radius: 16px;
  padding: 24px 20px;
  box-shadow: 0 4px 12px rgba(156, 39, 176, 0.15);
  border: 2px solid #e1bee7;
  transition: all 0.3s ease;
  cursor: pointer;
  position: relative;
  overflow: hidden;
}

.kanji-vocab-item:hover {
  transform: translateY(-4px);
  box-shadow: 0 8px 20px rgba(156, 39, 176, 0.25);
  border-color: #9C27B0;
}

.kanji-vocab-item::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 4px;
  background: linear-gradient(90deg, #9C27B0, #AB47BC);
}

.kanji-vocab-item-title {
  font-size: 18px;
  font-weight: bold;
  color: #7B1FA2;
  margin-bottom: 8px;
  display: flex;
  align-items: center;
  gap: 8px;
}



.kanji-vocab-item-level {
  font-size: 14px;
  color: #AB47BC;
  margin-bottom: 12px;
  display: flex;
  align-items: center;
  gap: 4px;
}

.kanji-vocab-item-description {
  font-size: 14px;
  color: #666;
  line-height: 1.5;
  margin-bottom: 16px;
}

.kanji-vocab-item-badge {
  background: #9C27B0;
  color: white;
  padding: 4px 8px;
  border-radius: 12px;
  font-size: 10px;
  font-weight: bold;
}

/* --- 漢字・語彙問題画面 --- */
.kanji-vocab-problem {
  max-width: 800px;
  margin: 0 auto;
  padding: 24px;
  background: #fff;
  border-radius: 16px;
  box-shadow: 0 4px 12px rgba(156, 39, 176, 0.1);
}

.kanji-meaning {
  font-size: 24px;
  color: #7B1FA2;
  text-align: center;
  margin-bottom: 32px;
  padding: 20px;
  background: #f3e5f5;
  border-radius: 12px;
  border: 2px solid #e1bee7;
  font-weight: bold;
}

.kanji-choices {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 16px;
  margin-bottom: 32px;
}

.kanji-choice {
  background: #fff;
  border: 3px solid #e1bee7;
  border-radius: 12px;
  padding: 20px;
  font-size: 40px;
  font-weight: bold;
  color: #000000;
  font-family: 'Tsukushi Mincho', 'Yu Mincho', 'YuMincho', 'MS Mincho', serif;
  text-align: center;
  cursor: pointer;
  transition: all 0.3s ease;
  min-height: 80px;
  display: flex;
  align-items: center;
  justify-content: center;
}

.kanji-choice:hover {
  background: #f3e5f5;
  border-color: #9C27B0;
  transform: translateY(-2px);
}

.kanji-choice.selected {
  background: #9C27B0;
  border-color: #7B1FA2;
  color: white;
}

.kanji-choice.correct {
  background: #20B2AA;
  border-color: #00695C;
  color: white;
}

.kanji-choice.incorrect {
  background: #f44336;
  border-color: #c62828;
  color: white;
}

.kanji-answer-area {
  background: #E0F2F1;
  border: 3px dashed #20B2AA;
  border-radius: 12px;
  padding: 24px;
  margin-bottom: 24px;
  text-align: center;
  min-height: 80px;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
}

.kanji-answer-area.has-answer {
  background: #f3e5f5;
  border-color: #9C27B0;
}

.selected-kanji {
  font-size: 44px;
  color: #000000;
  font-weight: bold;
  font-family: 'Tsukushi Mincho', 'Yu Mincho', 'YuMincho', 'MS Mincho', serif;
  margin: 0 4px;
}

.kanji-problem-controls {
  display: flex;
  justify-content: center;
  gap: 16px;
  margin-top: 24px;
}

.kanji-btn {
  background: #87CEEB;
  color: white;
  border: none;
  border-radius: 25px;
  padding: 12px 32px;
  font-size: 16px;
  font-weight: bold;
  cursor: pointer;
  transition: all 0.3s ease;

}

.kanji-btn:hover {
  background: #6CB4D8;
  transform: translateY(-2px);
}

/* 答えを確認ボタン - 緑色 */
#kanjiCheckBtn {
  background: #4CAF50;
  box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);
}

#kanjiCheckBtn:hover {
  background: #45a049;
  box-shadow: 0 6px 16px rgba(76, 175, 80, 0.4);
}

/* 次の問題へボタン - 青色 */
#kanjiNextBtn {
  background: #2196F3;
  box-shadow: 0 4px 12px rgba(33, 150, 243, 0.3);
}

#kanjiNextBtn:hover {
  background: #1976D2;
  box-shadow: 0 6px 16px rgba(33, 150, 243, 0.4);
}

.kanji-feedback {
  margin-top: 24px;
  padding: 20px;
  border-radius: 12px;
  text-align: center;
  font-weight: bold;
  display: none;
}

.kanji-feedback.correct {
  background: #e0f2f1;
  color: #00695c;
  border: 2px solid #4db6ac;
}

.kanji-feedback.incorrect {
  background: #fce4ec;
  color: #880e4f;
  border: 2px solid #f06292;
}

/* 文法トレーニング問題画面のスタイル */
.grammar-option-btn {
  background: #fff3e0;
  border: 2px solid #FFB74D;
  border-radius: 12px;
  padding: 18px 24px;
  font-size: 16px;
  font-weight: 500;
  color: #e65100;
  cursor: pointer;
  transition: all 0.3s ease;
  text-align: left;
  min-height: 60px;
  display: flex;
  align-items: center;
}

.grammar-option-btn:hover {
  background: #ffcc02;
  border-color: #FF9800;
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(255, 152, 0, 0.3);
}

.grammar-option-btn.selected {
  background: #FFB74D;
  border-color: #FF9800;
  color: #fff;
}

.grammar-option-btn.correct {
  background: #B2DFDB;
  border-color: #20B2AA;
  color: #00695C;
}

.grammar-option-btn.incorrect {
  background: #ffcdd2;
  border-color: #f44336;
  color: #c62828;
}

.grammar-option-btn:disabled {
  cursor: not-allowed;
}

.grammar-next-btn, .grammar-finish-btn {
  background: #17a2b8;
  color: white;
  border: none;
  border-radius: 25px;
  padding: 12px 32px;
  font-size: 16px;
  font-weight: bold;
  cursor: pointer;
  transition: all 0.3s ease;
  box-shadow: 0 4px 12px rgba(23, 162, 184, 0.3);
}

.grammar-next-btn:hover, .grammar-finish-btn:hover {
  background: #138496;
  transform: translateY(-2px);
  box-shadow: 0 6px 16px rgba(23, 162, 184, 0.4);
}

.grammar-back-btn {
  background: #FF9800;
  color: white;
  border: none;
  border-radius: 25px;
  padding: 12px 32px;
  font-size: 16px;
  font-weight: bold;
  cursor: pointer;
  transition: all 0.3s ease;
  box-shadow: 0 4px 12px rgba(255, 152, 0, 0.3);
}

.grammar-back-btn:hover {
  background: #F57C00;
  transform: translateY(-2px);
  box-shadow: 0 6px 16px rgba(255, 152, 0, 0.4);
}

/* 主語・述語問題のスタイル */
.subject-predicate-sentence-vertical {
  writing-mode: vertical-rl;
  text-orientation: upright;
  font-size: 24px;
  line-height: 2.5;
  padding: 20px;
  font-family: 'Tsukushi Mincho', 'Yu Mincho', 'YuMincho', 'MS Mincho', serif;
  max-height: 400px; /* 最大高さを設定して複数行表示を可能に */
  overflow-wrap: break-word; /* 長い文章の改行処理 */
}

.subject-predicate-word {
  display: inline;
  padding: 6px 10px;
  margin: 1px;
  background: transparent;
  border: none;
  cursor: pointer;
  transition: all 0.3s ease;
  font-size: 20px;
  font-weight: 500;
  position: relative;
  vertical-align: top;
}

.subject-predicate-word:hover {
  background: #f5f5f5;
  transform: translateX(-3px);
}

.subject-predicate-word.selected-predicate {
  background: #e3f2fd !important;
  color: #0d47a1 !important;
  border-right: 4px solid #1976d2 !important;
  padding-right: 6px !important;
}

.subject-predicate-word.selected-subject {
  background: #ffebee !important;
  color: #c62828 !important;
  border: 3px solid #d32f2f !important;
  border-radius: 6px !important;
  padding: 3px 7px !important;
}

.subject-predicate-word.correct {
  background: #20B2AA !important;
  color: white !important;
  border-color: #00695C !important;
}

.subject-predicate-word.incorrect {
  background: #f44336 !important;
  color: white !important;
  border-color: #d32f2f !important;
}

.subject-predicate-word.disabled {
  cursor: not-allowed;
}

/* 修飾語問題のスタイル */
.modifier-sentence-vertical {
  writing-mode: vertical-rl;
  text-orientation: upright;
  font-size: 24px;
  line-height: 1.8;
  padding: 20px;
  font-family: 'Tsukushi Mincho', 'Yu Mincho', 'YuMincho', 'MS Mincho', serif;
}

/* 文の構造問題のスタイル */
.sentence-structure-diagram {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 20px;
  padding: 20px;
  max-width: 700px;
  margin: 0 auto;
}

.sentence-structure-row {
  display: flex;
  align-items: center;
  gap: 20px;
  width: 100%;
  justify-content: center;
}

.structure-box {
  border: 2px solid #ccc;
  border-radius: 8px;
  padding: 12px 20px;
  min-width: 120px;
  min-height: 50px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 16px;
  background: #f8f9fa;
  cursor: pointer;
  transition: all 0.3s ease;
  position: relative;
}

.structure-box.main-box {
  border: 4px solid #00b7f1;
  background: #e6f8ff;
  min-width: 150px;
  min-height: 60px;
  font-weight: bold;
}

.structure-box.modifier-box {
  border: 2px solid #888;
  background: #fafafa;
}

.structure-box:hover {
  transform: scale(1.05);
  box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.structure-box.drag-over {
  background: #ffe6e6;
  border-color: #ff6b6b;
}

.structure-box.filled {
  background: #fff;
  border-color: #20B2AA;
}

.structure-box.correct {
  background: #d4edda;
  border-color: #28a745;
}

.structure-box.incorrect {
  background: #f8d7da;
  border-color: #dc3545;
}

.bunsetsu-item {
  display: inline-block;
  padding: 8px 16px;
  margin: 4px;
  background: #ffffff;
  border: 2px solid #20B2AA;
  border-radius: 6px;
  cursor: grab;
  font-size: 16px;
  transition: all 0.3s ease;
  user-select: none;
}

.bunsetsu-item:hover {
  transform: scale(1.1);
  box-shadow: 0 4px 8px rgba(0,0,0,0.2);
}

.bunsetsu-item.dragging {
  opacity: 0.5;
  cursor: grabbing;
}

.bunsetsu-container {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  justify-content: center;
  padding: 20px;
  background: #f8f9fa;
  border-radius: 8px;
  margin-bottom: 20px;
}

.structure-arrow {
  font-size: 24px;
  color: #666;
  margin: 0 10px;
}

.structure-arrow.vertical {
  writing-mode: vertical-lr;
  transform: rotate(90deg);
}

.modifier-word {
  display: inline;
  padding: 6px 10px;
  margin: 1px;
  background: transparent;
  border: none;
  cursor: pointer;
  transition: all 0.3s ease;
  font-size: 20px;
  font-weight: 500;
  position: relative;
}

.modifier-word:hover {
  background: #f5f5f5;
  transform: translateX(-3px);
}

/* 修飾語（マークされた単語）に緑の右線のみ */
.modifier-word.marked-modifier {
  cursor: default !important;
  position: relative;
}

.modifier-word.marked-modifier::after {
  content: '';
  position: absolute;
  top: 0;
  right: -2px;
  bottom: 0;
  width: 4px;
  background: #4CAF50;
}

/* 選択された修飾先 */
.modifier-word.selected-modified {
  background: #e8f5e8 !important;
  color: #2e7d32 !important;
  border: 3px solid #4CAF50 !important;
  border-radius: 6px !important;
  padding: 3px 7px !important;
}

/* 正解の修飾先 */
.modifier-word.correct-modified {
  background: #20B2AA !important;
  color: white !important;
  border: 3px solid #00695C !important;
  border-radius: 6px !important;
}

/* 不正解の修飾先 */
.modifier-word.incorrect-modified {
  background: #f44336 !important;
  color: white !important;
  border: 3px solid #d32f2f !important;
  border-radius: 6px !important;
}

.modifier-word.disabled {
  cursor: not-allowed;
}



.word-label {
  position: absolute;
  left: 100%;
  top: 50%;
  transform: translateY(-50%) scale(0.8);
  font-size: 14px;
  font-weight: bold;
  white-space: nowrap;
  z-index: 100;
  margin-left: -3px;
  writing-mode: horizontal-tb;
  text-orientation: mixed;
  text-align: center;
  opacity: 0;
  animation: labelAppear 0.3s ease-out forwards;
  display: block !important;
}

@keyframes labelAppear {
  from {
    opacity: 0;
    transform: translateY(-50%) scale(0.8);
  }
  to {
    opacity: 1;
    transform: translateY(-50%) scale(1);
  }
}

.word-label.predicate-label {
  color: #1976d2;
}

.word-label.subject-label {
  color: #d32f2f;
}

.word-label.modifier-label {
  color: #4CAF50;
}

.word-label.modified-label {
  color: #4CAF50;
}

/* 助詞カードゲームのスタイル */
.particle-card {
  background: #fff;
  color: #333;
  border: 2px solid #FF9800;
  border-radius: 6px;
  padding: 6px 10px;
  font-size: 20px;
  font-weight: bold;
  cursor: grab;
  transition: all 0.3s ease;
  user-select: none;
  width: 48px;
  height: 34px;
  text-align: center;
  font-family: "Tsukushi Mincho", "Yu Mincho", "YuMincho", "MS Mincho", serif;
  display: flex;
  align-items: center;
  justify-content: center;
  box-sizing: border-box;
  line-height: 1;
}

/* 二文字・三文字の助詞カード */
.particle-card.multi-char {
  writing-mode: vertical-rl;
  text-orientation: upright;
  padding: 6px 4px;
  width: 34px;
  height: 58px;
  line-height: 1.3;
  border: 2px solid #FF9800;
}

.particle-card:hover {
  transform: scale(1.1);
  background: #fff8f0;
}

.particle-card.dragging {
  opacity: 0.5;
  cursor: grabbing;
  transform: rotate(5deg);
}

.particle-blank {
  display: inline-block;
  width: 50px;
  height: 36px;
  border: 1px solid #666;
  border-radius: 6px;
  background: #fff;
  margin: 2px 2px;
  vertical-align: baseline;
  text-align: center;
  line-height: 34px;
  transition: all 0.3s ease;
  position: relative;
  box-sizing: border-box;
  transform: translateX(-1px);
}

/* 二文字・三文字の助詞用ドロップゾーン */
.particle-blank.multi-char {
  width: 36px;
  height: 60px;
  line-height: 1.3;
  writing-mode: vertical-rl;
  text-orientation: upright;
  display: inline-flex;
  align-items: center;
  justify-content: center;
}

.particle-blank.drag-over {
  background: #f0f0f0;
  border: 1px solid #333;
  transform: scale(1.05);
}

.particle-blank .particle-card {
  margin: 0;
  position: absolute;
  top: 1px;
  left: 1px;
  width: 48px;
  height: 34px;
  border: none;
  box-sizing: border-box;
  background: transparent;
}

/* 文節並び替え問題のスタイル */
.clause-card {
  writing-mode: vertical-rl;
  text-orientation: upright;
  background: #fff;
  border: 2px solid #FF9800;
  border-radius: 8px;
  padding: 12px 8px;
  font-size: 18px;
  font-weight: bold;
  cursor: grab;
  transition: all 0.3s ease;
  user-select: none;
  min-width: 44px;
  min-height: 60px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-family: "Tsukushi Mincho", "Yu Mincho", "YuMincho", "MS Mincho", serif;
  line-height: 1.5;
  box-shadow: 0 2px 4px rgba(255, 152, 0, 0.2);
  box-sizing: border-box;
}

/* 文字数に応じたカードサイズ */
.clause-card.char-1 {
  width: 44px;
  height: 60px;
}

.clause-card.char-2 {
  width: 44px;
  height: 80px;
}

.clause-card.char-3 {
  width: 44px;
  height: 100px;
}

.clause-card.char-4 {
  width: 44px;
  height: 120px;
}

.clause-card.char-5-plus {
  width: 44px;
  height: 140px;
}

.clause-card:hover {
  transform: translateY(-3px) scale(1.05);
  box-shadow: 0 4px 12px rgba(255, 152, 0, 0.4);
  border-color: #F57C00;
  background: #fff8f0;
}

.clause-card.dragging {
  opacity: 0.6;
  cursor: grabbing;
  transform: rotate(3deg) scale(1.1);
  z-index: 1000;
}

.clause-input-slot {
  writing-mode: vertical-rl;
  text-orientation: upright;
  width: 44px;
  height: 80px;
  border: 2px dashed #ccc;
  border-radius: 8px;
  background: #f9f9f9;
  display: flex;
  align-items: center;
  justify-content: center;
  font-family: "Tsukushi Mincho", "Yu Mincho", "YuMincho", "MS Mincho", serif;
  font-size: 18px;
  font-weight: bold;
  transition: all 0.3s ease;
  position: relative;
  box-sizing: border-box;
}

/* 文字数に応じた入力スロットサイズ */
.clause-input-slot.char-1 {
  width: 44px;
  height: 60px;
}

.clause-input-slot.char-2 {
  width: 44px;
  height: 80px;
}

.clause-input-slot.char-3 {
  width: 44px;
  height: 100px;
}

.clause-input-slot.char-4 {
  width: 44px;
  height: 120px;
}

.clause-input-slot.char-5-plus {
  width: 44px;
  height: 140px;
}

.clause-input-slot.drag-over {
  background: #e8f5e8;
  border-color: #4CAF50;
  border-style: solid;
  transform: scale(1.05);
}

.clause-input-slot.filled {
  background: transparent;
  border-color: #666;
  border-style: solid;
  padding: 0;
}

.clause-input-slot .clause-card {
  margin: 0;
  border: none;
  background: transparent;
  cursor: pointer;
  border-radius: 8px;
  box-shadow: none;
  transition: all 0.2s ease;
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  padding: 12px 8px;
  box-sizing: border-box;
}

.clause-input-slot.correct {
  background: #e0f2f1;
  border-color: #20B2AA;
}

.clause-input-slot.correct .clause-card {
  background: #20B2AA !important;
  color: white !important;
  border: 3px solid #00695C !important;
  transform: scale(1.1) !important;
  z-index: 10 !important;
}

.clause-input-slot.incorrect {
  background: #ffebee;
  border-color: #DC143C;
}

.clause-input-slot.incorrect .clause-card {
  background: #DC143C !important;
  color: white !important;
  border: 3px solid #B22222 !important;
  transform: scale(1.1) !important;
  z-index: 10 !important;
}

/* 入力スロット内のカードは自動的にスロットサイズに合わせる */

.clause-input-slot .clause-card:hover {
  transform: scale(1.02);
  box-shadow: 0 3px 8px rgba(76, 175, 80, 0.4);
}



/* 文節並び替え問題のレスポンシブ対応 */
@media (max-width: 768px) {
  .clause-problem-area {
    flex-direction: column !important;
    gap: 24px !important;
    max-width: 90% !important;
  }
  
  .clause-cards-area, .clause-input-area {
    max-width: 100% !important;
  }
  
  #clauseCards, #clauseInputSlots {
    min-height: 200px !important;
    padding: 16px !important;
  }
}

.particle-blank .particle-card.multi-char {
  padding: 6px 4px;
  font-size: 18px;
  line-height: 1.3;
  display: flex;
  align-items: center;
  justify-content: center;
  box-sizing: border-box;
  border-radius: 6px;
  background: transparent;
  writing-mode: vertical-rl;
  text-orientation: upright;
  width: 34px;
  height: 58px;
  border: none;
  top: 1px;
  left: 1px;
}

/* 二文字・三文字の助詞カードがドロップゾーンに配置された時 */
.particle-blank.multi-char .particle-card {
  width: 34px;
  height: 58px;
  writing-mode: vertical-rl;
  text-orientation: upright;
  line-height: 1.3;
  padding: 6px 4px;
  border: none;
  box-sizing: border-box;
  top: 1px;
  left: 1px;
}

/* 文節分けキャンバスのスタイル */
#clauseCanvas {
  max-width: 100%;
  height: auto;
  touch-action: none; /* タッチスクロールを無効化 */
}

@media (max-width: 768px) {
  #clauseCanvas {
    width: 80vw;
    height: 100vw;
    max-height: 650px;
  }
  
  .clause-controls {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    justify-content: center;
  }
  
  .clause-controls button {
    flex: 1;
    min-width: 120px;
    margin: 4px;
  }
}

@media (max-width: 768px) {
  .reading-training-menu {
    grid-template-columns: 1fr;
    padding: 0 16px;
  }
  
  .reading-item {
    padding: 20px 16px;
  }
  
  .logic-menu {
    grid-template-columns: 1fr;
    padding: 0 16px;
  }
  
  .logic-item {
    padding: 20px 16px;
  }
  
  .grammar-menu {
    grid-template-columns: 1fr;
    padding: 0 16px;
  }
  
  .grammar-item {
    padding: 20px 16px;
  }
}

/* --- 具体と抽象ゲーム --- */
.concrete-abstract-game {
  display: flex;
  flex-direction: row-reverse;
  gap: 40px;
  max-width: 1200px;
  margin: 0 auto;
  padding: 20px;
}

/* --- 発展編専用スタイル --- */
.advanced-content {
  display: flex;
  flex-direction: row-reverse;
  gap: 40px;
  max-width: 1200px;
  margin: 0 auto;
  padding: 20px;
}

.text-section {
  flex: 1;
}

.reading-text {
  background: #fff;
  border-radius: 12px;
  padding: 24px;
  line-height: 1.6;
  font-size: 20px;
  color: #2c3e50;
  border: 2px solid #e9ecef;
  height: 320px;
  max-height: 320px;
  overflow-y: auto;
  writing-mode: vertical-rl;
  text-orientation: upright;
  font-family: 'Tsukushi Mincho', 'Yu Mincho', 'YuMincho', 'MS Mincho', serif;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.diagram-section {
  flex: 1;
  display: flex;
  justify-content: center;
  align-items: flex-start;
}

.hierarchy-diagram-advanced {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 0;
  width: 100%;
  max-width: 480px;
  margin: 0 auto;
  position: relative;
  min-height: 320px;
  padding: 15px;
}

.abstract-level-advanced {
  display: flex;
  justify-content: center;
  width: 100%;
  margin-bottom: 40px;
  z-index: 10;
  position: relative;
}

.abstract-box-advanced {
  background: #fff;
  border: 3px solid #20B2AA;
  border-radius: 8px;
  padding: 8px 12px;
  text-align: center;
  width: 90px;
  min-height: 120px;
  box-shadow: 0 4px 12px rgba(32, 178, 170, 0.25);
  z-index: 10;
  position: relative;
}

.middle-level-advanced {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 10px;
  width: 100%;
  margin-bottom: 40px;
  z-index: 10;
  position: relative;
}

.middle-boxes-advanced {
  display: flex;
  gap: 40px;
  justify-content: center;
  width: 100%;
}

.middle-box-advanced {
  background: #fff;
  border: 3px solid #FF9800;
  border-radius: 8px;
  padding: 8px 12px;
  text-align: center;
  width: 75px;
  min-height: 110px;
  box-shadow: 0 4px 12px rgba(255, 152, 0, 0.25);
  z-index: 10;
  position: relative;
}

.middle-level-advanced > .label {
  font-size: 14px;
  color: #FF9800;
  font-weight: bold;
  margin-bottom: 8px;
}

.concrete-level-advanced {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 10px;
  width: 100%;
  z-index: 10;
  position: relative;
}

.concrete-boxes-advanced {
  display: flex;
  gap: 15px;
  justify-content: center;
  width: 100%;
  position: relative;
}

.concrete-box-advanced {
  background: #fff;
  border: 3px solid #757575;
  border-radius: 8px;
  padding: 8px 10px;
  text-align: center;
  width: 70px;
  min-height: 100px;
  box-shadow: 0 4px 12px rgba(117, 117, 117, 0.25);
  z-index: 10;
  position: relative;
}

.answer-input {
  width: 100%;
  height: 80px;
  border: none;
  background: rgba(255, 255, 255, 0.8);
  font-size: 14px;
  text-align: center;
  outline: none;
  padding: 8px 6px;
  color: #2c3e50;
  font-weight: bold;
  border-radius: 6px;
  transition: background-color 0.2s ease;
  writing-mode: vertical-rl;
  text-orientation: upright;
  font-family: 'Tsukushi Mincho', 'Yu Mincho', 'YuMincho', 'MS Mincho', serif;
  resize: none;
  box-sizing: border-box;
}

.answer-input:focus {
  background: rgba(255, 255, 255, 0.95);
  box-shadow: inset 0 0 0 2px rgba(0, 123, 255, 0.3);
}

.answer-input::placeholder {
  color: #888;
  font-weight: normal;
  font-size: 13px;
}

.abstract-box-advanced .label {
  display: block;
  font-size: 14px;
  color: #4CAF50;
  font-weight: bold;
  margin-bottom: 8px;
}

.concrete-level-advanced > .label {
  font-size: 14px;
  color: #757575;
  font-weight: bold;
  margin-bottom: 8px;
}

/* レスポンシブ対応 */
@media (max-width: 768px) {
  .advanced-content {
    flex-direction: column;
    gap: 24px;
  }
  
  .hierarchy-diagram-advanced {
    max-width: 350px;
    transform: scale(0.85);
  }
  
  .middle-boxes-advanced {
    gap: 25px;
  }
  
  .concrete-boxes-advanced {
    gap: 10px;
  }
  
  .concrete-box-advanced {
    width: 60px;
    min-height: 90px;
  }
  
  .middle-box-advanced {
    width: 65px;
    min-height: 100px;
  }
  
  .abstract-box-advanced {
    width: 75px;
    min-height: 110px;
  }
  
  .answer-input {
    height: 70px;
    font-size: 13px;
    padding: 6px 4px;
  }
}

.word-bank {
  flex: 0 0 180px;
  background: #f8f9fa;
  border-radius: 12px;
  padding: 16px;
  border: 2px solid #e9ecef;
}

.word-bank h3 {
  margin: 0 0 16px 0;
  color: #4CAF50;
  font-size: 16px;
  text-align: center;
}

.word-cards {
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.word-card {
  background: #fff;
  border: 2px solid #4CAF50;
  border-radius: 8px;
  padding: 10px;
  text-align: center;
  font-weight: normal;
  color: #2e7d32;
  cursor: grab;
  transition: all 0.3s ease;
  user-select: none;
  font-size: 14px;
}

/* 抽象エリアに配置された時の青色スタイル */
.word-card.in-abstract, .sentence-card.in-abstract {
  background: #e3f2fd;
  border: 2px solid #2196F3;
  color: #1565c0;
}

/* 具体エリアに配置された時のグレー色スタイル */
.word-card.in-concrete, .sentence-card.in-concrete {
  background: #f5f5f5;
  border: 2px solid #757575;
  color: #424242;
}

.word-card:hover {
  transform: scale(1.05);
  box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);
}

.word-card.dragging {
  opacity: 0.5;
  cursor: grabbing;
  transform: rotate(5deg);
}

/* 文カード用のスタイル（応用編のときに使用） */
.sentence-card {
  background: #fff;
  border: 2px solid #4CAF50;
  border-radius: 8px;
  padding: 10px 12px;
  text-align: left;
  font-weight: normal;
  color: #2e7d32;
  cursor: grab;
  transition: all 0.3s ease;
  user-select: none;
  width: 100%;
  max-width: 160px;
  line-height: 1.3;
  font-size: 13px;
  min-height: 45px;
  display: flex;
  align-items: center;
  box-sizing: border-box;
}

.sentence-card:hover {
  transform: scale(1.02);
  box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);
}

.sentence-card.dragging {
  opacity: 0.5;
  cursor: grabbing;
    transform: rotate(2deg);
}

/* 文章レベル用のレイアウト調整 */
.sentence-mode .word-bank {
  flex: 0 0 280px;
}

.sentence-mode .word-cards {
  display: grid;
  grid-template-columns: 1fr;
  gap: 8px;
  justify-items: stretch;
}

.sentence-mode .abstract-box {
  min-width: 220px;
  min-height: 70px;
}

.sentence-mode .concrete-box {
  min-width: 160px;
  min-height: 70px;
}

.sentence-mode .drop-zone {
  min-height: 60px;
  padding: 6px;
}

.sentence-mode .drop-zone .sentence-card {
  margin: 0;
  width: 100%;
  box-sizing: border-box;
}

.hierarchy-diagram {
  flex: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 30px;
}

.abstract-level {
  display: flex;
  justify-content: center;
}

.abstract-box {
  position: relative;
  background: #e3f2fd;
  border: 3px solid #2196f3;
  border-radius: 12px;
  padding: 16px;
  min-width: 160px;
  text-align: center;
}

.abstract-box .label {
  font-size: 14px;
  color: #1565c0;
  font-weight: bold;
  display: block;
  margin-bottom: 8px;
}

.concrete-level {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 16px;
}

.concrete-level > .label {
  font-size: 14px;
  color: #757575;
  font-weight: bold;
}

.concrete-boxes {
  display: flex;
  gap: 20px;
}

.concrete-box {
  position: relative;
  background: #f5f5f5;
  border: 3px solid #757575;
  border-radius: 12px;
  padding: 16px;
  min-width: 120px;
  min-height: 60px;
  text-align: center;
}

.drop-zone {
  min-height: 50px;
  border-radius: 8px;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.3s ease;
}

.drop-zone.drag-over {
  background: rgba(76, 175, 80, 0.2);
  border: 2px dashed #4CAF50;
}

.drop-zone .word-card {
  margin: 0;
  cursor: grab;
}

.drop-zone .sentence-card {
  margin: 0;
  cursor: grab;
  width: 100%;
  box-sizing: border-box;
}

.logic-check-btn, .logic-reset-btn {
  padding: 12px 24px;
  margin: 0 8px;
  border: none;
  border-radius: 8px;
  font-size: 16px;
  font-weight: bold;
  cursor: pointer;
  transition: all 0.3s ease;
}

.logic-check-btn {
  background: #20B2AA;
  color: white;
}

.logic-check-btn:hover {
  background: #1a8f8a;
}

.logic-reset-btn:hover {
  background: #f57c00;
}

.game-result {
  margin-top: 20px;
  padding: 16px;
  border-radius: 8px;
  text-align: center;
  font-weight: bold;
}

.game-result.correct {
  background: #e8f5e9;
  color: #2e7d32;
  border: 2px solid #4CAF50;
}

.game-result.incorrect {
  background: #ffebee;
  color: #c62828;
  border: 2px solid #f44336;
}

@media (max-width: 768px) {
  .concrete-abstract-game {
    flex-direction: column;
    gap: 20px;
    padding: 16px;
  }
  
  .word-bank {
    flex: none;
  }
  
  .word-cards {
    flex-direction: row;
    flex-wrap: wrap;
    gap: 8px;
  }
  
  .sentence-mode .word-cards {
    grid-template-columns: 1fr;
    gap: 6px;
  }
  
  .sentence-mode .word-bank {
    flex: 0 0 240px;
  }
  
  .sentence-card {
    max-width: 140px;
    font-size: 12px;
    padding: 8px 10px;
    min-height: 40px;
  }
  
  .concrete-boxes {
    flex-direction: column;
    gap: 12px;
  }
}

.shop-btn {
  background: linear-gradient(90deg, #f7b42c 50%, #f75c2c 100%);
  color: #fff;
  width: 30%;
  font-weight: bold;
  border: none;
  border-radius: 20px;
  padding: 12px 28px;
  font-size: 17px;
  box-shadow: 0 4px 16px #ffd68035;
  margin-top: 8px;
  cursor: pointer;
  transition: background 0.2s;
}

.shop-btn:hover {
  background: linear-gradient(90deg, #f2994a 60%, #f2c94c 100%);
}

.shop-item-card {
  background: #fff7ee;
  border-radius: 15px;
  padding: 16px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  box-shadow: 0 2px 10px #ffd1b333;
}

.shop-item-name {
  font-size: 18px;
  font-weight: bold;
  color: #f75c2c;
}

.shop-item-price {
  font-size: 15px;
  color: #ff8c34;
  margin-right: 20px;
}

.buy-btn {
  background: #00b7f1;
  color: #fff;
  border: none;
  border-radius: 16px;
  padding: 7px 20px;
  font-size: 15px;
  font-weight: bold;
  cursor: pointer;
  box-shadow: 0 1px 4px #00b7f120;
  transition: background 0.17s;
}

.buy-btn:hover {
  background: #179de3;
}

.ai-gen-select {
  width: 100%;
  max-width: 360px;
  padding: 14px 18px;
  margin: 0 auto 18px auto;
  font-size: 18px;
  border-radius: 14px;
  border: none;
  background: #f2fbff;
  color: #1976d2;
  font-weight: bold;
  box-shadow: 0 3px 12px #cce7f955;
  transition: box-shadow 0.15s, border 0.12s;
  outline: none;
  appearance: none;
  cursor: pointer;
  box-sizing: border-box;
  display: block;
}

.ai-gen-select:focus {
  box-shadow: 0 0 0 2.5px #00b7f1cc, 0 3px 12px #cce7f955;
  background: #e1f4fb;
}

.ai-gen-select option {
  background: #fff;
  color: #1976d2;
}

.ai-gen-btn {
  margin-top: 14px;
  padding: 14px 0;
  border-radius: 13px;
  font-size: 18px;
  font-weight: bold;
  background: #1b98d7;
  color: #fff;
  border: none;
  width: 100%;
  max-width: 360px;
  box-shadow: 0 6px 20px #b3e5fc3a;
  cursor: pointer;
  transition: background 0.14s, box-shadow 0.14s, transform 0.08s;
  position: relative;
  overflow: visible;
}

.ai-gen-btn::after {
  content: '';
  position: absolute;
  left: -10px;
  top: 50%;
  transform: translateY(-50%);
  width: 100px;
  height: 100px;
  background-image: url('robot_bear.png');
  background-size: contain;
  background-repeat: no-repeat;
  pointer-events: none;
  z-index: 1;
}

.ai-gen-btn:active {
  background: #1b6094;
  box-shadow: 0 2px 8px #b3e5fc1a;
  transform: translateY(3px) scale(0.98);
}

/* --- クイズ空欄入力用 --- */
.blankInput {
  font-size: 16px;
  font-family: 'Tsukushi Mincho', 'Yu Mincho', 'YuMincho', 'MS Mincho', serif;
  text-align: center;
  margin: 0 2px;
  border-radius: 6px;
  border: 2px solid #cce7f9;
  background-color: #e6f8ff !important;
  outline: none;
  transition: border 0.2s;
  line-height: 1.2;
  padding: 4px 2px;
  writing-mode: vertical-rl;
  text-orientation: upright;
}

.blankInput:focus {
  border: 2px solid #00b7f1;
  box-shadow: 0 0 0 1px rgba(0, 183, 241, 0.2);
}

/* --- 入力欄 正解/不正解カラー --- */
.blankInput.correct {
  background-color: #e3f2fd !important;
  border-color: #00b7f1 !important;
  color: #00b7f1 !important;
}

.blankInput.wrong {
  background-color: #ffeaea !important;
  border-color: #d81b60 !important;
  color: #d81b60 !important;
}

/* --- 大きな緑の〇のスタイル --- */
.big-green-circle {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%) scale(0);
  width: 300px;
  height: 300px;
  border: 12px solid #4CAF50;
  border-radius: 50%;
  background: rgba(76, 175, 80, 0.1);
  z-index: 10000;
  display: none;
  animation: circleAppear 2s ease-out forwards;
}

@keyframes circleAppear {
  0% {
    transform: translate(-50%, -50%) scale(0);
    opacity: 0;
  }
  50% {
    transform: translate(-50%, -50%) scale(1.2);
    opacity: 1;
  }
  100% {
    transform: translate(-50%, -50%) scale(1);
    opacity: 0;
  }
}

/* --- 大きな赤い×のスタイル --- */
.big-red-cross {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%) scale(0);
  width: 300px;
  height: 300px;
  z-index: 10000;
  display: none;
  animation: crossAppear 2s ease-out forwards;
}

.big-red-cross::before,
.big-red-cross::after {
  content: '';
  position: absolute;
  top: 50%;
  left: 50%;
  width: 80%;
  height: 12px;
  background: #f44336;
  border-radius: 6px;
}

.big-red-cross::before {
  transform: translate(-50%, -50%) rotate(45deg);
}

.big-red-cross::after {
  transform: translate(-50%, -50%) rotate(-45deg);
}

@keyframes crossAppear {
  0% {
    transform: translate(-50%, -50%) scale(0);
    opacity: 0;
  }
  50% {
    transform: translate(-50%, -50%) scale(1.2);
    opacity: 1;
  }
  100% {
    transform: translate(-50%, -50%) scale(1);
    opacity: 0;
  }
}

/* スライドアニメーション */
.slide-animation-container {
  position: relative;
  overflow: hidden;
  width: 100%;
}

.problem-content {
  transition: transform 0.5s cubic-bezier(0.4, 0, 0.2, 1);
  width: 100%;
}

.problem-content.slide-out-left {
  transform: translateX(-100%);
  opacity: 0;
}

.problem-content.slide-in-right {
  transform: translateX(100%);
  opacity: 0;
}

.problem-content.slide-center {
  transform: translateX(0);
  opacity: 1;
}

/* フォーム要素 */
input{width:80%;max-width:300px;padding:12px;border:2px solid #cce7f9;border-radius:10px;font-size:15px;background:#e6f8ff}
button{width:170px;height:44px;border-radius:24px;background:#00b7f1;color:#fff;border:none;font-weight:bold;cursor:pointer}
button:hover{background:#2f74b5}

/* ダッシュボード */
.dashboard{display:flex;align-items:center;justify-content:space-between;gap:32px;background:#fff;border-radius:20px;box-shadow:0 2px 8px rgba(97,97,97,0.25);padding:18px 24px;margin-bottom:30px;width:100%;max-width:800px}
.profile{display:flex;align-items:center;gap:18px}
.avatar{width:64px;height:64px;border-radius:50%;background:#e6f8ff}
.username{font-weight:bold;font-size:18px}
.level{font-size:15px;color:#2c3e50;margin-top:4px;display:flex;align-items:center}
.level span{background:#00f160;color:white;padding:4px 12px;border-radius:10px;font-size:16px}
.stats{display:flex;gap:22px}
.stat-num{font-weight:bold;font-size:28px;color:#2c3e50;text-align:center}
.stat-label{font-size:13px;color:#888;text-align:center}
.challenge{min-width:200px}
.challenge-title{color:#2c3e50;font-size:15px;font-weight:bold}
.challenge-bar{background:#e0f7fa;border-radius:8px;height:14px;width:100%;margin:8px 0}
.challenge-progress{height:14px;background:#00b7f1;border-radius:8px 0 0 8px;transition:width 0.4s}
.challenge-desc{font-size:13px;color:#fff;background:#ff9800;border-radius:11px;padding:7px 18px;margin-top:12px;font-weight:bold;display:inline-block;letter-spacing:0.8px;box-shadow:0 2px 12px #ffd18033}

/* カードグリッド */
.cards{display:grid;grid-template-columns:repeat(3,1fr);gap:36px;justify-content:center;align-items:flex-end;margin:38px 0 0 0;max-width:1000px;margin-left:auto;margin-right:auto}
@media(max-width:768px){.cards{grid-template-columns:repeat(2,1fr)}}
@media(max-width:480px){.cards{grid-template-columns:1fr}}

.card{width:220px;min-height:320px;max-height:320px;background:linear-gradient(110deg,#fff 70%,#e3f2fd 100%);border-radius:4px 8px 8px 4px;box-shadow:0 8px 22px #b6c3d93b,9px 0 0 #eadec7,0 16px 36px #90caf94c;position:relative;display:flex;flex-direction:column;align-items:stretch;justify-content:flex-start;transition:transform 0.13s,box-shadow 0.14s}
.card:hover{transform:scale(1.045) translateY(-5px) rotate(-1deg);box-shadow:0 20px 40px #b3c7ef3a,0 10px 32px #90caf933,11px 0 0 #f2dfb9}
.card::before{content:"";position:absolute;left:-12px;top:0;bottom:0;width:20px;background:var(--spine-color,#435ba3);border-radius:4px 0 0 4px;z-index:2}

.title{font-size:15.5px;font-weight:bold;color:#17416a;margin:32px 15px 5px 20px;text-align:left;line-height:1.38;min-height:2.1em;letter-spacing:1.2px;z-index:10;position:relative}
.illustration{width:100%;height:140px;margin:0 0 8px 0;background-size:contain;background-position:center;background-repeat:no-repeat;border-radius:0 4px 4px 0}
.author{font-size:12.3px;color:#40566a;margin:0 0 3px 20px;text-align:left;z-index:10;position:relative;font-weight:500}
.meta{font-size:12px;color:#8499b0;margin-left:20px;margin-bottom:8px;text-align:left;line-height:1.32;z-index:10;position:relative}

/* ボタンスタイル */
.card-buttons{display:flex;flex-direction:column;gap:4px;margin:0 15px 12px 20px}
.small-buttons{display:flex;gap:4px;margin-top:4px}
.start-btn,.small-btn,.audio-btn{border:none;border-radius:6px;font-size:12px;font-weight:bold;margin:0;padding:3px;cursor:pointer;transition:background 0.16s;z-index:10;position:relative;display:flex;align-items:center;justify-content:center}
.start-btn{background:#007bb8;color:#fff;width:100%;height:40px}
.start-btn:hover{background:#113f76}
.small-btn{background:#4CAF50;color:#fff;width:50%;height:25px}
.small-btn:hover{background:#388E3C}
.audio-btn{background:#FF9800;color:#fff;width:50%;height:25px}
.audio-btn:hover{background:#F57C00}

/* テキスト表示・読書エリア */
#textDisplay{position:relative;writing-mode:vertical-rl;text-orientation:upright;height:60vh;width:760px;margin:0 auto;padding:18px;font-family:"Tsukushi Mincho","Yu Mincho","YuMincho","MS Mincho",serif;font-size:19px;line-height:2;border-radius:12px;background:#fff;border:none;color:#2c3e50;overflow:hidden}
#textDisplay ruby{ruby-position:over}
.page-info{position:absolute;left:8px;bottom:6px;font-size:12px;color:#666}
.highlight{background:#b3e5fc;border-radius:4px}
.progress-container{position:relative;width:100%;height:18px;background:#fff;border-radius:12px;margin-top:8px}
.progress-bar{position:absolute;right:0;top:0;height:100%;width:0%;background:#00b7f1;transition:width .3s;border-radius:12px}
.progress-text{text-align:left;font-size:13px;margin-top:5px;color:#333}

/* アニメーション */
.success-animation-container{position:fixed;top:0;left:0;width:100vw;height:100vh;pointer-events:none;z-index:9999;display:none}
.success-main-message{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);color:#20B2AA;font-size:4rem;font-weight:bold;text-align:center;opacity:0;animation:successPop 0.8s cubic-bezier(0.68,-0.55,0.265,1.55) forwards}
@keyframes successPop{0%{opacity:0;transform:translate(-50%,-50%) scale(0.3) rotate(-10deg)}50%{transform:translate(-50%,-50%) scale(1.1) rotate(5deg)}100%{opacity:1;transform:translate(-50%,-50%) scale(1) rotate(0deg)}}

/* クイズ・オーバーレイ */
#quizOverlay{position:fixed;inset:0;display:none;z-index:3000;background:rgba(0,0,0,.55);backdrop-filter:blur(2px);align-items:center;justify-content:center}
.quiz-box{width:90%;max-width:700px;max-height:80vh;background:#fff;border-radius:14px;padding:24px;box-shadow:0 6px 20px rgba(0,0,0,.25);overflow-y:auto}
.quiz-box h3{margin:0 0 18px;font-size:20px;font-weight:bold;color:#2563eb;text-align:center}
#quizList{list-style:none;margin:12px 0;padding:0;display:flex;flex-direction:column;gap:10px}
#quizList li{display:flex;align-items:center;gap:10px;padding:10px;border:1px solid #cce7f9;border-radius:8px;cursor:pointer;background:#fff;position:relative}
#quizList li:hover{background:#d8f1ff}

/* 宝箱・カレンダー */
#treasureBox{position:fixed;right:40px;bottom:40px;z-index:3000;width:100px;height:72px;display:flex;align-items:center;justify-content:center;gap:8px}
#diamondCount{background:#fff8;border-radius:12px;padding:2px 8px;font-size:19px;color:#2563eb;font-weight:bold;margin-right:2px}
.calendar{display:grid;grid-template-columns:repeat(7,40px);gap:8px;justify-content:center}
.cal-day{width:40px;height:40px;font-size:14px;color:#666;border:1px solid #fff;border-radius:6px;display:flex;align-items:center;justify-content:center;background:#def8ff}
.cal-day.stamp{background:#b3e5fc!important;border:none;position:relative}

/* レスポンシブ */
@media(max-width:768px){
  .success-main-message{font-size:2.5rem}
  #treasureBox{right:10px;bottom:10px;width:54px;height:54px}
  #diamondCount{font-size:15px;padding:2px 6px}
}

.card {
  width: 220px;
  min-height: 320px;
  max-height: 320px;
  background: linear-gradient(110deg, #fff 70%, #e3f2fd 100%);
  border-radius: 4px 8px 8px 4px;
  box-shadow: 0 8px 22px #b6c3d93b, 9px 0 0 #eadec7, 0 16px 36px #90caf94c;
  position: relative;
  display: flex;
  flex-direction: column;
  align-items: stretch;
  justify-content: flex-start;
  transition: transform 0.13s, box-shadow 0.14s;
}

.card:hover {
  transform: scale(1.045) translateY(-5px) rotate(-1deg);
  box-shadow: 0 20px 40px #b3c7ef3a, 0 10px 32px #90caf933, 11px 0 0 #f2dfb9;
}

.title {
  font-size: 15.5px;
  font-weight: bold;
  color: #17416a;
  margin: 32px 15px 5px 20px;
  text-align: left;
  line-height: 1.38;
  min-height: 2.1em;
  letter-spacing: 1.2px;
  z-index: 10;
  position: relative;
  text-shadow: 0 1px 6px #dbe8f84e;
}

.illustration {
  width: 100%;
  height: 140px; /* 画像の高さを増やす */
  margin: 0 0 8px 0;
  background-size: contain;
  background-position: center;
  background-repeat: no-repeat;
  border-radius: 0 4px 4px 0;
}

.author {
  font-size: 12.3px;
  color: #40566a;
  margin: 0 0 3px 20px;
  text-align: left;
  z-index: 10;
  position: relative;
  font-weight: 500;
}

.meta {
  font-size: 12px;
  color: #8499b0;
  margin-left: 20px;
  margin-bottom: 8px;
  text-align: left;
  line-height: 1.32;
  z-index: 10;
  position: relative;
}

.card-buttons {
  display: flex;
  flex-direction: column;
  gap: 4px; /* ボタン間の間隔を小さく */
  margin: 0 15px 12px 20px; /* 下部のマージンを小さく */
}

.small-buttons {
  display: flex;
  gap: 4px; /* 小さいボタン間の間隔を小さく */
  margin-top: 4px; /* 上部のマージンを小さく */
}

.start-btn {
  background: #007bb8;
  color: #fff;
  border: none;
  border-radius: 6px;
  font-size: 12px;
  font-weight: bold;
  margin: 0;
  padding: 3px;
  width: 100%;
  box-shadow: 0 2px 9px #7bc8f320;
  cursor: pointer;
  transition: background 0.16s;
  z-index: 10;
  position: relative;
  letter-spacing: 0.5px;
  line-height: 1;
  height: 40px;
  display: flex;
  align-items: center;
  justify-content: center;
}

.start-btn:hover {
  background: #113f76;
  color: #fff;
}

/* 小さいボタンのスタイル */
.small-btn {
  background: #4CAF50;
  color: #fff;
  border: none;
  border-radius: 4px;
  font-size: 12px;
  font-weight: bold;
  margin: 0;
  padding: 3px;
  width: 50%;
  box-shadow: 0 2px 9px #7bc8f320;
  cursor: pointer;
  transition: background 0.16s;
  z-index: 10;
  position: relative;
  line-height: 1;
  height: 25px;
  display: flex;
  align-items: center;
  justify-content: center;
}

.small-btn:hover {
  background: #388E3C;
  color: #fff;
}

/* 音声ボタンのスタイル */
.audio-btn {
  background: #FF9800;
  color: #fff;
  border: none;
  border-radius: 4px;
  font-size: 16px;
  font-weight: bold;
  margin: 0;
  padding: 3px;
  width: 50%;
  box-shadow: 0 2px 9px #7bc8f320;
  cursor: pointer;
  transition: background 0.16s;
  z-index: 10;
  position: relative;
  display: flex;
  align-items: center;
  justify-content: center;
  line-height: 1;
  height: 25px;
}

.audio-btn:hover {
  background: #F57C00;
  color: #fff;
}

.audio-btn svg {
  width: 18px; /* アイコンサイズを大きく */
  height: 18px; /* アイコンサイズを大きく */
  fill: currentColor;
}

/* 本の背表紙の装飾 */
.card::before {
  content: "";
  position: absolute;
  left: -12px;
  top: 0;
  bottom: 0;
  width: 20px;
  background: var(--spine-color, #435ba3);
  border-radius: 4px 0 0 4px;
  z-index: 2;
}

/* 本のページの装飾 */
.card::after {
  content: "";
  position: absolute;
  left: 0;
  top: 0;
  bottom: 0;
  right: 0;
  background: linear-gradient(90deg, transparent 0%, rgba(255,255,255,0.1) 50%, transparent 100%);
  pointer-events: none;
  z-index: 1;
}

.medal-badge {position:absolute;top:-13px;left:-13px;z-index:2;display:block;width:32px;height:32px;background:none;}
/* --- AI生成UI追加 --- */
#aiGenerateBox {
  display: none;
  flex-direction: column;
  align-items: center;
  gap: 14px;
  padding: 32px 0;
  max-width: 400px;
  margin: 0 auto;
}

#aiGenerateBox select, #aiGenerateBox button {
  font-size: 17px;
  padding: 8px 14px;
  border-radius: 10px;
  border: 1px solid #cce7f9;
  margin-bottom: 8px;
}
#aiLoading {
  color: #00b7f1;
  font-size: 18px;
  text-align: center;
  margin-top: 24px;
}
#aiErr {
  color: #d81b60;
  margin-top: 10px;
}
/* --- 進捗バー --- */
#textDisplay {
  position: relative;
  writing-mode: vertical-rl;
  text-orientation: upright;
  height: 60vh;
  width: 760px;
  margin: 0 auto;
  padding: 18px;
  font-family: "Tsukushi Mincho", "Yu Mincho", "YuMincho", "MS Mincho", serif;
  font-size: 19px;
  line-height: 2;
  border-radius: 12px;
  background: #ffffff;
  border: none;
  color: #2c3e50;
  overflow: hidden;
}

.page-content {
  position: relative;
  z-index: 0;
}

#textDisplay ruby{ruby-position:over}
.page-info {position:absolute;left:8px;bottom:6px;font-size:12px;color:#666}
.highlight {background:#b3e5fc;border-radius:4px}
.progress-container {
  position: relative;
  width: 100%;
  height: 18px;
  background: #ffffff;
  border-radius: 12px;
  margin-top: 18px;
}

.progress-bar {
  position: absolute;
  right: 0;
  top: 0;
  height: 100%;
  width: 0%;
  background: #00b7f1;
  transition: width .3s;
  border-radius: 12px;
}

.progress-text {
  text-align: left;
  font-size: 13px;
  margin-top: 5px;
  color: #333;
}

.reading-label {
  position: absolute;
  background: #e4389f;
  color: #fff;
  padding: 6px 12px;
  border-radius: 8px;
  font-size: 12px;
  font-weight: bold;
  display: none;
  z-index: 2100;
  align-items: center;
  gap: 4px;
}

.eq {
  display: inline-flex;
  align-items: flex-end;
  width: 18px;
  height: 12px;
  gap: 2px;
}

.eq i {
  flex: 1;
  background: #fff;
  border-radius: 1px;
  animation: peak .8s infinite ease-in-out;
}

.eq i:nth-child(2) {
  animation-delay: -.2s;
}

.eq i:nth-child(3) {
  animation-delay: -.4s;
}

.eq i:nth-child(4) {
  animation-delay: -.6s;
}

@keyframes peak {
  0%, 100% { height: 15%; }
  40% { height: 100%; }
  60% { height: 30%; }
}

/* === 正解時の爽快アニメーション === */
.success-animation-container {
  position: fixed;
  top: 0;
  left: 0;
  width: 100vw;
  height: 100vh;
  pointer-events: none;
  z-index: 9999;
  display: none;
}

.success-main-message {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  color: #20B2AA;
  font-size: 4rem;
  font-weight: bold;
  text-align: center;
  opacity: 0;
  animation: successPop 0.8s cubic-bezier(0.68, -0.55, 0.265, 1.55) forwards;
  text-shadow: 
    0 0 5px rgba(255, 255, 255, 1),
    0 0 5px rgba(255, 255, 255, 1),
    0 0 5px rgba(255, 255, 255, 1),
    0 0 5px rgba(255, 255, 255, 1),
    0 0 5px rgba(255, 255, 255, 1),
    0 0 5px rgba(255, 255, 255, 1),
    2px 2px 0px rgba(255, 255, 255, 1),
    -2px -2px 0px rgba(255, 255, 255, 1),
    2px -2px 0px rgba(255, 255, 255, 1),
    -2px 2px 0px rgba(255, 255, 255, 1);
}

.success-particles {
  position: absolute;
  width: 100%;
  height: 100%;
  overflow: hidden;
}

.particle {
  position: absolute;
  width: 8px;
  height: 8px;
  background: linear-gradient(45deg, #20B2AA, #48D1CC, #40E0D0, #66CDAA, #ffd700);
  border-radius: 50%;
  animation: particleFloat 1.2s ease-out forwards;
  box-shadow: 0 0 10px rgba(255, 255, 255, 0.8);
}

.success-burst {
  display: none;
}

.success-ring {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  border: 4px solid;
  border-color: #20B2AA transparent #48D1CC transparent;
  border-radius: 50%;
  opacity: 0;
  animation: ringExpand 1s ease-out forwards;
}

.success-star {
  position: absolute;
  color: #ffd700;
  font-size: 2rem;
  opacity: 0;
  animation: starTwinkle 1s ease-in-out forwards;
}

@keyframes successPop {
  0% {
    opacity: 0;
    transform: translate(-50%, -50%) scale(0.3) rotate(-10deg);
  }
  50% {
    transform: translate(-50%, -50%) scale(1.1) rotate(5deg);
  }
  100% {
    opacity: 1;
    transform: translate(-50%, -50%) scale(1) rotate(0deg);
  }
  }

@keyframes particleFloat {
  0% {
    opacity: 1;
    transform: translateY(0) scale(0);
  }
  10% {
    transform: translateY(-20px) scale(1);
  }
  100% {
    opacity: 0;
    transform: translateY(-300px) scale(0.5);
  }
}

@keyframes burstExpand {
  0% {
    opacity: 0;
    transform: translate(-50%, -50%) scale(0);
  }
  50% {
    opacity: 1;
    transform: translate(-50%, -50%) scale(1);
  }
  100% {
    opacity: 0;
    transform: translate(-50%, -50%) scale(2);
  }
}

@keyframes ringExpand {
  0% {
    opacity: 1;
    transform: translate(-50%, -50%) scale(0);
  }
  100% {
    opacity: 0;
    transform: translate(-50%, -50%) scale(3);
  }
}

@keyframes starTwinkle {
  0%, 100% {
    opacity: 0;
    transform: scale(0) rotate(0deg);
  }
  50% {
    opacity: 1;
    transform: scale(1.2) rotate(180deg);
  }
}

@media (max-width: 768px) {
  .success-main-message {
    font-size: 2.5rem;
  }
}



.reader-toolbar {
  width: 100%;
  display: flex;
  justify-content: flex-end;
  margin-bottom: 0;
}

.home-btn {
  display: flex;
  align-items: center;
  gap: 6px;
  padding: 4px 14px;
  font-size: 14px;
  background: #00b7f1;
  color: #fff;
  border: none;
  border-radius: 20px;
  cursor: pointer;
  justify-content: center;
  box-shadow: 0 2px 4px rgba(0, 0, 0, .15);
}

.home-btn:hover {
  background: #2f74b5;
}

.home-btn svg {
  width: 18px;
  height: 18px;
  fill: #fff;
}

#finishReadingBtn {
  background: #1a5fb3;
  width: 50%;
}

#finishReadingBtn:hover {
  background: #113f76;
}

/* --- カレンダー・宝箱 --- */
.calendar-wrapper {
  margin-top: 32px;
  text-align: center;
}

.calendar-title {
  font-weight: normal;
  margin: 8px;
}

.calendar-week {
  display: grid;
  grid-template-columns: repeat(7, 40px);
  gap: 8px;
  justify-content: center;
  font-size: 12px;
  color: #aaa;
  margin-bottom: 4px;
}

.calendar-week span {
  width: 40px;
  height: 16px;
  line-height: 16px;
}

.calendar {
  display: grid;
  grid-template-columns: repeat(7, 40px);
  gap: 8px;
  justify-content: center;
}

.cal-day {
  width: 40px;
  height: 40px;
  font-size: 14px;
  color: #666;
  border: 1px solid #ffffff;
  border-radius: 6px;
  display: flex;
  align-items: center;
  justify-content: center;
  background: #def8ff;
}

.cal-day.stamp {
  background: #b3e5fc !important;  /* 明るい水色 */
  border: none;
  position: relative;
}

.stamp-img {
  position: absolute;
  top: 2px;
  left: 50%;
  transform: translateX(-50%);
  width: 40px;
  height: 40px;
  pointer-events: none;
  z-index: 2;
}

.cal-day.blank {
  border: none;
  background: transparent;
}

#treasureBox {
  position: fixed;
  right: 40px;
  bottom: 40px;
  z-index: 3000;
  width: 100px;
  height: 72px;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
}

#treasureBox span {
  font-size: 30px;
  display: inline-flex;
  align-items: center;
}

#diamondCount {
  background: #fff8;
  border-radius: 12px;
  padding: 2px 8px;
  font-size: 19px;
  color: #00b7f1;
  box-shadow: 0 2px 6px #00b7f111;
  font-weight: bold;
  margin-right: 2px;
}

.treasures-dashboard-title {
  font-weight: normal;
  font-size: 14px;
  color: #888;
  margin-bottom: 4px;
  letter-spacing: 0.2px;
  text-align: center;
  width: 100%;
  display: block;
}

.treasures-dashboard {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  text-align: center;
}

.treasure-row {
  display: flex;
  flex-direction: row;
  gap: 10px;
  margin-top: 2px;
}

.treasure-card {
  display: flex;
  flex-direction: column;
  align-items: center;
  background: rgba(255, 255, 255, 0.89);
  border-radius: 15px;
  box-shadow: 0 2px 8px #c6d8f618, 0 1px 0 #fff;
  padding: 7px 5px 7px 5px;
  min-width: 46px;
  min-height: 60px;
}

.treasure-icon {
  font-size: 25px;
  font-weight: bold;
  margin-bottom: 2px;
  margin-top: 1px;
}

.treasure-num {
  font-size: 20px;
  font-weight: bold;
  margin: 0;
  letter-spacing: 1px;
  line-height: 1.0;
}

.treasure-diamond {
  color: #00b7f1;
}

@media (max-width: 700px) {
  #treasureBox {
    right: 10px;
    bottom: 10px;
    width: 54px;
    height: 54px;
  }

  #diamondCount {
    font-size: 15px;
    padding: 2px 6px;
  }
}

.quiz-box.shrink {
  width: 220px !important;
  min-width: 0 !important;
  max-width: 230px !important;
  left: 18px !important;
  right: auto !important;
  top: 18px !important;
  bottom: auto !important;
  position: fixed !important;
  transform: none !important;
  background: #fff;
  opacity: 0.97;
  transition: width 0.2s, left 0.2s, bottom 0.2s, box-shadow 0.3s;
  box-shadow: 0 4px 18px 0 rgba(50, 80, 110, 0.18);
  z-index: 99999;
}

#quizOverlay.shrink {
  background: transparent !important;
  backdrop-filter: none !important;
  pointer-events: none;
}

.quiz-box.shrink * {
  pointer-events: auto !important;
}

/* シンプルな〇×表示用のアニメーション */
@keyframes showCircle {
  0% {
    opacity: 0;
    transform: translate(-50%, -50%) scale(0.5);
  }
  50% {
    opacity: 1;
    transform: translate(-50%, -50%) scale(1.1);
  }
  100% {
    opacity: 0;
    transform: translate(-50%, -50%) scale(1);
  }
}

/* styleタグに追加！ */
ruby rt, rt {
  user-select: none;
  -webkit-user-select: none;
  pointer-events: none;
}



/* 評価・クイズ */
#quizOverlay {
  position: fixed;
  inset: 0;
  display: none;
  z-index: 3000;
  background: rgba(0, 0, 0, .55);
  backdrop-filter: blur(2px);
  align-items: center;
  justify-content: center;
}

.quiz-box {
  width: 90%;
  max-width: 700px;
  max-height: 80vh;
  background: #fff;
  border-radius: 14px;
  padding: 24px;
  box-shadow: 0 6px 20px rgba(0, 0, 0, .25);
  overflow-y: auto;
}

.quiz-box h3 {
  margin: 0 0 18px;
  font-size: 20px;
  font-weight: bold;
  color: #00b7f1;
  text-align: center;
}

#quizList {
  list-style: none;
  margin: 12px 0;
  padding: 0;
  display: flex;
  flex-direction: column;
  gap: 10px;
}

#quizList li {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 10px;
  border: 1px solid #cce7f9;
  border-radius: 8px;
  cursor: pointer;
  background: #fff;
  position: relative;
}

#quizList li:hover {
  background: #d8f1ff;
}

.choice-label {
  display: inline-block;
  width: 26px;
  height: 26px;
  line-height: 26px;
  border-radius: 50%;
  background: #00b7f1;
  color: #fff;
  font-weight: bold;
  text-align: center;
}

.choice-mark {
  position: absolute;
  right: 10px;
  font-size: 20px;
  font-weight: bold;
}

.correctMark {
  color: #1b8e3e;
}

.wrongMark {
  color: #d81b60;
}

#feedback {
  font-size: 16px;
  font-weight: bold;
  text-align: center;
  margin-top: 20px;
  color: #2f74b5;
  writing-mode: vertical-rl;
  text-orientation: upright;
  font-family: 'Tsukushi Mincho', 'Yu Mincho', 'YuMincho', 'MS Mincho', serif;
  line-height: 2.2;
  align-self: flex-start;
}

#scoreOverlay {
  position: fixed;
  inset: 0;
  display: none;
  z-index: 5000;
  background: rgba(0, 0, 0, .55);
  backdrop-filter: blur(3px);
  align-items: center;
  justify-content: center;
}

.score-board {
  width: 92%;
  max-width: 440px;
  background: #fff7fd;
  border-radius: 24px;
  padding: 40px 28px;
  text-align: center;
  box-shadow: 0 10px 28px rgba(0, 0, 0, .28);
}

.grade-letter {
  font-size: 84px;
  font-weight: 900;
  margin: 0;
}

.grade-percent {
  font-size: 28px;
  font-weight: bold;
  margin: 8px 0 20px;
}

.grade-comment {
  font-size: 18px;
  margin-bottom: 28px;
}

.close-btn {
  background: #ff5fa1;
  color: #fff;
  border: none;
  border-radius: 16px;
  font-size: 16px;
  font-weight: bold;
  padding: 12px 28px;
  cursor: pointer;
}

.grade-S {
  color: #ff2b51;
}

.grade-A {
  color: #ff5fa1;
}

.grade-B {
  color: #ff9345;
}

.grade-C {
  color: #ffd740;
}

.grade-D {
  color: #42a5ff;
}

.grade-E {
  color: #9e9e9e;
}

.quiz-box {
  background: #fff;
  border-radius: 18px;
  box-shadow: 0 6px 24px rgba(0, 0, 0, 0.15);
  padding: 28px 24px 32px 24px;
  margin: 0 auto;
  writing-mode: vertical-rl;
  text-orientation: upright;
  font-family: 'Tsukushi Mincho', 'Yu Mincho', 'YuMincho', 'MS Mincho', serif;
  font-size: 18px;
  line-height: 2.2;
  color: #2c3e50;
  min-height: 400px;
  display: flex;
  flex-direction: column;
  align-items: flex-start;
}

.quiz-box h3 {
  color: #333;
  font-size: 18px;
  font-weight: bold;
  margin-bottom: 20px;
  letter-spacing: 1px;
  writing-mode: vertical-rl;
  text-orientation: upright;
  font-family: 'Tsukushi Mincho', 'Yu Mincho', 'YuMincho', 'MS Mincho', serif;
  line-height: 2.2;
  align-self: flex-start;
}

#quizList {
  margin: 0;
  padding: 0;
  display: flex;
  flex-direction: column;
  align-items: flex-start;
  width: 100%;
}

/* ---- 問題部（extract型のカード部分） ---- */
#extractMainQuestion {
  background: #e6f8ff;
  color: #1976d2;
  font-weight: normal !important;
  font-size: 18px;
  border-radius: 12px;
  border: 1.5px solid #b3e5fc;
  padding: 16px 16px 12px 16px;
  margin-bottom: 14px;
  margin-top: 0;
}

#selectedTextDisplay {
  background: #f2fafe;
  border: 1px solid #cce7f9;
  border-radius: 9px;
  font-weight: normal !important;
  padding: 10px 14px;
  color: #2c3e50;
  font-size: 16px;
  margin-bottom: 18px;
}

#extractHint {
  margin-top: 10px !important;
  margin-bottom: 0 !important;
}

/* ---- ボタン2つカスタム ---- */
#extractAnsBtn {
  background: #00b7f1;
  color: #fff;
  font-size: 17px;
  border: none;
  border-radius: 25px;
  width: 170px;
  height: 44px;
  margin-bottom: 8px;
  cursor: pointer;
  transition: background 0.2s;
}

#extractAnsBtn:hover {
  background: #007bb8;
}

#shrinkBtn {
  background: #f86098;
  color: #fff;
  font-size: 17px;
  border: none;
  border-radius: 25px;
  width: 170px;
  height: 44px;
  margin-bottom: 12px;
  cursor: pointer;
  transition: background 0.2s;
}

#shrinkBtn:hover {
  background: #d61e6d;
}

/* 戻るボタンも色調整 */
#expandBtn {
  background: #007bb8;
  color: #fff;
  font-size: 15px;
  border: none;
  border-radius: 22px;
  width: 140px;
  height: 38px;
  margin-bottom: 10px;
  cursor: pointer;
}

#goSelectBtn, #goAIGenBtn, #goLogicBtn, #goReadingTrainingBtn, #goGrammarTrainingBtn, #goKanjiVocabBtn {
  display: block;
  margin: 8px auto;
  width: 270px;
  height: 56px;
  font-size: 18px;
  font-weight: bold;
  border: none;
  border-radius: 15px;
  letter-spacing: 0.2px;
  line-height: 1.2;
  color: #fff;
  box-shadow: 0 8px 0 0 rgba(0, 0, 0, 0.10), 0 2px 12px #b3e5fc30;
  position: relative;
  transition: transform 0.13s, box-shadow 0.14s;
  z-index: 1;
}

/* 水色ボタン */
#goSelectBtn {
  background: #f86098;
  box-shadow: 0 8px 0 0 #d8497d, 0 2px 12px #ffd1e7;
}

/* ピンクボタン */
#goAIGenBtn {
  background: #00b7f1;
  box-shadow: 0 8px 0 0 #1a99ca, 0 2px 12px #b3e5fc30;
}

/* 音読トレーニングボタン（青） */
#goReadingTrainingBtn {
  background: #00b7f1;
  box-shadow: 0 8px 0 0 #1a99ca, 0 2px 12px #b3e5fc30;
}

/* 文法トレーニングボタン（オレンジ） */
#goGrammarTrainingBtn {
  background: #ea580c;
  box-shadow: 0 8px 0 0 #c2410c, 0 2px 12px #fed7aa;
}

/* 漢字・語彙トレーニングボタン（紫） */
#goKanjiVocabBtn {
  background: #9C27B0;
  box-shadow: 0 8px 0 0 #7B1FA2, 0 2px 12px #e1bee7;
}

/* 論理トレーニングボタン（緑） */
#goLogicBtn {
  background: #4CAF50;
  box-shadow: 0 8px 0 0 #388E3C, 0 2px 12px #c8e6c9;
}

/* 押したとき沈む効果 */
#goSelectBtn:active {
  transform: translateY(6px);
  box-shadow: 0 2px 0 0 #d8497d, 0 1px 4px #ffd1e7;
}

#goAIGenBtn:active {
  transform: translateY(6px);
  box-shadow: 0 2px 0 0 #1a99ca, 0 1px 4px #b3e5fc30;
}

#goReadingTrainingBtn:active {
  transform: translateY(6px);
  box-shadow: 0 2px 0 0 #1a99ca, 0 1px 4px #b3e5fc30;
}

#goGrammarTrainingBtn:active {
  transform: translateY(6px);
  box-shadow: 0 2px 0 0 #c2410c, 0 1px 4px #fed7aa;
}

#goKanjiVocabBtn:active {
  transform: translateY(6px);
  box-shadow: 0 2px 0 0 #7B1FA2, 0 1px 4px #e1bee7;
}

#goLogicBtn:active {
  transform: translateY(6px);
  box-shadow: 0 2px 0 0 #388E3C, 0 1px 4px #c8e6c9;
}

/* --- 論理トレーニングメニュー --- */
.logic-menu {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
  gap: 24px;
  max-width: 1000px;
  margin: 0 auto;
  padding: 0 20px;
}

.logic-item {
  background: linear-gradient(135deg, #fff 0%, #f8f9fa 100%);
  border-radius: 16px;
  padding: 24px 20px;
  box-shadow: 0 4px 12px rgba(76, 175, 80, 0.15);
  border: 2px solid #e8f5e8;
  transition: all 0.3s ease;
  cursor: pointer;
  position: relative;
  overflow: hidden;
}

.logic-item:hover {
  transform: translateY(-4px);
  box-shadow: 0 8px 20px rgba(76, 175, 80, 0.25);
  border-color: #4CAF50;
}

.logic-item::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 4px;
  background: linear-gradient(90deg, #4CAF50, #66BB6A);
}

.logic-item-title {
  font-size: 18px;
  font-weight: bold;
  color: #2e7d32;
  margin-bottom: 8px;
  display: flex;
  align-items: center;
  gap: 8px;
}

.logic-item-level {
  font-size: 14px;
  color: #66BB6A;
  margin-bottom: 12px;
  display: flex;
  align-items: center;
  gap: 4px;
}

.logic-item-description {
  font-size: 14px;
  color: #666;
  line-height: 1.5;
  margin-bottom: 16px;
}

.logic-item-status {
  display: flex;
  justify-content: space-between;
  align-items: center;
  font-size: 12px;
  color: #888;
}

.logic-item-badge {
  background: #4CAF50;
  color: white;
  padding: 4px 8px;
  border-radius: 12px;
  font-size: 10px;
  font-weight: bold;
}

.logic-item-badge.coming-soon {
  background: #ff9800;
}

.logic-item-badge.locked {
  background: #757575;
}

/* --- 指示語問題のスタイル --- */
.pronoun-reference-game {
  max-width: 800px;
  margin: 0 auto;
  padding: 20px;
}

#pronounText {
  position: relative;
  height: 350px !important;
  overflow: visible !important;
}

.pronoun-highlight {
  text-decoration: underline;
  text-decoration-color: #4CAF50;
  text-decoration-thickness: 2px;
  font-weight: bold;
  cursor: pointer;
  display: inline;
  vertical-align: baseline;
}



.pronoun-option {
  padding: 16px 24px;
  border: 2px solid #e0e0e0;
  border-radius: 12px;
  background: #ffffff;
  cursor: pointer;
  font-size: 18px;
  text-align: center;
  transition: all 0.3s ease;
  position: relative;
}

.pronoun-option:hover {
  border-color: #4CAF50;
  box-shadow: 0 4px 12px rgba(76, 175, 80, 0.2);
  transform: translateY(-2px);
}

.pronoun-option.selected {
  border-color: #4CAF50;
  background: #e8f5e8;
  color: #2e7d32;
  font-weight: bold;
}

.pronoun-option.correct {
  border-color: #20B2AA;
  background: #B2DFDB;
  color: #00695C;
}

.pronoun-option.incorrect {
  border-color: #f44336;
  background: #ffcdd2;
  color: #b71c1c;
}

.pronoun-option.disabled {
  pointer-events: none;
}

/* --- 音読トレーニングメニュー --- */
.reading-training-menu {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
  gap: 24px;
  max-width: 1000px;
  margin: 0 auto;
  padding: 0 20px;
}

.reading-item {
  background: linear-gradient(135deg, #fff 0%, #f3f8ff 100%);
  border-radius: 16px;
  padding: 24px 20px;
  box-shadow: 0 4px 12px rgba(33, 150, 243, 0.15);
  border: 2px solid #e3f2fd;
  transition: all 0.3s ease;
  cursor: pointer;
  position: relative;
  overflow: hidden;
}

.reading-item:hover {
  transform: translateY(-4px);
  box-shadow: 0 8px 20px rgba(33, 150, 243, 0.25);
  border-color: #2196f3;
}

.reading-item::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 4px;
  background: linear-gradient(90deg, #2196f3, #42a5f5);
}

.reading-item.ai-item {
  box-shadow: 0 4px 12px rgba(66, 165, 245, 0.15);
  border: 2px solid #e3f2fd;
}

.reading-item.ai-item:hover {
  box-shadow: 0 8px 20px rgba(66, 165, 245, 0.25);
  border-color: #42a5f5;
}

.reading-item.ai-item::before {
  background: linear-gradient(90deg, #42a5f5, #64b5f6);
}

.reading-item-title {
  font-size: 18px;
  font-weight: bold;
  color: #1976d2;
  margin-bottom: 8px;
  display: flex;
  align-items: center;
  gap: 8px;
}

.reading-item.ai-item .reading-item-title {
  color: #1976d2;
}

.reading-item-level {
  font-size: 14px;
  color: #42a5f5;
  margin-bottom: 12px;
  display: flex;
  align-items: center;
  gap: 4px;
}

.reading-item.ai-item .reading-item-level {
  color: #64b5f6;
}

.reading-item-description {
  font-size: 14px;
  color: #666;
  line-height: 1.5;
  margin-bottom: 16px;
}

.reading-item-status {
  display: flex;
  justify-content: space-between;
  align-items: center;
  font-size: 12px;
  color: #888;
}

.reading-item-badge {
  background: #2196f3;
  color: white;
  padding: 4px 8px;
  border-radius: 12px;
  font-size: 10px;
  font-weight: bold;
}

.reading-item.ai-item .reading-item-badge {
  background: #42a5f5;
}

/* --- 文法トレーニングメニュー --- */
.grammar-menu {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
  gap: 24px;
  max-width: 1000px;
  margin: 0 auto;
  padding: 0 20px;
}

/* --- 問題画面共通ヘッダー --- */
.problem-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 16px 20px;
  margin-bottom: 20px;
}

.problem-header-title {
  font-size: 18px;
  font-weight: bold;
  color: #2c3e50;
}

.problem-header-progress {
  font-size: 16px;
  font-weight: bold;
  color: #666;
}

/* 重複していた古いスタイル定義を削除 */

/* --- 文章タップ問題のスタイル --- */
.sentence-tap-container {
  max-width: 800px;
  margin: 0 auto;
  padding: 20px;
}

.sentence-tap-text {
  font-size: 20px;
  line-height: 2;
  margin-bottom: 32px;
  padding: 24px;
  background: #ffffff;
  border-radius: 12px;
  border: 2px solid #e0e0e0;
  font-family: 'UD Digi Kyokasho N-R', 'UD デジタル 教科書体 N-R', 'Klee', 'HiraMinProN-W3', serif;
}

.sentence-tap-text p {
  margin: 0 0 16px 0;
  cursor: pointer;
  padding: 8px 12px;
  border-radius: 8px;
  transition: all 0.3s ease;
  border: 2px solid transparent;
}

.sentence-tap-text p:hover {
  background: #f5f5f5;
  border-color: #ccc;
}

.sentence-tap-text p.claim {
  background: #ffebee;
  border-color: #f44336;
  color: #d32f2f;
  font-weight: bold;
}

.sentence-tap-text p.concrete {
  background: #e3f2fd;
  border-color: #2196f3;
  color: #1976d2;
  font-weight: bold;
}

.sentence-tap-text p.claim:hover {
  background: #ffcdd2;
  border-color: #f44336;
}

.sentence-tap-text p.concrete:hover {
  background: #bbdefb;
  border-color: #2196f3;
}

.sentence-tap-instructions {
  background: #f8f9fa;
  border: 1px solid #dee2e6;
  border-radius: 8px;
  padding: 16px;
  margin-bottom: 24px;
  font-size: 14px;
  color: #495057;
  text-align: center;
}

.sentence-tap-legend {
  display: flex;
  justify-content: center;
  gap: 32px;
  margin-bottom: 24px;
  flex-wrap: wrap;
}

.legend-item {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 14px;
  color: #666;
}

.legend-color {
  width: 20px;
  height: 20px;
  border-radius: 4px;
  border: 2px solid;
}

.legend-color.claim {
  background: #ffebee;
  border-color: #f44336;
}

.legend-color.concrete {
  background: #e3f2fd;
  border-color: #2196f3;
}

.grammar-item-status {
  display: flex;
  justify-content: space-between;
  align-items: center;
  font-size: 12px;
  color: #888;
}

.grammar-item-badge {
  background: #FF9800;
  color: white;
  padding: 4px 8px;
  border-radius: 12px;
  font-size: 10px;
  font-weight: bold;
}

.grammar-item-badge.coming-soon {
  background: #ffa726;
}

.grammar-item-badge.locked {
  background: #757575;
}

/* --- 文法トレーニング下位メニュー --- */
.grammar-submenu {
  display: flex;
  flex-wrap: wrap;
  justify-content: center;
  gap: 20px;
  max-width: 1000px;
  margin: 0 auto;
  padding: 0 20px;
}

.grammar-submenu-item {
  width: 140px;
  height: 140px;
  background: #fff;
  border-radius: 20px;
  cursor: pointer;
  position: relative;
  transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  text-align: center;
  padding: 16px;
  box-shadow: 0 8px 32px rgba(0,0,0,0.12);
  border: 3px solid;
  overflow: hidden;
}

/* レベル別の色分け */
.grammar-submenu-item[data-level="intro"] {
  background: linear-gradient(135deg, #fb923c 0%, #fdba74 100%);
  border-color: #ea580c;
  color: white;
}

.grammar-submenu-item[data-level="basic"] {
  background: linear-gradient(135deg, #64B5F6 0%, #90CAF9 100%);
  border-color: #2196F3;
  color: white;
}

.grammar-submenu-item[data-level="advanced"] {
  background: linear-gradient(135deg, #FFB74D 0%, #FFCC02 100%);
  border-color: #FF9800;
  color: white;
}

.grammar-submenu-item[data-level="expert"] {
  background: linear-gradient(135deg, #F06292 0%, #F48FB1 100%);
  border-color: #E91E63;
  color: white;
}

.grammar-submenu-item[data-level="exam"] {
  background: linear-gradient(135deg, #9575CD 0%, #B39DDB 100%);
  border-color: #673AB7;
  color: white;
}

.grammar-submenu-item:hover {
  transform: translateY(-8px) scale(1.05);
  box-shadow: 0 16px 48px rgba(0,0,0,0.2);
}

.grammar-submenu-item:active {
  transform: translateY(-4px) scale(1.02);
}

/* キラキラ効果 */
.grammar-submenu-item::before {
  content: '';
  position: absolute;
  top: -50%;
  left: -50%;
  width: 200%;
  height: 200%;
  background: linear-gradient(45deg, transparent, rgba(255,255,255,0.3), transparent);
  animation: sparkle 3s infinite;
  opacity: 0;
}

.grammar-submenu-item:hover::before {
  opacity: 1;
  animation: sparkle 0.6s ease-in-out;
}

@keyframes sparkle {
  0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
  100% { transform: translateX(100%) translateY(100%) rotate(45deg); }
}

.grammar-submenu-item-icon {
  font-size: 28px;
  margin-bottom: 8px;
  display: block;
  animation: bounce 2s infinite;
}



.grammar-submenu-item-title {
  font-size: 13px;
  font-weight: bold;
  margin-bottom: 4px;
  line-height: 1.2;
  text-shadow: 0 1px 2px rgba(0,0,0,0.2);
}

.grammar-submenu-item-description {
  font-size: 10px;
  line-height: 1.3;
  opacity: 0.9;
  text-shadow: 0 1px 2px rgba(0,0,0,0.2);
}

/* レベル別アイコンの装飾 */
.grammar-submenu-item[data-level="intro"] .grammar-submenu-item-icon::after {
  content: '';
  position: absolute;
  top: -5px;
  right: -5px;
  font-size: 14px;
}

.grammar-submenu-item[data-level="basic"] .grammar-submenu-item-icon::after {
  content: '';
  position: absolute;
  top: -5px;
  right: -5px;
  font-size: 14px;
}

.grammar-submenu-item[data-level="advanced"] .grammar-submenu-item-icon::after {
  content: '';
  position: absolute;
  top: -5px;
  right: -5px;
  font-size: 14px;
}

.grammar-submenu-item[data-level="expert"] .grammar-submenu-item-icon::after {
  content: '';
  position: absolute;
  top: -5px;
  right: -5px;
  font-size: 14px;
}

.grammar-submenu-item[data-level="exam"] .grammar-submenu-item-icon::after {
  content: '';
  position: absolute;
  top: -5px;
  right: -5px;
  font-size: 14px;
}

/* 完了済みアイテムのスタイル */
.grammar-submenu-item.completed {
  background: linear-gradient(135deg, #20B2AA 0%, #48D1CC 100%);
  border-color: #00695C;
}

.grammar-submenu-item.completed .grammar-submenu-item-icon::after {
  content: '';
}

/* ロックされたアイテム */
.grammar-submenu-item.locked {
  background: linear-gradient(135deg, #B0BEC5 0%, #CFD8DC 100%);
  border-color: #78909C;
  color: #546E7A;
  cursor: not-allowed;
}

.grammar-submenu-item.locked .grammar-submenu-item-icon::after {
  content: '';
}

.grammar-submenu-item.locked:hover {
  transform: none;
  box-shadow: 0 8px 32px rgba(0,0,0,0.12);
}

.grammar-submenu-item-badge {
  position: absolute;
  top: -8px;
  right: -8px;
  background: #FF5722;
  color: white;
  border-radius: 50%;
  width: 24px;
  height: 24px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 10px;
  font-weight: bold;
  border: 2px solid white;
  box-shadow: 0 2px 8px rgba(0,0,0,0.2);
}

.grammar-submenu-item-badge.coming-soon {
  background: #ffa726;
}

.grammar-submenu-item-badge.locked {
  background: #757575;
}

/* --- 漢字・語彙トレーニングメニュー --- */
.kanji-vocab-menu {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
  gap: 24px;
  max-width: 1000px;
  margin: 0 auto;
  padding: 0 20px;
}

.kanji-vocab-item {
  background: linear-gradient(135deg, #fff 0%, #faf4ff 100%);
  border-radius: 16px;
  padding: 24px 20px;
  box-shadow: 0 4px 12px rgba(156, 39, 176, 0.15);
  border: 2px solid #e1bee7;
  transition: all 0.3s ease;
  cursor: pointer;
  position: relative;
  overflow: hidden;
}

.kanji-vocab-item:hover {
  transform: translateY(-4px);
  box-shadow: 0 8px 20px rgba(156, 39, 176, 0.25);
  border-color: #9C27B0;
}

.kanji-vocab-item::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 4px;
  background: linear-gradient(90deg, #9C27B0, #AB47BC);
}

.kanji-vocab-item-title {
  font-size: 18px;
  font-weight: bold;
  color: #7B1FA2;
  margin-bottom: 8px;
  display: flex;
  align-items: center;
  gap: 8px;
}



.kanji-vocab-item-level {
  font-size: 14px;
  color: #AB47BC;
  margin-bottom: 12px;
  display: flex;
  align-items: center;
  gap: 4px;
}

.kanji-vocab-item-description {
  font-size: 14px;
  color: #666;
  line-height: 1.5;
  margin-bottom: 16px;
}

.kanji-vocab-item-badge {
  background: #9C27B0;
  color: white;
  padding: 4px 8px;
  border-radius: 12px;
  font-size: 10px;
  font-weight: bold;
}

/* --- 漢字・語彙問題画面 --- */
.kanji-vocab-problem {
  max-width: 800px;
  margin: 0 auto;
  padding: 24px;
  background: #fff;
  border-radius: 16px;
  box-shadow: 0 4px 12px rgba(156, 39, 176, 0.1);
}

.kanji-meaning {
  font-size: 24px;
  color: #7B1FA2;
  text-align: center;
  margin-bottom: 32px;
  padding: 20px;
  background: #f3e5f5;
  border-radius: 12px;
  border: 2px solid #e1bee7;
  font-weight: bold;
}

.kanji-choices {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 16px;
  margin-bottom: 32px;
}

.kanji-choice {
  background: #fff;
  border: 3px solid #e1bee7;
  border-radius: 12px;
  padding: 20px;
  font-size: 40px;
  font-weight: bold;
  color: #000000;
  font-family: 'Tsukushi Mincho', 'Yu Mincho', 'YuMincho', 'MS Mincho', serif;
  text-align: center;
  cursor: pointer;
  transition: all 0.3s ease;
  min-height: 80px;
  display: flex;
  align-items: center;
  justify-content: center;
}

.kanji-choice:hover {
  background: #f3e5f5;
  border-color: #9C27B0;
  transform: translateY(-2px);
}

.kanji-choice.selected {
  background: #9C27B0;
  border-color: #7B1FA2;
  color: white;
}

.kanji-choice.correct {
  background: #20B2AA;
  border-color: #00695C;
  color: white;
}

.kanji-choice.incorrect {
  background: #f44336;
  border-color: #c62828;
  color: white;
}

.kanji-answer-area {
  background: #E0F2F1;
  border: 3px dashed #20B2AA;
  border-radius: 12px;
  padding: 24px;
  margin-bottom: 24px;
  text-align: center;
  min-height: 80px;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
}

.kanji-answer-area.has-answer {
  background: #f3e5f5;
  border-color: #9C27B0;
}

.selected-kanji {
  font-size: 44px;
  color: #000000;
  font-weight: bold;
  font-family: 'Tsukushi Mincho', 'Yu Mincho', 'YuMincho', 'MS Mincho', serif;
  margin: 0 4px;
}

.kanji-problem-controls {
  display: flex;
  justify-content: center;
  gap: 16px;
  margin-top: 24px;
}

.kanji-btn {
  background: #87CEEB;
  color: white;
  border: none;
  border-radius: 25px;
  padding: 12px 32px;
  font-size: 16px;
  font-weight: bold;
  cursor: pointer;
  transition: all 0.3s ease;
}

.kanji-btn:hover {
  background: #6CB4D8;
  transform: translateY(-2px);
}

/* 答えを確認ボタン - 緑色 */
#kanjiCheckBtn {
  background: #4CAF50;
  box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);
}

#kanjiCheckBtn:hover {
  background: #45a049;
  box-shadow: 0 6px 16px rgba(76, 175, 80, 0.4);
}

/* 次の問題へボタン - 青色 */
#kanjiNextBtn {
  background: #2196F3;
  box-shadow: 0 4px 12px rgba(33, 150, 243, 0.3);
}

#kanjiNextBtn:hover {
  background: #1976D2;
  box-shadow: 0 6px 16px rgba(33, 150, 243, 0.4);
}

.kanji-feedback {
  margin-top: 24px;
  padding: 20px;
  border-radius: 12px;
  text-align: center;
  font-weight: bold;
  display: none;
}

.kanji-feedback.correct {
  background: #e0f2f1;
  color: #00695c;
  border: 2px solid #4db6ac;
}

.kanji-feedback.incorrect {
  background: #fce4ec;
  color: #880e4f;
  border: 2px solid #f06292;
}

/* 文法トレーニング問題画面のスタイル */
.grammar-option-btn {
  background: #fff3e0;
  border: 2px solid #FFB74D;
  border-radius: 12px;
  padding: 18px 24px;
  font-size: 16px;
  font-weight: 500;
  color: #e65100;
  cursor: pointer;
  transition: all 0.3s ease;
  text-align: left;
  min-height: 60px;
  display: flex;
  align-items: center;
}

.grammar-option-btn:hover {
  background: #ffcc02;
  border-color: #FF9800;
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(255, 152, 0, 0.3);
}

.grammar-option-btn.selected {
  background: #FFB74D;
  border-color: #FF9800;
  color: #fff;
}

.grammar-option-btn.correct {
  background: #B2DFDB;
  border-color: #20B2AA;
  color: #00695C;
}

.grammar-option-btn.incorrect {
  background: #ffcdd2;
  border-color: #f44336;
  color: #c62828;
}

.grammar-option-btn:disabled {
  cursor: not-allowed;
}

.grammar-next-btn, .grammar-finish-btn {
  background: #17a2b8;
  color: white;
  border: none;
  border-radius: 25px;
  padding: 12px 32px;
  font-size: 16px;
  font-weight: bold;
  cursor: pointer;
  transition: all 0.3s ease;
  box-shadow: 0 4px 12px rgba(23, 162, 184, 0.3);
}

.grammar-next-btn:hover, .grammar-finish-btn:hover {
  background: #138496;
  transform: translateY(-2px);
  box-shadow: 0 6px 16px rgba(23, 162, 184, 0.4);
}

.grammar-back-btn {
  background: #FF9800;
  color: white;
  border: none;
  border-radius: 25px;
  padding: 12px 32px;
  font-size: 16px;
  font-weight: bold;
  cursor: pointer;
  transition: all 0.3s ease;
  box-shadow: 0 4px 12px rgba(255, 152, 0, 0.3);
}

.grammar-back-btn:hover {
  background: #F57C00;
  transform: translateY(-2px);
  box-shadow: 0 6px 16px rgba(255, 152, 0, 0.4);
}

/* 主語・述語問題のスタイル */
.subject-predicate-sentence-vertical {
  writing-mode: vertical-rl;
  text-orientation: upright;
  font-size: 24px;
  line-height: 2.5;
  padding: 20px;
  font-family: 'Tsukushi Mincho', 'Yu Mincho', 'YuMincho', 'MS Mincho', serif;
  max-height: 400px; /* 最大高さを設定して複数行表示を可能に */
  overflow-wrap: break-word; /* 長い文章の改行処理 */
}

.subject-predicate-word {
  display: inline;
  padding: 6px 10px;
  margin: 1px;
  background: transparent;
  border: none;
  cursor: pointer;
  transition: all 0.3s ease;
  font-size: 20px;
  font-weight: 500;
  position: relative;
  vertical-align: top;
}

.subject-predicate-word:hover {
  background: #f5f5f5;
  transform: translateX(-3px);
}

.subject-predicate-word.selected-predicate {
  background: #e3f2fd !important;
  color: #0d47a1 !important;
  border-right: 4px solid #1976d2 !important;
  padding-right: 6px !important;
}

.subject-predicate-word.selected-subject {
  background: #ffebee !important;
  color: #c62828 !important;
  border: 3px solid #d32f2f !important;
  border-radius: 6px !important;
  padding: 3px 7px !important;
}

.subject-predicate-word.correct {
  background: #20B2AA !important;
  color: white !important;
  border-color: #00695C !important;
}

.subject-predicate-word.incorrect {
  background: #f44336 !important;
  color: white !important;
  border-color: #d32f2f !important;
}

.subject-predicate-word.disabled {
  cursor: not-allowed;
}

/* 修飾語問題のスタイル */
.modifier-sentence-vertical {
  writing-mode: vertical-rl;
  text-orientation: upright;
  font-size: 24px;
  line-height: 1.8;
  padding: 20px;
  font-family: 'Tsukushi Mincho', 'Yu Mincho', 'YuMincho', 'MS Mincho', serif;
}

/* 文の構造問題のスタイル */
.sentence-structure-diagram {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 20px;
  padding: 20px;
  max-width: 700px;
  margin: 0 auto;
}

.sentence-structure-row {
  display: flex;
  align-items: center;
  gap: 20px;
  width: 100%;
  justify-content: center;
}

.structure-box {
  border: 2px solid #ccc;
  border-radius: 8px;
  padding: 12px 20px;
  min-width: 120px;
  min-height: 50px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 16px;
  background: #f8f9fa;
  cursor: pointer;
  transition: all 0.3s ease;
  position: relative;
}

.structure-box.main-box {
  border: 4px solid #00b7f1;
  background: #e6f8ff;
  min-width: 150px;
  min-height: 60px;
  font-weight: bold;
}

.structure-box.modifier-box {
  border: 2px solid #888;
  background: #fafafa;
}

.structure-box:hover {
  transform: scale(1.05);
  box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.structure-box.drag-over {
  background: #ffe6e6;
  border-color: #ff6b6b;
}

.structure-box.filled {
  background: #fff;
  border-color: #20B2AA;
}

.structure-box.correct {
  background: #d4edda;
  border-color: #28a745;
}

.structure-box.incorrect {
  background: #f8d7da;
  border-color: #dc3545;
}

.bunsetsu-item {
  display: inline-block;
  padding: 8px 16px;
  margin: 4px;
  background: #ffffff;
  border: 2px solid #20B2AA;
  border-radius: 6px;
  cursor: grab;
  font-size: 16px;
  transition: all 0.3s ease;
  user-select: none;
}

.bunsetsu-item:hover {
  transform: scale(1.1);
  box-shadow: 0 4px 8px rgba(0,0,0,0.2);
}

.bunsetsu-item.dragging {
  opacity: 0.5;
  cursor: grabbing;
}

.bunsetsu-container {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  justify-content: center;
  padding: 20px;
  background: #f8f9fa;
  border-radius: 8px;
  margin-bottom: 20px;
}

.structure-arrow {
  font-size: 24px;
  color: #666;
  margin: 0 10px;
}

.structure-arrow.vertical {
  writing-mode: vertical-lr;
  transform: rotate(90deg);
}

.modifier-word {
  display: inline;
  padding: 6px 10px;
  margin: 1px;
  background: transparent;
  border: none;
  cursor: pointer;
  transition: all 0.3s ease;
  font-size: 20px;
  font-weight: 500;
  position: relative;
}

.modifier-word:hover {
  background: #f5f5f5;
  transform: translateX(-3px);
}

/* 修飾語（マークされた単語）に緑の右線のみ */
.modifier-word.marked-modifier {
  cursor: default !important;
  position: relative;
}

.modifier-word.marked-modifier::after {
  content: '';
  position: absolute;
  top: 0;
  right: -2px;
  bottom: 0;
  width: 4px;
  background: #4CAF50;
}

/* 選択された修飾先 */
.modifier-word.selected-modified {
  background: #e8f5e8 !important;
  color: #2e7d32 !important;
  border: 3px solid #4CAF50 !important;
  border-radius: 6px !important;
  padding: 3px 7px !important;
}

/* 正解の修飾先 */
.modifier-word.correct-modified {
  background: #20B2AA !important;
  color: white !important;
  border: 3px solid #00695C !important;
  border-radius: 6px !important;
}

/* 不正解の修飾先 */
.modifier-word.incorrect-modified {
  background: #f44336 !important;
  color: white !important;
  border: 3px solid #d32f2f !important;
  border-radius: 6px !important;
}

.modifier-word.disabled {
  cursor: not-allowed;
}



.word-label {
  position: absolute;
  left: 100%;
  top: 50%;
  transform: translateY(-50%) scale(0.8);
  font-size: 14px;
  font-weight: bold;
  white-space: nowrap;
  z-index: 100;
  margin-left: -3px;
  writing-mode: horizontal-tb;
  text-orientation: mixed;
  text-align: center;
  opacity: 0;
  animation: labelAppear 0.3s ease-out forwards;
  display: block !important;
}

@keyframes labelAppear {
  from {
    opacity: 0;
    transform: translateY(-50%) scale(0.8);
  }
  to {
    opacity: 1;
    transform: translateY(-50%) scale(1);
  }
}

.word-label.predicate-label {
  color: #1976d2;
}

.word-label.subject-label {
  color: #d32f2f;
}

.word-label.modifier-label {
  color: #4CAF50;
}

.word-label.modified-label {
  color: #4CAF50;
}

/* 助詞カードゲームのスタイル */
.particle-card {
  background: #fff;
  color: #333;
  border: 2px solid #FF9800;
  border-radius: 6px;
  padding: 6px 10px;
  font-size: 20px;
  font-weight: bold;
  cursor: grab;
  transition: all 0.3s ease;
  user-select: none;
  width: 48px;
  height: 34px;
  text-align: center;
  font-family: "Tsukushi Mincho", "Yu Mincho", "YuMincho", "MS Mincho", serif;
  display: flex;
  align-items: center;
  justify-content: center;
  box-sizing: border-box;
  line-height: 1;
}

/* 二文字・三文字の助詞カード */
.particle-card.multi-char {
  writing-mode: vertical-rl;
  text-orientation: upright;
  padding: 6px 4px;
  width: 34px;
  height: 58px;
  line-height: 1.3;
  border: 2px solid #FF9800;
}

.particle-card:hover {
  transform: scale(1.1);
  background: #fff8f0;
}

.particle-card.dragging {
  opacity: 0.5;
  cursor: grabbing;
  transform: rotate(5deg);
}

.particle-blank {
  display: inline-block;
  width: 50px;
  height: 36px;
  border: 1px solid #666;
  border-radius: 6px;
  background: #fff;
  margin: 2px 2px;
  vertical-align: baseline;
  text-align: center;
  line-height: 34px;
  transition: all 0.3s ease;
  position: relative;
  box-sizing: border-box;
  transform: translateX(-1px);
}

/* 二文字・三文字の助詞用ドロップゾーン */
.particle-blank.multi-char {
  width: 36px;
  height: 60px;
  line-height: 1.3;
  writing-mode: vertical-rl;
  text-orientation: upright;
  display: inline-flex;
  align-items: center;
  justify-content: center;
}

.particle-blank.drag-over {
  background: #f0f0f0;
  border: 1px solid #333;
  transform: scale(1.05);
}

.particle-blank .particle-card {
  margin: 0;
  position: absolute;
  top: 1px;
  left: 1px;
  width: 48px;
  height: 34px;
  border: none;
  box-sizing: border-box;
  background: transparent;
}

/* 文節並び替え問題のスタイル */
.clause-card {
  writing-mode: vertical-rl;
  text-orientation: upright;
  background: #fff;
  border: 2px solid #FF9800;
  border-radius: 8px;
  padding: 12px 8px;
  font-size: 18px;
  font-weight: bold;
  cursor: grab;
  transition: all 0.3s ease;
  user-select: none;
  min-width: 44px;
  min-height: 60px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-family: "Tsukushi Mincho", "Yu Mincho", "YuMincho", "MS Mincho", serif;
  line-height: 1.5;
  box-shadow: 0 2px 4px rgba(255, 152, 0, 0.2);
  box-sizing: border-box;
}

/* 文字数に応じたカードサイズ */
.clause-card.char-1 {
  width: 44px;
  height: 60px;
}

.clause-card.char-2 {
  width: 44px;
  height: 80px;
}

.clause-card.char-3 {
  width: 44px;
  height: 100px;
}

.clause-card.char-4 {
  width: 44px;
  height: 120px;
}

.clause-card.char-5-plus {
  width: 44px;
  height: 140px;
}

.clause-card:hover {
  transform: translateY(-3px) scale(1.05);
  box-shadow: 0 4px 12px rgba(255, 152, 0, 0.4);
  border-color: #F57C00;
  background: #fff8f0;
}

.clause-card.dragging {
  opacity: 0.6;
  cursor: grabbing;
  transform: rotate(3deg) scale(1.1);
  z-index: 1000;
}

.clause-input-slot {
  writing-mode: vertical-rl;
  text-orientation: upright;
  width: 44px;
  height: 80px;
  border: 2px dashed #ccc;
  border-radius: 8px;
  background: #f9f9f9;
  display: flex;
  align-items: center;
  justify-content: center;
  font-family: "Tsukushi Mincho", "Yu Mincho", "YuMincho", "MS Mincho", serif;
  font-size: 18px;
  font-weight: bold;
  transition: all 0.3s ease;
  position: relative;
  box-sizing: border-box;
}

/* 文字数に応じた入力スロットサイズ */
.clause-input-slot.char-1 {
  width: 44px;
  height: 60px;
}

.clause-input-slot.char-2 {
  width: 44px;
  height: 80px;
}

.clause-input-slot.char-3 {
  width: 44px;
  height: 100px;
}

.clause-input-slot.char-4 {
  width: 44px;
  height: 120px;
}

.clause-input-slot.char-5-plus {
  width: 44px;
  height: 140px;
}

.clause-input-slot.drag-over {
  background: #e8f5e8;
  border-color: #4CAF50;
  border-style: solid;
  transform: scale(1.05);
}

.clause-input-slot.filled {
  background: transparent;
  border-color: #666;
  border-style: solid;
  padding: 0;
}

.clause-input-slot .clause-card {
  margin: 0;
  border: none;
  background: transparent;
  cursor: pointer;
  border-radius: 8px;
  box-shadow: none;
  transition: all 0.2s ease;
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  padding: 12px 8px;
  box-sizing: border-box;
}

.clause-input-slot.correct {
  background: #e0f2f1;
  border-color: #20B2AA;
}

.clause-input-slot.correct .clause-card {
  background: #20B2AA !important;
  color: white !important;
  border: 3px solid #00695C !important;
  transform: scale(1.1) !important;
  z-index: 10 !important;
}

.clause-input-slot.incorrect {
  background: #ffebee;
  border-color: #DC143C;
}

.clause-input-slot.incorrect .clause-card {
  background: #DC143C !important;
  color: white !important;
  border: 3px solid #B22222 !important;
  transform: scale(1.1) !important;
  z-index: 10 !important;
}

/* 入力スロット内のカードは自動的にスロットサイズに合わせる */

.clause-input-slot .clause-card:hover {
  transform: scale(1.02);
  box-shadow: 0 3px 8px rgba(76, 175, 80, 0.4);
}



/* 文節並び替え問題のレスポンシブ対応 */
@media (max-width: 768px) {
  .clause-problem-area {
    flex-direction: column !important;
    gap: 24px !important;
    max-width: 90% !important;
  }
  
  .clause-cards-area, .clause-input-area {
    max-width: 100% !important;
  }
  
  #clauseCards, #clauseInputSlots {
    min-height: 200px !important;
    padding: 16px !important;
  }
}

.particle-blank .particle-card.multi-char {
  padding: 6px 4px;
  font-size: 18px;
  line-height: 1.3;
  display: flex;
  align-items: center;
  justify-content: center;
  box-sizing: border-box;
  border-radius: 6px;
  background: transparent;
  writing-mode: vertical-rl;
  text-orientation: upright;
  width: 34px;
  height: 58px;
  border: none;
  top: 1px;
  left: 1px;
}

/* 二文字・三文字の助詞カードがドロップゾーンに配置された時 */
.particle-blank.multi-char .particle-card {
  width: 34px;
  height: 58px;
  writing-mode: vertical-rl;
  text-orientation: upright;
  line-height: 1.3;
  padding: 6px 4px;
  border: none;
  box-sizing: border-box;
  top: 1px;
  left: 1px;
}

/* 文節分けキャンバスのスタイル */
#clauseCanvas {
  max-width: 100%;
  height: auto;
  touch-action: none; /* タッチスクロールを無効化 */
}

@media (max-width: 768px) {
  #clauseCanvas {
    width: 80vw;
    height: 100vw;
    max-height: 650px;
  }
  
  .clause-controls {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    justify-content: center;
  }
  
  .clause-controls button {
    flex: 1;
    min-width: 120px;
    margin: 4px;
  }
}

@media (max-width: 768px) {
  .reading-training-menu {
    grid-template-columns: 1fr;
    padding: 0 16px;
  }
  
  .reading-item {
    padding: 20px 16px;
  }
  
  .logic-menu {
    grid-template-columns: 1fr;
    padding: 0 16px;
  }
  
  .logic-item {
    padding: 20px 16px;
  }
  
  .grammar-menu {
    grid-template-columns: 1fr;
    padding: 0 16px;
  }
  
  .grammar-item {
    padding: 20px 16px;
  }
}

/* --- 具体と抽象ゲーム --- */
.concrete-abstract-game {
  display: flex;
  flex-direction: row-reverse;
  gap: 40px;
  max-width: 1200px;
  margin: 0 auto;
  padding: 20px;
}

/* --- 発展編専用スタイル --- */
.advanced-content {
  display: flex;
  flex-direction: row-reverse;
  gap: 40px;
  max-width: 1200px;
  margin: 0 auto;
  padding: 20px;
}

.text-section {
  flex: 1;
}

.reading-text {
  background: #fff;
  border-radius: 12px;
  padding: 24px;
  line-height: 1.6;
  font-size: 20px;
  color: #2c3e50;
  border: 2px solid #e9ecef;
  height: 320px;
  max-height: 320px;
  overflow-y: auto;
  writing-mode: vertical-rl;
  text-orientation: upright;
  font-family: 'Tsukushi Mincho', 'Yu Mincho', 'YuMincho', 'MS Mincho', serif;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.diagram-section {
  flex: 1;
  display: flex;
  justify-content: center;
  align-items: flex-start;
}

.hierarchy-diagram-advanced {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 0;
  width: 100%;
  max-width: 480px;
  margin: 0 auto;
  position: relative;
  min-height: 320px;
  padding: 15px;
}

.abstract-level-advanced {
  display: flex;
  justify-content: center;
  width: 100%;
  margin-bottom: 40px;
  z-index: 10;
  position: relative;
}

.abstract-box-advanced {
  background: #fff;
  border: 3px solid #20B2AA;
  border-radius: 8px;
  padding: 8px 12px;
  text-align: center;
  width: 90px;
  min-height: 120px;
  box-shadow: 0 4px 12px rgba(32, 178, 170, 0.25);
  z-index: 10;
  position: relative;
}

.middle-level-advanced {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 10px;
  width: 100%;
  margin-bottom: 40px;
  z-index: 10;
  position: relative;
}

.middle-boxes-advanced {
  display: flex;
  gap: 40px;
  justify-content: center;
  width: 100%;
}

.middle-box-advanced {
  background: #fff;
  border: 3px solid #FF9800;
  border-radius: 8px;
  padding: 8px 12px;
  text-align: center;
  width: 75px;
  min-height: 110px;
  box-shadow: 0 4px 12px rgba(255, 152, 0, 0.25);
  z-index: 10;
  position: relative;
}

.middle-level-advanced > .label {
  font-size: 14px;
  color: #FF9800;
  font-weight: bold;
  margin-bottom: 8px;
}

.concrete-level-advanced {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 10px;
  width: 100%;
  z-index: 10;
  position: relative;
}

.concrete-boxes-advanced {
  display: flex;
  gap: 15px;
  justify-content: center;
  width: 100%;
  position: relative;
}

.concrete-box-advanced {
  background: #fff;
  border: 3px solid #757575;
  border-radius: 8px;
  padding: 8px 10px;
  text-align: center;
  width: 70px;
  min-height: 100px;
  box-shadow: 0 4px 12px rgba(117, 117, 117, 0.25);
  z-index: 10;
  position: relative;
}

.answer-input {
  width: 100%;
  height: 80px;
  border: none;
  background: rgba(255, 255, 255, 0.8);
  font-size: 14px;
  text-align: center;
  outline: none;
  padding: 8px 6px;
  color: #2c3e50;
  font-weight: bold;
  border-radius: 6px;
  transition: background-color 0.2s ease;
  writing-mode: vertical-rl;
  text-orientation: upright;
  font-family: 'Tsukushi Mincho', 'Yu Mincho', 'YuMincho', 'MS Mincho', serif;
  resize: none;
  box-sizing: border-box;
}

.answer-input:focus {
  background: rgba(255, 255, 255, 0.95);
  box-shadow: inset 0 0 0 2px rgba(0, 123, 255, 0.3);
}

.answer-input::placeholder {
  color: #888;
  font-weight: normal;
  font-size: 13px;
}

.abstract-box-advanced .label {
  display: block;
  font-size: 14px;
  color: #4CAF50;
  font-weight: bold;
  margin-bottom: 8px;
}

.concrete-level-advanced > .label {
  font-size: 14px;
  color: #757575;
  font-weight: bold;
  margin-bottom: 8px;
}

/* レスポンシブ対応 */
@media (max-width: 768px) {
  .advanced-content {
    flex-direction: column;
    gap: 24px;
  }
  
  .hierarchy-diagram-advanced {
    max-width: 350px;
    transform: scale(0.85);
  }
  
  .middle-boxes-advanced {
    gap: 25px;
  }
  
  .concrete-boxes-advanced {
    gap: 10px;
  }
  
  .concrete-box-advanced {
    width: 60px;
    min-height: 90px;
  }
  
  .middle-box-advanced {
    width: 65px;
    min-height: 100px;
  }
  
  .abstract-box-advanced {
    width: 75px;
    min-height: 110px;
  }
  
  .answer-input {
    height: 70px;
    font-size: 13px;
    padding: 6px 4px;
  }
}

.word-bank {
  flex: 0 0 180px;
  background: #f8f9fa;
  border-radius: 12px;
  padding: 16px;
  border: 2px solid #e9ecef;
}

.word-bank h3 {
  margin: 0 0 16px 0;
  color: #4CAF50;
  font-size: 16px;
  text-align: center;
}

.word-cards {
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.word-card {
  background: #fff;
  border: 2px solid #4CAF50;
  border-radius: 8px;
  padding: 10px;
  text-align: center;
  font-weight: normal;
  color: #2e7d32;
  cursor: grab;
  transition: all 0.3s ease;
  user-select: none;
  font-size: 14px;
}

/* 抽象エリアに配置された時の青色スタイル */
.word-card.in-abstract, .sentence-card.in-abstract {
  background: #e3f2fd;
  border: 2px solid #2196F3;
  color: #1565c0;
}

/* 具体エリアに配置された時のグレー色スタイル */
.word-card.in-concrete, .sentence-card.in-concrete {
  background: #f5f5f5;
  border: 2px solid #757575;
  color: #424242;
}

.word-card:hover {
  transform: scale(1.05);
  box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);
}

.word-card.dragging {
  opacity: 0.5;
  cursor: grabbing;
  transform: rotate(5deg);
}

/* 文カード用のスタイル（応用編のときに使用） */
.sentence-card {
  background: #fff;
  border: 2px solid #4CAF50;
  border-radius: 8px;
  padding: 10px 12px;
  text-align: left;
  font-weight: normal;
  color: #2e7d32;
  cursor: grab;
  transition: all 0.3s ease;
  user-select: none;
  width: 100%;
  max-width: 160px;
  line-height: 1.3;
  font-size: 13px;
  min-height: 45px;
  display: flex;
  align-items: center;
  box-sizing: border-box;
}

.sentence-card:hover {
  transform: scale(1.02);
  box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);
}

.sentence-card.dragging {
  opacity: 0.5;
  cursor: grabbing;
    transform: rotate(2deg);
}

/* 文章レベル用のレイアウト調整 */
.sentence-mode .word-bank {
  flex: 0 0 280px;
}

.sentence-mode .word-cards {
  display: grid;
  grid-template-columns: 1fr;
  gap: 8px;
  justify-items: stretch;
}

.sentence-mode .abstract-box {
  min-width: 220px;
  min-height: 70px;
}

.sentence-mode .concrete-box {
  min-width: 160px;
  min-height: 70px;
}

.sentence-mode .drop-zone {
  min-height: 60px;
  padding: 6px;
}

.sentence-mode .drop-zone .sentence-card {
  margin: 0;
  width: 100%;
  box-sizing: border-box;
}

.hierarchy-diagram {
  flex: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 30px;
}

.abstract-level {
  display: flex;
  justify-content: center;
}

.abstract-box {
  position: relative;
  background: #e3f2fd;
  border: 3px solid #2196f3;
  border-radius: 12px;
  padding: 16px;
  min-width: 160px;
  text-align: center;
}

.abstract-box .label {
  font-size: 14px;
  color: #1565c0;
  font-weight: bold;
  display: block;
  margin-bottom: 8px;
}

.concrete-level {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 16px;
}

.concrete-level > .label {
  font-size: 14px;
  color: #757575;
  font-weight: bold;
}

.concrete-boxes {
  display: flex;
  gap: 20px;
}

.concrete-box {
  position: relative;
  background: #f5f5f5;
  border: 3px solid #757575;
  border-radius: 12px;
  padding: 16px;
  min-width: 120px;
  min-height: 60px;
  text-align: center;
}

.drop-zone {
  min-height: 50px;
  border-radius: 8px;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.3s ease;
}

.drop-zone.drag-over {
  background: rgba(76, 175, 80, 0.2);
  border: 2px dashed #4CAF50;
}

.drop-zone .word-card {
  margin: 0;
  cursor: grab;
}

.drop-zone .sentence-card {
  margin: 0;
  cursor: grab;
  width: 100%;
  box-sizing: border-box;
}

.logic-check-btn, .logic-reset-btn {
  padding: 12px 24px;
  margin: 0 8px;
  border: none;
  border-radius: 8px;
  font-size: 16px;
  font-weight: bold;
  cursor: pointer;
  transition: all 0.3s ease;
}

.logic-check-btn {
  background: #20B2AA;
  color: white;
}

.logic-check-btn:hover {
  background: #1a8f8a;
}

.logic-reset-btn:hover {
  background: #f57c00;
}

.game-result {
  margin-top: 20px;
  padding: 16px;
  border-radius: 8px;
  text-align: center;
  font-weight: bold;
}

.game-result.correct {
  background: #e8f5e9;
  color: #2e7d32;
  border: 2px solid #4CAF50;
}

.game-result.incorrect {
  background: #ffebee;
  color: #c62828;
  border: 2px solid #f44336;
}

@media (max-width: 768px) {
  .concrete-abstract-game {
    flex-direction: column;
    gap: 20px;
    padding: 16px;
  }
  
  .word-bank {
    flex: none;
  }
  
  .word-cards {
    flex-direction: row;
    flex-wrap: wrap;
    gap: 8px;
  }
  
  .sentence-mode .word-cards {
    grid-template-columns: 1fr;
    gap: 6px;
  }
  
  .sentence-mode .word-bank {
    flex: 0 0 240px;
  }
  
  .sentence-card {
    max-width: 140px;
    font-size: 12px;
    padding: 8px 10px;
    min-height: 40px;
  }
  
  .concrete-boxes {
    flex-direction: column;
    gap: 12px;
  }
}

.shop-btn {
  background: linear-gradient(90deg, #f7b42c 50%, #f75c2c 100%);
  color: #fff;
  width: 30%;
  font-weight: bold;
  border: none;
  border-radius: 20px;
  padding: 12px 28px;
  font-size: 17px;
  box-shadow: 0 4px 16px #ffd68035;
  margin-top: 8px;
  cursor: pointer;
  transition: background 0.2s;
}

.shop-btn:hover {
  background: linear-gradient(90deg, #f2994a 60%, #f2c94c 100%);
}

.shop-item-card {
  background: #fff7ee;
  border-radius: 15px;
  padding: 16px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  box-shadow: 0 2px 10px #ffd1b333;
}

.shop-item-name {
  font-size: 18px;
  font-weight: bold;
  color: #f75c2c;
}

.shop-item-price {
  font-size: 15px;
  color: #ff8c34;
  margin-right: 20px;
}

.buy-btn {
  background: #00b7f1;
  color: #fff;
  border: none;
  border-radius: 16px;
  padding: 7px 20px;
  font-size: 15px;
  font-weight: bold;
  cursor: pointer;
  box-shadow: 0 1px 4px #00b7f120;
  transition: background 0.17s;
}

.buy-btn:hover {
  background: #179de3;
}

.ai-gen-select {
  width: 100%;
  max-width: 360px;
  padding: 14px 18px;
  margin: 0 auto 18px auto;
  font-size: 18px;
  border-radius: 14px;
  border: none;
  background: #f2fbff;
  color: #1976d2;
  font-weight: bold;
  box-shadow: 0 3px 12px #cce7f955;
  transition: box-shadow 0.15s, border 0.12s;
  outline: none;
  appearance: none;
  cursor: pointer;
  box-sizing: border-box;
  display: block;
}

.ai-gen-select:focus {
  box-shadow: 0 0 0 2.5px #00b7f1cc, 0 3px 12px #cce7f955;
  background: #e1f4fb;
}

.ai-gen-select option {
  background: #fff;
  color: #1976d2;
}

.ai-gen-btn {
  margin-top: 14px;
  padding: 14px 0;
  border-radius: 13px;
  font-size: 18px;
  font-weight: bold;
  background: #1b98d7;
  color: #fff;
  border: none;
  width: 100%;
  max-width: 360px;
  box-shadow: 0 6px 20px #b3e5fc3a;
  cursor: pointer;
  transition: background 0.14s, box-shadow 0.14s, transform 0.08s;
  position: relative;
  overflow: visible;
}

.ai-gen-btn::after {
  content: '';
  position: absolute;
  left: -10px;
  top: 50%;
  transform: translateY(-50%);
  width: 100px;
  height: 100px;
  background-image: url('robot_bear.png');
  background-size: contain;
  background-repeat: no-repeat;
  pointer-events: none;
  z-index: 1;
}

.ai-gen-btn:active {
  background: #1b6094;
  box-shadow: 0 2px 8px #b3e5fc1a;
  transform: translateY(3px) scale(0.98);
}

/* --- クイズ空欄入力用 --- */
.blankInput {
  font-size: 16px;
  font-family: 'Tsukushi Mincho', 'Yu Mincho', 'YuMincho', 'MS Mincho', serif;
  text-align: center;
  margin: 0 2px;
  border-radius: 6px;
  border: 2px solid #cce7f9;
  background-color: #e6f8ff !important;
  outline: none;
  transition: border 0.2s;
  line-height: 1.2;
  padding: 4px 2px;
  writing-mode: vertical-rl;
  text-orientation: upright;
}

.blankInput:focus {
  border: 2px solid #00b7f1;
  box-shadow: 0 0 0 1px rgba(0, 183, 241, 0.2);
}

/* --- 入力欄 正解/不正解カラー --- */
.blankInput.correct {
  background-color: #e3f2fd !important;
  border-color: #00b7f1 !important;
  color: #00b7f1 !important;
}

.blankInput.wrong {
  background-color: #ffeaea !important;
  border-color: #d81b60 !important;
  color: #d81b60 !important;
}

/* --- 大きな緑の〇のスタイル --- */
.big-green-circle {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%) scale(0);
  width: 300px;
  height: 300px;
  border: 12px solid #4CAF50;
  border-radius: 50%;
  background: rgba(76, 175, 80, 0.1);
  z-index: 10000;
  display: none;
  animation: circleAppear 2s ease-out forwards;
}

@keyframes circleAppear {
  0% {
    transform: translate(-50%, -50%) scale(0);
    opacity: 0;
  }
  50% {
    transform: translate(-50%, -50%) scale(1.2);
    opacity: 1;
  }
  100% {
    transform: translate(-50%, -50%) scale(1);
    opacity: 0;
  }
}

/* --- 大きな赤い×のスタイル --- */
.big-red-cross {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%) scale(0);
  width: 300px;
  height: 300px;
  z-index: 10000;
  display: none;
  animation: crossAppear 2s ease-out forwards;
}

.big-red-cross::before,
.big-red-cross::after {
  content: '';
  position: absolute;
  top: 50%;
  left: 50%;
  width: 80%;
  height: 12px;
  background: #f44336;
  border-radius: 6px;
}

.big-red-cross::before {
  transform: translate(-50%, -50%) rotate(45deg);
}

.big-red-cross::after {
  transform: translate(-50%, -50%) rotate(-45deg);
}

@keyframes crossAppear {
  0% {
    transform: translate(-50%, -50%) scale(0);
    opacity: 0;
  }
  50% {
    transform: translate(-50%, -50%) scale(1.2);
    opacity: 1;
  }
  100% {
    transform: translate(-50%, -50%) scale(1);
    opacity: 0;
  }
}

/* スライドアニメーション */
.slide-animation-container {
  position: relative;
  overflow: hidden;
  width: 100%;
}

.problem-content {
  transition: transform 0.5s cubic-bezier(0.4, 0, 0.2, 1);
  width: 100%;
}

.problem-content.slide-out-left {
  transform: translateX(-100%);
  opacity: 0;
}

.problem-content.slide-in-right {
  transform: translateX(100%);
  opacity: 0;
}

.problem-content.slide-center {
  transform: translateX(0);
  opacity: 1;
}

/* 問題切り替えアニメーション */
@keyframes slideOutLeft {
  from {
    transform: translateX(0);
    opacity: 1;
  }
  to {
    transform: translateX(-100%);
    opacity: 0;
  }
}

@keyframes slideInRight {
  from {
    transform: translateX(100%);
    opacity: 0;
  }
  to {
    transform: translateX(0);
    opacity: 1;
  }
}

.slide-out {
  animation: slideOutLeft 0.5s cubic-bezier(0.4, 0, 0.2, 1) forwards;
}

.slide-in {
  animation: slideInRight 0.5s cubic-bezier(0.4, 0, 0.2, 1) forwards;
}

/* --- 折りたたみ（左下）miniウィンドウ --- */
#quizFoldMini {
  position: fixed;
  left: 18px;
  top: 18px;
  background: #fff;
  border: 2px solid #00b7f1;
  border-radius: 15px;
  box-shadow: 0 2px 12px rgba(0, 0, 0, 0.10);
  padding: 10px 18px;
  font-size: 16px;
  display: none;
  z-index: 5000;
  animation: fadeInMini 0.25s;
}

@keyframes fadeInMini {
  from { opacity: 0; transform: scale(0.95); }
  to   { opacity: 1; transform: scale(1); }
}

#quizFoldMini .restoreQuizBtn {
  background: #00b7f1;
  color: #fff;
  border: none;
  border-radius: 8px;
  font-size: 15px;
  padding: 6px 18px;
  margin-left: 14px;
  cursor: pointer;
  transition: background 0.2s;
}

#quizFoldMini .restoreQuizBtn:hover {
  background: #008ecb;
}

/* --- 青ボタン --- */
.blue-btn, .toTextBtn {
  background: #00b7f1;
  color: #fff;
  border: none;
  border-radius: 22px;
  font-size: 18px;
  font-weight: bold;
  padding: 11px 34px;
  margin: 10px 10px 0 0;
  cursor: pointer;
  transition: background 0.15s;
  box-shadow: 0 2px 8px rgba(0, 183, 241, 0.08);
}

.blue-btn:hover, .toTextBtn:hover {
  background: #17416a;
}

/* スピナーCSS */
.spinner {
  border: 6px solid #e0e0e0;
  border-top: 6px solid #00b7f1;
  border-radius: 50%;
  width: 48px;
  height: 48px;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

.accuracy-gauge {
  width: 80%;
  height: 24px;
  background: #f0f0f0;
  border-radius: 12px;
  margin: 20px auto;
  position: relative;
  overflow: hidden;
}

.gauge-background {
  position: absolute;
  width: 100%;
  height: 100%;
  background: #e0e0e0;
}

.gauge-fill {
  position: absolute;
  width: 0%;
  height: 100%;
  background: #00b7f1;
  transition: width 1.5s cubic-bezier(0.4, 0, 0.2, 1);
  border-radius: 12px;
  right: 0;
  transform-origin: right;
}

@keyframes scorePop {
  0% { transform: scale(0.5); opacity: 0; }
  50% { transform: scale(1.2); }
  100% { transform: scale(1); opacity: 1; }
}

.score-pop {
  animation: scorePop 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
}

.grade-percent {
  opacity: 0;
}

#readerBox {
  background: #e6f8ff;
  padding: 36px;
  border-radius: 20px;
  margin-top: 20px;
}

.generate-button {
    background-color: #4a90e2;
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 5px;
    cursor: pointer;
    font-size: 16px;
    transition: background-color 0.3s;
    position: relative;
    padding-left: 50px; /* 画像のためのスペースを確保 */
}

.generate-button:hover {
    background-color: #336ba3;
}

.generate-button img {
    position: absolute;
    left: 10px;
    top: 50%;
    transform: translateY(-50%);
    width: 30px;
    height: 30px;
}

.nav-btn {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 4px;
  padding: 6px 12px;
  min-width: 64px;
  background: #00b7f1;
  color: #fff;
  border: none;
  border-radius: 20px;
  cursor: pointer;
  font-weight: bold;
  transition: background 0.2s;
}

.nav-btn:hover {
  background: #2f74b5;
}

.nav-btn svg {
  fill: currentColor;
}

.fillin-input {
    width: 100px;
    padding: 5px;
    margin: 0 5px;
    border: 1px solid #ccc;
    border-radius: 4px;
}

.result-message {
    margin-top: 20px;
    font-weight: bold;
    text-align: center;
}

/* --- 確認問題 見出しフォント/色 --- */
.quiz-box h3 {
  font-family: "Meiryo", sans-serif !important;
  color: #00b7f1 !important;
}
/* --- オンスクリーンキーボード --- */
.keyboard-overlay { position: fixed; left: 0; right: 0; bottom: 0; background:#f5d67a; box-shadow: 0 -4px 12px rgba(0,0,0,.18); padding: 16px; z-index: 10000; display:flex; justify-content:center; align-items:center; }
.keyboard-box { display:grid; grid-template-columns: repeat(10, 1fr); gap:8px; width:calc(100% - 20px); max-width:640px; }
.keyboard-box button { font-size:20px; padding:12px 8px; border:2px solid #ddd; border-radius:8px; background:#ffffff; color:#333; cursor:pointer; transition:background .14s; font-weight:500; min-height:44px; }
.keyboard-box button:hover { background:#f0f0f0; }
.keyboard-box button.control { background:#666; color:#fff; font-size:16px; }
.keyboard-box button.control:hover { background:#555; }

/* === 立体購入ボタンスタイル === */
.buy-btn {
  background: linear-gradient(135deg, #b3e5fc 0%, #87ceeb 50%, #5dccf0 100%) !important;
  color: #fff !important;
  border: 2px solid #29b6f6 !important;
  border-radius: 20px !important;
  padding: 12px 24px !important;
  font-size: 16px !important;
  font-weight: 700 !important;
  cursor: pointer !important;
  transition: all 0.15s ease !important;
  box-shadow: 
    0 6px 0 #039be5,
    0 8px 15px rgba(87, 206, 240, 0.4),
    inset 0 1px 0 rgba(255, 255, 255, 0.5),
    inset 0 -1px 0 rgba(0, 0, 0, 0.1) !important;
  position: relative !important;
  user-select: none !important;

  font-family: 'Arial', sans-serif !important;
  letter-spacing: 0.5px !important;
  min-width: 100px !important;
  text-align: center !important;
}

.buy-btn:hover:not(:disabled) {
  background: linear-gradient(135deg, #e1f5fe 0%, #b3e5fc 50%, #81d4fa 100%) !important;
  transform: translateY(-2px) !important;
  box-shadow: 
    0 8px 0 #039be5,
    0 12px 20px rgba(87, 206, 240, 0.5),
    inset 0 1px 0 rgba(255, 255, 255, 0.6),
    inset 0 -1px 0 rgba(0, 0, 0, 0.1) !important;
}

.buy-btn:active:not(:disabled) {
  background: linear-gradient(135deg, #b3e5fc 0%, #87ceeb 50%, #4fc3f7 100%) !important;
  transform: translateY(4px) !important;
  box-shadow: 
    0 2px 0 #039be5,
    0 4px 8px rgba(87, 206, 240, 0.3),
    inset 0 1px 0 rgba(255, 255, 255, 0.4),
    inset 0 -1px 0 rgba(0, 0, 0, 0.2) !important;
}

.buy-btn:disabled {
  background: #e0e0e0 !important;
  color: #9e9e9e !important;
  border-color: #bdbdbd !important;
  cursor: not-allowed !important;
  box-shadow: none !important;
  transform: none !important;
}

/* --- AI Loading Overlay --- */
/* === 洗練された文法メニューのスタイル === */
.grammar-menu {
  display: flex;
  flex-direction: column;
  gap: 24px;
  max-width: 900px;
  margin: 0 auto;
  padding: 60px 20px;
}

.grammar-item {
  background: #ffffff;
  border-radius: 12px;
  padding: 24px 32px;
  box-shadow: 
    0 1px 3px rgba(0, 0, 0, 0.12),
    0 1px 2px rgba(0, 0, 0, 0.06);
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  cursor: pointer;
  position: relative;
  overflow: hidden;
  display: flex;
  flex-direction: row;
  align-items: center;
  min-height: 120px;
  border: 2px solid transparent; /* 透明な枠線で安定したアニメーション */
}

.grammar-item:hover {
  transform: translateY(-4px);
  box-shadow: 
    0 10px 15px -3px rgba(0, 0, 0, 0.1),
    0 4px 6px -2px rgba(0, 0, 0, 0.05);
  border: 2px solid #ea580c; /* 文法トレーニングのオレンジ色枠線 */
}

/* ホバー時の左側の線を削除
.grammar-item::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  bottom: 0;
  width: 6px;
  background: linear-gradient(180deg, #FF6B35 0%, #FF9500 100%);
  opacity: 0;
  transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  border-radius: 12px 0 0 12px;
  z-index: 1;
}

.grammar-item:hover::before {
  opacity: 1;
  width: 100px;
}
*/

.grammar-item-header {
  display: flex;
  align-items: center;
  gap: 20px;
  margin-right: 32px;
  flex-shrink: 0;
}

.grammar-item-number {
  font-size: 48px;
  font-weight: 300;
  color: #ea580c;
  line-height: 1;
  letter-spacing: -2px;
  font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, sans-serif;
}

.grammar-item:hover .grammar-item-number {
  color: #c2410c;
}

.grammar-item-category {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 2px;
  padding: 8px 16px;
  background: #f0fdf4;
  border-radius: 100px;
  margin-bottom: 4px;
}

.category-en {
  font-size: 11px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 1.5px;
  color: #16a34a;
  line-height: 1;
}

.category-jp {
  font-size: 10px;
  font-weight: 500;
  color: #22c55e;
  line-height: 1;
}

.grammar-item-content {
  flex: 1;
  display: flex;
  flex-direction: column;
  justify-content: center;
  gap: 8px;
}

.grammar-item-title {
  font-size: 20px;
  font-weight: 600;
  color: #111827;
  line-height: 1.2;
  letter-spacing: -0.025em;
  font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, sans-serif;
}

.grammar-item-description {
  font-size: 14px;
  color: #6b7280;
  line-height: 1.5;
  font-weight: 400;
  letter-spacing: 0.01em;
}

.grammar-item-right {
  display: flex;
  flex-direction: column;
  align-items: flex-end;
  justify-content: center;
  gap: 16px;
  flex-shrink: 0;
  min-width: 100px;
}

.grammar-item-progress {
  display: flex;
  align-items: center;
  gap: 12px;
  width: 100%;
  margin-top: 8px;
}

.progress-text {
  font-size: 11px;
  color: #9ca3af;
  font-weight: 500;
  white-space: nowrap;
  flex-shrink: 0;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.progress-boxes {
  flex: 1;
  display: flex;
  gap: 4px;
  align-items: center;
}

.progress-box {
  width: 16px;
  height: 16px;
  background: #f0fdf4;
  border: none;
  transition: all 0.3s ease;
  position: relative;
}

.progress-box.filled {
  background: #ea580c;
  border-color: #f97316;
}

.progress-numbers {
  font-size: 14px;
  color: #374151;
  font-weight: 500;
  white-space: nowrap;
  flex-shrink: 0;
  font-family: 'Inter', 'Helvetica Neue', -apple-system, BlinkMacSystemFont, sans-serif;
  letter-spacing: -0.01em;
}

.grammar-item-action {
  display: flex;
  align-items: center;
  gap: 8px;
  color: #ea580c;
  font-weight: 500;
  font-size: 13px;
  transition: all 0.3s ease;
}

.action-text {
  letter-spacing: 0.01em;
}

.action-arrow {
  font-size: 16px;
  transform: translateX(0);
  transition: transform 0.3s ease;
}

.grammar-item:hover .action-arrow {
  transform: translateX(4px);
}

.grammar-item:hover .grammar-item-action {
  color: #c2410c;
}

/* Progress bar animations */
@keyframes progressPulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.8; }
}

.progress-fill::after {
  content: '';
  position: absolute;
  top: 0;
  right: 0;
  bottom: 0;
  width: 30px;
  background: linear-gradient(90deg, transparent, rgba(255,255,255,0.5), transparent);
  animation: progressPulse 2s ease-in-out infinite;
}

/* レスポンシブ対応 */
@media (max-width: 768px) {
  .grammar-menu {
    padding: 40px 16px;
    gap: 20px;
  }

  .grammar-item {
    flex-direction: column;
    align-items: flex-start;
    padding: 20px;
    min-height: auto;
  }

  .grammar-item-header {
    margin-right: 0;
    margin-bottom: 16px;
    width: 100%;
    justify-content: center;
    align-items: center;
  }

  .grammar-item-content {
    margin-bottom: 16px;
  }

  .grammar-item-right {
    width: 100%;
    align-items: flex-end;
    min-width: auto;
  }
  
  .grammar-item-progress {
    width: 100%;
    margin-top: 6px;
  }

  .grammar-item-number {
    font-size: 36px;
  }

  .grammar-item-title {
    font-size: 18px;
  }

  .progress-boxes {
    gap: 3px;
  }
  
  .progress-box {
    width: 14px;
    height: 14px;
  }
}

/* === プロフェッショナル文法下位メニューデザイン === */
.grammar-submenu {
  display: flex !important;
  flex-direction: column !important;
  gap: 24px !important;
  max-width: 850px !important;
  margin: 0 auto !important;
  padding: 0 24px !important;
}

.grammar-submenu-item {
  background: linear-gradient(135deg, #ffffff 0%, #fafafa 100%) !important;
  border-radius: 20px !important;
  padding: 0 !important;
  box-shadow: 
    0 4px 6px -1px rgba(0, 0, 0, 0.1),
    0 2px 4px -1px rgba(0, 0, 0, 0.06),
    0 0 0 1px rgba(0, 0, 0, 0.05) !important;
  transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) !important;
  cursor: pointer !important;
  position: relative !important;
  overflow: hidden !important;
  display: flex !important;
  flex-direction: row !important;
  align-items: stretch !important;
  min-height: 140px !important;
  border: 2px solid transparent !important;
  width: auto !important;
  height: auto !important;
  text-align: left !important;
  backdrop-filter: blur(10px) !important;
}

.grammar-submenu-item::before {
  content: '' !important;
  position: absolute !important;
  top: 0 !important;
  left: 0 !important;
  right: 0 !important;
  bottom: 0 !important;
  background: linear-gradient(135deg, rgba(22, 163, 74, 0.02) 0%, rgba(22, 163, 74, 0.08) 100%) !important;
  opacity: 0 !important;
  transition: opacity 0.3s ease !important;
  border-radius: 20px !important;
  z-index: 1 !important;
}

.grammar-submenu-item:hover {
  transform: translateY(-8px) scale(1.02) !important;
  box-shadow: 
    0 20px 25px -5px rgba(0, 0, 0, 0.15),
    0 10px 10px -5px rgba(0, 0, 0, 0.04) !important;
  border: 2px solid #ea580c !important;
}

.grammar-submenu-item:hover::before {
  opacity: 1 !important;
}

.grammar-submenu-item-header {
  display: none !important;
}

/* 難易度表示関連のCSS削除 */

.grammar-submenu-item-content {
  flex: 1 !important;
  display: flex !important;
  flex-direction: column !important;
  justify-content: center !important;
  gap: 12px !important;
  padding: 32px 28px !important;
  position: relative !important;
  z-index: 2 !important;
}

.grammar-submenu-item-title {
  font-size: 20px !important;
  font-weight: 700 !important;
  color: #1f2937 !important;
  line-height: 1.25 !important;
  letter-spacing: -0.025em !important;
  font-family: 'Inter', 'SF Pro Display', -apple-system, BlinkMacSystemFont, sans-serif !important;
  margin-bottom: 6px !important;
  text-shadow: none !important;
  transition: color 0.3s ease !important;
}

.grammar-submenu-item-description {
  font-size: 15px !important;
  color: #6b7280 !important;
  line-height: 1.6 !important;
  font-weight: 500 !important;
  letter-spacing: 0.01em !important;
  opacity: 1 !important;
  text-shadow: none !important;
  font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif !important;
  transition: color 0.3s ease !important;
}

.grammar-submenu-item:hover .grammar-submenu-item-title {
  color: #9a3412 !important;
}

.grammar-submenu-item:hover .grammar-submenu-item-description {
  color: #374151 !important;
}

.grammar-submenu-item-right {
  display: flex !important;
  flex-direction: column !important;
  align-items: center !important;
  justify-content: center !important;
  gap: 12px !important;
  flex-shrink: 0 !important;
  min-width: 120px !important;
  padding: 32px 32px 32px 16px !important;
  position: relative !important;
  z-index: 2 !important;
}

.grammar-submenu-item-action {
  display: flex !important;
  align-items: center !important;
  justify-content: center !important;
  gap: 8px !important;
  color: #ffffff !important;
  font-weight: 600 !important;
  font-size: 14px !important;
  transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) !important;
  background: linear-gradient(135deg, #ea580c 0%, #c2410c 100%) !important;
  border-radius: 50px !important;
  padding: 12px 20px !important;
  box-shadow: 0 4px 6px -1px rgba(234, 88, 12, 0.3) !important;
  font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif !important;
  letter-spacing: 0.5px !important;
  text-transform: uppercase !important;
  border: none !important;
  cursor: pointer !important;
  position: relative !important;
  overflow: hidden !important;
}

.grammar-submenu-item-action::before {
  content: '' !important;
  position: absolute !important;
  top: 0 !important;
  left: -100% !important;
  width: 100% !important;
  height: 100% !important;
  background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent) !important;
  transition: left 0.6s ease !important;
}

.grammar-submenu-item:hover .grammar-submenu-item-action::before {
  left: 100% !important;
}

.grammar-submenu-item-action .action-text {
  letter-spacing: 0.5px !important;
  position: relative !important;
  z-index: 1 !important;
}

.grammar-submenu-item-action .action-arrow {
  font-size: 14px !important;
  transform: translateX(0) !important;
  transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) !important;
  position: relative !important;
  z-index: 1 !important;
}

.grammar-submenu-item:hover .action-arrow {
  transform: translateX(6px) !important;
}

.grammar-submenu-item:hover .grammar-submenu-item-action {
  background: linear-gradient(135deg, #c2410c 0%, #9a3412 100%) !important;
  box-shadow: 0 8px 12px -3px rgba(234, 88, 12, 0.4) !important;
  transform: translateY(-2px) scale(1.05) !important;
}

/* プロフェッショナルレスポンシブ対応 */
@media (max-width: 768px) {
  .grammar-submenu {
    padding: 0 16px !important;
    gap: 20px !important;
  }

  .grammar-submenu-item {
    flex-direction: column !important;
    align-items: stretch !important;
    min-height: auto !important;
    border-radius: 16px !important;
  }

  .grammar-submenu-item-header {
    display: none !important;
  }

  .grammar-submenu-item-content {
    padding: 24px 20px 16px 20px !important;
    width: 100% !important;
    order: 1 !important;
  }

  .grammar-submenu-item-right {
    width: 100% !important;
    align-items: center !important;
    min-width: auto !important;
    padding: 0 20px 20px 20px !important;
    order: 2 !important;
  }

  .grammar-submenu-item-title {
    font-size: 18px !important;
  }

  .grammar-submenu-item-description {
    font-size: 14px !important;
  }

  .grammar-submenu-item-action {
    width: 100% !important;
    padding: 14px 24px !important;
    justify-content: center !important;
  }
}

/* === 古いgrammar-itemの装飾を無効化 === */
.grammar-item::before,
.grammar-item:hover::before,
.grammar-item::after,
.grammar-item:hover::after {
  display: none !important;
  content: none !important;
  opacity: 0 !important;
}

</style>
<script src="https://unpkg.com/wanakana"></script>
</head>
<div id="countdownOverlay" style="
  position:fixed;z-index:99999;inset:0;display:none;
  align-items:center;justify-content:center;
  background:rgba(0,0,0,0.25);
">
  <div id="countdownNum" style="
    font-size:86px;
    font-weight:bold;
    font-family: century;
    color:#2563eb;
    background:#fff;
    border-radius:100px;
    padding:42px 68px;
    box-shadow:0 8px 32px #00b7f138;
    border:4px solid #a8dffc;
    text-align:center;
  "></div>
</div>
<!-- AIローディングオーバーレイ -->
<div id="aiLoadingOverlay" style="
  display:none;position:fixed;z-index:99999;inset:0;
  background:rgba(255,255,255,0.85);align-items:center;justify-content:center;
">
  <div style="display:flex;flex-direction:column;align-items:center;gap:18px;">
    <div class="spinner"></div>
          <div style="font-size:20px;color:#2563eb;font-weight:bold;">しろくまAIが文章を生成中…</div>
    <div style="font-size:13px;color:#888;">最大30秒かかることがあります</div>
  </div>
</div>
<body>
<!-- 正解時アニメーション用コンテナ -->
<div id="successAnimationContainer" class="success-animation-container">
  <div class="success-particles" id="successParticles"></div>
  <div class="success-burst"></div>
  <div class="success-ring" style="width: 100px; height: 100px; animation-delay: 0s;"></div>
  <div class="success-ring" style="width: 150px; height: 150px; animation-delay: 0.2s;"></div>
  <div class="success-ring" style="width: 200px; height: 200px; animation-delay: 0.4s;"></div>
  <div class="success-main-message" id="successMessage">正解！！</div>
</div>

<!-- ===== ラベル ===== -->
<div class="reading-label" id="readingLabel">
  <span class="eq"><i></i><i></i><i></i><i></i></span> 音読採点中…
</div>
<!-- ---------- HEADER ---------- -->
<div class="header" id="header">
  <div style="display:flex;align-items:center;justify-content:center;gap:18px;">
    <img src="dog.png" alt="音読プラス ロゴ" style="width:120px;display:block;">
    <div style="display:flex;flex-direction:column;align-items:flex-start;">
    <span style="font-size:16px;color:#fff;font-weight:normal;letter-spacing:1px;margin-bottom:0;">国語力が道をひらく。</span>
      <img src="Kovia.png" alt="Kovia" style="height:60px;display:block;">
    </div>
  </div>
</div>


<!-- ---------- MAIN ---------- -->
<div class="container">

  <!-- ホーム画面 -->
  <div class="box show" id="homeBox">
    <div class="dashboard" id="dashboard">
      <div class="profile">
        <span class="avatar" style="background:#e6e6e6;display:flex;align-items:center;justify-content:center;">
          <svg width="38" height="38" viewBox="0 0 38 38" fill="none">
            <circle cx="19" cy="19" r="19" fill="#e6e6e6"/>
            <ellipse cx="19" cy="14" rx="6.3" ry="6.2" fill="#bbb"/>
            <ellipse cx="19" cy="27.7" rx="11" ry="7.1" fill="#bbb"/>
          </svg>
        </span>
        <div>
          <div class="username" id="dashboardUsername">ゲスト</div>
          <div class="level"><span id="userLevel">9級</span></div>
        </div>
      </div>
      <div class="stats">
        <div class="stat">
          <div class="stat-label">🔊総音読回数</div>
          <div class="stat-num">
            <span id="statTotal">0</span>
          </div>
        </div>
        <div class="stat">
          <div class="stat-label">🏅クリアした文章数</div>
          <div class="stat-num">
            <span id="statLesson">0</span>
          </div>
        </div>
      </div>
      <!-- ▼▼▼ダッシュボード用 宝物カウント▼▼▼ -->
      <div class="treasures-dashboard" id="treasuresDashboard">
        <span class="treasures-dashboard-title">獲得した報酬</span>
        <div class="treasure-row">
          <div class="treasure-card" style="display: flex !important; flex-direction: row !important; align-items: center !important; gap: 8px !important;">
            <span class="treasure-icon treasure-diamond" style="margin: 0 !important;"><img src="diamond.png" alt="💎" style="display: inline; width: 1em; height: 1em; vertical-align: middle;"></span>
            <span id="dashboardDiamondCount" class="treasure-num treasure-diamond">0</span>
          </div>
        </div>
        <!-- 宝石交換ボタンを追加 -->
        <button id="gemExchangeBtn" onclick="showGemExchangeScreen()" class="gem-exchange-button">
          宝石交換所へ
        </button>
      </div>
    </div>

    <!-- ▼音読するボタン 2つに分岐（既存・AI生成）▼ -->
    <!-- ベン図メニューボタン -->
    <div class="venn-diagram-container" style="display: flex; justify-content: center; align-items: center; margin: 32px 0;">
      <svg width="400" height="340" viewBox="0 0 400 340" style="cursor: pointer;">
        <defs>
          <!-- グラデーション定義 -->
          <linearGradient id="blueGradient" x1="0%" y1="0%" x2="100%" y2="100%">
            <stop offset="0%" style="stop-color:#7dd3fc;stop-opacity:0.8" />
            <stop offset="100%" style="stop-color:#0ea5e9;stop-opacity:0.6" />
          </linearGradient>
          <linearGradient id="orangeGradient" x1="0%" y1="0%" x2="100%" y2="100%">
            <stop offset="0%" style="stop-color:#fed7aa;stop-opacity:0.8" />
            <stop offset="100%" style="stop-color:#f97316;stop-opacity:0.6" />
          </linearGradient>
          <linearGradient id="purpleGradient" x1="0%" y1="0%" x2="100%" y2="100%">
            <stop offset="0%" style="stop-color:#e9d5ff;stop-opacity:0.8" />
            <stop offset="100%" style="stop-color:#a855f7;stop-opacity:0.6" />
          </linearGradient>
          <linearGradient id="greenGradient" x1="0%" y1="0%" x2="100%" y2="100%">
            <stop offset="0%" style="stop-color:#bbf7d0;stop-opacity:0.8" />
            <stop offset="100%" style="stop-color:#22c55e;stop-opacity:0.6" />
          </linearGradient>
          
          <!-- 影とグロー効果 -->
          <filter id="buttonShadow" x="-50%" y="-50%" width="200%" height="200%">
            <feDropShadow dx="0" dy="4" flood-opacity="0.25" flood-color="black"/>
            <feDropShadow dx="0" dy="2" flood-opacity="0.15" flood-color="white"/>
          </filter>
          
          <filter id="textGlow" x="-50%" y="-50%" width="200%" height="200%">
            <feDropShadow dx="1" dy="1" stdDeviation="1" flood-opacity="0.8"/>
            <feDropShadow dx="0" dy="0" stdDeviation="3" flood-opacity="0.4"/>
          </filter>
          
          <!-- 各トレーニング用の色付き影フィルター -->
          <filter id="blueTextShadow" x="-50%" y="-50%" width="200%" height="200%">
            <feDropShadow dx="2" dy="2" stdDeviation="1" flood-color="#0066cc" flood-opacity="0.7"/>
          </filter>
          
          <filter id="orangeTextShadow" x="-50%" y="-50%" width="200%" height="200%">
            <feDropShadow dx="2" dy="2" stdDeviation="1" flood-color="#ff6600" flood-opacity="0.7"/>
          </filter>
          
          <filter id="purpleTextShadow" x="-50%" y="-50%" width="200%" height="200%">
            <feDropShadow dx="2" dy="2" stdDeviation="1" flood-color="#8800cc" flood-opacity="0.7"/>
          </filter>
          
          <filter id="greenTextShadow" x="-50%" y="-50%" width="200%" height="200%">
            <feDropShadow dx="2" dy="2" stdDeviation="1" flood-color="#00aa44" flood-opacity="0.7"/>
          </filter>
        </defs>
        
        <!-- 全ての円を同じレイヤーで描画、mix-blend-modeで重なり部分を自然に -->
        <g id="circleGroup" style="mix-blend-mode: multiply;">
          <!-- 青色円 - 音読トレーニング -->
          <circle id="venn-reading" cx="130" cy="110" r="95" 
                  fill="url(#blueGradient)" stroke="#2563eb" stroke-width="3"
                  filter="url(#buttonShadow)"
                  style="cursor: pointer; transition: all 0.1s ease;"
                  onmouseover="this.setAttribute('r', '105'); this.setAttribute('stroke-width', '4'); 
                              document.getElementById('venn-reading-furigana').setAttribute('font-size', '12');
                              document.getElementById('venn-reading-text').setAttribute('font-size', '18');
                              document.getElementById('venn-reading-text').setAttribute('y', '98');
                              document.getElementById('venn-reading-text').querySelector('tspan:last-child').setAttribute('dy', '18');
                              this.parentNode.appendChild(this);
                              this.parentNode.parentNode.appendChild(document.getElementById('venn-reading-furigana'));
                              this.parentNode.parentNode.appendChild(document.getElementById('venn-reading-text'));"
                  onmouseout="this.setAttribute('r', '95'); this.setAttribute('stroke-width', '3');
                              document.getElementById('venn-reading-furigana').setAttribute('font-size', '10');
                              document.getElementById('venn-reading-text').setAttribute('font-size', '16');
                              document.getElementById('venn-reading-text').setAttribute('y', '95');
                              document.getElementById('venn-reading-text').querySelector('tspan:last-child').setAttribute('dy', '16');"
                  onclick="document.getElementById('goReadingTrainingBtn').click();">
          </circle>
          
          <!-- 緑色円 - 文法トレーニング -->
          <circle id="venn-grammar" cx="270" cy="110" r="95" 
                  fill="url(#orangeGradient)" stroke="#ea580c" stroke-width="3"
                  filter="url(#buttonShadow)"
                  style="cursor: pointer; transition: all 0.1s ease;"
                  onmouseover="this.setAttribute('r', '105'); this.setAttribute('stroke-width', '4');
                              document.getElementById('venn-grammar-furigana').setAttribute('font-size', '12');
                              document.getElementById('venn-grammar-text').setAttribute('font-size', '18');
                              document.getElementById('venn-grammar-text').setAttribute('y', '98');
                              document.getElementById('venn-grammar-text').querySelector('tspan:last-child').setAttribute('dy', '18');
                              this.parentNode.appendChild(this);
                              this.parentNode.parentNode.appendChild(document.getElementById('venn-grammar-furigana'));
                              this.parentNode.parentNode.appendChild(document.getElementById('venn-grammar-text'));"
                  onmouseout="this.setAttribute('r', '95'); this.setAttribute('stroke-width', '3');
                              document.getElementById('venn-grammar-furigana').setAttribute('font-size', '10');
                              document.getElementById('venn-grammar-text').setAttribute('font-size', '16');
                              document.getElementById('venn-grammar-text').setAttribute('y', '95');
                              document.getElementById('venn-grammar-text').querySelector('tspan:last-child').setAttribute('dy', '16');"
                  onclick="document.getElementById('goGrammarTrainingBtn').click();">
          </circle>
          
          <!-- 紫色円 - 漢字・語彙トレーニング -->
          <circle id="venn-kanji" cx="130" cy="230" r="95" 
                  fill="url(#purpleGradient)" stroke="#9333ea" stroke-width="3"
                  filter="url(#buttonShadow)"
                  style="cursor: pointer; transition: all 0.1s ease;"
                  onmouseover="this.setAttribute('r', '105'); this.setAttribute('stroke-width', '4');
                              document.getElementById('venn-kanji-furigana').setAttribute('font-size', '12');
                              document.getElementById('venn-kanji-text').setAttribute('font-size', '18');
                              document.getElementById('venn-kanji-text').setAttribute('y', '258');
                              document.getElementById('venn-kanji-text').querySelector('tspan:last-child').setAttribute('dy', '18');
                              this.parentNode.appendChild(this);
                              this.parentNode.parentNode.appendChild(document.getElementById('venn-kanji-furigana'));
                              this.parentNode.parentNode.appendChild(document.getElementById('venn-kanji-text'));"
                  onmouseout="this.setAttribute('r', '95'); this.setAttribute('stroke-width', '3');
                              document.getElementById('venn-kanji-furigana').setAttribute('font-size', '10');
                              document.getElementById('venn-kanji-text').setAttribute('font-size', '16');
                              document.getElementById('venn-kanji-text').setAttribute('y', '255');
                              document.getElementById('venn-kanji-text').querySelector('tspan:last-child').setAttribute('dy', '16');"
                  onclick="document.getElementById('goKanjiVocabBtn').click();">
          </circle>
          
          <!-- オレンジ色円 - 論理トレーニング -->
          <circle id="venn-logic" cx="270" cy="230" r="95" 
                  fill="url(#greenGradient)" stroke="#16a34a" stroke-width="3"
                  filter="url(#buttonShadow)"
                  style="cursor: pointer; transition: all 0.1s ease;"
                  onmouseover="this.setAttribute('r', '105'); this.setAttribute('stroke-width', '4');
                              document.getElementById('venn-logic-furigana').setAttribute('font-size', '12');
                              document.getElementById('venn-logic-text').setAttribute('font-size', '18');
                              document.getElementById('venn-logic-text').setAttribute('y', '258');
                              document.getElementById('venn-logic-text').querySelector('tspan:last-child').setAttribute('dy', '18');
                              this.parentNode.appendChild(this);
                              this.parentNode.parentNode.appendChild(document.getElementById('venn-logic-furigana'));
                              this.parentNode.parentNode.appendChild(document.getElementById('venn-logic-text'));"
                  onmouseout="this.setAttribute('r', '95'); this.setAttribute('stroke-width', '3');
                              document.getElementById('venn-logic-furigana').setAttribute('font-size', '10');
                              document.getElementById('venn-logic-text').setAttribute('font-size', '16');
                              document.getElementById('venn-logic-text').setAttribute('y', '255');
                              document.getElementById('venn-logic-text').querySelector('tspan:last-child').setAttribute('dy', '16');"
                  onclick="document.getElementById('goLogicBtn').click();">
          </circle>
        </g>
        
        <!-- ラベル -->
        <!-- 音読トレーニング -->
        <!-- ふりがな -->
        <text id="venn-reading-furigana" x="110" y="78" text-anchor="middle" fill="white" font-size="10" font-weight="600" 
              filter="url(#blueTextShadow)" style="pointer-events: none; font-family: 'Helvetica Neue', Arial, sans-serif; letter-spacing: 1px; opacity: 0.9; transition: font-size 0.1s ease;">
          <tspan x="110" dy="0">おんどく</tspan>
        </text>
        <text id="venn-reading-text" x="110" y="95" text-anchor="middle" fill="white" font-size="16" font-weight="900" 
              filter="url(#blueTextShadow)" style="pointer-events: none; font-family: 'Helvetica Neue', Arial, sans-serif; letter-spacing: 0.5px; transition: font-size 0.1s ease;">
          <tspan x="110" dy="0">音読</tspan>
          <tspan x="110" dy="16">トレーニング</tspan>
        </text>
              
        <!-- 文法トレーニング -->
        <!-- ふりがな -->
        <text id="venn-grammar-furigana" x="290" y="78" text-anchor="middle" fill="white" font-size="10" font-weight="600" 
              filter="url(#orangeTextShadow)" style="pointer-events: none; font-family: 'Helvetica Neue', Arial, sans-serif; letter-spacing: 1px; opacity: 0.9; transition: font-size 0.1s ease;">
          <tspan x="290" dy="0">ぶんぽう</tspan>
        </text>
        <text id="venn-grammar-text" x="290" y="95" text-anchor="middle" fill="white" font-size="16" font-weight="900" 
              filter="url(#orangeTextShadow)" style="pointer-events: none; font-family: 'Helvetica Neue', Arial, sans-serif; letter-spacing: 0.5px; transition: font-size 0.1s ease;">
          <tspan x="290" dy="0">文法</tspan>
          <tspan x="290" dy="16">トレーニング</tspan>
        </text>
              
        <!-- 漢字・語彙トレーニング -->
        <!-- ふりがな -->
        <text id="venn-kanji-furigana" x="110" y="238" text-anchor="middle" fill="white" font-size="10" font-weight="600" 
              filter="url(#purpleTextShadow)" style="pointer-events: none; font-family: 'Helvetica Neue', Arial, sans-serif; letter-spacing: 1px; opacity: 0.9; transition: font-size 0.1s ease;">
          <tspan x="110" dy="0">かんじ・ごい</tspan>
        </text>
        <text id="venn-kanji-text" x="110" y="255" text-anchor="middle" fill="white" font-size="16" font-weight="900" 
              filter="url(#purpleTextShadow)" style="pointer-events: none; font-family: 'Helvetica Neue', Arial, sans-serif; letter-spacing: 0.5px; transition: font-size 0.1s ease;">
          <tspan x="110" dy="0">漢字・語彙</tspan>
          <tspan x="110" dy="16">トレーニング</tspan>
        </text>
              
        <!-- 論理トレーニング -->
        <!-- ふりがな -->
        <text id="venn-logic-furigana" x="290" y="238" text-anchor="middle" fill="white" font-size="10" font-weight="600" 
              filter="url(#greenTextShadow)" style="pointer-events: none; font-family: 'Helvetica Neue', Arial, sans-serif; letter-spacing: 1px; opacity: 0.9; transition: font-size 0.1s ease;">
          <tspan x="290" dy="0">ろんり</tspan>
        </text>
        <text id="venn-logic-text" x="290" y="255" text-anchor="middle" fill="white" font-size="16" font-weight="900" 
              filter="url(#greenTextShadow)" style="pointer-events: none; font-family: 'Helvetica Neue', Arial, sans-serif; letter-spacing: 0.5px; transition: font-size 0.1s ease;">
          <tspan x="290" dy="0">論理</tspan>
          <tspan x="290" dy="16">トレーニング</tspan>
        </text>
      </svg>
    </div>
    
    <!-- 元のボタンは非表示にして機能を保持 -->
    <button id="goReadingTrainingBtn" style="display: none;">音読トレーニング</button>
    <button id="goGrammarTrainingBtn" style="display: none;">文法トレーニング</button>
    <button id="goKanjiVocabBtn" style="display: none;">漢字・語彙トレーニング</button>
    <button id="goLogicBtn" style="display: none;">論理トレーニング</button>

    <div class="calendar-wrapper">
      <div class="calendar-title">今月の記録</div>
      <div class="calendar-week">
        <span>日</span><span>月</span><span>火</span><span>水</span><span>木</span><span>金</span><span>土</span>
      </div>
      <div id="calendar" class="calendar"></div>
      <!-- ▼▼▼ チャレンジをここに移動 ▼▼▼ -->
<div class="challenge" style="margin-top:24px;">
  <div class="challenge-title">🔥5日間続音読にチャレンジ</div>
  <div class="challenge-bar-wrapper">
    <span class="challenge-num"><span id="challengeDay">0</span>/5日</span>
    <div class="challenge-bar">
      <div class="challenge-progress" id="challengeProgress" style="width:0%"></div>
    </div>
  </div>
  <div class="challenge-desc">5日間連続音読でボーナスゲット！</div>
</div>

    </div>
  </div>

  <!-- カード選択画面 -->
  <div class="box" id="selectBox">
    <div style="width:100%;display:flex;justify-content:space-between;align-items:center;margin-bottom:18px;">
      <button id="selectBackBtn" class="home-btn">
        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
          <path d="M19 7v4H5.83l3.58-3.59L8 6l-6 6 6 6 1.41-1.41L5.83 13H21V7h-2z"/>
        </svg>
        <span>戻る</span>
      </button>
      <button id="selectHomeBtn" class="home-btn">
      <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
        <path d="M12 3 3 9.5v11a1 1 0 0 0 1 1h6v-6h4v6h6a1 1 0 0 0 1-1v-11L12 3z"/>
      </svg>
      <span>ホームへ</span>
    </button>
  </div>
  <div style="font-size:20px;font-weight:normal;color:#666;text-align:center;margin-bottom:12px;">
    音読する文章を選ぶ
  </div>
    <div class="cards" id="cardsContainer">
      <div class="card">
        <div class="bookmark"></div>
        <div class="title">ラプンツェル</div>
        <div class="illustration" style="background-image: url('rapuntuxeru.png');"></div>
        <div class="author">グリム童話</div>
        <div class="meta">レベル: 初級</div>
        <div class="card-buttons">
          <button class="start-btn" onclick="startText('${t.id}')">
            <svg viewBox="0 0 24 24" style="width: 18px; height: 18px; margin-right: 6px;">
              <path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm5.91-3c-.49 0-.9.36-.98.85C16.52 14.2 14.47 16 12 16s-4.52-1.8-4.93-4.15c-.08-.49-.49-.85-.98-.85-.61 0-1.09.54-1 1.14.49 3 2.89 5.35 5.91 5.78V20c0 .55.45 1 1 1s1-.45 1-1v-2.08c3.02-.43 5.42-2.78 5.91-5.78.1-.6-.39-1.14-1-1.14z" fill="currentColor"/>
            </svg>
            音読する
          </button>
          <div class="small-buttons">
            <button class="small-btn" onclick="readText('${t.id}')">解く</button>
            <button class="audio-btn" onclick="playAudio('${t.id}')" title="音声を聞く">
              <svg viewBox="0 0 24 24">
                <path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/>
              </svg>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- 宝石交換設定画面 -->
  <div class="box" id="gemExchangeBox">
    <div style="width:100%;display:flex;justify-content:space-between;align-items:center;margin-bottom:24px;">
      <button id="gemExchangeBackBtn" onclick="showBox(homeBox)" class="home-btn">
        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
          <path d="M19 7v4H5.83l3.58-3.59L8 6l-6 6 6 6 1.41-1.41L5.83 13H21V7h-2z"/>
        </svg>
        <span>戻る</span>
      </button>
      <button id="gemExchangeHomeBtn" onclick="showBox(homeBox)" class="home-btn">
        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
          <path d="M12 3 3 9.5v11a1 1 0 0 0 1 1h6v-6h4v6h6a1 1 0 0 0 1-1v-11L12 3z"/>
        </svg>
        <span>ホームへ</span>
      </button>
    </div>
    
    <div class="shop-container">
      <!-- ヘッダー -->
      <div class="shop-header">
        <h2 class="shop-title">宝石交換所</h2>
        <div class="shop-balance">
          <span class="balance-icon"><img src="diamond.png" alt="💎" style="display: inline; width: 1em; height: 1em; vertical-align: middle;"></span>
          <span id="currentDiamondCount">0</span>
        </div>
      </div>

      <!-- 商品リスト -->
      <div class="shop-items">
        <!-- カスタムアイテムがここに動的に追加されます -->
        <div id="customItemsList" class="custom-items-container">
          <!-- カスタムアイテムがここに表示されます -->
        </div>
        
        <div class="shop-item" data-item="ice-cream">
          <div class="item-info">
            <div class="item-icon">🍦</div>
            <div class="item-name">アイスクリーム</div>
          </div>
          <div class="item-price">
            <span class="price-gems"><img src="diamond.png" alt="💎" style="display: inline; width: 1em; height: 1em; vertical-align: middle;"> 10</span>
            <button class="buy-btn" onclick="buyItem('ice-cream', 'アイスクリーム', 10)">購入</button>
          </div>
        </div>

        <div class="shop-item" data-item="toy">
          <div class="item-info">
            <div class="item-icon">🧸</div>
            <div class="item-name">おもちゃ</div>
          </div>
          <div class="item-price">
            <span class="price-gems"><img src="diamond.png" alt="💎" style="display: inline; width: 1em; height: 1em; vertical-align: middle;"> 25</span>
            <button class="buy-btn" onclick="buyItem('toy', 'おもちゃ', 25)">購入</button>
          </div>
        </div>

        <div class="shop-item" data-item="snack">
          <div class="item-info">
            <div class="item-icon">🍿</div>
            <div class="item-name">おやつ</div>
          </div>
          <div class="item-price">
            <span class="price-gems"><img src="diamond.png" alt="💎" style="display: inline; width: 1em; height: 1em; vertical-align: middle;"> 15</span>
            <button class="buy-btn" onclick="buyItem('snack', 'おやつ', 15)">購入</button>
          </div>
        </div>

        <div class="shop-item" data-item="book">
          <div class="item-info">
            <div class="item-icon">📚</div>
            <div class="item-name">本</div>
          </div>
          <div class="item-price">
            <span class="price-gems"><img src="diamond.png" alt="💎" style="display: inline; width: 1em; height: 1em; vertical-align: middle;"> 20</span>
            <button class="buy-btn" onclick="buyItem('book', '本', 20)">購入</button>
          </div>
        </div>

        <div class="shop-item" data-item="game">
          <div class="item-info">
            <div class="item-icon">🎮</div>
            <div class="item-name">ゲーム時間</div>
          </div>
          <div class="item-price">
            <span class="price-gems"><img src="diamond.png" alt="💎" style="display: inline; width: 1em; height: 1em; vertical-align: middle;"> 30</span>
            <button class="buy-btn" onclick="buyItem('game', 'ゲーム時間', 30)">購入</button>
          </div>
        </div>

        <div class="shop-item" data-item="movie">
          <div class="item-info">
            <div class="item-icon">🎬</div>
            <div class="item-name">映画鑑賞</div>
          </div>
          <div class="item-price">
            <span class="price-gems"><img src="diamond.png" alt="💎" style="display: inline; width: 1em; height: 1em; vertical-align: middle;"> 50</span>
            <button class="buy-btn" onclick="buyItem('movie', '映画鑑賞', 50)">購入</button>
          </div>
        </div>
      </div>

      <!-- カスタムアイテム追加 -->
      <div class="custom-item-section">
        <h3 class="custom-title">オリジナルアイテム</h3>
        <div class="custom-form">
          <input type="text" id="customItemName" placeholder="アイテム名" class="custom-input">
          <input type="number" id="customItemPrice" placeholder="宝石数" min="1" max="1000" class="custom-input">
          <button onclick="addCustomItem()" class="add-custom-btn">追加</button>
        </div>

      </div>
    </div>
  </div>

  <!-- 具体と抽象問題画面 -->
  <div class="box" id="concreteAbstractBox">
    <div style="width:100%;display:flex;justify-content:space-between;align-items:center;margin-bottom:18px;">
      <button id="concreteAbstractBackBtn" class="home-btn">
        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
          <path d="M19 7v4H5.83l3.58-3.59L8 6l-6 6 6 6 1.41-1.41L5.83 13H21V7h-2z"/>
        </svg>
        <span>戻る</span>
      </button>
      <button id="concreteAbstractHomeBtn" class="home-btn">
        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
          <path d="M12 3 3 9.5v11a1 1 0 0 0 1 1h6v-6h4v6h6a1 1 0 0 0 1-1v-11L12 3z"/>
        </svg>
        <span>ホームへ</span>
      </button>
    </div>
    <div style="text-align:center;margin-bottom:24px;">
      <h2 style="color:#ea580c;margin:0 0 8px 0;">具体と抽象 基礎編</h2>
      <p style="color:#666;margin:0;font-size:16px;">📖 次の文章を読んで、図を完成させよう</p>
    </div>
    
    <div class="concrete-abstract-game" id="concreteAbstractGame">
      <div class="word-bank" id="wordBank">
        <h3 id="cardTitle">単語カード</h3>
        <div class="word-cards" id="wordCards">
          <!-- 単語カードはJavaScriptで生成 -->
        </div>
      </div>
      
      <div class="hierarchy-diagram" id="hierarchyDiagram">
        <div class="abstract-level">
          <div class="abstract-box" id="abstractBox">
            <span class="label">抽象（まとめ）</span>
            <div class="drop-zone" id="abstractDropZone"></div>
          </div>
        </div>
        
        <div class="concrete-level">
          <span class="label">具体（くわしく）</span>
          <div class="concrete-boxes">
            <div class="concrete-box" id="concreteBox1">
              <div class="drop-zone" id="concreteDropZone1"></div>
            </div>
            <div class="concrete-box" id="concreteBox2">
              <div class="drop-zone" id="concreteDropZone2"></div>
            </div>
            <div class="concrete-box" id="concreteBox3">
              <div class="drop-zone" id="concreteDropZone3"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <div class="game-info" style="text-align:center;margin-top:16px;">
      <div id="problemInfo" style="font-size:14px;color:#666;margin-bottom:8px;"></div>
    </div>
    
    <div class="game-controls" style="text-align:center;margin-top:24px;">
      <button id="checkAnswerBtn" class="logic-check-btn">解答する</button>
      <button id="resetGameBtn" class="logic-reset-btn">リセット</button>
    </div>
    
    <div id="gameResult" class="game-result" style="display:none;"></div>
  </div>

  <!-- 指示語問題画面 -->
  <div class="box" id="pronounReferenceBox">
    <div style="width:100%;display:flex;justify-content:space-between;align-items:center;margin-bottom:18px;">
      <button id="pronounReferenceBackBtn" class="home-btn">
        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
          <path d="M19 7v4H5.83l3.58-3.59L8 6l-6 6 6 6 1.41-1.41L5.83 13H21V7h-2z"/>
        </svg>
        <span>戻る</span>
      </button>
      <button id="pronounReferenceHomeBtn" class="home-btn">
        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
          <path d="M12 3 3 9.5v11a1 1 0 0 0 1 1h6v-6h4v6h6a1 1 0 0 0 1-1v-11L12 3z"/>
        </svg>
        <span>ホームへ</span>
      </button>
    </div>
    <div style="text-align:center;margin-bottom:24px;">
      <h2 style="color:#ea580c;margin:0 0 8px 0;">指示語問題 基礎編</h2>
      <p style="color:#666;margin:0;font-size:16px;">次の――線部の指示語が何を指すのか答えなさい。</p>
    </div>
    
    <div class="pronoun-reference-game" id="pronounReferenceGame">
      <div id="pronounProgress" style="text-align:center;margin-bottom:16px;font-size:16px;color:#666;">
        <div style="margin-bottom: 8px;">1/10</div>
        <div style="width: 200px; height: 10px; background: #e0e0e0; border-radius: 5px; margin: 0 auto; position: relative; overflow: hidden;">
          <div style="width: 10%; height: 100%; background: #87CEEB; border-radius: 5px; transition: width 0.3s ease;">
          </div>
        </div>
      </div>
      
          <div id="pronounText" style="font-size:20px;line-height:1.8;margin-bottom:32px;font-family:'UD Digi Kyokasho N-R','UD デジタル 教科書体 N-R','Klee','HiraMinProN-W3',serif;writing-mode:vertical-rl;text-orientation:upright;height:450px;width:600px;margin-left:auto;margin-right:auto;padding:20px;overflow:hidden;position:relative;">
        <div style="position:absolute;left:50%;transform:translateX(-50%);width:auto;height:100%;writing-mode:inherit;text-orientation:inherit;">
          <!-- 問題文がここに表示されます -->
        </div>
    </div>
      
      <div id="pronounQuestion" style="font-size:18px;font-weight:bold;margin-bottom:24px;text-align:center;color:#ea580c;">
        <!-- 質問がここに表示されます -->
      </div>
      
      <div id="pronounOptions" style="display:grid;grid-template-columns:1fr;gap:16px;margin-bottom:32px;max-width:600px;margin-left:auto;margin-right:auto;">
        <!-- 選択肢がここに表示されます -->
      </div>
      
      <div id="pronounFeedback" style="margin-bottom:24px;font-size:16px;padding:16px;border-radius:8px;display:none;">
        <!-- フィードバックがここに表示されます -->
      </div>
    </div>
    
    <div class="game-controls" style="text-align:center;margin-top:24px;">
      <button id="pronounCheckBtn" class="logic-check-btn" style="display:none;">解答する</button>
      <button id="pronounResetBtn" class="logic-reset-btn">リセット</button>
      <button id="pronounNextBtn" class="logic-check-btn" style="display:none;">次の問題へ</button>
      <button id="pronounFinishBtn" class="logic-check-btn" style="display:none;">結果を見る</button>
    </div>
    
    <div id="pronounGameResult" class="game-result" style="display:none;"></div>
  </div>

  <!-- 音読トレーニング選択画面 -->
  <div class="box" id="readingTrainingBox">
    <div style="width:100%;display:flex;justify-content:flex-end;margin-bottom:18px;">
      <button id="readingTrainingHomeBtn" class="home-btn">
        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
          <path d="M12 3 3 9.5v11a1 1 0 0 0 1 1h6v-6h4v6h6a1 1 0 0 0 1-1v-11L12 3z"/>
        </svg>
        <span>ホームへ</span>
      </button>
    </div>
    <div style="font-size:22px;font-weight:bold;color:#2563eb;margin-bottom:24px;text-align:center;">
      音読トレーニング
    </div>
    <div style="font-size:16px;color:#666;margin-bottom:32px;text-align:center;">
      音読で読解力を向上させよう！
    </div>
    <div class="reading-training-menu" id="readingTrainingMenuItems">
      <!-- メニューアイテムはJavaScriptで生成 -->
    </div>
  </div>

  <!-- 文法トレーニング画面 -->
  <div class="box" id="grammarTrainingBox">
    <div style="width:100%;display:flex;justify-content:flex-end;margin-bottom:18px;">
      <button id="grammarTrainingHomeBtn" class="home-btn">
        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
          <path d="M12 3 3 9.5v11a1 1 0 0 0 1 1h6v-6h4v6h6a1 1 0 0 0 1-1v-11L12 3z"/>
        </svg>
        <span>ホームへ</span>
      </button>
    </div>
    <div style="text-align:center;margin-bottom:24px;">
          <div style="font-size:22px;font-weight:bold;color:#ea580c;margin-bottom:8px;">
      文法トレーニング
    </div>
    <div style="font-size:14px;color:#ea580c;font-weight:600;text-transform:uppercase;letter-spacing:2px;">
      GRAMMAR 文法
    </div>
    </div>
    <div style="font-size:16px;color:#666;margin-bottom:32px;text-align:center;">
      正しい日本語の文法を身につけよう！
    </div>
    <div class="grammar-menu" id="grammarMenu">
      <!-- メニューアイテムはJavaScriptで生成 -->
    </div>
  </div>

  <!-- 文法トレーニング下位メニュー画面 -->
  <div class="box" id="grammarSubmenuBox">
    <div style="width:100%;display:flex;justify-content:space-between;align-items:center;margin-bottom:18px;">
      <button id="grammarSubmenuBackBtn" class="home-btn">
        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
          <path d="M19 7v4H5.83l3.58-3.59L8 6l-6 6 6 6 1.41-1.41L5.83 13H21V7h-2z"/>
        </svg>
        <span>戻る</span>
      </button>
      <button id="grammarSubmenuHomeBtn" class="home-btn">
        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
          <path d="M12 3 3 9.5v11a1 1 0 0 0 1 1h6v-6h4v6h6a1 1 0 0 0 1-1v-11L12 3z"/>
        </svg>
        <span>ホームへ</span>
      </button>
    </div>
    <div id="grammarSubmenuTitle" style="font-size:22px;font-weight:bold;color:#ea580c;margin-bottom:12px;text-align:center;">
      主語と述語
    </div>
    <div id="grammarSubmenuDescription" style="font-size:16px;color:#666;margin-bottom:32px;text-align:center;">
      難易度を選択してください
    </div>
    <div class="grammar-submenu" id="grammarSubmenu">
      <!-- 下位メニューアイテムはJavaScriptで生成 -->
    </div>
  </div>

  <!-- 漢字・語彙トレーニング画面 -->
  <div class="box" id="kanjiVocabTrainingBox">
    <div style="width:100%;display:flex;justify-content:flex-end;margin-bottom:18px;">
      <button id="kanjiVocabTrainingHomeBtn" class="home-btn">
        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
          <path d="M12 3 3 9.5v11a1 1 0 0 0 1 1h6v-6h4v6h6a1 1 0 0 0 1-1v-11L12 3z"/>
        </svg>
        <span>ホームへ</span>
      </button>
    </div>
    <div style="font-size:22px;font-weight:bold;color:#9333ea;margin-bottom:24px;text-align:center;">
      漢字・語彙トレーニング
    </div>
    <div style="font-size:16px;color:#666;margin-bottom:32px;text-align:center;">
      漢字の組み合わせで語彙力を向上させよう！
    </div>
    <div class="kanji-vocab-menu" id="kanjiVocabMenu">
      <!-- メニューアイテムはJavaScriptで生成 -->
    </div>
  </div>

  <!-- 漢字・語彙問題画面 -->
  <div class="box" id="kanjiVocabProblemBox">
    <div style="width:100%;display:flex;justify-content:space-between;align-items:center;margin-bottom:18px;">
      <button id="kanjiVocabBackBtn" class="home-btn">
        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
          <path d="M19 7v4H5.83l3.58-3.59L8 6l-6 6 6 6 1.41-1.41L5.83 13H21V7h-2z"/>
        </svg>
        <span>戻る</span>
      </button>
      <button id="kanjiVocabProblemHomeBtn" class="home-btn">
        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
          <path d="M12 3 3 9.5v11a1 1 0 0 0 1 1h6v-6h4v6h6a1 1 0 0 0 1-1v-11L12 3z"/>
        </svg>
        <span>ホームへ</span>
      </button>
    </div>
    
    <div class="kanji-vocab-problem">
      <div id="kanjiMeaning" class="kanji-meaning">
        <!-- 言葉の意味がここに表示されます -->
      </div>
      
      <div id="kanjiAnswerArea" class="kanji-answer-area">
        <span style="font-size:18px;color:#666;">漢字を選んで組み合わせてください</span>
      </div>
      
      <div id="kanjiChoices" class="kanji-choices">
        <!-- 漢字の選択肢がここに表示されます -->
      </div>
      
      <div class="kanji-problem-controls">
        <button id="kanjiCheckBtn" class="kanji-btn">答えを確認</button>
        <button id="kanjiResetBtn" class="kanji-btn" style="background:#ff9800;">リセット</button>
        <button id="kanjiNextBtn" class="kanji-btn" style="display:none;">次の問題へ</button>
        <button id="kanjiFinishBtn" class="kanji-btn" style="display:none;">結果を見る</button>
      </div>
      
      <div id="kanjiFeedback" class="kanji-feedback">
        <!-- フィードバックがここに表示されます -->
      </div>
    </div>
  </div>

  <!-- 漢字・語彙結果画面 -->
  <div class="box" id="kanjiVocabResultBox">
    <div style="width:100%;display:flex;justify-content:flex-end;margin-bottom:18px;">
      <button id="kanjiVocabResultHomeBtn" class="home-btn">
        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
          <path d="M12 3 3 9.5v11a1 1 0 0 0 1 1h6v-6h4v6h6a1 1 0 0 0 1-1v-11L12 3z"/>
        </svg>
        <span>ホームへ</span>
      </button>
    </div>
    <div style="font-size:22px;font-weight:bold;color:#9333ea;margin-bottom:24px;text-align:center;">
      漢字・語彙トレーニング結果
    </div>
    <div id="kanjiVocabResultContent" style="text-align:center;margin-bottom:32px;">
      <!-- 結果がここに表示されます -->
    </div>
    <div style="text-align:center;">
      <button id="kanjiVocabBackToMenuBtn" class="kanji-btn">メニューに戻る</button>
    </div>
  </div>

  <!-- ことわざトレーニングメニュー画面 -->
  <div class="box" id="kotowazaMenuBox">
    <div style="width:100%;display:flex;justify-content:space-between;align-items:center;margin-bottom:18px;">
      <button id="kotowazaMenuBackBtn" class="home-btn">
        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
          <path d="M19 7v4H5.83l3.58-3.59L8 6l-6 6 6 6 1.41-1.41L5.83 13H21V7h-2z"/>
        </svg>
        <span>戻る</span>
      </button>
      <button id="kotowazaMenuHomeBtn" class="home-btn">
        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
          <path d="M12 3 3 9.5v11a1 1 0 0 0 1 1h6v-6h4v6h6a1 1 0 0 0 1-1v-11L12 3z"/>
        </svg>
        <span>ホームへ</span>
      </button>
    </div>
    <div style="font-size:22px;font-weight:bold;color:#9333ea;margin-bottom:24px;text-align:center;">
      ことわざトレーニング
    </div>
    <div style="font-size:16px;color:#666;margin-bottom:32px;text-align:center;">
      ことわざを覚えて語彙力を身につけよう！
    </div>
    <div class="kotowaza-menu" style="display:flex;justify-content:center;gap:32px;flex-wrap:wrap;">
      <div class="kotowaza-menu-item" id="kotowazaStudyBtn" style="background:#f8f9fa;border:2px solid #9333ea;border-radius:16px;padding:32px;width:280px;height:200px;text-align:center;cursor:pointer;transition:all 0.3s ease;display:flex;flex-direction:column;justify-content:center;align-items:center;">
        <div style="margin-bottom:0px;"><img src="anki.png" style="width:64px;height:64px;" alt="暗記"></div>
        <div style="font-size:20px;font-weight:bold;color:#9333ea;margin-bottom:8px;">暗記編</div>
        <div style="color:#666;">穴抜きをタップして答えを確認</div>
      </div>
      <div class="kotowaza-menu-item" id="kotowazaTestBtn" style="background:#f8f9fa;border:2px solid #9333ea;border-radius:16px;padding:32px;width:280px;height:200px;text-align:center;cursor:pointer;transition:all 0.3s ease;display:flex;flex-direction:column;justify-content:center;align-items:center;">
        <div style="font-size:48px;margin-bottom:16px;">✏️</div>
        <div style="font-size:20px;font-weight:bold;color:#9333ea;margin-bottom:8px;">問題編</div>
        <div style="color:#666;">穴抜きと意味を選択して回答</div>
      </div>
    </div>
  </div>

  <!-- ことわざ暗記編画面 -->
  <div class="box" id="kotowazaStudyBox">
    <div style="width:100%;display:flex;justify-content:space-between;align-items:center;margin-bottom:18px;">
      <button id="kotowazaStudyBackBtn" class="home-btn">
        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
          <path d="M19 7v4H5.83l3.58-3.59L8 6l-6 6 6 6 1.41-1.41L5.83 13H21V7h-2z"/>
        </svg>
        <span>戻る</span>
      </button>
      <button id="kotowazaStudyHomeBtn" class="home-btn">
        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
          <path d="M12 3 3 9.5v11a1 1 0 0 0 1 1h6v-6h4v6h6a1 1 0 0 0 1-1v-11L12 3z"/>
        </svg>
        <span>ホームへ</span>
      </button>
    </div>
    
    <div style="font-size:22px;font-weight:bold;color:#9333ea;margin-bottom:24px;text-align:center;">
      ことわざ暗記編
    </div>
    
    <div id="kotowazaStudyContent" style="display:flex;justify-content:center;align-items:flex-start;gap:48px;max-width:1000px;margin:0 auto;">
      <!-- 左側：意味 -->
      <div class="kotowaza-meaning-area" style="flex:1;max-width:500px;">
        <div style="padding:24px;display:flex;align-items:flex-start;justify-content:center;gap:8px;">
          <div id="kotowazaMeaning" style="font-size:22px;line-height:1.8;color:#333;font-family:'Tsukushi Mincho','Yu Mincho','YuMincho','MS Mincho',serif;writing-mode:vertical-rl;text-orientation:mixed;min-height:200px;height:auto;display:block;padding:16px;overflow:visible;white-space:normal;flex:1;">
            <!-- ことわざの意味がここに表示されます -->
          </div>
          <div style="writing-mode:vertical-rl;text-orientation:mixed;font-size:18px;color:#333;background:#f0f0f0;font-family:'Tsukushi Mincho','Yu Mincho','YuMincho','MS Mincho',serif;font-weight:normal;padding:8px 6px;border-radius:4px;">
            意味
          </div>
        </div>
      </div>
      
      <!-- 右側：ことわざ（縦書き） -->
      <div class="kotowaza-text-area" style="flex:1;max-width:400px;">
        <div style="background:#ffffff;padding:32px;min-height:300px;display:flex;justify-content:center;align-items:center;">
          <div id="kotowazaText" style="writing-mode:vertical-rl;text-orientation:upright;font-size:28px;line-height:2;color:#333;font-family:'Tsukushi Mincho','Yu Mincho','YuMincho','MS Mincho',serif;text-align:center;font-weight:bold;">
            <!-- ことわざがここに表示されます -->
          </div>
        </div>
      </div>
    </div>
    
    <div style="text-align:center;margin-top:32px;">
      <div id="kotowazaProgress" style="margin-bottom:16px;color:#666;">1 / 10</div>
      <button id="kotowazaNextBtn" class="kanji-btn" style="background:#9333ea;">次のことわざ</button>
    </div>
  </div>

  <!-- ことわざ問題編画面 -->
  <div class="box" id="kotowazaTestBox">
    <div style="width:100%;display:flex;justify-content:space-between;align-items:center;margin-bottom:18px;">
      <button id="kotowazaTestBackBtn" class="home-btn">
        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
          <path d="M19 7v4H5.83l3.58-3.59L8 6l-6 6 6 6 1.41-1.41L5.83 13H21V7h-2z"/>
        </svg>
        <span>戻る</span>
      </button>
      <button id="kotowazaTestHomeBtn" class="home-btn">
        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
          <path d="M12 3 3 9.5v11a1 1 0 0 0 1 1h6v-6h4v6h6a1 1 0 0 0 1-1v-11L12 3z"/>
        </svg>
        <span>ホームへ</span>
      </button>
    </div>
    
    <div style="font-size:22px;font-weight:bold;color:#9333ea;margin-bottom:8px;text-align:center;">
      ことわざ問題編
    </div>
    
    <div id="kotowazaTestProgress" style="text-align:center;margin-bottom:24px;color:#666;">
      <div style="margin-bottom: 8px;">1/10</div>
      <div style="width: 200px; height: 10px; background: #e0e0e0; border-radius: 5px; margin: 0 auto; position: relative; overflow: hidden;">
        <div style="width: 10%; height: 100%; background: #9333ea; border-radius: 5px; transition: width 0.3s ease;"></div>
      </div>
    </div>
    
    <div id="kotowazaTestContent" style="display:flex;justify-content:center;align-items:flex-start;gap:48px;max-width:1000px;margin:0 auto;">
      <!-- 左側：ことわざ（縦書き、入力フィールド付き） -->
      <div class="kotowaza-text-area" style="flex:1;max-width:400px;">
        <div style="background:#ffffff;padding:32px;min-height:300px;display:flex;justify-content:center;align-items:center;">
          <div id="kotowazaQuestionText" style="writing-mode:vertical-rl;text-orientation:upright;font-size:28px;line-height:2;color:#333;font-family:'Tsukushi Mincho','Yu Mincho','YuMincho','MS Mincho',serif;text-align:center;font-weight:bold;">
            <!-- ことわざの問題がここに表示されます -->
          </div>
        </div>
      </div>
      
      <!-- 右側：問題文 -->
      <div class="kotowaza-meaning-area" style="flex:1;max-width:500px;">
        <div style="padding:24px;display:flex;align-items:flex-start;justify-content:center;gap:8px;">
          <div id="kotowazaTestMeaning" style="font-size:22px;line-height:1.8;color:#333;font-family:'Tsukushi Mincho','Yu Mincho','YuMincho','MS Mincho',serif;writing-mode:vertical-rl;text-orientation:mixed;min-height:200px;height:auto;display:block;padding:16px;overflow:visible;white-space:normal;flex:1;">
            <!-- ことわざの問題文がここに表示されます -->
          </div>
        </div>
      </div>
    </div>
    
    <div id="kotowazaTestFeedback" style="margin:32px auto 24px auto;padding:16px;border-radius:8px;display:none;max-width:800px;">
      <!-- フィードバックがここに表示されます -->
    </div>
    
    <div style="text-align:center;margin-top:32px;">
      <button id="kotowazaCheckBtn" class="kanji-btn" style="background:#9333ea;">答えを確認</button>
      <button id="kotowazaTestNextBtn" class="kanji-btn" style="background:#9333ea;display:none;">次の問題</button>
      <button id="kotowazaTestFinishBtn" class="kanji-btn" style="background:#9333ea;display:none;">結果を見る</button>
    </div>
  </div>

  <!-- ことわざ結果画面 -->
  <div class="box" id="kotowazaResultBox">
    <div style="width:100%;display:flex;justify-content:flex-end;margin-bottom:18px;">
      <button id="kotowazaResultHomeBtn" class="home-btn">
        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
          <path d="M12 3 3 9.5v11a1 1 0 0 0 1 1h6v-6h4v6h6a1 1 0 0 0 1-1v-11L12 3z"/>
        </svg>
        <span>ホームへ</span>
      </button>
    </div>
    <div style="font-size:22px;font-weight:bold;color:#9333ea;margin-bottom:24px;text-align:center;">
      ことわざトレーニング結果
    </div>
    <div id="kotowazaResultContent" style="text-align:center;margin-bottom:32px;">
      <!-- 結果がここに表示されます -->
    </div>
    <div style="text-align:center;">
      <button id="kotowazaBackToMenuBtn" class="kanji-btn" style="background:#9333ea;">メニューに戻る</button>
    </div>
  </div>

  <!-- ことわざ暗記編完了画面 -->
  <div class="box" id="kotowazaStudyCompleteBox">
    <div style="width:100%;display:flex;justify-content:flex-end;margin-bottom:18px;">
      <button id="kotowazaStudyCompleteHomeBtn" class="home-btn">
        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
          <path d="M12 3 3 9.5v11a1 1 0 0 0 1 1h6v-6h4v6h6a1 1 0 0 0 1-1v-11L12 3z"/>
        </svg>
        <span>ホームへ</span>
      </button>
    </div>
    <div style="text-align:center;padding:40px;">
      <div style="font-size:48px;margin-bottom:24px;">🎉</div>
      <div style="font-size:24px;font-weight:bold;color:#9333ea;margin-bottom:16px;">
        お疲れ様でした！
      </div>
      <div style="font-size:20px;color:#666;margin-bottom:32px;">
        すべてのことわざを確認しました
      </div>
      <div style="display:flex;justify-content:center;gap:20px;flex-wrap:wrap;">
        <button id="kotowazaStudyRestartBtn" class="kanji-btn" style="background:#9333ea;min-width:200px;padding:12px 20px;font-size:16px;">
          もう一度始めから
        </button>
        <button id="kotowazaStudyCompleteBackBtn" class="kanji-btn" style="background:#666;min-width:160px;padding:12px 20px;font-size:16px;">
          メニューに戻る
        </button>
      </div>
    </div>
  </div>

  <!-- 論理トレーニング画面 -->
  <div class="box" id="logicTrainingBox">
    <div style="width:100%;display:flex;justify-content:flex-end;margin-bottom:18px;">
      <button id="logicHomeBtn" class="home-btn">
        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
          <path d="M12 3 3 9.5v11a1 1 0 0 0 1 1h6v-6h4v6h6a1 1 0 0 0 1-1v-11L12 3z"/>
        </svg>
        <span>ホームへ</span>
      </button>
    </div>
    <div style="text-align:center;margin-bottom:24px;">
      <div style="font-size:22px;font-weight:bold;color:#ea580c;margin-bottom:8px;">
        論理トレーニング
      </div>
      <div style="font-size:14px;color:#ea580c;font-weight:600;text-transform:uppercase;letter-spacing:2px;">
        LOGIC 論理
      </div>
    </div>
    <div style="font-size:16px;color:#666;margin-bottom:32px;text-align:center;">
      論理的思考力を段階的に鍛えよう！
    </div>
    <div class="logic-menu" id="logicMenu">
      <!-- メニューアイテムはJavaScriptで生成 -->
    </div>
  </div>

  <!-- 文法トレーニング問題画面 -->
  <div class="box" id="grammarProblemBox">
    <div style="width:100%;display:flex;justify-content:space-between;align-items:center;margin-bottom:24px;">
      <button id="grammarBackBtn" class="grammar-back-btn">
        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" style="width:20px;height:20px;margin-right:6px;fill:currentColor;">
          <path d="M15 18l-6-6 6-6"/>
        </svg>
        <span>戻る</span>
      </button>
      <button id="grammarProblemHomeBtn" class="home-btn">
        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
          <path d="M12 3 3 9.5v11a1 1 0 0 0 1 1h6v-6h4v6h6a1 1 0 0 0 1-1v-11L12 3z"/>
        </svg>
        <span>ホームへ</span>
      </button>
    </div>
    
    <div id="grammarProblemTitle" style="font-size:22px;font-weight:bold;color:#ea580c;margin-bottom:12px;text-align:center;">
      文法トレーニング
    </div>
    
    <div id="grammarProblemProgress" style="font-size:16px;color:#666;margin-bottom:32px;text-align:center;">
      <div style="margin-bottom: 8px;">1/3</div>
      <div style="width: 200px; height: 10px; background: #e0e0e0; border-radius: 5px; margin: 0 auto; position: relative; overflow: hidden;">
        <div style="width: 33.33%; height: 100%; background: #87CEEB; border-radius: 5px; transition: width 0.3s ease;">
        </div>
      </div>
    </div>
    
    <div id="grammarProblemContent" style="max-width:800px;margin:0 auto;">
      <div id="grammarQuestion" style="font-size:20px;font-weight:bold;margin-bottom:32px;text-align:center;background:#fff3e0;padding:24px;border-radius:12px;border:2px solid #FFB74D;">
        問題がここに表示されます
      </div>
      
      <div id="grammarOptions" style="display:grid;gap:16px;margin-bottom:32px;">
        <!-- 選択肢がここに表示されます -->
      </div>
      
      <div id="grammarFeedback" style="margin-bottom:24px;font-size:16px;padding:16px;border-radius:8px;display:none;">
        <!-- フィードバックがここに表示されます -->
      </div>
      
      <div class="grammar-controls" style="text-align:center;">
        <button id="grammarNextBtn" class="grammar-next-btn" style="display:none;">次の問題へ</button>
        <button id="grammarFinishBtn" class="grammar-finish-btn" style="display:none;">結果を見る</button>
      </div>
    </div>
  </div>

  <!-- 文法トレーニング結果画面 -->
  <div class="box" id="grammarResultBox">
    <div style="width:100%;display:flex;justify-content:flex-end;margin-bottom:18px;">
      <button id="grammarResultHomeBtn" class="home-btn">
        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
          <path d="M12 3 3 9.5v11a1 1 0 0 0 1 1h6v-6h4v6h6a1 1 0 0 0 1-1v-11L12 3z"/>
        </svg>
        <span>ホームへ</span>
      </button>
    </div>
    
    <div style="font-size:22px;font-weight:bold;color:#ea580c;margin-bottom:24px;text-align:center;">
      文法トレーニング 結果
    </div>
    
    <div id="grammarResultContent" style="max-width:600px;margin:0 auto;text-align:center;">
      <!-- 結果がここに表示されます -->
    </div>
    
    <div style="text-align:center;margin-top:32px;">
      <button id="grammarBackToMenuBtn" class="grammar-back-btn">メニューに戻る</button>
    </div>
  </div>

  <!-- 助詞問題画面 -->
  <div class="box" id="particlesBox">
    <div style="width:100%;display:flex;justify-content:space-between;align-items:center;margin-bottom:24px;">
      <button id="particlesBackBtn" class="grammar-back-btn">
        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" style="width:20px;height:20px;margin-right:6px;fill:currentColor;">
          <path d="M15 18l-6-6 6-6"/>
        </svg>
        <span>戻る</span>
      </button>
      <button id="particlesHomeBtn" class="home-btn">
        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
          <path d="M12 3 3 9.5v11a1 1 0 0 0 1 1h6v-6h4v6h6a1 1 0 0 0 1-1v-11L12 3z"/>
        </svg>
        <span>ホームへ</span>
      </button>
    </div>
    
    <div id="particlesProblemContent" style="max-width:800px;margin:0 auto;">
      <div class="particles-game">
        <!-- 問題ヘッダー -->
        <div class="problem-header" style="margin-bottom:16px;">
          <div class="problem-header-title">問題</div>
          <div class="problem-header-progress" id="particlesProblemProgress">
            <div style="margin-bottom: 8px;">1/3</div>
            <div style="width: 200px; height: 10px; background: #e0e0e0; border-radius: 5px; margin: 0 auto; position: relative; overflow: hidden;">
              <div style="width: 33.33%; height: 100%; background: #87CEEB; border-radius: 5px; transition: width 0.3s ease;">
              </div>
            </div>
          </div>
        </div>
        
        <div style="text-align:center;margin-bottom:24px;color:#666;font-size:14px;">
           助詞カードを文の（　）にあてはめて正しい文を作りなさい。
        </div>
        <!-- 文章表示エリア -->
        <div id="particlesSentence" style="font-size:20px;font-weight:bold;margin-bottom:32px;padding:24px;line-height:2;font-family:'Tsukushi Mincho','Yu Mincho','YuMincho','MS Mincho',serif;writing-mode:vertical-rl;text-orientation:upright;width:fit-content;max-width:300px;min-height:200px;max-height:400px;margin:0 auto 32px auto;border-radius:12px;background:#ffffff;text-align:left;overflow:visible;">
          問題文がここに表示されます
        </div>
        
        <!-- 助詞カードエリア -->
        <div class="particles-cards-area" style="margin-bottom:32px;">
          <h3 style="text-align:center;margin-bottom:16px;color:#16a34a;">助詞カード</h3>
          <div id="particlesCards" style="display:flex;justify-content:center;gap:16px;flex-wrap:wrap;">
            <!-- 助詞カードがここに表示されます -->
          </div>
        </div>
        

        
        <div id="particlesFeedback-static" style="margin-bottom:24px;font-size:16px;padding:16px;border-radius:8px;display:none;">
          <!-- この要素は使用されません -->
        </div>
        
        <div class="particles-controls" style="text-align:center;margin-top:24px;">
          <button id="particlesCheckBtn-static" class="logic-check-btn">解答する</button>
          <button id="particlesResetBtn-static" class="logic-reset-btn">リセット</button>
          <button id="particlesNextBtn-static" class="grammar-next-btn" style="display:none;">次の問題へ</button>
          <button id="particlesFinishBtn-static" class="grammar-finish-btn" style="display:none;">結果を見る</button>
        </div>
      </div>
    </div>
  </div>

  <!-- 文節分け問題画面 -->
  <div class="box" id="clauseDivisionBox">
    <div style="width:100%;display:flex;justify-content:space-between;align-items:center;margin-bottom:24px;">
      <button id="clauseBackBtn" class="grammar-back-btn">
        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" style="width:20px;height:20px;margin-right:6px;fill:currentColor;">
          <path d="M15 18l-6-6 6-6"/>
        </svg>
        <span>戻る</span>
      </button>
      <button id="clauseHomeBtn" class="home-btn">
        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
          <path d="M12 3 3 9.5v11a1 1 0 0 0 1 1h6v-6h4v6h6a1 1 0 0 0 1-1v-11L12 3z"/>
        </svg>
        <span>ホームへ</span>
      </button>
    </div>
    

    
    <div id="clauseProblemContent" style="max-width:800px;margin:0 auto;">
      <div id="clauseCanvasContainer" style="display:flex;justify-content:center;margin-bottom:24px;">
        <canvas id="clauseCanvas" width="400" height="650" style="cursor:crosshair;"></canvas>
      </div>
      

      
      <div id="clauseFeedback" style="margin-bottom:24px;font-size:16px;padding:16px;border-radius:8px;display:none;">
        <!-- フィードバックがここに表示されます -->
      </div>
      
      <div class="clause-controls" style="text-align:center;margin-top:24px;">
        <button id="clauseCheckBtn" class="logic-check-btn">解答する</button>
        <button id="clauseResetBtn" class="logic-reset-btn">リセット</button>
        <button id="clauseNextBtn" class="grammar-next-btn" style="display:none;">次の問題へ</button>
        <button id="clauseFinishBtn" class="grammar-finish-btn" style="display:none;">結果を見る</button>
      </div>
    </div>
  </div>

  <!-- 主語・述語問題画面 -->
  <div class="box" id="subjectPredicateBox">
    <div style="width:100%;display:flex;justify-content:space-between;align-items:center;margin-bottom:24px;">
      <button id="subjectPredicateBackBtn" class="grammar-back-btn">
        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" style="width:20px;height:20px;margin-right:6px;fill:currentColor;">
          <path d="M15 18l-6-6 6-6"/>
        </svg>
        <span>戻る</span>
      </button>
      <button id="subjectPredicateHomeBtn" class="home-btn">
        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
          <path d="M12 3 3 9.5v11a1 1 0 0 0 1 1h6v-6h4v6h6a1 1 0 0 0 1-1v-11L12 3z"/>
        </svg>
        <span>ホームへ</span>
      </button>
    </div>
    
    <div id="subjectPredicateProblemContent" style="width:100%;margin:0 auto;display:flex;flex-direction:column;align-items:center;">
      <div id="subjectPredicateSentence" style="font-size:24px;padding:24px;line-height:2.5;width:fit-content;writing-mode:vertical-rl;text-orientation:upright;font-family:'Tsukushi Mincho','Yu Mincho','YuMincho','MS Mincho',serif;">
        <!-- 文章と単語がここに表示されます -->
      </div>
      
      <div id="subjectPredicateFeedback" style="margin-top: 20px; margin-bottom:24px;font-size:16px;padding:16px;border-radius:8px;display:none;">
        <!-- フィードバックがここに表示されます -->
      </div>
      
      <div class="subject-predicate-controls" style="text-align:center;margin-bottom:20px;">
        <button id="subjectPredicateCheckBtn" style="background:#20B2AA;color:white;border:none;padding:10px 20px;border-radius:8px;font-size:14px;cursor:pointer;margin-right:10px;">解答する</button>
        <button id="subjectPredicateResetBtn" style="background:#495057;color:white;border:none;padding:10px 20px;border-radius:8px;font-size:14px;cursor:pointer;">リセット</button>
      </div>
      
      <div class="grammar-controls" style="text-align:center;">
        <button id="subjectPredicateNextBtn" class="grammar-next-btn" style="display:none;">次の問題へ</button>
        <button id="subjectPredicateFinishBtn" class="grammar-finish-btn" style="display:none;">結果を見る</button>
      </div>
    </div>
  </div>



  <!-- 修飾語問題画面 -->
  <div class="box" id="modifierBox">
    <div style="width:100%;display:flex;justify-content:space-between;align-items:center;margin-bottom:18px;">
      <button id="modifierBackBtn" class="home-btn">
        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
          <path d="M19 7v4H5.83l3.58-3.59L8 6l-6 6 6 6 1.41-1.41L5.83 13H21V7h-2z"/>
        </svg>
        <span>戻る</span>
      </button>
      <button id="modifierHomeBtn" class="home-btn">
        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
          <path d="M12 3 3 9.5v11a1 1 0 0 0 1 1h6v-6h4v6h6a1 1 0 0 0 1-1v-11L12 3z"/>
        </svg>
        <span>ホームへ</span>
      </button>
    </div>

    <div id="modifierProblemContent" style="width:100%;margin:0 auto;">
      <div id="modifierSentence" class="modifier-sentence-vertical" style="text-align:center;margin:40px auto;width:fit-content;">
        <!-- 文章と単語がここに表示されます -->
      </div>
      
      <div id="modifierFeedback" style="margin-bottom:24px;font-size:16px;padding:16px;border-radius:8px;display:none;">
        <!-- フィードバックがここに表示されます -->
      </div>
      
      <div class="modifier-controls" style="text-align:center;margin-bottom:20px;">
        <button id="modifierCheckBtn" style="background:#20B2AA;color:white;border:none;padding:10px 20px;border-radius:8px;font-size:14px;cursor:pointer;margin-right:10px;">解答する</button>
        <button id="modifierResetBtn" style="background:#495057;color:white;border:none;padding:10px 20px;border-radius:8px;font-size:14px;cursor:pointer;">リセット</button>
      </div>
      
      <div class="grammar-controls" style="text-align:center;">
        <button id="modifierNextBtn" class="grammar-next-btn" style="display:none;">次の問題へ</button>
        <button id="modifierFinishBtn" class="grammar-finish-btn" style="display:none;">結果を見る</button>
      </div>
    </div>
  </div>

  <!-- 文の構造問題画面 -->
  <div class="box" id="sentenceStructureBox">
    <div style="width:100%;display:flex;justify-content:space-between;align-items:center;margin-bottom:24px;">
      <button id="sentenceStructureBackBtn" class="home-btn">
        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
          <path d="M19 7v4H5.83l3.58-3.59L8 6l-6 6 6 6 1.41-1.41L5.83 13H21V7h-2z"/>
        </svg>
        <span>戻る</span>
      </button>
      <button id="sentenceStructureHomeBtn" class="home-btn">
        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
          <path d="M12 3 3 9.5v11a1 1 0 0 0 1 1h6v-6h4v6h6a1 1 0 0 0 1-1v-11L12 3z"/>
        </svg>
        <span>ホームへ</span>
      </button>
    </div>
    
    <div id="sentenceStructureProblemContent" style="width:100%;margin:0 auto;display:flex;flex-direction:column;align-items:center;">
      <div id="sentenceStructureSentence" style="font-size:22px;margin-bottom:30px;text-align:center;padding:16px;background:#f8f9fa;border-radius:8px;line-height:1.8;">
        <!-- 文章がここに表示されます -->
      </div>
      
      <div id="sentenceStructureDiagram" style="width:100%;max-width:800px;margin:0 auto;padding:20px;">
        <!-- 図解がここに表示されます -->
      </div>
      
      <div id="sentenceStructureFeedback" style="margin:24px 0;font-size:16px;padding:16px;border-radius:8px;display:none;">
        <!-- フィードバックがここに表示されます -->
      </div>
      
      <div class="sentence-structure-controls" style="text-align:center;margin-bottom:20px;">
        <button id="sentenceStructureCheckBtn" style="background:#20B2AA;color:white;border:none;padding:10px 20px;border-radius:8px;font-size:14px;cursor:pointer;margin-right:10px;">解答する</button>
        <button id="sentenceStructureResetBtn" style="background:#495057;color:white;border:none;padding:10px 20px;border-radius:8px;font-size:14px;cursor:pointer;">リセット</button>
      </div>
      
      <div class="grammar-controls" style="text-align:center;">
        <button id="sentenceStructureNextBtn" class="grammar-next-btn" style="display:none;">次の問題へ</button>
        <button id="sentenceStructureFinishBtn" class="grammar-finish-btn" style="display:none;">結果を見る</button>
      </div>
    </div>
  </div>

  <!-- 文節並び替え問題画面 -->
  <div class="box" id="clauseRearrangementBox">
    <div style="width:100%;display:flex;justify-content:space-between;align-items:center;margin-bottom:24px;">
      <button id="clauseRearrangementBackBtn" class="grammar-back-btn">
        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" style="width:20px;height:20px;margin-right:6px;fill:currentColor;">
          <path d="M15 18l-6-6 6-6"/>
        </svg>
        <span>戻る</span>
      </button>
      <button id="clauseRearrangementHomeBtn" class="home-btn">
        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
          <path d="M12 3 3 9.5v11a1 1 0 0 0 1 1h6v-6h4v6h6a1 1 0 0 0 1-1v-11L12 3z"/>
        </svg>
        <span>ホームへ</span>
      </button>
    </div>
    
    <div id="clauseRearrangementProblemContent" style="width:100%;margin:0 auto;display:flex;flex-direction:column;align-items:center;">
      <!-- 問題ヘッダー -->
      <div class="problem-header" style="margin-bottom:24px;text-align:center;">
                  <div class="problem-header-title" style="font-size:22px;font-weight:bold;color:#ea580c;margin-bottom:8px;">文節並び替え問題</div>
        <div class="problem-header-progress" id="clauseRearrangementProblemProgress" style="color:#666;">
          <div style="margin-bottom: 8px;">1/3</div>
          <div style="width: 200px; height: 10px; background: #e0e0e0; border-radius: 5px; margin: 0 auto; position: relative; overflow: hidden;">
            <div style="width: 33.33%; height: 100%; background: #FF9800; border-radius: 5px; transition: width 0.3s ease;"></div>
          </div>
        </div>
      </div>
      
      <div style="text-align:center;margin-bottom:32px;color:#666;font-size:16px;">
        文節カードを入力欄にドラッグして、正しい順番に並び替えましょう
      </div>
      
      <!-- 問題エリア（横並び） -->
      <div class="clause-problem-area" style="display:flex;gap:40px;justify-content:center;align-items:flex-start;margin-bottom:32px;max-width:1000px;margin-left:auto;margin-right:auto;">
        
        <!-- 入力欄エリア -->
        <div class="clause-input-area" style="flex:1;max-width:400px;">
                      <h3 style="text-align:center;margin-bottom:16px;color:#16a34a;font-size:18px;">並び替え入力欄</h3>
          <div id="clauseInputSlots" style="display:flex;flex-direction:column;gap:12px;align-items:center;min-height:300px;padding:20px;border:2px dashed #ccc;border-radius:12px;background:#f9f9f9;">
            <!-- 入力スロットがここに表示されます -->
          </div>
        </div>
        
        <!-- 文節カードエリア -->
        <div class="clause-cards-area" style="flex:1;max-width:400px;">
                      <h3 style="text-align:center;margin-bottom:16px;color:#16a34a;font-size:18px;">文節カード</h3>
          <div id="clauseCards" style="display:flex;flex-direction:column;gap:12px;align-items:center;min-height:300px;padding:20px;border:2px solid #FF9800;border-radius:12px;background:#fff8f0;">
            <!-- 文節カードがここに表示されます -->
          </div>
        </div>
        
      </div>
      
      <div id="clauseRearrangementFeedback" style="margin-bottom:24px;font-size:16px;padding:16px;border-radius:8px;display:none;">
        <!-- フィードバックがここに表示されます -->
      </div>
      
      <div class="clause-rearrangement-controls" style="text-align:center;margin-bottom:20px;">
        <button id="clauseRearrangementCheckBtn" class="logic-check-btn">解答する</button>
        <button id="clauseRearrangementResetBtn" class="logic-reset-btn">リセット</button>
        <button id="clauseRearrangementNextBtn" class="grammar-next-btn" style="display:none;">次の問題へ</button>
        <button id="clauseRearrangementFinishBtn" class="grammar-finish-btn" style="display:none;">結果を見る</button>
      </div>
    </div>
  </div>

  <!-- AI文章生成画面 -->
<div class="box" id="aiGenerateBox">
  <div style="width:100%;display:flex;justify-content:space-between;align-items:center;margin-bottom:18px;">
    <button id="aiGenBackBtn" class="home-btn">
      <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
        <path d="M19 7v4H5.83l3.58-3.59L8 6l-6 6 6 6 1.41-1.41L5.83 13H21V7h-2z"/>
      </svg>
      <span>戻る</span>
    </button>
    <button id="aiGenHomeBtn" class="home-btn">
      <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
        <path d="M12 3 3 9.5v11a1 1 0 0 0 1 1h6v-6h4v6h6a1 1 0 0 0 1-1v-11L12 3z"/>
      </svg>
      <span>ホームへ</span>
    </button>
  </div>
  <!-- ★ここをタイトルに変更 -->
      <div style="font-size:22px;font-weight:bold;color:#2563eb;margin-bottom:16px;text-align:center;">
      文章生成の条件を指定する
    </div>
  <div style="width:100%;max-width:350px;display:flex;flex-direction:column;gap:14px;margin:0 auto;">
    <select id="aiGenGrade" class="ai-gen-select">
      <option value="">難易度を選択</option>
      <option value="1">レベル1（小1）</option>
      <option value="2">レベル2（小2）</option>
      <option value="3">レベル3（小3）</option>
      <option value="4">レベル4（小4）</option>
      <option value="5">レベル5（小5）</option>
      <option value="6">レベル6（小6）</option>
      <option value="10">中学受験</option>
    </select>
    <select id="aiGenType" class="ai-gen-select">
      <option value="">文章タイプを選択</option>
      <option value="物語文">物語文</option>
      <option value="説明文">説明文</option>
      <option value="論説文">論説文</option>
    </select>
    <select id="aiGenGenre" class="ai-gen-select">
      <option value="">ジャンルを選択</option>
      <!-- 説明文・論説文用のジャンル -->
      <option value="自然" class="non-fiction">自然</option>
      <option value="科学" class="non-fiction">科学</option>
      <option value="動物" class="non-fiction">動物</option>
      <option value="植物" class="non-fiction">植物</option>
      <option value="偉人" class="non-fiction">偉人</option>
      <option value="時事" class="non-fiction">時事</option>
      <option value="宇宙" class="non-fiction">宇宙</option>
      <option value="恐竜" class="non-fiction">恐竜</option>
      <option value="歴史" class="non-fiction">歴史</option>
      <option value="環境" class="non-fiction">環境</option>
      <option value="SDGs" class="non-fiction">SDGs</option>
      <option value="未来・テクノロジー" class="non-fiction">未来・テクノロジー</option>
      <option value="社会" class="non-fiction">社会</option>
      <option value="福祉" class="non-fiction">福祉</option>
      <option value="心理" class="non-fiction">心理</option>
      <option value="哲学" class="non-fiction">哲学</option>
      <option value="学び" class="non-fiction">学び</option>
      <option value="スポーツ" class="non-fiction">スポーツ</option>
      <!-- 物語文用のジャンル -->
      <option value="冒険物語" class="fiction">冒険物語</option>
      <option value="友情物語" class="fiction">友情物語</option>
      <option value="成長物語" class="fiction">成長物語</option>
      <option value="家族の物語" class="fiction">家族の物語</option>
      <option value="挫折物語" class="fiction">挫折物語</option>
      <option value="ファンタジー" class="fiction">ファンタジー</option>
      <option value="コンピュータ" class="non-fiction">コンピュータ</option>
    </select>
    <select id="aiGenDetail" class="ai-gen-select">
      <option value="">話題を掘り下げる</option>
      <option value="1">掘り下げる</option>
      <option value="0">掘り下げない</option>
    </select>
    <button id="aiGenBtn" class="ai-gen-btn">しろくまAIで文章を生成</button>
    <div id="aiLoading"></div>
    <div id="aiErr"></div>
  </div>
</div>

  <!-- リーダー画面 -->
  <div class="box" id="readerBox">
    <div class="reader-toolbar">
      <button id="homeBtn" class="home-btn">
        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
          <path d="M12 3 3 9.5v11a1 1 0 0 0 1 1h6v-6h4v6h6a1 1 0 0 0 1-1v-11L12 3z"/>
        </svg>
        <span>ホームへ</span>
      </button>
    </div>
    <div id="textDisplay"></div>
    <div id="pageCountText" style="text-align: center; margin: 10px 0; font-size: 14px; color: #666; font-weight: bold;">1/4ページ</div>
    <div id="fillInTheBlankSection" style="display: none; margin-top: 20px; padding: 18px; background: #ffffff; border-radius: 12px; writing-mode: vertical-rl; text-orientation: upright; font-family: 'Tsukushi Mincho', 'Yu Mincho', 'YuMincho', 'MS Mincho', serif; font-size: 19px; line-height: 2; color: #2c3e50;">
      <div style="writing-mode: horizontal-tb; margin-bottom: 15px;">
        <h3 style="margin: 0 0 15px 0; color: #333;">穴埋め問題</h3>
        <p id="fillInTheBlankQuestion" style="margin: 0 0 15px 0; font-weight: bold;"></p>
      </div>
      <div id="fillInTheBlankContent" style="margin-bottom: 15px;"></div>
      <div id="fillInTheBlankFeedback" style="writing-mode: horizontal-tb; margin-bottom: 15px;"></div>
      <button id="checkFillInTheBlankBtn" class="blue-btn" style="writing-mode: horizontal-tb;">答え合わせ</button>
    </div>
    <!-- 三角形ナビゲーションボタン -->
    <div style="position: relative; margin: 20px 0; width: 100%; padding: 0 20px; height: 60px;">
      <!-- 左側固定位置：つぎボタン（左向き三角形） -->
      <button id="nextBtn" class="triangle-btn-left" style="
        position: absolute;
        left: 20px;
        top: 50%;
        transform: translateY(-50%);
        width: 80px; 
        height: 50px; 
        background: #87ceeb; 
        border: 2px solid #4682b4; 
        cursor: pointer;
        clip-path: polygon(80% 0%, 80% 100%, 0% 50%);
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
        box-shadow: 0 4px 8px rgba(70, 130, 180, 0.3);
        border-radius: 4px;
        z-index: 10;
      " 
      onmouseover="this.style.background='#b0e0e6'; this.style.transform='translateY(-50%) scale(1.05)'; this.style.boxShadow='0 6px 12px rgba(70, 130, 180, 0.4)'" 
      onmouseout="this.style.background='#87ceeb'; this.style.transform='translateY(-50%) scale(1)'; this.style.boxShadow='0 4px 8px rgba(70, 130, 180, 0.3)'"
      onclick="nextPage()">
        <span style="position: absolute; right: 22px; top: 50%; transform: translateY(-50%); font-size: 14px; color: white; font-weight: bold; text-shadow: 1px 1px 2px rgba(0,0,0,0.3); pointer-events: none;">つぎ</span>
      </button>
      
      <!-- 中央エリア（固定位置のボタン） -->
      <div style="position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%); display: flex; justify-content: center; align-items: center; gap: 12px;">
        <button id="checkQuizBtn" style="
          display: none; 
          padding: 0; 
          width: 140px;
          height: 50px;
          background: #2196f3; 
          color: white; 
          border: 2px solid #1976d2; 
          border-radius: 12px; 
          font-size: 16px; 
          cursor: pointer; 
          font-weight: bold;
          box-shadow: 0 4px 8px rgba(33, 150, 243, 0.3);
          transition: all 0.2s;
          text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
          line-height: 46px;
          text-align: center;
          vertical-align: middle;
        "
        onmouseover="this.style.background='#42a5f5'; this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 12px rgba(33, 150, 243, 0.4)'"
        onmouseout="this.style.background='#2196f3'; this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 8px rgba(33, 150, 243, 0.3)'">
          確認問題へ
        </button>
        <button id="finishReadingBtn" style="
          padding: 0; 
          width: 140px;
          height: 50px;
          background: #4285f4; 
          color: white; 
          border: 2px solid #1976d2; 
          border-radius: 12px; 
          font-size: 16px; 
          cursor: pointer; 
          font-weight: bold;
          box-shadow: 0 4px 8px rgba(66, 133, 244, 0.3);
          transition: all 0.2s;
          text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
          line-height: 46px;
          text-align: center;
          vertical-align: middle;
        "
        onmouseover="this.style.background='#5294ff'; this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 12px rgba(66, 133, 244, 0.4)'"
        onmouseout="this.style.background='#4285f4'; this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 8px rgba(66, 133, 244, 0.3)'">
          音読完了
        </button>
      </div>
      
      <!-- 右側固定位置：まえボタン（右向き三角形） -->
      <button id="prevBtn" class="triangle-btn-right" style="
        position: absolute;
        right: 20px;
        top: 50%;
        transform: translateY(-50%);
        width: 80px; 
        height: 50px; 
        background: #87ceeb; 
        border: 2px solid #4682b4; 
        cursor: pointer;
        clip-path: polygon(100% 50%, 20% 0%, 20% 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
        box-shadow: 0 4px 8px rgba(70, 130, 180, 0.3);
        border-radius: 4px;
        z-index: 10;
      "
      onmouseover="this.style.background='#b0e0e6'; this.style.transform='translateY(-50%) scale(1.05)'; this.style.boxShadow='0 6px 12px rgba(70, 130, 180, 0.4)'" 
      onmouseout="this.style.background='#87ceeb'; this.style.transform='translateY(-50%) scale(1)'; this.style.boxShadow='0 4px 8px rgba(70, 130, 180, 0.3)'"
      onclick="prevPage()">
        <span style="position: absolute; left: 22px; top: 50%; transform: translateY(-50%); font-size: 14px; color: white; font-weight: bold; text-shadow: 1px 1px 2px rgba(0,0,0,0.3); pointer-events: none;">まえ</span>
      </button>
    </div>
  </div>
</div>
<!-- ▼▼▼ 宝箱UI（右下）▼▼▼ -->
<div id="treasureBox" style="display:none;">
  <span id="diamondCount" style="display: flex; align-items: center; gap: 8px;"><img src="diamond.png" alt="💎" style="width: 1em; height: 1em;"><span>0</span></span>
</div>
<!-- クイズ -->
<div id="quizOverlay"><div class="quiz-box">
       <div class="problem-header">
       <div class="problem-header-title">問題</div>
       <div class="problem-header-progress" id="quizProblemProgress">
         <div style="margin-bottom: 8px;">1/1</div>
         <div style="width: 200px; height: 10px; background: #e0e0e0; border-radius: 5px; margin: 0 auto; position: relative; overflow: hidden;">
           <div style="width: 100%; height: 100%; background: #87CEEB; border-radius: 5px; transition: width 0.3s ease;">
           </div>
         </div>
       </div>
     </div>
  <p id="quizQuestion"></p>
  <ul id="quizList"></ul>
  <div id="feedback"></div>
</div></div>

<!-- 穴埋め問題 -->
<div id="fillInTheBlankOverlay" style="display: none;">
  <div class="quiz-box">
    <h3>穴埋め問題</h3>
    <p id="fillInTheBlankQuestion"></p>
    <div id="fillInTheBlankContent"></div>
    <div id="fillInTheBlankFeedback"></div>
    <button id="checkFillInTheBlankBtn" class="blue-btn">答え合わせ</button>
  </div>
</div>

<!-- 評価 -->
<div id="scoreOverlay"><div class="score-board">
  <p id="gradeLetter"  class="grade-letter">A</p>
  <p id="gradePercent" class="grade-percent">100%</p>
  <div class="accuracy-gauge">
    <div class="gauge-background"></div>
    <div id="gaugeFill" class="gauge-fill"></div>
  </div>
  <p id="gradeComment" class="grade-comment">とってもよくできました！</p>
  <button id="scoreCloseBtn" class="close-btn">閉じる</button>
</div></div>



<script src="https://unpkg.com/wanakana"></script>
<!-- ↓ここに次のメッセージでJS全コードを挿入してください -->
</body>
</html>
<script>


// API設定（直接OpenAI API呼び出し）
const API_BASE_URL = 'https://api.openai.com/v1';
const OPENAI_API_KEY = ''; // ここにAPIキーを直接入力してください

const $ = id => document.getElementById(id);

const homeBox = $('homeBox'),
  selectBox = $('selectBox'),
  readerBox = $('readerBox'),
  aiGenerateBox = $('aiGenerateBox'),
  readingTrainingBox = $('readingTrainingBox'),
  grammarTrainingBox = $('grammarTrainingBox'),
  grammarSubmenuBox = $('grammarSubmenuBox'),
  kanjiVocabTrainingBox = $('kanjiVocabTrainingBox'),
  kanjiVocabProblemBox = $('kanjiVocabProblemBox'),
  kanjiVocabResultBox = $('kanjiVocabResultBox'),
  kotowazaMenuBox = $('kotowazaMenuBox'),
  kotowazaStudyBox = $('kotowazaStudyBox'),
  kotowazaTestBox = $('kotowazaTestBox'),
  kotowazaResultBox = $('kotowazaResultBox'),
  kotowazaStudyCompleteBox = $('kotowazaStudyCompleteBox'),
  logicTrainingBox = $('logicTrainingBox'),
  concreteAbstractBox = $('concreteAbstractBox'),
  pronounReferenceBox = $('pronounReferenceBox'),
  grammarProblemBox = $('grammarProblemBox'),
  grammarResultBox = $('grammarResultBox'),
  particlesBox = $('particlesBox'),
  clauseDivisionBox = $('clauseDivisionBox'),
  clauseRearrangementBox = $('clauseRearrangementBox'),
  subjectPredicateBox = $('subjectPredicateBox'),
  modifierBox = $('modifierBox'),
  sentenceStructureBox = $('sentenceStructureBox'),
  gemExchangeBox = $('gemExchangeBox');

const goReadingTrainingBtn = $('goReadingTrainingBtn'),
  goGrammarTrainingBtn = $('goGrammarTrainingBtn'),
  goKanjiVocabBtn = $('goKanjiVocabBtn'),
  goSelectBtn = $('goSelectBtn'),
  goAIGenBtn = $('goAIGenBtn'),
  readingTrainingHomeBtn = $('readingTrainingHomeBtn'),
  grammarTrainingHomeBtn = $('grammarTrainingHomeBtn'),
  grammarSubmenuBackBtn = $('grammarSubmenuBackBtn'),
  grammarSubmenuHomeBtn = $('grammarSubmenuHomeBtn'),
  aiGenHomeBtn = $('aiGenHomeBtn'),
  logicHomeBtn = $('logicHomeBtn');

const aiGenGrade = $('aiGenGrade'),
  aiGenType = $('aiGenType'),
  aiGenGenre = $('aiGenGenre'),
  aiGenDetail = $('aiGenDetail'),
  aiGenBtn = $('aiGenBtn'),
  aiLoading = $('aiLoading'),
  aiErr = $('aiErr');

const cardsContainer = $('cardsContainer'),
  calendarEl = $('calendar');
const textDisplay = $('textDisplay'),
  pageCountText = $('pageCountText');
const prevBtn = $('prevBtn'),
  nextBtn = $('nextBtn'),
  finishReadingBtn = $('finishReadingBtn');
const quizOverlay = $('quizOverlay'),
  quizQuestion = $('quizQuestion'),
  quizList = $('quizList'),
  feedback = $('feedback');
const scoreOverlay = $('scoreOverlay'),
  gradeLetterEl = $('gradeLetter'),
  gradePercent = $('gradePercent'),
  gradeComment = $('gradeComment'),
  scoreCloseBtn = $('scoreCloseBtn');
const readingLabel = $('readingLabel');

const diamondCountEl = $('diamondCount'),
  dashboardDiamondCountEl = $('dashboardDiamondCount');
let diamonds = 0;
const treasures = [
  { type: "diamond", icon: "<img src='diamond.png' alt='💎' style='display: inline; width: 1em; height: 1em; vertical-align: middle;'>", count: () => ++diamonds, elId: "diamondCount" }
];

const texts = [
  { id: 'usagitokame', title: '『うさぎとかめ』' },
  { id: 'kasajizou', title: '『かさじぞう』' },
  { id: 'gachonotanjobi', title: '『がちょうのたんじょうび』', author: '新美 南吉' },
  { id: 'kaninoshoubai', title: '『かにのしょうばい』', author: '新美 南吉' },
  { id: 'amedama', title: '『あめだま』', author: '新美 南吉' },
  { id: 'shitakirisuzume1', title: '『舌切りすずめ』【前編】', author: '楠山 正雄' },
  { id: 'shitakirisuzume2', title: '『舌切りすずめ』【後編】', author: '楠山 正雄' },
  { id: 'gongitsune1', title: '『ごんぎつね』【前編】', author: '新美 南吉' },
  { id: 'gongitsune2', title: '『ごんぎつね』【中編】', author: '新美 南吉' },
  { id: 'gongitsune3', title: '『ごんぎつね』【後編】', author: '新美 南吉' },
  { id: 'chuumonnoooi', title: '『注文の多い料理店』【前編】', author: '宮沢 賢治' },
  { id: 'chuumonnoooi1', title: '『注文の多い料理店』【中編】', author: '宮沢 賢治' },
  { id: 'chuumonnoooi2', title: '『注文の多い料理店』【後編】', author: '宮沢 賢治' },
  { id: 'kumonoito1', title: '『蜘蛛の糸』</br>【前編】', author: '芥川 龍之介' },
  { id: 'kumonoito2', title: '『蜘蛛の糸』</br>【後編】', author: '芥川 龍之介' },
  { id: 'hashiremerosu1', title: '『走れメロス』</br>【前編】', author: '太宰 治' },
  { id: 'hashiremerosu2', title: '『走れメロス』</br>【中編】', author: '太宰 治' },
  { id: 'hashiremerosu3', title: '『走れメロス』</br>【後編】', author: '太宰 治' },
  { id: 'amenimomakezu', title: '『雨ニモマケズ』', author: '宮沢 賢治' },
  { id: 'rapuntuxeru1', title: '『ラプンツェル』</br>【前編】', author: 'グリム' }
];
let pagesHTML = [],
  pagesPlain = [],
  currentPage = 0,
  currentTextID = '';
let recognition, mediaRecorder, currentAudioChunks = [], quizData = [], pageScores = [];
let savedQuizAnswers = []; // 入力中の解答を保存するための配列
let hasShownInitialCountdown = false; // 初回カウントダウンが表示されたかのフラグ

// 論理トレーニングのメニューデータ
const logicTrainingItems = [
  {
    id: 'concrete-abstract-0',
    title: '具体と抽象 入門編',
    level: '★☆☆',
    description: 'はじめての具体と抽象。簡単な例から論理的思考の第一歩を踏み出そう！',
    status: 'available',
    badge: '利用可能',
    filename: 'concrete_abstract_basic.json'  // 基礎編ファイルを使用
  },
  {
    id: 'concrete-abstract-1',
    title: '具体と抽象 基礎編',
    level: '★☆☆',
    description: '具体的な例と抽象的な概念の関係を理解しよう。身近な例から始めて、論理的思考の基礎を身につけます。',
    status: 'available',
    badge: '利用可能',
    filename: 'concrete_abstract_basic.json'
  },
  {
    id: 'concrete-abstract-2',
    title: '具体と抽象 応用編',
    level: '★★☆',
    description: 'より複雑な具体例と抽象概念の関係を学習。複数の具体例から共通点を見つけ出す練習をします。',
    status: 'available',
    badge: '利用可能',
    filename: 'concrete_abstract_intermediate.json'
  },
  {
    id: 'concrete-abstract-3',
    title: '具体と抽象 発展編',
    level: '★★★',
    description: '高度な抽象的思考力を鍛える。複雑な概念を具体例で説明したり、抽象化して考える練習をします。',
    status: 'available',
    badge: '利用可能',
    filename: 'concrete_abstract_advanced.json'
  },
  {
    id: 'concrete-abstract-exam1',
    title: '具体と抽象 中学受験対策編①',
    level: '★★★',
    description: '中学受験レベルの具体と抽象問題。高度な論理的思考力を試そう！',
    status: 'available',
    badge: '利用可能',
    filename: 'concrete_abstract_advanced.json'  // 発展編ファイルを使用
  },
  {
    id: 'concrete-abstract-exam2',
    title: '具体と抽象 中学受験対策編②',
    level: '★★★',
    description: '最難関中学対応の複雑な抽象概念問題。論理的思考の極意をマスターしよう！',
    status: 'coming-soon',
    badge: '近日公開'
  },
  {
    id: 'opposition-1',
    title: '対立関係 基礎編',
    level: '★☆☆',
    description: '対立する概念や意見の関係を理解しよう。対比構造を見つけて、論理的な比較ができるようになります。',
    status: 'coming-soon',
    badge: '近日公開'
  },
  {
    id: 'cause-effect-1',
    title: '因果関係 基礎編',
    level: '★☆☆',
    description: '原因と結果の関係を正しく理解しよう。論理的な推論の基礎となる因果関係を学習します。',
    status: 'coming-soon',
    badge: '近日公開'
  },
  {
    id: 'pronoun-reference-0',
    title: '指示語問題 入門編',
    level: '★☆☆',
    description: 'はじめての指示語問題。「これ」「それ」の基本的な使い方から学ぼう！',
    status: 'available',
    badge: '利用可能',
    filename: 'pronoun_reference_intro.json'
  },
  {
    id: 'pronoun-reference-1',
    title: '指示語問題 基礎編',
    level: '★☆☆',
    description: '「それ」「これ」「あれ」などの指示語が何を指すのかを理解する問題。指でなぞって正しい答えを選びましょう。',
    status: 'available',
    badge: '利用可能',
    filename: 'pronoun_reference_problems.json'
  },
  {
    id: 'pronoun-reference-exam1',
    title: '指示語問題 中学受験対策編①',
    level: '★★★',
    description: '中学受験レベルの複雑な指示語問題。文脈をしっかり読み取ろう！',
    status: 'available',
    badge: '利用可能',
    filename: 'pronoun_reference_exam1.json'
  },
  {
    id: 'pronoun-reference-exam2',
    title: '指示語問題 中学受験対策編②',
    level: '★★★',
    description: '最難関中学対応の高度な指示語問題。複雑な文章読解に挑戦しよう！',
    status: 'available',
    badge: '利用可能',
    filename: 'pronoun_reference_exam2.json'
  },
  {
    id: 'logical-reasoning-1',
    title: '論理的推論 基礎編',
    level: '★★☆',
    description: '前提から結論を導く論理的な推論を学習。三段論法や演繹的推論の基礎を身につけます。',
    status: 'coming-soon',
    badge: '近日公開'
  }
];

// 音読トレーニングのメニューデータ
const readingTrainingItems = [
  {
    id: 'classic-reading',
    title: '名文を音読する',
    level: '★☆☆',
    description: '古典的な名作文学や教科書から厳選された文章を音読します。正確な発音と読解力を同時に鍛えることができます。',
    status: 'available',
    badge: '利用可能',
    icon: '📖'
  },
  {
    id: 'ai-generated',
    title: 'AI文章生成で音読練習',
    level: '★★☆',
    description: 'AIが生成したオリジナル文章で音読練習を行います。あなたの学年やレベルに合わせた文章を自動生成できます。',
    status: 'available',
    badge: '利用可能',
    icon: '🤖'
  }
];

// 文法トレーニングのメニューデータ
const grammarTrainingItems = [
  {
    id: 'clause-division',
    title: '文節分け',
    level: '★★☆',
    description: '文を文節に正しく分けてみよう。手やマウスで線を引いて文節の境界を見つけます。',
    status: 'available',
    badge: '利用可能',
    submenu: [
      { id: 'clause-division-intro1', title: '【入門編】', description: '基本的な文節の区切りを学ぼう' },
      { id: 'clause-division-basic1', title: '【基礎編①】', description: '短い文の文節分け' },
      { id: 'clause-division-basic2', title: '【基礎編②】', description: '複数の文節を含む文' },
      { id: 'clause-division-advanced1', title: '【応用編①】', description: '複文の文節分け' },
      { id: 'clause-division-advanced2', title: '【応用編②】', description: '修飾語を含む文の分析' }
    ]
  },
  {
    id: 'clause-rearrangement',
    title: '文節並び替え',
    level: '★★☆',
    description: 'バラバラになった文節を正しい順番に並び替えよう。文節カードをドラッグして正しい文を作ります。',
    status: 'available',
    badge: '利用可能',
    submenu: [
      { id: 'clause-rearrangement-intro1', title: '【入門編】', description: '基本的な文節の並び替えを学ぼう' }
    ]
  },
  {
    id: 'subject-predicate',
    title: '主語と述語',
    level: '★☆☆',
    description: '文の主語と述語の関係を理解しよう。正しい文章構成の基礎を学習します。',
    status: 'available',
    badge: '利用可能',
    submenu: [
      { id: 'subject-predicate-intro1', title: '【入門編①】', description: 'シンプルな主語と述語を見つけよう' },
      { id: 'subject-predicate-intro2', title: '【入門編②】', description: '動物や人の動作で主語・述語を覚えよう' },
      { id: 'subject-predicate-basic1', title: '【基礎編①】', description: '基本的な主語と述語の関係' },
      { id: 'subject-predicate-basic2', title: '【基礎編②】', description: '主語の省略がある文' },
      { id: 'subject-predicate-advanced1', title: '【応用編①】', description: '複数の主語・述語を含む文' },
      { id: 'subject-predicate-advanced2', title: '【応用編②】', description: '複文における主語・述語' },
      { id: 'subject-predicate-expert1', title: '【発展編①】', description: '複雑な文の主語・述語関係' },
      { id: 'subject-predicate-expert2', title: '【発展編②】', description: '総合的な主語・述語の理解' },
      { id: 'subject-predicate-exam1', title: '【中学受験対策編①】', description: '入試レベルの主語・述語問題' },
      { id: 'subject-predicate-exam2', title: '【中学受験対策編②】', description: '複雑な文構造の主語・述語' }
    ]
  },
  {
    id: 'modifiers',
    title: '修飾語',
    level: '★★☆',
    description: '連体修飾語と連用修飾語の使い方を覚えよう。豊かな表現力を身につけます。',
    status: 'available',
    badge: '利用可能',
    submenu: [
      { id: 'modifiers-intro1', title: '【入門編】', description: '修飾語の基本を学ぼう' },
      { id: 'modifiers-basic1', title: '【基礎編①】', description: '連体修飾語の基本' },
      { id: 'modifiers-basic2', title: '【基礎編②】', description: '連用修飾語の基本' },
      { id: 'modifiers-advanced1', title: '【応用編①】', description: '修飾語の係り受け関係' },
      { id: 'modifiers-advanced2', title: '【応用編②】', description: '複数の修飾語を含む文' },
      { id: 'modifiers-expert1', title: '【発展編①】', description: '複雑な修飾構造の分析' },
      { id: 'modifiers-expert2', title: '【発展編②】', description: '総合的な修飾語の理解' },
      { id: 'modifiers-exam1', title: '【中学受験対策編①】', description: '入試レベルの修飾語問題' },
      { id: 'modifiers-exam2', title: '【中学受験対策編②】', description: '複雑な修飾関係の解析' }
    ]
  },
  {
    id: 'sentence-structure',
    title: '文の構造',
    level: '★★☆',
    description: '単文・複文・重文の違いを理解しよう。文章の構造を正しく把握する力を身につけます。',
    status: 'available',
    badge: '利用可能',
    submenu: [
      { id: 'sentence-structure-intro1', title: '【入門編】', description: '文の基本的な構造を学ぼう' },
      { id: 'sentence-structure-basic1', title: '【基礎編①】', description: '単文の構造' },
      { id: 'sentence-structure-basic2', title: '【基礎編②】', description: '複文の基本構造' },
      { id: 'sentence-structure-advanced1', title: '【応用編①】', description: '重文と複文の違い' },
      { id: 'sentence-structure-advanced2', title: '【応用編②】', description: '入れ子構造の文' },
      { id: 'sentence-structure-expert1', title: '【発展編①】', description: '複雑な文の構造分析' },
      { id: 'sentence-structure-expert2', title: '【発展編②】', description: '総合的な文構造の理解' },
      { id: 'sentence-structure-exam1', title: '【中学受験対策編①】', description: '入試レベルの文構造問題' },
      { id: 'sentence-structure-exam2', title: '【中学受験対策編②】', description: '高度な文構造解析' }
    ]
  },
  {
    id: 'particles',
    title: '助詞の使い方',
    level: '★☆☆',
    description: '「は」「が」「を」「に」などの助詞を正しく使い分けよう。日本語文法の基礎となる重要な要素です。',
    status: 'available',
    badge: '利用可能',
    submenu: [
      { id: 'particles-intro1', title: '【入門編】', description: 'シンプルな助詞から始めよう' },
      { id: 'particles-basic1', title: '【基礎編①】', description: '基本的な助詞の使い分け' },
      { id: 'particles-basic2', title: '【基礎編②】', description: '助詞の応用練習' },
      { id: 'particles-advanced1', title: '【応用編①】', description: '複雑な助詞の使い方' },
      { id: 'particles-advanced2', title: '【応用編②】', description: '文脈に応じた助詞選択' },
      { id: 'particles-expert1', title: '【発展編①】', description: '難易度の高い助詞問題' },
      { id: 'particles-expert2', title: '【発展編②】', description: '総合的な助詞の理解' },
      { id: 'particles-exam1', title: '【中学受験対策編①】', description: '中学受験レベルの助詞問題' },
      { id: 'particles-exam2', title: '【中学受験対策編②】', description: '難関中学対応の助詞応用' }
    ]
  }
];

// 論理トレーニングの問題データ（JSONから読み込み）
let logicProblemsData = null;
let concreteAbstractProblems = [];

// 統合された論理トレーニング問題データを読み込む
async function loadLogicTrainingProblems() {
  try {
    const response = await fetch('logic_training_problems.json');
    if (!response.ok) {
      throw new Error('logic_training_problems.jsonの読み込みに失敗しました');
    }
    logicProblemsData = await response.json();
    console.log('論理トレーニング問題データを読み込みました:', logicProblemsData);
    return true;
  } catch (error) {
    console.error('論理トレーニング問題データの読み込みエラー:', error);
    return false;
  }
}
// 主語・述語問題のデータ
let subjectPredicateProblems = [];
let currentSubjectPredicateSession = {
  problems: [],
  currentIndex: 0,
  selectedPredicate: null,
  selectedSubject: null,
  score: 0,
  isChecked: false
};

// 指示語問題のデータ
let pronounReferenceProblems = [];
let currentPronounSession = {
  problems: [],
  currentIndex: 0,
  selectedAnswer: null,
  score: 0,
  isChecked: false
};

// 文の構造問題のデータ
let sentenceStructureProblems = [];
let currentSentenceStructureSession = {
  problems: [],
  currentIndex: 0,
  placement: {},
  score: 0,
  isChecked: false
};

// 文節並び替え問題のデータ
let clauseRearrangementProblems = [];
let currentClauseRearrangementSession = {
  problems: [],
  currentIndex: 0,
  userOrder: [],
  score: 0,
  isChecked: false
};

let currentProblem = null;
let gameState = {
  abstract: null,
  concretes: [null, null, null]
};

// 問題データを読み込む（ファイル名を指定）
async function loadConcreteAbstractProblems(filename) {
  console.log('問題データ読み込み開始:', filename);
  
  try {
    // まず統合されたファイルから読み込みを試行
    if (logicProblemsData && logicProblemsData.concrete_abstract) {
      console.log('統合データから読み込み試行');
      const integratedResult = loadFromIntegratedData(filename);
      if (integratedResult) {
        console.log('統合データからの読み込み成功');
        return true;
      } else {
        console.log('統合データからの読み込み失敗、個別ファイルから読み込み試行');
      }
    } else {
      console.log('統合データが利用できません、個別ファイルから読み込み');
    }
    
    // 統合データがない場合は個別ファイルから読み込み
    console.log('個別ファイル読み込み試行:', filename);
    const response = await fetch(filename);
    if (!response.ok) {
      throw new Error(`問題データの読み込みに失敗しました: ${filename} (HTTP ${response.status})`);
    }
    const problemData = await response.json();
    console.log('個別ファイル読み込み成功:', problemData);
    
    const result = processConcreteAbstractData(problemData);
    console.log('個別ファイル処理結果:', result);
    return result;
    
  } catch (error) {
    console.error('問題データの読み込みエラー:', error);
    console.log('フォールバックデータを使用');
    // フォールバック用のデータ
    createFallbackData();
    return true; // フォールバックを使用したので成功として扱う
  }
}

// 統合されたデータから特定レベルの問題を抽出
function loadFromIntegratedData(filename) {
  try {
    console.log('統合データから読み込み試行:', filename);
    console.log('logicProblemsData:', logicProblemsData);
    
    if (!logicProblemsData || !logicProblemsData.concrete_abstract) {
      console.error('統合データまたはconcrete_abstractセクションが見つかりません');
      return false;
    }
    
    const data = logicProblemsData.concrete_abstract;
    console.log('concrete_abstractデータ:', data);
    
    // ファイル名からレベルを推定（logic_training_problems.jsonの構造に合わせる）
    let targetLevel = '基礎';
    let title = '具体と抽象 基礎編';
    
    if (filename.includes('intro')) {
      targetLevel = '基礎'; // intro ファイルも基礎レベルとして扱う
      title = '具体と抽象 入門編';
    } else if (filename.includes('basic')) {
      targetLevel = '基礎';
      title = '具体と抽象 基礎編';
    } else if (filename.includes('intermediate')) {
      targetLevel = '応用';
      title = '具体と抽象 応用編';
    } else if (filename.includes('advanced')) {
      targetLevel = '発展';
      title = '具体と抽象 発展編';
    } else if (filename.includes('exam')) {
      targetLevel = '発展'; // exam ファイルも発展レベルとして扱う
      title = '具体と抽象 中学受験対策編';
    }
    
    console.log('対象レベル:', targetLevel);
    console.log('利用可能な問題数:', data.problems ? data.problems.length : 0);
    
    if (!data.problems || !Array.isArray(data.problems)) {
      console.error('problems配列が見つかりません');
      return false;
    }
    
    // 利用可能なレベルを確認
    const availableLevels = [...new Set(data.problems.map(p => p.level))];
    console.log('利用可能なレベル:', availableLevels);
    
    // 対象レベルの問題を抽出
    let levelProblems = data.problems.filter(problem => problem.level === targetLevel);
    console.log(`${targetLevel}レベルの問題数:`, levelProblems.length);
    
    // 対象レベルの問題がない場合は、利用可能な問題を使用
    if (levelProblems.length === 0) {
      console.warn(`${targetLevel}レベルの問題が見つかりません。利用可能なレベル:`, availableLevels);
      
      // フォールバック：利用可能な最初のレベルの問題を使用
      if (availableLevels.length > 0) {
        const fallbackLevel = availableLevels[0];
        levelProblems = data.problems.filter(problem => problem.level === fallbackLevel);
        console.log(`フォールバック: ${fallbackLevel}レベルの問題を使用 (${levelProblems.length}問)`);
        targetLevel = fallbackLevel;
        title = `具体と抽象 ${fallbackLevel}編`;
      } else {
        console.error('利用可能な問題が見つかりません');
        return false;
      }
    }
    
    const problemData = {
      title: title,
      level: targetLevel,
      description: data.description,
      problems: levelProblems
    };
    
    console.log('処理用問題データ:', problemData);
    return processConcreteAbstractData(problemData);
    
  } catch (error) {
    console.error('統合データの処理エラー:', error);
    return false;
  }
}

// 問題データを処理する共通関数
function processConcreteAbstractData(problemData) {
  // 現在のレベル情報を保存
  currentProblemLevel = {
    title: problemData.title,
    level: problemData.level,
    description: problemData.description
  };
  
  // 発展編かどうかで処理を分岐
  if (problemData.level === '発展') {
    // 発展編の場合：text, abstract_answer, concrete_answers の構造
    concreteAbstractProblems = problemData.problems.map(problem => ({
      id: problem.id,
      level: problemData.level,
      text: problem.text,
      abstract_answer: problem.abstract_answer,
      concrete_answers: problem.concrete_answers,
      hint: problem.hint || '',
      diagram_instruction: problem.diagram_instruction || ''
    }));
  } else {
    // 基礎編・応用編の場合：abstract, concretes, distractors の構造
    concreteAbstractProblems = problemData.problems.map(problem => ({
      id: problem.id,
      level: problemData.level,
      abstract: problem.abstract,
      concretes: problem.concretes,  
      distractors: problem.distractors || [],
      hint: problem.hint || '',
      allWords: [problem.abstract, ...problem.concretes, ...(problem.distractors || [])]
    }));
  }
  
  console.log(`${problemData.title}問題データを読み込みました:`, concreteAbstractProblems.length + '問');
  
  return true;
}

// フォールバックデータを作成
function createFallbackData() {
  concreteAbstractProblems = [
    {
      id: 1,
      level: '基礎',
      abstract: '魚',
      concretes: ['たい', 'まぐろ', 'さんま'],
      distractors: [],
      hint: '海や川にすんでいる生き物をまとめた言葉は何でしょう？',
      allWords: ['魚', 'たい', 'まぐろ', 'さんま']
    }
  ];
  
  currentProblemLevel = {
    title: '具体と抽象 基礎編',
    level: '基礎',
    description: 'フォールバック問題'
  };
  
  return false;
}

// 現在の問題レベル情報
let currentProblemLevel = null;

// 指示語問題データを読み込む関数
async function loadPronounReferenceProblems(filename) {
  try {
    const response = await fetch(filename);
    if (!response.ok) {
      throw new Error(`問題データの読み込みに失敗しました: ${filename}`);
    }
    const problemData = await response.json();
    
    // 現在のレベル情報を保存
    currentProblemLevel = {
      title: problemData.title,
      level: problemData.level,
      description: problemData.description
    };
    
    pronounReferenceProblems = problemData.problems.map(problem => ({
      id: problem.id,
      text: problem.text,
      pronoun: problem.pronoun,
      pronoun_position: problem.pronoun_position,
      options: problem.options,
      correct_answer: problem.correct_answer,
      hint: problem.hint || ''
    }));
    
    console.log(`${problemData.title}問題データを読み込みました:`, pronounReferenceProblems.length + '問');
    
    return true;
  } catch (error) {
    console.error('指示語問題データの読み込みエラー:', error);
    // フォールバック用のデータ
    pronounReferenceProblems = [
      {
        id: 1,
        text: "太郎は新しい本を買いました。それはとてもおもしろい物語でした。",
        pronoun: "それ",
        pronoun_position: { start: 13, end: 15 },
        options: ["太郎", "新しい本", "物語"],
        correct_answer: "新しい本",
        hint: "「それ」の前に出てくる名詞に注目しましょう。"
      }
    ];
    
    currentProblemLevel = {
      title: '指示語問題 基礎編',
      level: '基礎',
      description: 'フォールバック問題'
    };
    
    return false;
  }
}

const PAGE_SIZE = 320,
  LOOK_AHEAD = 2,
  MAX_SKIP = 25,
  RECENT_LEN = 25;











const spineColors = [
  "#90caf9", // 0回: 薄い水色
  "#64b5f6", // 1回: やや濃い水色
  "#42a5f5", // 2回: 明るい水色
  "#2196f3", // 3回: やや濃い水色
  "#1e88e5", // 4回: 濃い水色
  "#1976d2"  // 5回以上: 最も濃い水色
];

  function showCountdown(onDone) {
  const overlay = document.getElementById('countdownOverlay');
  const num = document.getElementById('countdownNum');
  overlay.style.display = 'flex';

  const steps = ['3', '2', '1', 'スタート!'];
  let i = 0;
  function nextStep() {
    num.textContent = steps[i];
    i++;
    if (i < steps.length) {
      setTimeout(nextStep, 700);
    } else {
      setTimeout(() => {
        overlay.style.display = 'none';
        if (typeof onDone === 'function') onDone();
      }, 700);
    }
  }
  nextStep();
}

const stripRuby = src => src.replace(/[｜\|]([^《]+)《[^》]+》/g, '$1');
const rubyToHTML = (src) => {
  // <title>...</title>を大きく表示
  src = src.replace(/<title>([\s\S]*?)<\/title>/g, (match, p1) => {
    // ルビ変換
    let html = p1.replace(/[｜\|]([^《]+)《([^》]+)》/g, (m, b, r) =>
      `<ruby><rb>${[...b].map(c => `<span style=\"font-size:28px;font-weight:bold;\">${c}</span>`).join('')}</rb><rt>${r}</rt></ruby>`
    );
    // 1文字ずつspanで大きく
    html = html.replace(/([\u3040-\u309F\u30A0-\u30FF\u3400-\u9FFF\uF900-\uFAFFA-Za-z0-9])/g,
      '<span style="font-size:28px;font-weight:bold;">$1</span>');
    return html;
  });
  // 残りの文章を通常通り処理
  let html = src.replace(/[｜\|]([^《]+)《([^》]+)》/g, (m, b, r) =>
    `<ruby><rb>${[...b].map(c => `<span>${c}</span>`).join('')}</rb><rt>${r}</rt></ruby>`
  );
  return html.split(/(<[^>]+>)/g).map(part => {
    if (part.startsWith('<')) return part;
    return part.replace(/([\u3040-\u309F\u30A0-\u30FF\u3400-\u9FFF\uF900-\uFAFFA-Za-z0-9])/g,
      '<span>$1</span>');
  }).join('').replace(/\n/g, '<br>');
};
function getStats() { try { return JSON.parse(localStorage.getItem('stats') || '{}') } catch { return {} } }
function saveStats(o) { localStorage.setItem('stats', JSON.stringify(o)) }
function getReadGrades() { try { return JSON.parse(localStorage.getItem('readGrades') || '{}') } catch { return {} } }
function saveReadGrades(o) { localStorage.setItem('readGrades', JSON.stringify(o)) }

function renderCards() {
  const stats = getStats();
  cardsContainer.innerHTML = '';
  texts.forEach(t => {
    const s = stats[t.id] || { count: 0, best: '–' };
    const hasMedal = s.count >= 5 && ['A', 'S'].includes(s.best);
    let stage = 0;
    if (s.count >= 5) stage = 5;
    else if (s.count >= 4) stage = 4;
    else if (s.count >= 3) stage = 3;
    else if (s.count >= 2) stage = 2;
    else if (s.count >= 1) stage = 1;
    else stage = 0;
    const card = document.createElement('div');
    card.className = 'card';
    card.style.setProperty('--spine-color', spineColors[stage]);
    if (stage >= 3) {
      card.style.color = "#fff";
    } else {
      card.style.color = "#2c3e50";
    }
    
    // 走れメロス・蜘蛛の糸・かさじぞう・ごんぎつねの場合は同じ画像を使用
    const imageId =
      t.id.startsWith('hashiremerosu') ? 'hashiremerosu' :
      t.id.startsWith('kumonoito') ? 'kumonoito' :
      t.id.startsWith('kasajizou') ? 'kasajizou' :
      t.id.startsWith('gongitsune') ? 'gongitsune' :
      t.id.startsWith('shitakirisuzume') ? 'shitakirisuzume' :
      t.id === 'gachonotanjobi' ? 'gachonotanjobi' :
      t.id === 'kaninoshoubai' ? 'kaninoshoubai' :
      t.id === 'amedama' ? 'amedama' :
      t.id.startsWith('chuumonnoooi') ? 'chuumonnoooi' :
      t.id.startsWith('rapuntuxeru') ? 'rapuntuxeru' :
      t.id;
    
    card.innerHTML = `
      ${hasMedal ? `<span class="medal-badge" title="金メダル">
        <svg viewBox="0 0 32 32" width="28" height="28">
          <circle cx="16" cy="16" r="12" fill="#FFD700" stroke="#E0B000" stroke-width="3"/>
        </svg>
      </span>` : ''}
      <div class="title">${t.title}</div>
      <div class="author">${t.author || ''}</div>
      <div class="illustration" style="background-image: url('${imageId}.png')"></div>
      <div class="meta">読了回数：${s.count}<br>最高評価：${s.best}</div>
      <div class="card-buttons">
        <button class="start-btn" onclick="startText('${t.id}')">
          <svg viewBox="0 0 24 24" style="width: 18px; height: 18px; margin-right: 6px;">
            <path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm5.91-3c-.49 0-.9.36-.98.85C16.52 14.2 14.47 16 12 16s-4.52-1.8-4.93-4.15c-.08-.49-.49-.85-.98-.85-.61 0-1.09.54-1 1.14.49 3 2.89 5.35 5.91 5.78V20c0 .55.45 1 1 1s1-.45 1-1v-2.08c3.02-.43 5.42-2.78 5.91-5.78.1-.6-.39-1.14-1-1.14z" fill="currentColor"/>
          </svg>
          音読する
        </button>
        <div class="small-buttons">
          <button class="small-btn" onclick="readText('${t.id}')">解く</button>
          <button class="audio-btn" onclick="playAudio('${t.id}')" title="音声を聞く">
            <svg viewBox="0 0 24 24">
              <path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/>
            </svg>
          </button>
        </div>
      </div>
    `;
    cardsContainer.appendChild(card);
  });
}
function renderCalendar() {
  calendarEl.innerHTML = '';
  const now = new Date(), y = now.getFullYear(), m = now.getMonth();
  const first = new Date(y, m, 1), start = first.getDay(), days = new Date(y, m + 1, 0).getDate();
  const grades = getReadGrades();
  for (let i = 0; i < start; i++) {
    const d = document.createElement('div');
    d.className = 'cal-day blank';
    calendarEl.appendChild(d);
  }
  for (let d = 1; d <= days; d++) {
    const key = `${y}-${String(m + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
    const cell = document.createElement('div');
    cell.className = 'cal-day' + (grades[key] ? ' stamp' : '');
    cell.textContent = d;
    if (grades[key]) {
      const img = document.createElement('img');
      img.src = 'good.png';
      img.alt = 'スタンプ';
      img.className = 'stamp-img';
      cell.appendChild(img);
    }
    calendarEl.appendChild(cell);
  }
}

async function loadText(id) {
  let raw = '';
  try { 
    const r = await fetch(`${id}_ruby.txt`); 
    if (r.ok) {
      raw = await r.text();
    } else {
      const r2 = await fetch(`${id}.txt`);
      if (r2.ok) {
        raw = await r2.text();
      } else {
        throw new Error('テキストファイルの読み込みに失敗しました');
      }
    }
  } catch (error) { 
    console.error('テキストの読み込みエラー:', error);
    return false;
  }
  
  try {
    pagesHTML = []; 
    pagesPlain = [];
    let bufR = '', bufP = '';
    const add = () => { 
      if (!bufR) return; 
      pagesHTML.push(rubyToHTML(bufR)); 
      pagesPlain.push(stripRuby(bufR).replace(/\s+/g, '')); 
      bufR = ''; 
      bufP = ''; 
    };
    
    raw.split(/(?<=[。！？]\s*|\n)/).forEach(u => {
      const p = stripRuby(u).replace(/\s+/g, '');
      if (bufP.length + p.length > PAGE_SIZE) { 
        add(); 
        bufR = u; 
        bufP = p; 
      } else { 
        bufR += u; 
        bufP += p; 
      }
    });
    add();
    return true;
  } catch (error) {
    console.error('テキストの処理エラー:', error);
    return false;
  }
}

async function loadQuiz(id) {
  try {
    const r = await fetch(`${id}_quiz.json`);
    quizData = r.ok ? await r.json() : [];
  } catch { quizData = []; }
}

function showPage(i, direction = 'none') {
  if (i < 0 || i >= pagesHTML.length) {
    console.error('無効なページ番号:', i);
    return;
  }
  
  const oldPage = currentPage;
  currentPage = i;
  let content = pagesHTML[i];
  if (!content) {
    console.error('ページ内容が見つかりません:', i);
    return;
  }
  

  
  // スライドアニメーション
  if (direction !== 'none' && oldPage !== i) {
    // 新しいページ用の一時的なコンテナを作成
    const tempContainer = document.createElement('div');
    tempContainer.innerHTML = content;
    tempContainer.style.position = 'absolute';
    tempContainer.style.top = '0';
    tempContainer.style.left = direction === 'next' ? '100%' : '-100%';
    tempContainer.style.width = '100%';
    tempContainer.style.height = '100%';
    tempContainer.style.transition = 'left 0.3s ease-in-out';
    tempContainer.style.background = 'inherit';
    
    // 現在のページにアニメーション設定
    textDisplay.style.position = 'relative';
    textDisplay.style.transition = 'left 0.3s ease-in-out';
    textDisplay.style.left = '0%';
    
    // 親コンテナに一時的なオーバーフロー設定
    const parent = textDisplay.parentElement;
    const originalOverflow = parent.style.overflow;
    parent.style.overflow = 'hidden';
    parent.style.position = 'relative';
    
    // 新しいページを追加
    parent.appendChild(tempContainer);
    
    // アニメーション実行
    setTimeout(() => {
      textDisplay.style.left = direction === 'next' ? '-100%' : '100%';
      tempContainer.style.left = '0%';
    }, 10);
    
    // アニメーション完了後の処理
    setTimeout(() => {
      textDisplay.innerHTML = content;
      textDisplay.style.position = '';
      textDisplay.style.transition = '';
      textDisplay.style.left = '';
      parent.removeChild(tempContainer);
      parent.style.overflow = originalOverflow;
      

    }, 320);
  } else {
    // アニメーションなしの場合
    textDisplay.innerHTML = content;
    

  }
  
  prevBtn.style.display = i === 0 ? 'none' : 'flex';
  nextBtn.style.display = i === pagesHTML.length - 1 ? 'none' : 'flex';
  
  // ページ数表示を更新
  if (pageCountText) {
    pageCountText.textContent = `${i + 1}/${pagesHTML.length}`;
    console.log('ページ数表示更新:', `${i + 1}/${pagesHTML.length}`);
  } else {
    console.error('pageCountText要素が見つかりません');
  }
  
  const highlighted = textDisplay.querySelectorAll('.highlight').length;
}

// 穴埋め問題を生成する関数
function generateFillInTheBlankQuestion() {
  const text = pagesPlain[currentPage];
  const words = text.split(/[、。！？]/).filter(word => word.length > 0);
  
  // 適切な長さの文を選ぶ（5-15文字程度）
  const suitableWords = words.filter(word => word.length >= 5 && word.length <= 15);
  if (suitableWords.length === 0) return '';
  
  const targetWord = suitableWords[Math.floor(Math.random() * suitableWords.length)];
  const question = `次の文章の（　）に入る言葉を考えましょう。`;
  
  // 問題文を作成
  const questionText = text.replace(targetWord, '<input id="fillInTheBlankAnswer" style="writing-mode:vertical-rl;text-orientation:upright;width:2em;height:6em;font-size:19px;border:1px solid #ccc;border-radius:4px;display:inline-block;vertical-align:middle;">');
  
  // 問題のHTMLを生成（すべて縦書き）
  const questionHtml = `
    <div style="writing-mode: vertical-rl; text-orientation: upright; font-family: 'Tsukushi Mincho', 'Yu Mincho', 'YuMincho', 'MS Mincho', serif; font-size: 19px; line-height: 2; color: #2c3e50;">
      <div style="margin-bottom: 1em; font-weight: bold;">穴埋め問題</div>
      <div style="margin-bottom: 1em;">${question}</div>
      <div style="margin-bottom: 1em;">${questionText}</div>
      <div id="fillInTheBlankFeedback" style="margin-bottom: 1em;"></div>
      <button id="checkFillInTheBlankBtn" class="blue-btn" style="writing-mode: vertical-rl; text-orientation: upright; font-size: 16px;">答え合わせ</button>
    </div>
  `;
  
  // 答え合わせボタンのイベントリスナーを設定
  setTimeout(() => {
    document.getElementById('checkFillInTheBlankBtn').onclick = () => {
      const userAnswer = document.getElementById('fillInTheBlankAnswer').value.trim();
      const feedback = document.getElementById('fillInTheBlankFeedback');
      
      if (userAnswer === targetWord) {
        feedback.innerHTML = `
          <div style=\"color: #1b8e3e; font-weight: bold; font-size: 20px;\">
            正解！
          </div>
        `;

      } else {
        feedback.innerHTML = `
          <div style=\"color: #d81b60; font-weight: bold;\">
            <img src=\"fuseikai.png\" alt=\"不正解\" style=\"height: 40px; vertical-align: middle; margin-right: 10px;\">
            ざんねん… 正解は「${targetWord}」でした。
          </div>
        `;
      }
    };
  }, 0);
  
  return questionHtml;
}

function spawnTreasureFromSpan(span) {
  let item = treasures[0]; // Always spawn diamonds

  const rect = span.getBoundingClientRect();
  const treasure = document.createElement("span");
  treasure.textContent = item.icon;
  treasure.style.position = "fixed";
  treasure.style.left = (rect.left + rect.width / 2) + "px";
  treasure.style.top = (rect.top + rect.height / 2) + "px";
  treasure.style.fontSize = "28px";
  treasure.style.pointerEvents = "none";
  treasure.style.zIndex = 9999;
  document.body.appendChild(treasure);

  const box = document.getElementById("treasureBox");
  const boxRect = box.getBoundingClientRect();
  treasure.animate([
    { transform: 'translate(0,0)', opacity: 1 },
    { transform: `translate(${boxRect.left - rect.left}px,${boxRect.top - rect.top}px) scale(0.5)`, opacity: 0.2 }
  ], {
    duration: 1000,
    easing: "cubic-bezier(.87,0,.13,1)"
  });

  setTimeout(() => {
    treasure.remove();
    item.count();
    updateTreasureCounts();
    box.animate([{ filter: 'drop-shadow(0 0 0 #fff)' }, { filter: 'drop-shadow(0 0 14px #fff)' }, { filter: 'drop-shadow(0 0 0 #fff)' }], { duration: 350 });
  }, 1000);
}

// 論理トレーニング専用のダイヤモンドアニメーション関数
function spawnDiamondsFromElement(element, count = 5) {
  const rect = element.getBoundingClientRect();
  const box = document.getElementById("treasureBox");
  
  // 宝箱が表示されていない場合は表示
  if (box.style.display === 'none') {
    box.style.display = 'block';
  }
  
  for (let i = 0; i < count; i++) {
    setTimeout(() => {
      const diamond = document.createElement("span");
      diamond.innerHTML = "<img src='diamond.png' alt='💎' style='display: inline; width: 1em; height: 1em; vertical-align: middle;'>";
      diamond.style.position = "fixed";
      
      // 少しずつ位置をずらして複数個を飛ばす
      const offsetX = (Math.random() - 0.5) * 100;
      const offsetY = (Math.random() - 0.5) * 50;
      diamond.style.left = (rect.left + rect.width / 2 + offsetX) + "px";
      diamond.style.top = (rect.top + rect.height / 2 + offsetY) + "px";
      diamond.style.fontSize = "28px";
      diamond.style.pointerEvents = "none";
      diamond.style.zIndex = 9999;
      document.body.appendChild(diamond);

      const boxRect = box.getBoundingClientRect();
      diamond.animate([
        { transform: 'translate(0,0)', opacity: 1 },
        { transform: `translate(${boxRect.left - (rect.left + offsetX)}px,${boxRect.top - (rect.top + offsetY)}px) scale(0.5)`, opacity: 0.2 }
      ], {
        duration: 1000,
        easing: "cubic-bezier(.87,0,.13,1)"
      });

      setTimeout(() => {
        diamond.remove();
        diamonds++;
        updateTreasureCounts();
        
        // 最後のダイヤモンドの時だけ宝箱を光らせる
        if (i === count - 1) {
          box.animate([{ filter: 'drop-shadow(0 0 0 #fff)' }, { filter: 'drop-shadow(0 0 14px #fff)' }, { filter: 'drop-shadow(0 0 0 #fff)' }], { duration: 350 });
        }
      }, 1000);
    }, i * 150); // 150ms間隔でダイヤモンドを次々と飛ばす
  }
}

function startHighlight() {
  const spans = [...textDisplay.querySelectorAll('span')];
  const expected = spans.map(s => s.textContent).join('');
  let idx = 0;
  let buffer = '';
  const MAX_ADVANCE = 7;

  recognition = new webkitSpeechRecognition();
  recognition.lang = 'ja-JP';
  recognition.continuous = true;
  recognition.interimResults = true;
  recognition.maxAlternatives = 1;

  recognition.onresult = e => {
    const seg = e.results[e.resultIndex];
    buffer += (seg[0].transcript || '').replace(/[、。・「」『』\s]/g, '');
    if (seg.isFinal) buffer = '';

    const spoken = buffer.slice(-RECENT_LEN);
    let m = idx;
    const maxJ = Math.min(idx + MAX_ADVANCE, expected.length);
    for (let j = maxJ; j > idx; j--) {
      if (spoken.endsWith(expected.slice(idx, j))) {
        m = j;
        break;
      }
    }
    if (m === idx) {
      const up = Math.min(expected.length, idx + 15);
      for (let j = idx + 1; j <= up; j++) {
        if (spoken.endsWith(expected.slice(j, j + LOOK_AHEAD))) {
          m = j;
          break;
        }
      }
    }
spans.slice(idx, m).forEach(s => {
  s.classList.add('highlight');
  spawnTreasureFromSpan(s);
});
const highlighted = Array.from(textDisplay.querySelectorAll('.highlight'))
  .filter(el => !el.closest('rt')).length;

    idx = m;
    const pct = Math.floor(idx / expected.length * 100);
    // 進捗ゲージは削除済み
  };
  recognition.start();
}
async function startPage() {
  // 音読モードでない場合は何もしない
  if (finishReadingBtn.style.display === 'none') {
    return;
  }

  // 最初のページかつ初回カウントダウンがまだ表示されていない場合のみカウントダウン
  if (currentPage === 0 && !hasShownInitialCountdown) {
    hasShownInitialCountdown = true; // フラグを設定
    showCountdown(async () => {
      const r = textDisplay.getBoundingClientRect();
      readingLabel.style.left = (r.left + 6) + 'px';
      readingLabel.style.top = (r.top - readingLabel.offsetHeight - 40) + 'px';
      readingLabel.style.display = 'flex';
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      mediaRecorder = new MediaRecorder(stream, { mimeType: 'audio/webm' });
      currentAudioChunks = [];
      mediaRecorder.ondataavailable = e => currentAudioChunks.push(e.data);
      mediaRecorder.start();
      startHighlight();
    });
  } else {
    // カウントダウンなしで直接開始
    const r = textDisplay.getBoundingClientRect();
    readingLabel.style.left = (r.left + 6) + 'px';
    readingLabel.style.top = (r.top - readingLabel.offsetHeight - 40) + 'px';
    readingLabel.style.display = 'flex';
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    mediaRecorder = new MediaRecorder(stream, { mimeType: 'audio/webm' });
    currentAudioChunks = [];
    mediaRecorder.ondataavailable = e => currentAudioChunks.push(e.data);
    mediaRecorder.start();
    startHighlight();
  }
}

async function finishPage() {
  try { recognition.stop(); } catch { }
  try { mediaRecorder.stop(); await new Promise(r => mediaRecorder.onstop = r); } catch { }
  readingLabel.style.display = 'none';
  
  // サーバープロキシ経由でAPI呼び出しを行う
  
  const blob = new Blob(currentAudioChunks, { type: 'audio/webm' });
  const fd = new FormData();
  fd.append('file', new File([blob], 'speech.webm', { type: 'audio/webm' }));
  fd.append('model', 'whisper-1');
  
  try {
    const res = await fetch(`${API_BASE_URL}/audio/transcriptions`, {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${OPENAI_API_KEY}`
      },
      body: fd
    });
    
    if (!res.ok) {
      throw new Error(`API Error: ${res.status} ${res.statusText}`);
    }
    
    const { text = '' } = await res.json();
    const hira = s => wanakana.toHiragana(s).replace(/[、。・「」『』\s]/g, '');
    const a = hira(text), b = hira(pagesPlain[currentPage]);
    const lev = (x, y) => {
      const m = x.length, n = y.length,
        d = Array.from({ length: m + 1 }, () => Array(n + 1).fill(0));
      for (let i = 0; i <= m; i++) d[i][0] = i;
      for (let j = 0; j <= n; j++) d[0][j] = j;
      for (let i = 1; i <= m; i++) for (let j = 1; j <= n; j++)
        d[i][j] = x[i - 1] === y[j - 1] ? d[i - 1][j - 1] : 1 + Math.min(d[i - 1][j], d[i][j - 1], d[i - 1][j - 1]);
      return d[m][n];
    };
    pageScores[currentPage] = Math.round(
      (a && b ? 1 - lev(a, b) / Math.max(a.length, b.length) : 0) * 100
    );
  } catch (error) {
    console.error('音声認識エラー:', error);
    // エラーの場合もデモ用スコアを設定
    pageScores[currentPage] = Math.floor(Math.random() * 30) + 70;
  }
}

function showQuiz() {
  if (!quizData || quizData.length === 0) {
    alert('この文章には確認問題がありません。');
    return;
  }
  // 確認問題は文章全体に対するものなので、最初の問題を使用
  const q = quizData[0];
  if (!q) {
    alert('問題データが正しく読み込まれていません。');
    return;
  }

  // quizOverlayを表示
  quizOverlay.style.display = 'flex';
  
  // 進捗を設定（確認問題は1問のみ）
  updateProblemProgress(0, 1, 'quizProblemProgress');
  
  quizList.innerHTML = '';
  quizQuestion.innerHTML = rubyToHTML(q.question);  // h3タグに問題文を表示（ふりがな付き）
  
  // 問題文のふりがなスタイルを設定
  const questionRubyElements = quizQuestion.querySelectorAll('ruby');
  questionRubyElements.forEach(ruby => {
    ruby.style.rubyPosition = 'over';
  });
  
  feedback.innerHTML = '';

  // 穴埋め問題文を表示（縦書き、ふりがな付き）
  let html = rubyToHTML(q.text); // ふりがなを適用
  const answers = q.answers;
  const blanks = answers.length;
  
  // （　）を入力フィールドに置換（縦書き対応）
  for (let i = 0; i < blanks; i++) {
    const answerLength = answers[i].length;
    const fieldHeight = Math.max(answerLength * 20 + 10, 30); // 文字数に応じた高さ
    html = html.replace(/（　）/, `<span style="display: inline-block; margin: 0 2px;"><input type="text" class="blankInput" id="blankInput${i}" style="writing-mode: vertical-rl; text-orientation: upright; width: 25px; height: ${fieldHeight}px; font-size: 16px; font-family: 'Tsukushi Mincho', 'Yu Mincho', 'YuMincho', 'MS Mincho', serif; text-align: center; border: 2px solid #cce7f9; border-radius: 4px; outline: none; line-height: 1.2; padding: 4px 2px;"></span>`);
  }
  
  const questionDiv = document.createElement("div");
  questionDiv.innerHTML = html;
  questionDiv.style.fontWeight = "normal";
  questionDiv.style.marginBottom = "20px";
  questionDiv.style.lineHeight = "2.2";
  questionDiv.style.fontSize = "18px";
  questionDiv.style.color = "#2c3e50";
  questionDiv.style.fontFamily = "'Tsukushi Mincho', 'Yu Mincho', 'YuMincho', 'MS Mincho', serif";
  
  // ルビ（ふりがな）のスタイルを設定
  const rubyElements = questionDiv.querySelectorAll('ruby');
  rubyElements.forEach(ruby => {
    ruby.style.rubyPosition = 'over';
  });
  
  quizList.appendChild(questionDiv);

  // 保存された入力値を復元し、初期色を設定
  setTimeout(() => {
    for (let i = 0; i < blanks; i++) {
      const inputField = document.getElementById(`blankInput${i}`);
      
      // 初期の背景色を設定
      if (inputField) {
        inputField.style.setProperty('background-color', '#e6f8ff', 'important');
        inputField.style.setProperty('color', '#2c3e50', 'important');
      }
      
      if (inputField && savedQuizAnswers[i]) {
        inputField.value = savedQuizAnswers[i];
      }
      
      // 不正解時の再入力用イベントリスナーを設定（色のリセットは行わない）
      if (inputField && !inputField.hasAttribute('data-error-listener')) {
        inputField.setAttribute('data-error-listener', 'true');
        inputField.addEventListener('focus', function() {
          // 正解済みの入力欄の場合は何もしない
          if (this.readOnly) return;
          
          // ×マークのみ削除（色は保持）
          const mark = this.parentNode.querySelector('.answer-mark');
          if (mark && mark.textContent === '×') {
            mark.remove();
          }
        });
      }
    }
  }, 0);

  // ボタンエリア（横書き）
  const btnArea = document.createElement('div');
  btnArea.style.display = "flex";
  btnArea.style.flexDirection = "column";
  btnArea.style.alignItems = "center";
  btnArea.style.gap = "12px";
  btnArea.style.marginTop = "20px";
  btnArea.style.writingMode = "horizontal-tb";
  btnArea.style.textOrientation = "mixed";
  btnArea.style.alignSelf = "center";

  // 答えるボタン
  const ansBtn = document.createElement("button");
  ansBtn.textContent = "答える";
  ansBtn.className = "blue-btn";
  ansBtn.style.width = "170px";
  btnArea.appendChild(ansBtn);

  // 本文を見るボタン
  const toTextBtn = document.createElement("button");
  toTextBtn.textContent = "本文を見る";
  toTextBtn.className = "toTextBtn";
  toTextBtn.style.width = "170px";
  btnArea.appendChild(toTextBtn);

  quizList.appendChild(btnArea);

  // 折りたたみウィンドウ
  let foldDiv = document.getElementById('quizFoldMini');
  if (!foldDiv) {
    foldDiv = document.createElement("div");
    foldDiv.id = "quizFoldMini";
    foldDiv.style.position = "fixed";
    foldDiv.style.bottom = "18px";
    foldDiv.style.left = "20px";
    foldDiv.style.background = "#fff";
    foldDiv.style.border = "2px solid #00b7f1";
    foldDiv.style.borderRadius = "15px";
    foldDiv.style.boxShadow = "0 2px 12px rgba(0,0,0,0.10)";
    foldDiv.style.padding = "10px 18px";
    foldDiv.style.fontSize = "16px";
    foldDiv.style.display = "none";
    foldDiv.style.zIndex = 5000;
    const restoreBtn = document.createElement("button");
    restoreBtn.textContent = "問題を解く";
    restoreBtn.className = "restoreQuizBtn";
    restoreBtn.onclick = () => {
      quizOverlay.style.display = "flex";
      foldDiv.style.display = "none";
    };
    foldDiv.appendChild(document.createTextNode("確認問題 "));
    foldDiv.appendChild(restoreBtn);
    document.body.appendChild(foldDiv);
  }

  // ボタンイベント
  toTextBtn.onclick = () => {
    // 現在の入力値を保存
    savedQuizAnswers = [];
    for (let i = 0; i < blanks; i++) {
      const inputField = document.getElementById(`blankInput${i}`);
      savedQuizAnswers[i] = inputField ? inputField.value : '';
    }
    
    quizOverlay.style.display = "none";
    foldDiv.style.display = "";
    feedback.innerHTML = ""; //←ここで残りバグ防止
  };

  ansBtn.onclick = () => {
    let ok = true;
    let wrongAnswers = [];
    for (let i = 0; i < blanks; i++) {
      const val = document.getElementById(`blankInput${i}`).value.trim();
      const ans = answers[i].trim();
      if (val !== ans) {
        ok = false;
        wrongAnswers.push(`第${i+1}問: 正解は「${ans}」`);
      }
    }
    // 各入力欄の色変更と文字に重ねて〇×を表示
    for (let i = 0; i < blanks; i++) {
      const inputField = document.getElementById(`blankInput${i}`);
      const val = inputField.value.trim();
      const ans = answers[i].trim();
      
      // 既存の〇×マークを削除
      const existingMark = inputField.parentNode.querySelector('.answer-mark');
      if (existingMark) {
        existingMark.remove();
      }
      
      // 既存の状態クラスを除去
      inputField.classList.remove('correct', 'wrong');
      // インラインの色スタイルを削除してクラスを優先させる
      inputField.style.removeProperty('background-color');
      inputField.style.removeProperty('border-color');
      inputField.style.removeProperty('color');
      
      if (val === ans) {
        // 正解の場合：クラスで青色を適用
        inputField.classList.add('correct');
        inputField.blur();
        inputField.readOnly = true; // 正解した箇所は編集不可
        
        // 〇マークを文字に重ねて表示
        const mark = document.createElement('span');
        mark.className = 'answer-mark';
        mark.textContent = '○';
        mark.style.position = 'absolute';
        mark.style.top = '50%';
        mark.style.left = '50%';
        mark.style.transform = 'translate(-50%, -50%)';
        mark.style.fontSize = '28px';
        mark.style.fontWeight = '900';
        mark.style.color = '#00bcd4';
        mark.style.pointerEvents = 'none';
        mark.style.textShadow = '2px 2px 4px rgba(255,255,255,0.9)';
        mark.style.zIndex = '10';
        
        inputField.parentNode.style.position = 'relative';
        inputField.parentNode.appendChild(mark);
      } else {
        // 不正解の場合：クラスで赤色を適用
        inputField.classList.add('wrong');
        inputField.blur();
        // インラインでも赤色を強制
        inputField.style.setProperty('background-color', '#ffeaea', 'important');
        inputField.style.setProperty('border-color', '#d81b60', 'important');
        inputField.style.setProperty('color', '#d81b60', 'important');
        inputField.readOnly = false; // 不正解の箇所は編集可能
        
        // ×マークを文字に重ねて表示
        const mark = document.createElement('span');
        mark.className = 'answer-mark';
        mark.textContent = '×';
        mark.style.position = 'absolute';
        mark.style.top = '50%';
        mark.style.left = '50%';
        mark.style.transform = 'translate(-50%, -50%)';
        mark.style.fontSize = '28px';
        mark.style.fontWeight = '900';
        mark.style.color = '#d81b60';
        mark.style.pointerEvents = 'none';
        mark.style.textShadow = '2px 2px 4px rgba(255,255,255,0.9)';
        mark.style.zIndex = '10';
        
        inputField.parentNode.style.position = 'relative';
        inputField.parentNode.appendChild(mark);
      }
    }

    if (ok) {
      feedback.innerHTML = `<div style="writing-mode: vertical-rl; text-orientation: upright; font-family: 'Tsukushi Mincho', 'Yu Mincho', 'YuMincho', 'MS Mincho', serif; text-align: center; line-height: 2.2;"><div style="font-size:24px;color:#1b8e3e;font-weight:bold;margin-top:20px;">せいかい！全問正解です！</div></div>`;
      setTimeout(() => { quizOverlay.style.display = "none"; foldDiv.style.display = "none"; }, 4000);
    } else {
      // 不正解時はメッセージなし
      feedback.innerHTML = "";
    }
  };
}


// --- 採点・成績 ---
const gradeOrder = ['E', 'D', 'C', 'B', 'A', 'S'];

function gradeLetter(score) {
  if (score >= 95) return 'S';
  if (score >= 80) return 'A';
  if (score >= 65) return 'B';
  if (score >= 50) return 'C';
  if (score >= 35) return 'D';
  return 'E';
}
function getTodayJST() {
  const now = new Date();
  now.setHours(now.getHours() + 9);
  return now.toISOString().slice(0, 10);
}
function showScore() {
  const avg = Math.round(pageScores.reduce((a, b) => a + b, 0) / pageScores.length || 0),
    letter = gradeLetter(avg);
  gradeLetterEl.className = `grade-letter grade-${letter}`;
  gradeLetterEl.textContent = letter;
  gradePercent.textContent = `${avg}%`;
  const comments = { S: 'スーパー！', A: 'とってもよくできました！', B: 'よくできました！', C: 'がんばったね！', D: 'あともう少し！', E: 'もう一回チャレンジ！' };
  gradeComment.textContent = comments[letter];
  scoreOverlay.style.display = 'flex';
  
  // ゲージのアニメーション
  const gaugeFill = document.getElementById('gaugeFill');
  gaugeFill.style.width = '0%';
  
  // 点数を一旦非表示
  gradePercent.style.opacity = '0';
  
  setTimeout(() => {
    gaugeFill.style.width = `${avg}%`;
    
    // ゲージのアニメーションが終わったら点数を表示
    setTimeout(() => {
      gradePercent.style.opacity = '1';
      gradePercent.classList.add('score-pop');
    }, 1500); // ゲージのアニメーション時間と同じ
  }, 100);

  // 読了回数の更新
  const stats = getStats();
  const s = stats[currentTextID] || { count: 0, best: 'E' };
  s.count = (s.count || 0) + 1;  // 読了回数を確実に増やす
  if (gradeOrder.indexOf(letter) > gradeOrder.indexOf(s.best)) {
    s.best = letter;
  }
  stats[currentTextID] = s;
  saveStats(stats);

  // 今日の最高評価の更新
  const grades = getReadGrades();
  const today = getTodayJST();
  if (!grades[today] || gradeOrder.indexOf(letter) > gradeOrder.indexOf(grades[today])) {
    grades[today] = letter;
    saveReadGrades(grades);
  }

  renderCalendar();
  renderCards();
}

// 音声を再生する関数
function playAudio(textId) {
  // 音声ファイルのパスを生成
  const audioPath = `audio/${textId}.mp3`;
  
  // 音声を再生
  const audio = new Audio(audioPath);
  audio.play().catch(error => {
    console.error('音声の再生に失敗しました:', error);
    alert('音声ファイルが見つかりませんでした。');
  });
}

// 文章を読む関数（音読採点なし、確認問題のみ）
function readText(textId) {
  currentTextID = textId;
  // 保存された解答をリセット
  savedQuizAnswers = [];
  
  Promise.all([loadText(textId), loadQuiz(textId)]).then(([textSuccess, quizSuccess]) => {
    if (!textSuccess) {
      alert('テキストの読み込みに失敗しました。');
      return;
    }
    
    header.style.display = 'none';
    showBox(readerBox);
    pageScores = [];
    showPage(0);
    
    // 音読関連機能を完全に無効化
    readingLabel.style.display = 'none';
    finishReadingBtn.style.display = 'none';
    
    // 音声認識と録音を完全に無効化
    if (recognition) {
      try { recognition.stop(); } catch { }
      recognition = undefined;
    }
    if (mediaRecorder) {
      try { mediaRecorder.stop(); } catch { }
      mediaRecorder = undefined;
    }
    if (window.currentStream) {
      window.currentStream.getTracks().forEach(track => track.stop());
      window.currentStream = null;
    }
    
    // 確認問題ボタンの表示設定
    const checkQuizBtn = document.getElementById('checkQuizBtn');
    if (checkQuizBtn) {
      if (quizData && quizData.length > 0) {
        // 確認問題がある場合は「確認問題へ」ボタンを表示
        checkQuizBtn.textContent = '確認問題へ';
        checkQuizBtn.style.display = 'block';
        console.log('readText: 確認問題ボタンを表示しました');
      } else {
        // 確認問題がない場合はボタンを非表示
        checkQuizBtn.style.display = 'none';
        console.log('readText: この文章には確認問題がありません');
      }
    }
  }).catch(error => {
    console.error('テキストまたはクイズの読み込みに失敗:', error);
    alert('データの読み込みに失敗しました。');
  });
}

function showTreasureBox(show) {
  const box = document.getElementById('treasureBox');
  if (box) box.style.display = show ? 'flex' : 'none';
}
function showBox(boxToShow) {
  [homeBox, selectBox, readerBox, aiGenerateBox, readingTrainingBox, grammarTrainingBox, grammarSubmenuBox, kanjiVocabTrainingBox, kanjiVocabProblemBox, kanjiVocabResultBox, kotowazaMenuBox, kotowazaStudyBox, kotowazaTestBox, kotowazaResultBox, kotowazaStudyCompleteBox, logicTrainingBox, concreteAbstractBox, pronounReferenceBox, grammarProblemBox, grammarResultBox, particlesBox, clauseDivisionBox, clauseRearrangementBox, subjectPredicateBox, modifierBox, sentenceStructureBox, gemExchangeBox].forEach(b => b && b.classList.remove('show'));
  boxToShow.classList.add('show');
  if (boxToShow === readerBox || boxToShow === concreteAbstractBox) showTreasureBox(true);
  else showTreasureBox(false);
}

// 論理トレーニングメニューを描画
function renderLogicMenu() {
  const logicMenu = $('logicMenu');
  logicMenu.innerHTML = '';
  
  logicTrainingItems.forEach(item => {
    const itemElement = document.createElement('div');
    itemElement.className = 'logic-item';
    itemElement.innerHTML = `
      <div class="logic-item-title">
        ${item.title}
      </div>
      <div class="logic-item-level">
        難易度: ${item.level}
      </div>
      <div class="logic-item-description">
        ${item.description}
      </div>
      <div class="logic-item-status">
        <span>クリックして開始</span>
      </div>
    `;
    
    // クリックイベントを追加
    itemElement.addEventListener('click', () => {
      if (item.status === 'available') {
        startLogicTraining(item.id);
      } else {
        alert(`${item.title}は${item.badge}です。`);
      }
    });
    
    logicMenu.appendChild(itemElement);
  });
}

// 音読トレーニングメニューを描画
function renderReadingTrainingMenu() {
  const readingMenu = $('readingTrainingMenuItems');
  readingMenu.innerHTML = '';
  
  readingTrainingItems.forEach(item => {
    const itemElement = document.createElement('div');
    itemElement.className = `reading-item ${item.id === 'ai-generated' ? 'ai-item' : ''}`;
    itemElement.innerHTML = `
      <div class="reading-item-title">
        ${item.icon} ${item.title}
      </div>
      <div class="reading-item-level">
        難易度: ${item.level}
      </div>
      <div class="reading-item-description">
        ${item.description}
      </div>
      <div class="reading-item-status">
        <span>クリックして開始</span>
        <span class="reading-item-badge ${item.status === 'available' ? '' : item.status}">
          ${item.badge}
        </span>
      </div>
    `;
    
    // クリックイベントを追加
    itemElement.addEventListener('click', () => {
      if (item.status === 'available') {
        startReadingTraining(item.id);
      } else {
        alert(`${item.title}は${item.badge}です。`);
      }
    });
    
    readingMenu.appendChild(itemElement);
  });
}

// 文法トレーニングメニューを描画（シンプルデザイン）
function renderGrammarMenu() {
  const grammarMenu = $('grammarMenu');
  grammarMenu.innerHTML = '';
  
  // メニューコンテナのスタイルを設定
  grammarMenu.style.cssText = `
    display: grid !important;
    grid-template-columns: 1fr !important;
    gap: 16px !important;
    max-width: 480px !important;
    margin: 0 auto !important;
    padding: 0 16px !important;
  `;
  
  grammarTrainingItems.forEach((item, index) => {
    const itemElement = document.createElement('div');
    itemElement.className = 'grammar-item-simple';
    
    // 進捗状況を取得
    const completedSubmenus = calculateCompletedSubmenus(item);
    const totalSubmenus = item.submenu ? item.submenu.length : 0;
    const completionRate = totalSubmenus > 0 ? (completedSubmenus / totalSubmenus) * 100 : 0;
    
    // 講座番号を生成
    const lectureNumber = `第${index + 1}講座`;
    
    // シンプルなデザイン（青系）
    itemElement.style.cssText = `
      background: #ffffff !important;
      border: 1px solid #e5e7eb !important;
      border-radius: 0 !important;
      padding: 16px !important;
      cursor: pointer !important;
      transition: all 0.3s ease !important;
    `;
    
    // 完了状況に応じたシンプルなステータス表示（青系）
    let statusText = '';
    if (completionRate >= 100) {
      statusText = '<span style="color: #059669; font-weight: 600;">✓ 完了</span>';
    } else if (completionRate > 0) {
      statusText = '<span style="color: #2563eb; font-weight: 600;">進行中</span>';
    } else {
      statusText = '<span style="color: #6b7280;">未開始</span>';
    }
    
    itemElement.innerHTML = `
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
        <div style="display: flex; align-items: center; gap: 12px;">
                     <span style="
            background: #3b82f6; 
            color: white; 
            padding: 4px 8px; 
            border-radius: 0; 
            font-size: 12px; 
            font-weight: 600;
          ">${lectureNumber}</span>
          <h3 style="
            font-size: 16px; 
            font-weight: 600; 
            color: #111827; 
            margin: 0;
            font-family: 'Meiryo', sans-serif;
          ">${item.title}</h3>
        </div>
        ${statusText}
      </div>
      
      <p style="
        font-size: 13px; 
        color: #6b7280; 
        margin: 0 0 14px 0;
        line-height: 1.4;
      ">${item.description}</p>
      
      <div style="margin-bottom: 8px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
          <span style="font-size: 13px; color: #6b7280;">学習進捗</span>
          <span id="progress-${item.id}" style="font-size: 13px; font-weight: 600; color: #374151;">0/0</span>
        </div>
        <div style="
          height: 12px; 
          width: 100%;
          background: #f1f5f9; 
          border-radius: 0; 
          overflow: hidden;
          border: 1px solid #e2e8f0;
        ">
          <div id="progress-fill-${item.id}" style="
            height: 100%; 
            background: linear-gradient(90deg, #3b82f6 0%, #60a5fa 100%); 
            transition: width 0.4s ease; 
            width: 0%;
            border-radius: 0;
          "></div>
        </div>
      </div>
    `;
    
    // ホバー効果（浮かせる）
    itemElement.addEventListener('mouseenter', () => {
      itemElement.style.borderColor = '#3b82f6';
      itemElement.style.boxShadow = '0 8px 16px rgba(59, 130, 246, 0.15)';
      itemElement.style.transform = 'translateY(-4px)';
    });
    
    itemElement.addEventListener('mouseleave', () => {
      itemElement.style.borderColor = '#e5e7eb';
      itemElement.style.boxShadow = 'none';
      itemElement.style.transform = 'translateY(0)';
    });
    
    // クリックイベントを追加
    itemElement.addEventListener('click', () => {
      if (item.status === 'available') {
        startGrammarTraining(item.id);
      } else {
        alert(`${item.title}は${item.badge}です。`);
      }
    });
    
    grammarMenu.appendChild(itemElement);
  });
  
  // 進捗を更新
  setTimeout(() => {
    updateGrammarProgressSimple();
  }, 100);
}

// 文法トレーニングの進捗を初期化・取得
function getGrammarProgress() {
  const savedProgress = localStorage.getItem('grammarProgress');
  if (savedProgress) {
    return JSON.parse(savedProgress);
  }
  
  // デフォルトの進捗データを作成
  const defaultProgress = {};
  grammarTrainingItems.forEach(item => {
    defaultProgress[item.id] = {};
    if (item.submenu) {
      item.submenu.forEach(subItem => {
        defaultProgress[item.id][subItem.id] = { solved: 0, total: 0 };
      });
    }
  });
  
  return defaultProgress;
}

// 文法トレーニングの進捗を保存
function saveGrammarProgress(progress) {
  localStorage.setItem('grammarProgress', JSON.stringify(progress));
}

// 各文法項目の問題数を取得（推定値）
function getEstimatedProblemCounts() {
  return {
    'particles': {
      'particles-intro1': 3,
      'particles-basic1': 4,
      'particles-basic2': 4,
      'particles-advanced1': 4,
      'particles-advanced2': 3,
      'particles-expert1': 3,
      'particles-expert2': 3,
      'particles-exam1': 3,
      'particles-exam2': 3
    },
    'clause-division': {
      'clause-division-intro1': 5,
      'clause-division-basic1': 5,
      'clause-division-basic2': 5,
      'clause-division-advanced1': 4,
      'clause-division-advanced2': 4,
      'clause-division-expert1': 3,
      'clause-division-expert2': 3,
      'clause-division-exam1': 4,
      'clause-division-exam2': 4
    },
    'subject-predicate': {
      'subject-predicate-intro1': 3,
      'subject-predicate-intro2': 3,
      'subject-predicate-basic1': 4,
      'subject-predicate-basic2': 4,
      'subject-predicate-advanced1': 4,
      'subject-predicate-advanced2': 3,
      'subject-predicate-expert1': 3,
      'subject-predicate-expert2': 3,
      'subject-predicate-exam1': 4,
      'subject-predicate-exam2': 4
    },
    'modifiers': {
      'modifiers-intro1': 5,
      'modifiers-basic1': 5,
      'modifiers-basic2': 5,
      'modifiers-advanced1': 4,
      'modifiers-advanced2': 4,
      'modifiers-expert1': 3,
      'modifiers-expert2': 3,
      'modifiers-exam1': 4,
      'modifiers-exam2': 4
    },
    'sentence-structure': {
      'sentence-structure-intro1': 5,
      'sentence-structure-basic1': 5,
      'sentence-structure-basic2': 5,
      'sentence-structure-advanced1': 4,
      'sentence-structure-advanced2': 4,
      'sentence-structure-expert1': 3,
      'sentence-structure-expert2': 3,
      'sentence-structure-exam1': 4,
      'sentence-structure-exam2': 4
    }
  };
}

// 文法トレーニングの進捗を更新表示（プロフェッショナル版）
function updateGrammarProgressPro() {
  const progress = getGrammarProgress();
  
  grammarTrainingItems.forEach(item => {
    // サブメニューの完了数を計算
    const completedSubmenus = calculateCompletedSubmenus(item);
    const totalSubmenus = item.submenu ? item.submenu.length : 0;
    
    // 進捗表示を更新
    const progressNumbers = document.getElementById(`progress-${item.id}`);
    const progressFill = document.getElementById(`progress-fill-${item.id}`);
    
    if (progressNumbers && progressFill) {
      progressNumbers.textContent = `${completedSubmenus}/${totalSubmenus}`;
      
      // プログレスバーの幅を更新（アニメーション付き）
      const percentage = totalSubmenus > 0 ? (completedSubmenus / totalSubmenus) * 100 : 0;
      
      // スムーズなアニメーションで進捗を更新
      setTimeout(() => {
        progressFill.style.width = `${percentage}%`;
      }, 100);
      
      // 進捗に応じてプログレスバーのグラデーションを調整
      if (percentage >= 100) {
        progressFill.style.background = 'linear-gradient(90deg, #22c55e 0%, #16a34a 50%, #15803d 100%)';
        progressNumbers.style.color = '#16a34a';
        progressNumbers.style.fontWeight = '800';
      } else if (percentage >= 80) {
        progressFill.style.background = 'linear-gradient(90deg, #3b82f6 0%, #60a5fa 50%, #93c5fd 100%)';
        progressNumbers.style.color = '#3b82f6';
        progressNumbers.style.fontWeight = '700';
      } else if (percentage >= 50) {
        progressFill.style.background = 'linear-gradient(90deg, #3b82f6 0%, #60a5fa 50%, #93c5fd 100%)';
        progressNumbers.style.color = '#3b82f6';
        progressNumbers.style.fontWeight = '700';
      } else if (percentage > 0) {
        progressFill.style.background = 'linear-gradient(90deg, #f59e0b 0%, #fbbf24 50%, #fcd34d 100%)';
        progressNumbers.style.color = '#f59e0b';
        progressNumbers.style.fontWeight = '600';
      } else {
        progressFill.style.background = 'linear-gradient(90deg, #e5e7eb 0%, #d1d5db 100%)';
        progressNumbers.style.color = '#9ca3af';
        progressNumbers.style.fontWeight = '600';
      }
      
      // 完了している場合は特別なエフェクトを追加
      if (percentage >= 100) {
        const shimmerDiv = progressFill.querySelector('div');
        if (shimmerDiv) {
          shimmerDiv.style.background = 'linear-gradient(90deg, transparent, rgba(255,255,255,0.6), transparent)';
          shimmerDiv.style.animation = 'shimmer 1.5s infinite';
        }
      }
    }
  });
}

// 文法トレーニングの進捗を更新表示（シンプル版）
function updateGrammarProgressSimple() {
  const progress = getGrammarProgress();
  
  grammarTrainingItems.forEach(item => {
    // サブメニューの完了数を計算
    const completedSubmenus = calculateCompletedSubmenus(item);
    const totalSubmenus = item.submenu ? item.submenu.length : 0;
    
    // 進捗表示を更新
    const progressNumbers = document.getElementById(`progress-${item.id}`);
    const progressFill = document.getElementById(`progress-fill-${item.id}`);
    
    if (progressNumbers && progressFill) {
      progressNumbers.textContent = `${completedSubmenus}/${totalSubmenus}`;
      
      // プログレスバーの幅を更新
      const percentage = totalSubmenus > 0 ? (completedSubmenus / totalSubmenus) * 100 : 0;
      progressFill.style.width = `${percentage}%`;
      
      // 進捗に応じて進捗数字の背景色を変更
      if (percentage >= 80) {
        progressNumbers.style.background = '#fef3f2';
        progressNumbers.style.color = '#ea580c';
        progressNumbers.style.borderColor = '#fed7aa';
      } else if (percentage >= 50) {
        progressNumbers.style.background = '#eff6ff';
        progressNumbers.style.color = '#2563eb';
        progressNumbers.style.borderColor = '#dbeafe';
      } else if (percentage > 0) {
        progressNumbers.style.background = '#f9fafb';
        progressNumbers.style.color = '#6b7280';
        progressNumbers.style.borderColor = '#e5e7eb';
      } else {
        progressNumbers.style.background = '#f9fafb';
        progressNumbers.style.color = '#374151';
        progressNumbers.style.borderColor = '#e5e7eb';
      }
    }
  });
}

// 文法トレーニングの進捗を更新表示（旧版・ボックス形式）
function updateGrammarProgress() {
  const progress = getGrammarProgress();
  const problemCounts = getEstimatedProblemCounts();
  
  grammarTrainingItems.forEach(item => {
    let totalSolved = 0;
    let totalProblems = 0;
    
    // 各レベルの進捗を合計
    if (item.submenu && problemCounts[item.id]) {
      item.submenu.forEach(subItem => {
        const subProgress = progress[item.id] && progress[item.id][subItem.id];
        const subCounts = problemCounts[item.id][subItem.id];
        
        if (subProgress && subCounts) {
          totalSolved += subProgress.solved || 0;
          totalProblems += subCounts || 0;
        } else if (subCounts) {
          totalProblems += subCounts;
        }
      });
    }
    
    // 進捗表示を更新（サブメニュー数ベース）
    const progressNumbers = document.getElementById(`progress-${item.id}`);
    const progressBoxes = document.getElementById(`progress-boxes-${item.id}`);
    
    if (progressNumbers && progressBoxes) {
      // サブメニューの完了数を計算
      const completedSubmenus = calculateCompletedSubmenus(item);
      const totalSubmenus = item.submenu ? item.submenu.length : 0;
      
      progressNumbers.textContent = `${completedSubmenus}/${totalSubmenus}`;
      
      // ボックス形式の進捗ゲージを生成（サブメニュー数ベース）
      updateProgressBoxes(progressBoxes, item.id);
      
      // 進捗数値のクラスをリセット
      progressNumbers.classList.remove('high-progress', 'medium-progress', 'low-progress');
      
      // 進捗に応じて動的な色調整
      const percentage = totalSubmenus > 0 ? (completedSubmenus / totalSubmenus) * 100 : 0;
      if (percentage >= 80) {
        progressNumbers.classList.add('high-progress');
      } else if (percentage >= 50) {
        progressNumbers.classList.add('medium-progress');
      } else if (percentage > 0) {
        progressNumbers.classList.add('low-progress');
      }
    }
  });
}

// 完了したサブメニューの数を計算
function calculateCompletedSubmenus(item) {
  if (!item.submenu) return 0;
  
  const progress = getGrammarProgress();
  const problemCounts = getEstimatedProblemCounts();
  
  let completedCount = 0;
  
  item.submenu.forEach(subItem => {
    const subProgress = progress[item.id] && progress[item.id][subItem.id];
    const subProblemCount = problemCounts[item.id] && problemCounts[item.id][subItem.id];
    
    if (subProgress && subProblemCount) {
      const solved = subProgress.solved || 0;
      const total = subProblemCount;
      const completionRate = total > 0 ? solved / total : 0;
      
      // 80%以上完了していれば完了とみなす
      if (completionRate >= 0.8) {
        completedCount++;
      }
    }
  });
  
  return completedCount;
}

// ボックス形式の進捗ゲージを更新（サブメニュー数ベース）
function updateProgressBoxes(container, itemId) {
  // コンテナをクリア
  container.innerHTML = '';
  
  // 該当する文法項目を取得
  const item = grammarTrainingItems.find(i => i.id === itemId);
  if (!item || !item.submenu) return;
  
  // 進捗データを取得
  const progress = getGrammarProgress();
  const problemCounts = getEstimatedProblemCounts();
  
  // 各サブメニューに対してボックスを作成
  item.submenu.forEach((subItem, index) => {
    const box = document.createElement('div');
    box.className = 'progress-box';
    
    // このサブメニューの進捗状況を確認
    const subProgress = progress[itemId] && progress[itemId][subItem.id];
    const subProblemCount = problemCounts[itemId] && problemCounts[itemId][subItem.id];
    
    if (subProgress && subProblemCount) {
      const solved = subProgress.solved || 0;
      const total = subProblemCount;
      const completionRate = total > 0 ? solved / total : 0;
      
      // 完了率に応じてボックスの状態を設定
      if (completionRate >= 1.0) {
        // 100%完了 - 完全に塗りつぶし
        box.classList.add('filled');
      } else if (completionRate > 0) {
        // 部分的完了 - 文法トレーニング中間色（オレンジ系）
        box.style.background = '#f97316';
      }
      // else: 未着手 - デフォルトの空ボックス
    }
    
    // ツールチップとして項目名を表示
    box.title = subItem.title;
    
    container.appendChild(box);
  });
}

// 問題完了後に進捗を更新
function updateGrammarProgressAfterCompletion(parentId, levelId, score, total) {
  const progress = getGrammarProgress();
  
  // 該当する進捗データを更新
  if (!progress[parentId]) {
    progress[parentId] = {};
  }
  
  progress[parentId][levelId] = {
    solved: score,
    total: total
  };
  
  // 進捗を保存
  saveGrammarProgress(progress);
  
  // 表示を更新（メニューに戻った時に反映される）
}

// 漢字・語彙トレーニングメニューデータ
const kanjiVocabTrainingItems = [
  {
    id: 'grade6',
    title: '小学6年生の漢字',
    level: '小学6年生',
    description: '解釈、評価、責任などの6年生で習う漢字を使った語彙問題',
    status: 'available',
    badge: '利用可能'
  },
  {
    id: 'kotowaza',
    title: 'ことわざトレーニング',
    level: '全学年',
    description: 'ことわざを覚えて語彙力をアップ！穴抜き問題で楽しく学習',
    status: 'available',
    badge: '利用可能'
  },
  {
    id: 'synonym',
    title: '類義語トレーニング',
    level: '全学年',
    description: '類義語を覚えて語彙力をアップ！意味の似た言葉を選んで学習',
    status: 'available',
    badge: '利用可能'
  },
  {
    id: 'antonym',
    title: '対義語トレーニング',
    level: '全学年',
    description: '対義語を覚えて語彙力をアップ！反対の意味の言葉を選んで学習',
    status: 'available',
    badge: '利用可能'
  }
];

// 漢字・語彙トレーニングメニューを描画
function renderKanjiVocabMenu() {
  const kanjiVocabMenu = $('kanjiVocabMenu');
  kanjiVocabMenu.innerHTML = '';
  
  kanjiVocabTrainingItems.forEach(item => {
    const itemElement = document.createElement('div');
    itemElement.className = 'kanji-vocab-item';
    itemElement.innerHTML = `
      <div class="kanji-vocab-item-title">
        ${item.title}
      </div>
      <div class="kanji-vocab-item-level">
        対象: ${item.level}
      </div>
      <div class="kanji-vocab-item-description">
        ${item.description}
      </div>
      <div class="kanji-vocab-item-status">
        <span>クリックして開始</span>
      </div>
    `;
    
    // クリックイベントを追加
    itemElement.addEventListener('click', () => {
      if (item.status === 'available') {
        startKanjiVocabTraining(item.id);
      } else {
        alert(`${item.title}は${item.badge}です。`);
      }
    });
    
    kanjiVocabMenu.appendChild(itemElement);
  });
}

// 文法トレーニングを開始（下位メニューを表示）
function startGrammarTraining(itemId) {
  const item = grammarTrainingItems.find(i => i.id === itemId);
  if (!item) return;
  
  // 下位メニュー画面に遷移
  showBox(grammarSubmenuBox);
  
  // タイトルと説明を更新
  document.getElementById('grammarSubmenuTitle').textContent = item.title;
  document.getElementById('grammarSubmenuDescription').textContent = item.description;
  
  // 下位メニューを描画
  renderGrammarSubmenu(item.submenu, itemId);
}

// 文法トレーニング下位メニューを描画（プロフェッショナル版）
function renderGrammarSubmenu(submenuItems, parentId) {
  const grammarSubmenu = document.getElementById('grammarSubmenu');
  grammarSubmenu.innerHTML = '';
  
  // メニューコンテナのスタイルを設定
  grammarSubmenu.style.cssText = `
    display: grid !important;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)) !important;
    gap: 16px !important;
    max-width: 900px !important;
    margin: 0 auto !important;
    padding: 0 16px !important;
  `;
  
  // 難易度レベルのカラーマップ
  const levelColors = {
    'intro': { bg: '#eff6ff', border: '#3b82f6', text: '#1e40af' },
    'basic': { bg: '#f0f9ff', border: '#0ea5e9', text: '#0c4a6e' },
    'advanced': { bg: '#fef3c7', border: '#f59e0b', text: '#92400e' },
    'expert': { bg: '#fdf2f8', border: '#ec4899', text: '#be185d' },
    'exam': { bg: '#f3f4f6', border: '#6b7280', text: '#374151' }
  };
  
  submenuItems.forEach((subItem, index) => {
    const itemElement = document.createElement('div');
    itemElement.className = 'grammar-submenu-item-pro';
    
    // タイトルから【】を取り除いて中身だけを残す
    let cleanTitle = subItem.title;
    if (cleanTitle.startsWith('【') && cleanTitle.includes('】')) {
      const startIndex = cleanTitle.indexOf('【') + 1;
      const endIndex = cleanTitle.indexOf('】');
      if (startIndex > 0 && endIndex > startIndex) {
        cleanTitle = cleanTitle.substring(startIndex, endIndex);
      }
    }
    cleanTitle = cleanTitle.trim();
    
    // レベルを判定
    let level = 'basic';
    if (subItem.id.includes('intro')) level = 'intro';
    else if (subItem.id.includes('advanced')) level = 'advanced';
    else if (subItem.id.includes('expert')) level = 'expert';
    else if (subItem.id.includes('exam')) level = 'exam';
    
    const colors = levelColors[level];
    
    // プロフェッショナルなカードデザイン
    itemElement.style.cssText = `
      background: linear-gradient(145deg, #ffffff 0%, #fafbfc 100%) !important;
      border-radius: 0 !important;
      padding: 18px !important;
      box-shadow: 
        0 2px 4px rgba(0, 0, 0, 0.04),
        0 8px 24px rgba(0, 0, 0, 0.06),
        0 0 0 1px rgba(0, 0, 0, 0.02) !important;
      border: none !important;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
      cursor: pointer !important;
      position: relative !important;
      overflow: hidden !important;
    `;
    
    itemElement.innerHTML = `
      <div style="
        position: absolute; 
        top: 0; 
        left: 0; 
        right: 0; 
        height: 4px; 
        background: ${colors.border}; 
        border-radius: 0;
      "></div>
      
      <div style="margin-bottom: 12px;">
        <div style="display: flex; justify-content: flex-start; align-items: flex-start; margin-bottom: 8px;">
          <div style="
            background: ${colors.bg}; 
            color: ${colors.text}; 
            padding: 4px 12px; 
            border-radius: 0; 
            font-size: 11px; 
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border: 1px solid ${colors.border};
          ">${level}</div>
        </div>
        
        <div style="
          font-size: 15px; 
          font-weight: 700; 
          color: #111827; 
          margin-bottom: 6px;
          font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
          letter-spacing: -0.025em;
          line-height: 1.3;
        ">${cleanTitle}</div>
        
        <div style="
          font-size: 12px; 
          color: #6b7280; 
          line-height: 1.4; 
          font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
          font-weight: 400;
        ">${subItem.description}</div>
      </div>
      
      <div style="
        display: flex; 
        justify-content: space-between; 
        align-items: center;
        margin-top: auto;
      ">
        <div style="
          display: flex; 
          align-items: center; 
          gap: 6px; 
          color: #9ca3af;
          font-size: 13px;
          font-weight: 500;
          box-shadow: none !important;
          text-shadow: none !important;
        ">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"/>
            <polyline points="12,6 12,12 16,14"/>
          </svg>
          <span style="box-shadow: none !important; text-shadow: none !important;">約5分</span>
        </div>
        
        <div style="
          background: linear-gradient(135deg, #3b82f6 0%, #60a5fa 100%);
          color: white;
          padding: 8px 16px;
          border-radius: 0;
          font-size: 13px;
          font-weight: 600;
          display: flex;
          align-items: center;
          gap: 6px;
          box-shadow: none;
          transition: all 0.2s ease;
        ">
          <span>開始</span>
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M9 18l6-6-6-6"/>
          </svg>
        </div>
      </div>
    `;
    
    // 高度なホバー効果
    itemElement.addEventListener('mouseenter', () => {
      itemElement.style.transform = 'translateY(-6px) scale(1.02)';
      itemElement.style.boxShadow = `
        0 4px 8px rgba(0, 0, 0, 0.06),
        0 16px 48px rgba(0, 0, 0, 0.08),
        0 0 0 1px ${colors.border}40
      `;
      
      // ボタンのホバー効果
      const startButton = itemElement.querySelector('div:last-child > div:last-child');
      if (startButton) {
        startButton.style.transform = 'scale(1.05)';
        startButton.style.boxShadow = 'none';
      }
    });
    
    itemElement.addEventListener('mouseleave', () => {
      itemElement.style.transform = 'translateY(0) scale(1)';
      itemElement.style.boxShadow = `
        0 2px 4px rgba(0, 0, 0, 0.04),
        0 8px 24px rgba(0, 0, 0, 0.06),
        0 0 0 1px rgba(0, 0, 0, 0.02)
      `;
      
      // ボタンのホバー効果をリセット
      const startButton = itemElement.querySelector('div:last-child > div:last-child');
      if (startButton) {
        startButton.style.transform = 'scale(1)';
        startButton.style.boxShadow = 'none';
      }
    });
    
    // クリックイベントを追加
    itemElement.addEventListener('click', () => {
      startGrammarSubTraining(subItem.id, parentId);
    });
    
    grammarSubmenu.appendChild(itemElement);
  });
}

// getGrammarLevelInfo関数を削除（新しいデザインでは不要）

// 文法トレーニング下位メニューから実際の問題を開始
function startGrammarSubTraining(subItemId, parentId) {
  if (parentId === 'particles') {
    // 助詞専用画面に遷移
    showBox(particlesBox);
    initParticlesProblem();
  } else if (parentId === 'clause-division') {
    // 文節分け専用画面に遷移
    showBox(clauseDivisionBox);
    initClauseDivisionProblem();
  } else if (parentId === 'clause-rearrangement') {
    // 文節並び替え専用画面に遷移
    showBox(clauseRearrangementBox);
    initClauseRearrangementProblem();
  } else if (parentId === 'subject-predicate') {
    // 主語・述語専用画面に遷移
    showBox(subjectPredicateBox);
    initSubjectPredicateProblem(subItemId);
  } else if (parentId === 'modifiers') {
    // 修飾語専用画面に遷移
    showBox(modifierBox);
    initModifierProblem();
  } else if (parentId === 'sentence-structure') {
    // 文の構造専用画面に遷移
    showBox(sentenceStructureBox);
    initSentenceStructureProblem();
  } else {
    // 通常の文法トレーニング問題画面に遷移
    showBox(grammarProblemBox);
    
    // タイトルを更新
    const parentItem = grammarTrainingItems.find(i => i.id === parentId);
    const subItem = parentItem.submenu.find(s => s.id === subItemId);
    document.getElementById('grammarProblemTitle').textContent = `${parentItem.title} ${subItem.title}`;
    
    // 問題を開始
    initGrammarProblem(parentId);
  }
}

// 音読トレーニングを開始
function startReadingTraining(itemId) {
  const item = readingTrainingItems.find(i => i.id === itemId);
  if (!item) return;
  
  if (itemId === 'classic-reading') {
    // 名文を音読する
    showBox(selectBox);
    renderCards();
  } else if (itemId === 'ai-generated') {
    // AI文章生成
    showBox(aiGenerateBox);
    aiLoading.textContent = '';
    aiErr.textContent = '';
    aiGenGrade.value = '';
    aiGenType.value = '';
    aiGenGenre.value = '';
    aiGenDetail.value = '';
  }
}

// 漢字・語彙トレーニングを開始
async function startKanjiVocabTraining(itemId) {
  const item = kanjiVocabTrainingItems.find(i => i.id === itemId);
  if (!item) return;
  
  // ことわざトレーニングの場合は専用メニューを表示
  if (itemId === 'kotowaza') {
    showBox(kotowazaMenuBox);
    setupKotowazaMenuButtons();
    return;
  }
  
  // 類義語トレーニングの場合
  if (itemId === 'synonym') {
    console.log('類義語トレーニング開始'); // デバッグ情報
    showBox(kanjiVocabProblemBox);
    
    // ローディング表示
    const problemDiv = document.querySelector('.kanji-vocab-problem');
    problemDiv.innerHTML = '<div style="text-align:center;padding:40px;"><div style="font-size:18px;color:#9333ea;">問題を読み込んでいます...</div></div>';
    
    // 類義語問題データを読み込み
    loadSynonymProblems().then(loaded => {
      console.log('類義語データ読み込み結果:', loaded); // デバッグ情報
      if (loaded) {
        console.log('類義語問題数:', synonymProblems.length); // デバッグ情報
        // 類義語専用の構造を復元
        restoreSynonymHTML();
        
        // 問題セッションを初期化
        currentKanjiVocabSession = {
          grade: 'synonym',
          problems: synonymProblems,
          currentIndex: 0,
          score: 0,
          selectedKanji: [],
          isChecked: false
        };
        
        // 最初の問題を表示
        displayCurrentSynonymProblem();
        setupKanjiVocabButtons();
        console.log('類義語トレーニング開始完了'); // デバッグ情報
      } else {
        console.error('類義語データの読み込みに失敗'); // デバッグ情報
        problemDiv.innerHTML = '<div style="text-align:center;padding:40px;color:#f44336;">問題の読み込みに失敗しました。</div>';
      }
    }).catch(error => {
      console.error('類義語データ読み込みエラー:', error); // デバッグ情報
      problemDiv.innerHTML = '<div style="text-align:center;padding:40px;color:#f44336;">問題の読み込みに失敗しました。</div>';
    });
    return;
  }
  
  // 対義語トレーニングの場合
  if (itemId === 'antonym') {
    console.log('対義語トレーニング開始'); // デバッグ情報
    showBox(kanjiVocabProblemBox);
    
    // ローディング表示
    const problemDiv = document.querySelector('.kanji-vocab-problem');
    problemDiv.innerHTML = '<div style="text-align:center;padding:40px;"><div style="font-size:18px;color:#e91e63;">問題を読み込んでいます...</div></div>';
    
    // 対義語問題データを読み込み
    loadAntonymProblems().then(loaded => {
      console.log('対義語データ読み込み結果:', loaded); // デバッグ情報
      if (loaded) {
        console.log('対義語問題数:', antonymProblems.length); // デバッグ情報
        // 対義語専用の構造を復元
        restoreAntonymHTML();
        
        // 問題セッションを初期化
        currentKanjiVocabSession = {
          grade: 'antonym',
          problems: antonymProblems,
          currentIndex: 0,
          score: 0,
          selectedKanji: [],
          isChecked: false
        };
        
        // 最初の問題を表示
        displayCurrentAntonymProblem();
        setupKanjiVocabButtons();
        console.log('対義語トレーニング開始完了'); // デバッグ情報
      } else {
        console.error('対義語データの読み込みに失敗'); // デバッグ情報
        problemDiv.innerHTML = '<div style="text-align:center;padding:40px;color:#f44336;">問題の読み込みに失敗しました。</div>';
      }
    }).catch(error => {
      console.error('対義語データ読み込みエラー:', error); // デバッグ情報
      problemDiv.innerHTML = '<div style="text-align:center;padding:40px;color:#f44336;">問題の読み込みに失敗しました。</div>';
    });
    return;
  }
  
  // 問題画面に遷移
  showBox(kanjiVocabProblemBox);
  
  // ローディング表示
  const problemDiv = document.querySelector('.kanji-vocab-problem');
          problemDiv.innerHTML = '<div style="text-align:center;padding:40px;"><div style="font-size:18px;color:#9333ea;">問題を読み込んでいます...</div></div>';
  
  // 問題データを読み込み
  const loaded = await loadKanjiVocabProblems(itemId);
  
  if (loaded) {
    // 問題画面の構造を復元
    restoreKanjiVocabHTML();
    
    // 問題セッションを初期化
    currentKanjiVocabSession = {
      grade: itemId,
      problems: kanjiVocabProblems[itemId] || [],
      currentIndex: 0,
      score: 0,
      selectedKanji: [],
      isChecked: false
    };
    
    // 最初の問題を表示
    displayCurrentKanjiVocabProblem();
    setupKanjiVocabButtons();
  } else {
    problemDiv.innerHTML = '<div style="text-align:center;padding:40px;color:#f44336;">問題の読み込みに失敗しました。</div>';
  }
}

// 漢字・語彙問題データを読み込み
async function loadKanjiVocabProblems(grade) {
  try {
    const response = await fetch(`kanji_${grade}_problems.json`);
    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }
    const data = await response.json();
    kanjiVocabProblems[grade] = data;
    return true;
  } catch (error) {
    console.error('漢字・語彙問題の読み込みエラー:', error);
    return false;
  }
}

// 類義語問題データを読み込み
async function loadSynonymProblems() {
  try {
    const response = await fetch('synonym_problems.json');
    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }
    const data = await response.json();
    synonymProblems = data;
    return true;
  } catch (error) {
    console.error('類義語問題の読み込みエラー:', error);
    return false;
  }
}

// 対義語問題データを読み込み
async function loadAntonymProblems() {
  try {
    const response = await fetch('antonym_problems.json');
    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }
    const data = await response.json();
    antonymProblems = data;
    return true;
  } catch (error) {
    console.error('対義語問題の読み込みエラー:', error);
    return false;
  }
}

// 漢字・語彙問題画面のHTML構造を復元
function restoreKanjiVocabHTML() {
  const problemDiv = document.querySelector('.kanji-vocab-problem');
  problemDiv.innerHTML = `
    <div class="problem-header">
      <div class="problem-header-title">問題</div>
      <div class="problem-header-progress" id="kanjiVocabProblemProgress">
        <div style="margin-bottom: 8px;">1/10</div>
        <div style="width: 200px; height: 10px; background: #e0e0e0; border-radius: 5px; margin: 0 auto; position: relative; overflow: hidden;">
          <div style="width: 10%; height: 100%; background: #87CEEB; border-radius: 5px; transition: width 0.3s ease;">
          </div>
        </div>
      </div>
    </div>
    
    <div id="kanjiMeaning" class="kanji-meaning">
      <!-- 言葉の意味がここに表示されます -->
    </div>
    
    <div id="kanjiAnswerArea" class="kanji-answer-area">
      <span style="font-size:18px;color:#666;">漢字を選んで組み合わせてください</span>
    </div>
    
    <div id="kanjiChoices" class="kanji-choices">
      <!-- 漢字の選択肢がここに表示されます -->
    </div>
    
    <div class="kanji-problem-controls">
      <button id="kanjiCheckBtn" class="kanji-btn">答えを確認</button>
      <button id="kanjiResetBtn" class="kanji-btn" style="background:#ff9800;">リセット</button>
      <button id="kanjiNextBtn" class="kanji-btn" style="display:none;">次の問題へ</button>
      <button id="kanjiFinishBtn" class="kanji-btn" style="display:none;">結果を見る</button>
    </div>
    
    <div id="kanjiFeedback" class="kanji-feedback">
      <!-- フィードバックがここに表示されます -->
    </div>
  `;
}

// 類義語問題画面のHTML構造を復元（漢字問題と同じ構造）
function restoreSynonymHTML() {
  const problemDiv = document.querySelector('.kanji-vocab-problem');
  problemDiv.className = 'kanji-vocab-problem synonym-problem';
  problemDiv.innerHTML = `
    <div class="problem-header">
      <div class="problem-header-title">類義語問題</div>
      <div class="problem-header-progress" id="kanjiVocabProblemProgress">
        <div style="margin-bottom: 8px;">1/20</div>
        <div style="width: 200px; height: 10px; background: #e0e0e0; border-radius: 5px; margin: 0 auto; position: relative; overflow: hidden;">
          <div style="width: 5%; height: 100%; background: #9333ea; border-radius: 5px; transition: width 0.3s ease;">
          </div>
        </div>
      </div>
    </div>
    
    <div id="kanjiMeaning" class="kanji-meaning" style="font-family: 'Tsukushi Mincho', 'Yu Mincho', 'YuMincho', 'MS Mincho', serif;">
      <!-- 対象の言葉がここに表示されます -->
    </div>
    
    <div id="kanjiAnswerArea" class="kanji-answer-area">
      <span style="font-size:18px;color:#666;">漢字を選んで類義語を組み合わせてください</span>
    </div>
    
    <div id="kanjiChoices" class="kanji-choices">
      <!-- 漢字の選択肢がここに表示されます -->
    </div>
    
    <div class="kanji-problem-controls">
      <button id="kanjiCheckBtn" class="kanji-btn">答えを確認</button>
      <button id="kanjiResetBtn" class="kanji-btn" style="background:#ff9800;">リセット</button>
      <button id="kanjiNextBtn" class="kanji-btn" style="display:none;">次の問題へ</button>
      <button id="kanjiFinishBtn" class="kanji-btn" style="display:none;">結果を見る</button>
    </div>
    
    <div id="kanjiFeedback" class="kanji-feedback">
      <!-- フィードバックがここに表示されます -->
    </div>
  `;
}

// 対義語問題画面のHTML構造を復元（類義語問題と同じ構造）
function restoreAntonymHTML() {
  const problemDiv = document.querySelector('.kanji-vocab-problem');
  problemDiv.className = 'kanji-vocab-problem antonym-problem';
  problemDiv.innerHTML = `
    <div class="problem-header">
      <div class="problem-header-title">対義語問題</div>
      <div class="problem-header-progress" id="kanjiVocabProblemProgress">
        <div style="margin-bottom: 8px;">1/20</div>
        <div style="width: 200px; height: 10px; background: #e0e0e0; border-radius: 5px; margin: 0 auto; position: relative; overflow: hidden;">
          <div style="width: 5%; height: 100%; background: #e91e63; border-radius: 5px; transition: width 0.3s ease;">
          </div>
        </div>
      </div>
    </div>
    
    <div id="kanjiMeaning" class="kanji-meaning" style="font-family: 'Tsukushi Mincho', 'Yu Mincho', 'YuMincho', 'MS Mincho', serif;">
      <!-- 対象の言葉がここに表示されます -->
    </div>
    
    <div id="kanjiAnswerArea" class="kanji-answer-area">
      <span style="font-size:18px;color:#666;">漢字を選んで対義語を組み合わせてください</span>
    </div>
    
    <div id="kanjiChoices" class="kanji-choices">
      <!-- 漢字の選択肢がここに表示されます -->
    </div>
    
    <div class="kanji-problem-controls">
      <button id="kanjiCheckBtn" class="kanji-btn">答えを確認</button>
      <button id="kanjiResetBtn" class="kanji-btn" style="background:#ff9800;">リセット</button>
      <button id="kanjiNextBtn" class="kanji-btn" style="display:none;">次の問題へ</button>
      <button id="kanjiFinishBtn" class="kanji-btn" style="display:none;">結果を見る</button>
    </div>
    
    <div id="kanjiFeedback" class="kanji-feedback">
      <!-- フィードバックがここに表示されます -->
    </div>
  `;
}

// 現在の漢字・語彙問題を表示
function displayCurrentKanjiVocabProblem() {
  const session = currentKanjiVocabSession;
  if (!session || !session.problems || session.problems.length === 0) {
    console.error('問題データがありません');
    return;
  }
  
  const problem = session.problems[session.currentIndex];
  if (!problem) {
    console.error('問題が見つかりません:', session.currentIndex);
    return;
  }
  
  // 進捗を更新
  updateProblemProgress(session.currentIndex, session.problems.length, 'kanjiVocabProblemProgress');
  
  // 意味を表示
  document.getElementById('kanjiMeaning').textContent = problem.meaning;
  
  // 答えエリアをリセット
  const answerArea = document.getElementById('kanjiAnswerArea');
  answerArea.innerHTML = '<span style="font-size:18px;color:#666;">漢字を選んで組み合わせてください</span>';
  answerArea.classList.remove('has-answer');
  
  // 選択肢を表示
  const choicesContainer = document.getElementById('kanjiChoices');
  choicesContainer.innerHTML = '';
  
  // 選択肢をシャッフル
  const shuffledChoices = [...problem.choices].sort(() => Math.random() - 0.5);
  
  shuffledChoices.forEach(kanji => {
    const choiceElement = document.createElement('div');
    choiceElement.className = 'kanji-choice';
    choiceElement.textContent = kanji;
    choiceElement.dataset.kanji = kanji;
    
    choiceElement.addEventListener('click', () => selectKanji(kanji, choiceElement));
    
    choicesContainer.appendChild(choiceElement);
  });
  
  // ボタンと状態をリセット
  document.getElementById('kanjiFeedback').style.display = 'none';
  document.getElementById('kanjiNextBtn').style.display = 'none';
  document.getElementById('kanjiFinishBtn').style.display = 'none';
  
  // 解答するボタンとリセットボタンを表示
  document.getElementById('kanjiCheckBtn').style.display = 'inline-block';
  document.getElementById('kanjiResetBtn').style.display = 'inline-block';
  
  session.selectedKanji = [];
  session.isChecked = false;
}

// 現在の類義語問題を表示（漢字問題と同じ形式）
function displayCurrentSynonymProblem() {
  const session = currentKanjiVocabSession;
  if (!session || !session.problems || session.problems.length === 0) {
    console.error('類義語問題データがありません');
    return;
  }
  
  // 類義語問題のコンテナから影を削除
  const problemContainer = document.querySelector('.kanji-vocab-problem');
  if (problemContainer) {
    problemContainer.style.boxShadow = 'none';
  }
  
  const problem = session.problems[session.currentIndex];
  if (!problem) {
    console.error('類義語問題が見つかりません:', session.currentIndex);
    return;
  }
  
  // 進捗を更新
  updateProblemProgress(session.currentIndex, session.problems.length, 'kanjiVocabProblemProgress');
  
  // 類義語表示エリアを作成（縦書き形式）
  const meaningElement = document.getElementById('kanjiMeaning');
  const answerArea = document.getElementById('kanjiAnswerArea');
  
  // 答えの文字数に応じた空白を作成
  const answerLength = problem.answer.length;
  const initialSpaces = '　'.repeat(answerLength + 1); // 全角スペースを答えの文字数+1文字分
  
  // 縦書きレイアウトで表示
  const synonymLayout = `
    <div style="display: flex; justify-content: center; align-items: center; gap: 40px; margin: 10px 0;">
      <div id="synonymAnswer" style="
        writing-mode: vertical-rl;
        text-orientation: upright;
        font-size: 48px;
        font-weight: bold;
        font-family: 'Tsukushi Mincho', 'Yu Mincho', 'YuMincho', 'MS Mincho', serif;
        color: #000000;
        min-height: 120px;
        min-width: 60px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        background: transparent;
        padding: 20px 10px;
      ">
        <div style="writing-mode: inherit; text-orientation: inherit; line-height: 1.2; display: flex; align-items: center;">
          <span style="font-size: 48px; color: #666;">（</span>
          <div id="synonymAnswerContent" style="writing-mode: inherit; text-orientation: inherit; line-height: 1.2; min-width: 48px; text-align: center;">
            ${initialSpaces}
          </div>
          <span style="font-size: 48px; color: #666;">）</span>
        </div>
      </div>
      
      <div style="
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 4px;
      ">
        <div style="
          font-size: 18px;
          font-weight: bold;
          color: #ffffff;
          font-family: 'Tsukushi Mincho', 'Yu Mincho', 'YuMincho', 'MS Mincho', serif;
          background: #1e40af;
          border-radius: 4px;
          padding: 4px 8px;
        ">類</div>
        <div style="
          font-size: 36px;
          font-weight: bold;
          color: #666;
          font-family: 'Tsukushi Mincho', 'Yu Mincho', 'YuMincho', 'MS Mincho', serif;
        ">＝</div>
      </div>
      
      <div style="
        writing-mode: vertical-rl;
        text-orientation: upright;
        font-size: 48px;
        font-weight: bold;
        font-family: 'Tsukushi Mincho', 'Yu Mincho', 'YuMincho', 'MS Mincho', serif;
        color: #1a202c;
        min-height: 140px;
        min-width: 80px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        background: transparent;
        padding: 20px 10px;
        line-height: 1.2;
        text-shadow: 0 2px 4px rgba(0,0,0,0.1);
      ">${problem.meaning}</div>
    </div>
    <div id="synonymCommonMeaning" style="
      font-size: 24px;
      color: #333;
      font-family: 'Tsukushi Mincho', 'Yu Mincho', 'YuMincho', 'MS Mincho', serif;
      text-align: center;
      margin-top: 15px;
      margin-bottom: 10px;
      font-weight: bold;
    ">
      <!-- 共通の意味がここに表示されます -->
    </div>
  `;
  
  // meaningElementの内容を置き換え
  meaningElement.innerHTML = synonymLayout;
  meaningElement.style.fontSize = 'inherit';
  meaningElement.style.color = 'inherit';
  meaningElement.style.fontFamily = 'inherit';
  meaningElement.style.background = 'transparent';
  meaningElement.style.border = 'none';
  
  // 共通の意味を設定（meaningElement.innerHTML の後に実行）
  const synonymMeanings = {
    '長所': '良いところ、優れている部分',
    '短所': '劣っているところ、足りない部分',
    '美しい': '見た目が美しく魅力的なこと',
    '大きい': 'サイズや規模が大きいこと',
    '喜ぶ': '嬉しい気持ちになること',
    '重要': '大切で価値があること',
    '困難': '難しくて大変なこと',
    '開始': '物事を始めること',
    '迅速': '早くて素早いこと',
    '賢明': '頭が良くて判断力があること',
    '静寂': '静かで音がしないこと',
    '増加': '数や量が増えること',
    '明確': 'はっきりしていて分かりやすいこと',
    '新鮮': '新しくて生き生きしていること',
    '安全': '危険がなくて安心なこと',
    '正確': '間違いがなくて正しいこと',
    '完成': '作業や制作が終わること',
    '協力': '力を合わせて助け合うこと',
    '発見': '新しいものを見つけること',
    '努力': '目標に向かって頑張ること'
  };
  
  const commonMeaning = synonymMeanings[problem.meaning] || '共通の意味';
  const commonMeaningElement = document.getElementById('synonymCommonMeaning');
  if (commonMeaningElement) {
    commonMeaningElement.textContent = commonMeaning;
  }
  
  // 答えエリアを非表示にする（meaningElementに含まれるため）
  answerArea.innerHTML = '<span style="font-size:16px;color:#666;text-align:center;display:block;margin-top:10px;">漢字を選んで類義語を組み合わせてください</span>';
  answerArea.style.background = 'transparent';
  answerArea.style.border = 'none';
  
  // 選択肢を表示
  const choicesContainer = document.getElementById('kanjiChoices');
  choicesContainer.innerHTML = '';
  
  // 漢字選択肢エリアを横4×縦3のグリッドレイアウトに設定
  choicesContainer.classList.add('grid-layout');
  choicesContainer.style.display = 'grid';
  choicesContainer.style.gridTemplateColumns = 'repeat(4, 1fr)';
  choicesContainer.style.gridTemplateRows = 'repeat(3, 1fr)';
  choicesContainer.style.gap = '16px';
  choicesContainer.style.width = '100%';
  choicesContainer.style.maxWidth = '600px';
  choicesContainer.style.margin = '16px auto';
  choicesContainer.style.padding = '20px';
  
  // 選択肢をシャッフル
  const shuffledChoices = [...problem.choices].sort(() => Math.random() - 0.5);
  
  shuffledChoices.forEach(choice => {
    const choiceElement = document.createElement('div');
    choiceElement.className = 'kanji-choice';
    choiceElement.textContent = choice;
    choiceElement.dataset.kanji = choice;
    choiceElement.style.fontFamily = "'Tsukushi Mincho', 'Yu Mincho', 'YuMincho', 'MS Mincho', serif";
    choiceElement.style.color = "#000000";
    choiceElement.style.fontWeight = "bold";
    choiceElement.style.fontSize = "48px";
    choiceElement.style.aspectRatio = "1";
    choiceElement.style.display = "flex";
    choiceElement.style.alignItems = "center";
    choiceElement.style.justifyContent = "center";
    choiceElement.style.border = "3px solid #3B82F6";
    choiceElement.style.borderRadius = "16px";
    choiceElement.style.background = "linear-gradient(145deg, #ffffff, #f8fafc)";
    choiceElement.style.boxShadow = "0 6px 20px rgba(0, 0, 0, 0.08), 0 3px 10px rgba(0, 0, 0, 0.04), inset 0 1px 0 rgba(255, 255, 255, 0.9)";
    choiceElement.style.cursor = "pointer";
    choiceElement.style.transition = "all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1)";
    choiceElement.style.position = "relative";
    choiceElement.style.overflow = "hidden";
    
    // 光沢エフェクト用の要素を追加
    const shineEffect = document.createElement('div');
    shineEffect.className = 'shine-effect';
    shineEffect.style.cssText = `
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.6), transparent);
      transition: left 0.5s ease;
      pointer-events: none;
    `;
    choiceElement.appendChild(shineEffect);
    
    // プロフェッショナルなホバーエフェクト
    choiceElement.addEventListener('mouseenter', () => {
      if (!session.isChecked && !choiceElement.classList.contains('selected')) {
        choiceElement.style.background = 'linear-gradient(145deg, #ffffff, #f1f5f9)';
        choiceElement.style.transform = 'translateY(-3px) scale(1.02)';
        choiceElement.style.boxShadow = '0 12px 40px rgba(0, 0, 0, 0.12), 0 6px 20px rgba(0, 0, 0, 0.08), inset 0 1px 0 rgba(255, 255, 255, 0.95)';
        choiceElement.style.color = '#1a202c';
        
        // 光沢エフェクトを動作
        const shine = choiceElement.querySelector('.shine-effect');
        if (shine) {
          shine.style.left = '100%';
        }
      }
    });
    choiceElement.addEventListener('mouseleave', () => {
      if (!session.isChecked && !choiceElement.classList.contains('selected')) {
        choiceElement.style.background = 'linear-gradient(145deg, #ffffff, #f8fafc)';
        choiceElement.style.transform = 'translateY(0) scale(1)';
        choiceElement.style.boxShadow = '0 6px 20px rgba(0, 0, 0, 0.08), 0 3px 10px rgba(0, 0, 0, 0.04), inset 0 1px 0 rgba(255, 255, 255, 0.9)';
        choiceElement.style.color = '#000000';
        
        // 光沢エフェクトをリセット
        const shine = choiceElement.querySelector('.shine-effect');
        if (shine) {
          shine.style.left = '-100%';
        }
      }
    });
    
    choiceElement.addEventListener('click', () => selectKanji(choice, choiceElement));
    
    choicesContainer.appendChild(choiceElement);
  });
  
  // ボタンと状態をリセット
  document.getElementById('kanjiFeedback').style.display = 'none';
  document.getElementById('kanjiNextBtn').style.display = 'none';
  document.getElementById('kanjiFinishBtn').style.display = 'none';
  
  // 解答するボタンとリセットボタンを表示
  document.getElementById('kanjiCheckBtn').style.display = 'inline-block';
  document.getElementById('kanjiResetBtn').style.display = 'inline-block';
  
  session.selectedKanji = [];
  session.isChecked = false;
}

// 現在の対義語問題を表示（類義語問題と同じ形式）
function displayCurrentAntonymProblem() {
  const session = currentKanjiVocabSession;
  if (!session || !session.problems || session.problems.length === 0) {
    console.error('対義語問題データがありません');
    return;
  }
  
  // 対義語問題のコンテナから影を削除
  const problemContainer = document.querySelector('.kanji-vocab-problem');
  if (problemContainer) {
    problemContainer.style.boxShadow = 'none';
  }
  
  const problem = session.problems[session.currentIndex];
  if (!problem) {
    console.error('対義語問題が見つかりません:', session.currentIndex);
    return;
  }
  
  // 進捗を更新
  updateProblemProgress(session.currentIndex, session.problems.length, 'kanjiVocabProblemProgress');
  
  // 対義語表示エリアを作成（縦書き形式）
  const meaningElement = document.getElementById('kanjiMeaning');
  const answerArea = document.getElementById('kanjiAnswerArea');
  
  // 答えの文字数に応じた空白を作成
  const answerLength = problem.answer.length;
  const initialSpaces = '　'.repeat(answerLength + 1); // 全角スペースを答えの文字数+1文字分
  
  // 縦書きレイアウトで表示
  const antonymLayout = `
    <div style="display: flex; justify-content: center; align-items: center; gap: 40px; margin: 10px 0;">
      <div id="antonymAnswer" style="
        writing-mode: vertical-rl;
        text-orientation: upright;
        font-size: 48px;
        font-weight: bold;
        font-family: 'Tsukushi Mincho', 'Yu Mincho', 'YuMincho', 'MS Mincho', serif;
        color: #000000;
        min-height: 120px;
        min-width: 60px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        background: transparent;
        padding: 20px 10px;
      ">
        <div style="writing-mode: inherit; text-orientation: inherit; line-height: 1.2; display: flex; align-items: center;">
          <span style="font-size: 48px; color: #666;">（</span>
          <div id="antonymAnswerContent" style="writing-mode: inherit; text-orientation: inherit; line-height: 1.2; min-width: 48px; text-align: center;">
            ${initialSpaces}
          </div>
          <span style="font-size: 48px; color: #666;">）</span>
        </div>
      </div>
      
      <div style="
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 4px;
      ">
        <div style="
          font-size: 18px;
          font-weight: bold;
          color: #ffffff;
          font-family: 'Tsukushi Mincho', 'Yu Mincho', 'YuMincho', 'MS Mincho', serif;
          background: #e91e63;
          border-radius: 4px;
          padding: 4px 8px;
        ">対</div>
                 <div style="
           font-size: 36px;
           font-weight: normal;
           color: #666;
           font-family: 'Arial', sans-serif;
         ">⇔</div>
      </div>
      
      <div style="
        writing-mode: vertical-rl;
        text-orientation: upright;
        font-size: 48px;
        font-weight: bold;
        font-family: 'Tsukushi Mincho', 'Yu Mincho', 'YuMincho', 'MS Mincho', serif;
        color: #1a202c;
        min-height: 140px;
        min-width: 80px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        background: transparent;
        padding: 20px 10px;
        line-height: 1.2;
        text-shadow: 0 2px 4px rgba(0,0,0,0.1);
      ">${problem.meaning}</div>
    </div>
    <div id="antonymCommonMeaning" style="
      font-size: 24px;
      color: #333;
      font-family: 'Tsukushi Mincho', 'Yu Mincho', 'YuMincho', 'MS Mincho', serif;
      text-align: center;
      margin-top: 15px;
      margin-bottom: 10px;
      font-weight: bold;
    ">
      <!-- 共通の意味がここに表示されます -->
    </div>
  `;
  
  // meaningElementの内容を置き換え
  meaningElement.innerHTML = antonymLayout;
  meaningElement.style.fontSize = 'inherit';
  meaningElement.style.color = 'inherit';
  meaningElement.style.fontFamily = 'inherit';
  meaningElement.style.background = 'transparent';
  meaningElement.style.border = 'none';
  
  // 共通の意味を設定（meaningElement.innerHTML の後に実行）
  const antonymMeanings = {
    '長所': '良いところの反対',
    '短所': '劣っているところの反対',
    '美しい': '見た目が美しいことの反対',
    '大きい': 'サイズや規模が大きいことの反対',
    '喜ぶ': '嬉しい気持ちの反対',
    '重要': '大切で価値があることの反対',
    '困難': '難しくて大変なことの反対',
    '開始': '物事を始めることの反対',
    '迅速': '早くて素早いことの反対',
    '賢明': '頭が良くて判断力があることの反対',
    '静寂': '静かで音がしないことの反対',
    '増加': '数や量が増えることの反対',
    '明確': 'はっきりしていて分かりやすいことの反対',
    '新鮮': '新しくて生き生きしていることの反対',
    '安全': '危険がなくて安心なことの反対',
    '正確': '間違いがなくて正しいことの反対',
    '完成': '作業や制作が終わることの反対',
    '協力': '力を合わせて助け合うことの反対',
    '発見': '新しいものを見つけることの反対',
    '努力': '目標に向かって頑張ることの反対'
  };
  
  const commonMeaning = antonymMeanings[problem.meaning] || '反対の意味';
  const commonMeaningElement = document.getElementById('antonymCommonMeaning');
  if (commonMeaningElement) {
    commonMeaningElement.textContent = commonMeaning;
  }
  
  // 答えエリアを非表示にする（meaningElementに含まれるため）
  answerArea.innerHTML = '<span style="font-size:16px;color:#666;text-align:center;display:block;margin-top:10px;">漢字を選んで対義語を組み合わせてください</span>';
  answerArea.style.background = 'transparent';
  answerArea.style.border = 'none';
  
  // 選択肢を表示
  const choicesContainer = document.getElementById('kanjiChoices');
  choicesContainer.innerHTML = '';
  
  // 漢字選択肢エリアを横4×縦3のグリッドレイアウトに設定
  choicesContainer.classList.add('grid-layout');
  choicesContainer.style.display = 'grid';
  choicesContainer.style.gridTemplateColumns = 'repeat(4, 1fr)';
  choicesContainer.style.gridTemplateRows = 'repeat(3, 1fr)';
  choicesContainer.style.gap = '16px';
  choicesContainer.style.width = '100%';
  choicesContainer.style.maxWidth = '600px';
  choicesContainer.style.margin = '16px auto';
  choicesContainer.style.padding = '20px';
  
  // 選択肢をシャッフル
  const shuffledChoices = [...problem.choices].sort(() => Math.random() - 0.5);
  
  shuffledChoices.forEach(choice => {
    const choiceElement = document.createElement('div');
    choiceElement.className = 'kanji-choice';
    choiceElement.textContent = choice;
    choiceElement.dataset.kanji = choice;
    choiceElement.style.fontFamily = "'Tsukushi Mincho', 'Yu Mincho', 'YuMincho', 'MS Mincho', serif";
    choiceElement.style.color = "#000000";
    choiceElement.style.fontWeight = "bold";
    choiceElement.style.fontSize = "48px";
    choiceElement.style.aspectRatio = "1";
    choiceElement.style.display = "flex";
    choiceElement.style.alignItems = "center";
    choiceElement.style.justifyContent = "center";
    choiceElement.style.border = "3px solid #e91e63";
    choiceElement.style.borderRadius = "16px";
    choiceElement.style.background = "linear-gradient(145deg, #ffffff, #f8fafc)";
    choiceElement.style.boxShadow = "0 6px 20px rgba(0, 0, 0, 0.08), 0 3px 10px rgba(0, 0, 0, 0.04), inset 0 1px 0 rgba(255, 255, 255, 0.9)";
    choiceElement.style.cursor = "pointer";
    choiceElement.style.transition = "all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1)";
    choiceElement.style.position = "relative";
    choiceElement.style.overflow = "hidden";
    
    // 光沢エフェクト用の要素を追加
    const shineEffect = document.createElement('div');
    shineEffect.className = 'shine-effect';
    shineEffect.style.cssText = `
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.6), transparent);
      transition: left 0.5s ease;
      pointer-events: none;
    `;
    choiceElement.appendChild(shineEffect);
    
    // プロフェッショナルなホバーエフェクト
    choiceElement.addEventListener('mouseenter', () => {
      if (!session.isChecked && !choiceElement.classList.contains('selected')) {
        choiceElement.style.background = 'linear-gradient(145deg, #ffffff, #f1f5f9)';
        choiceElement.style.transform = 'translateY(-3px) scale(1.02)';
        choiceElement.style.boxShadow = '0 12px 40px rgba(0, 0, 0, 0.12), 0 6px 20px rgba(0, 0, 0, 0.08), inset 0 1px 0 rgba(255, 255, 255, 0.95)';
        choiceElement.style.color = '#1a202c';
        
        // 光沢エフェクトを動作
        const shine = choiceElement.querySelector('.shine-effect');
        if (shine) {
          shine.style.left = '100%';
        }
      }
    });
    choiceElement.addEventListener('mouseleave', () => {
      if (!session.isChecked && !choiceElement.classList.contains('selected')) {
        choiceElement.style.background = 'linear-gradient(145deg, #ffffff, #f8fafc)';
        choiceElement.style.transform = 'translateY(0) scale(1)';
        choiceElement.style.boxShadow = '0 6px 20px rgba(0, 0, 0, 0.08), 0 3px 10px rgba(0, 0, 0, 0.04), inset 0 1px 0 rgba(255, 255, 255, 0.9)';
        choiceElement.style.color = '#000000';
        
        // 光沢エフェクトをリセット
        const shine = choiceElement.querySelector('.shine-effect');
        if (shine) {
          shine.style.left = '-100%';
        }
      }
    });
    
    choiceElement.addEventListener('click', () => selectKanji(choice, choiceElement));
    
    choicesContainer.appendChild(choiceElement);
  });
  
  // ボタンと状態をリセット
  document.getElementById('kanjiFeedback').style.display = 'none';
  document.getElementById('kanjiNextBtn').style.display = 'none';
  document.getElementById('kanjiFinishBtn').style.display = 'none';
  
  // 解答するボタンとリセットボタンを表示
  document.getElementById('kanjiCheckBtn').style.display = 'inline-block';
  document.getElementById('kanjiResetBtn').style.display = 'inline-block';
  
  session.selectedKanji = [];
  session.isChecked = false;
}




// 漢字を選択
function selectKanji(kanji, element) {
  const session = currentKanjiVocabSession;
  
  if (session.isChecked) return; // 回答済みの場合は選択不可
  
  const answerArea = document.getElementById('kanjiAnswerArea');
  
  if (element.classList.contains('selected')) {
    // 既に選択されている場合は選択解除
    if (session.grade === 'synonym') {
      // 類義語問題では左側エリアから漢字を削除
      const answerContent = document.getElementById('synonymAnswerContent');
      if (answerContent) {
        const currentText = answerContent.textContent || '';
        // 該当する漢字を削除し、全角スペースで置き換え
        const kanjiIndex = currentText.indexOf(kanji);
        if (kanjiIndex !== -1) {
          const newText = currentText.substring(0, kanjiIndex) + '　' + currentText.substring(kanjiIndex + 1);
          answerContent.textContent = newText;
          console.log('漢字を削除:', kanji, '現在の組み合わせ:', newText);
        } else {
          console.warn('削除対象の漢字が見つかりませんでした:', kanji);
        }
      }
      element.classList.remove('selected');
      element.style.background = 'linear-gradient(145deg, #ffffff, #f8fafc)';
      element.style.border = '3px solid #3B82F6';
      element.style.boxShadow = '0 6px 20px rgba(0, 0, 0, 0.08), 0 3px 10px rgba(0, 0, 0, 0.04), inset 0 1px 0 rgba(255, 255, 255, 0.9)';
      element.style.color = '#000000';
      element.style.opacity = '1';
      element.style.pointerEvents = 'auto';
      element.style.transform = 'translateY(0) scale(1)';
    } else if (session.grade === 'antonym') {
      // 対義語問題では左側エリアから漢字を削除
      const answerContent = document.getElementById('antonymAnswerContent');
      if (answerContent) {
        const currentText = answerContent.textContent || '';
        // 該当する漢字を削除し、全角スペースで置き換え
        const kanjiIndex = currentText.indexOf(kanji);
        if (kanjiIndex !== -1) {
          const newText = currentText.substring(0, kanjiIndex) + '　' + currentText.substring(kanjiIndex + 1);
          answerContent.textContent = newText;
          console.log('漢字を削除:', kanji, '現在の組み合わせ:', newText);
        } else {
          console.warn('削除対象の漢字が見つかりませんでした:', kanji);
        }
      }
      element.classList.remove('selected');
      element.style.background = 'linear-gradient(145deg, #ffffff, #f8fafc)';
      element.style.border = '3px solid #e91e63';
      element.style.boxShadow = '0 6px 20px rgba(0, 0, 0, 0.08), 0 3px 10px rgba(0, 0, 0, 0.04), inset 0 1px 0 rgba(255, 255, 255, 0.9)';
      element.style.color = '#000000';
      element.style.opacity = '1';
      element.style.pointerEvents = 'auto';
      element.style.transform = 'translateY(0) scale(1)';
    } else {
      // 従来の選択解除処理
      element.classList.remove('selected');
      element.style.background = '#fff';
      element.style.borderColor = '#e1bee7';
    }
    const index = session.selectedKanji.indexOf(kanji);
    if (index > -1) {
      session.selectedKanji.splice(index, 1);
    }
  } else {
    // 新しく選択
    if (session.selectedKanji.length < 2) {
      // 類義語問題では飛んでいくアニメーション
      if (session.grade === 'synonym') {
        animateKanjiToCell(kanji, element);
      } else if (session.grade === 'antonym') {
        animateKanjiToAntonymCell(kanji, element);
      } else {
        element.classList.add('selected');
        element.style.background = '#666';
        element.style.borderColor = '#444';
      }
      session.selectedKanji.push(kanji);
    } else {
      alert('漢字は2文字まで選択できます。');
      return;
    }
  }
  
  // 答えエリアを更新（類義語・対義語問題以外）
  if (session.grade !== 'synonym' && session.grade !== 'antonym') {
    if (session.selectedKanji.length > 0) {
      answerArea.innerHTML = session.selectedKanji.map(k => 
        `<span class="selected-kanji">${k}</span>`
      ).join('');
      answerArea.classList.add('has-answer');
    } else {
      answerArea.innerHTML = '<span style="font-size:18px;color:#666;">漢字を選んで組み合わせてください</span>';
      answerArea.classList.remove('has-answer');
    }
  }
}

// 漢字が左側エリアに飛んでいくアニメーション
function animateKanjiToCell(kanji, sourceElement) {
  const session = currentKanjiVocabSession;
  
  // 左側の答えエリアを取得
  const targetArea = document.getElementById('synonymAnswer');
  if (!targetArea) {
    console.error('答えエリアが見つかりません');
    return;
  }
  
  // 既に2文字選択されている場合は何もしない
  if (session.selectedKanji.length >= 2) {
    alert('漢字は2文字まで選択できます。');
    return;
  }
  
  // 飛んでいく要素を作成
  const flyingKanji = document.createElement('div');
  
  // 元のボタンのスタイルを取得
  const computedStyle = window.getComputedStyle(sourceElement);
  
  // 飛んでいく要素のスタイルを設定
  flyingKanji.className = 'kanji-choice flying-kanji-animated';
  flyingKanji.textContent = kanji;
  
  // 位置とサイズの設定
  const sourceRect = sourceElement.getBoundingClientRect();
  const targetRect = targetArea.getBoundingClientRect();
  
  flyingKanji.style.position = 'fixed';
  flyingKanji.style.left = sourceRect.left + 'px';
  flyingKanji.style.top = sourceRect.top + 'px';
  flyingKanji.style.width = sourceRect.width + 'px';
  flyingKanji.style.height = sourceRect.height + 'px';
  flyingKanji.style.zIndex = '1000';
  flyingKanji.style.pointerEvents = 'none';
  
  // 元のスタイルを維持（背景は透明）
  flyingKanji.style.background = 'transparent';
  flyingKanji.style.border = 'none';
  flyingKanji.style.borderRadius = computedStyle.borderRadius;
  flyingKanji.style.fontSize = computedStyle.fontSize;
  flyingKanji.style.fontWeight = computedStyle.fontWeight;
  flyingKanji.style.fontFamily = computedStyle.fontFamily;
  flyingKanji.style.color = computedStyle.color;
  flyingKanji.style.display = 'flex';
  flyingKanji.style.alignItems = 'center';
  flyingKanji.style.justifyContent = 'center';
  flyingKanji.style.transition = 'all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94)';
  flyingKanji.style.boxShadow = 'none';
  flyingKanji.style.opacity = '0.6';
  
  document.body.appendChild(flyingKanji);
  
  // 元の要素に選択状態のスタイルを適用
  sourceElement.style.opacity = '1';
  sourceElement.style.pointerEvents = 'auto';
  sourceElement.classList.add('selected');
  sourceElement.style.background = 'linear-gradient(145deg, #e1bee7, #d1c4e9)';
  sourceElement.style.border = '3px solid #9C27B0';
  sourceElement.style.boxShadow = '0 8px 32px rgba(209, 196, 233, 0.4), 0 4px 16px rgba(209, 196, 233, 0.3), inset 0 1px 0 rgba(255, 255, 255, 0.6)';
  sourceElement.style.color = '#4a148c';
  sourceElement.style.transform = 'translateY(-2px) scale(1.01)';
  
  // アニメーション開始（高速）
  setTimeout(() => {
    // ターゲット位置を計算（左側エリアの中央）
    const targetLeft = targetRect.left + (targetRect.width - sourceRect.width) / 2;
    const targetTop = targetRect.top + (targetRect.height - sourceRect.height) / 2;
    
    flyingKanji.style.left = targetLeft + 'px';
    flyingKanji.style.top = targetTop + 'px';
    flyingKanji.style.transform = 'scale(0.95)';
    
    // 飛行中の効果
    flyingKanji.style.filter = 'brightness(1)';
    flyingKanji.style.opacity = '0.5';
  }, 20);
  
  // アニメーション完了後の処理
  setTimeout(() => {
    // 飛んでいく要素を削除
    if (document.body.contains(flyingKanji)) {
      document.body.removeChild(flyingKanji);
    }
    
    // 左側エリアに漢字を追加
    const answerContent = document.getElementById('synonymAnswerContent');
    if (answerContent) {
      // 最初の全角スペースを漢字で置き換え
      const currentText = answerContent.textContent || '';
      const spaceIndex = currentText.indexOf('　');
      if (spaceIndex !== -1) {
        const newText = currentText.substring(0, spaceIndex) + kanji + currentText.substring(spaceIndex + 1);
        answerContent.textContent = newText;
      } else {
        // スペースがない場合は末尾に追加
        answerContent.textContent = currentText + kanji;
      }
      
      console.log('漢字配置完了:', kanji, '現在の組み合わせ:', answerContent.textContent);
    } else {
      console.error('答えコンテンツエリアが見つかりません');
    }
    
    // エリアにふわっと現れるアニメーション
    targetArea.style.transform = 'scale(1.02)';
    setTimeout(() => {
      targetArea.style.transform = 'scale(1)';
    }, 150);
    
    // 2文字揃ったら次へボタンを有効化
    if (session.selectedKanji.length === 2) {
      const nextBtn = document.getElementById('kanjiNextBtn');
      if (nextBtn) {
        nextBtn.disabled = false;
        nextBtn.style.opacity = '1';
      }
    }
  }, 150);
}

// 漢字が左側エリアに飛んでいくアニメーション（対義語用）
function animateKanjiToAntonymCell(kanji, sourceElement) {
  const session = currentKanjiVocabSession;
  
  // 左側の答えエリアを取得
  const targetArea = document.getElementById('antonymAnswer');
  if (!targetArea) {
    console.error('対義語答えエリアが見つかりません');
    return;
  }
  
  // 既に2文字選択されている場合は何もしない
  if (session.selectedKanji.length >= 2) {
    alert('漢字は2文字まで選択できます。');
    return;
  }
  
  // 飛んでいく要素を作成
  const flyingKanji = document.createElement('div');
  
  // 元のボタンのスタイルを取得
  const computedStyle = window.getComputedStyle(sourceElement);
  
  // 飛んでいく要素のスタイルを設定
  flyingKanji.className = 'kanji-choice flying-kanji-animated';
  flyingKanji.textContent = kanji;
  
  // 位置とサイズの設定
  const sourceRect = sourceElement.getBoundingClientRect();
  const targetRect = targetArea.getBoundingClientRect();
  
  flyingKanji.style.position = 'fixed';
  flyingKanji.style.left = sourceRect.left + 'px';
  flyingKanji.style.top = sourceRect.top + 'px';
  flyingKanji.style.width = sourceRect.width + 'px';
  flyingKanji.style.height = sourceRect.height + 'px';
  flyingKanji.style.zIndex = '1000';
  flyingKanji.style.pointerEvents = 'none';
  
  // 元のスタイルを維持（背景は透明）
  flyingKanji.style.background = 'transparent';
  flyingKanji.style.border = 'none';
  flyingKanji.style.borderRadius = computedStyle.borderRadius;
  flyingKanji.style.fontSize = computedStyle.fontSize;
  flyingKanji.style.fontWeight = computedStyle.fontWeight;
  flyingKanji.style.fontFamily = computedStyle.fontFamily;
  flyingKanji.style.color = computedStyle.color;
  flyingKanji.style.display = 'flex';
  flyingKanji.style.alignItems = 'center';
  flyingKanji.style.justifyContent = 'center';
  flyingKanji.style.transition = 'all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94)';
  flyingKanji.style.boxShadow = 'none';
  flyingKanji.style.opacity = '0.6';
  
  document.body.appendChild(flyingKanji);
  
  // 元の要素に選択状態のスタイルを適用（対義語用カラー）
  sourceElement.style.opacity = '1';
  sourceElement.style.pointerEvents = 'auto';
  sourceElement.classList.add('selected');
  sourceElement.style.background = 'linear-gradient(145deg, #fce7f3, #f3e8ff)';
  sourceElement.style.border = '3px solid #e91e63';
  sourceElement.style.boxShadow = '0 8px 32px rgba(233, 30, 99, 0.4), 0 4px 16px rgba(233, 30, 99, 0.3), inset 0 1px 0 rgba(255, 255, 255, 0.6)';
  sourceElement.style.color = '#831843';
  sourceElement.style.transform = 'translateY(-2px) scale(1.01)';
  
  // アニメーション開始（高速）
  setTimeout(() => {
    // ターゲット位置を計算（左側エリアの中央）
    const targetLeft = targetRect.left + (targetRect.width - sourceRect.width) / 2;
    const targetTop = targetRect.top + (targetRect.height - sourceRect.height) / 2;
    
    flyingKanji.style.left = targetLeft + 'px';
    flyingKanji.style.top = targetTop + 'px';
    flyingKanji.style.transform = 'scale(0.95)';
    
    // 飛行中の効果
    flyingKanji.style.filter = 'brightness(1)';
    flyingKanji.style.opacity = '0.5';
  }, 20);
  
  // アニメーション完了後の処理
  setTimeout(() => {
    // 飛んでいく要素を削除
    if (document.body.contains(flyingKanji)) {
      document.body.removeChild(flyingKanji);
    }
    
    // 左側エリアに漢字を追加
    const answerContent = document.getElementById('antonymAnswerContent');
    if (answerContent) {
      // 最初の全角スペースを漢字で置き換え
      const currentText = answerContent.textContent || '';
      const spaceIndex = currentText.indexOf('　');
      if (spaceIndex !== -1) {
        const newText = currentText.substring(0, spaceIndex) + kanji + currentText.substring(spaceIndex + 1);
        answerContent.textContent = newText;
      } else {
        // スペースがない場合は末尾に追加
        answerContent.textContent = currentText + kanji;
      }
      
      console.log('対義語漢字配置完了:', kanji, '現在の組み合わせ:', answerContent.textContent);
    } else {
      console.error('対義語答えコンテンツエリアが見つかりません');
    }
    
    // エリアにふわっと現れるアニメーション
    targetArea.style.transform = 'scale(1.02)';
    setTimeout(() => {
      targetArea.style.transform = 'scale(1)';
    }, 150);
    
    // 2文字揃ったら次へボタンを有効化
    if (session.selectedKanji.length === 2) {
      const nextBtn = document.getElementById('kanjiNextBtn');
      if (nextBtn) {
        nextBtn.disabled = false;
        nextBtn.style.opacity = '1';
      }
    }
  }, 150);
}

// 論理トレーニングを開始
async function startLogicTraining(itemId) {
  const item = logicTrainingItems.find(i => i.id === itemId);
  if (!item) return;
  
  // 近日公開のアイテムの場合は何もしない
  if (item.status === 'coming-soon') {
    console.log('このアイテムは近日公開です:', item.title);
    return;
  }
  
  // ファイル名が指定されていない場合は何もしない
  if (!item.filename) {
    console.log('ファイル名が指定されていません:', item.title);
    return;
  }
  
  // 具体と抽象の問題の場合
  if (itemId.startsWith('concrete-abstract-')) {
    // 問題データを読み込んでからゲームを開始
    showBox(concreteAbstractBox);
    
    // タイトルを更新
    updateGameTitle(item.title);
    
    // 問題インデックスをリセット
    window.currentProblemIndex = 0;
    
    // 問題データを読み込み
    const loaded = await loadConcreteAbstractProblems(item.filename);
    if (loaded && concreteAbstractProblems.length > 0) {
      // 初期化
      initConcreteAbstractGame();
    } else {
      // エラー表示
      const gameDiv = $('concreteAbstractGame');
      gameDiv.innerHTML = '<div style="text-align:center;padding:40px;color:#f44336;">問題データの読み込みに失敗しました。</div>';
    }
  } else if (itemId.startsWith('pronoun-reference-')) {
    // 指示語問題の場合
    showBox(pronounReferenceBox);
    
    // タイトルを更新
    updatePronounGameTitle(item.title);
    
    // ローディング表示
    const gameDiv = $('pronounReferenceGame');
            gameDiv.innerHTML = '<div style="text-align:center;padding:40px;"><div style="font-size:18px;color:#ea580c;">問題を読み込んでいます...</div></div>';
    
    const loaded = await loadPronounReferenceProblems(item.filename);
    if (loaded) {
      // 元のHTML構造を復元
      restorePronounGameHTML();
      initPronounReferenceGame();
    } else {
      gameDiv.innerHTML = '<div style="text-align:center;padding:40px;color:#f44336;">問題の読み込みに失敗しましたが、基本問題で続行します。</div>';
      setTimeout(() => {
        restorePronounGameHTML();
        initPronounReferenceGame();
      }, 2000);
    }
  } else {
    alert(`${item.title}の詳細な問題は現在開発中です。お楽しみに！`);
  }
}

// ゲームタイトルを更新
function updateGameTitle(title) {
  const titleElement = document.querySelector('#concreteAbstractBox h2');
  if (titleElement) {
    titleElement.textContent = title;
  }
}

// 指示語問題のタイトルを更新
function updatePronounGameTitle(title) {
  const titleElement = document.querySelector('#pronounReferenceBox h2');
  if (titleElement) {
    titleElement.textContent = title;
  }
}

// 指示語問題のHTML構造を復元
function restorePronounGameHTML() {
  const gameDiv = $('pronounReferenceGame');
  
  gameDiv.innerHTML = `
    <div class="problem-header">
      <div class="problem-header-title">問題</div>
      <div class="problem-header-progress" id="pronounProgress">
        <div style="margin-bottom: 8px;">1/10</div>
        <div style="width: 200px; height: 10px; background: #e0e0e0; border-radius: 5px; margin: 0 auto; position: relative; overflow: hidden;">
          <div style="width: 10%; height: 100%; background: #87CEEB; border-radius: 5px; transition: width 0.3s ease;">
          </div>
        </div>
      </div>
    </div>
    
    <div id="pronounText" style="font-size:20px;line-height:1.8;margin-bottom:32px;font-family:'UD Digi Kyokasho N-R','UD デジタル 教科書体 N-R','Klee','HiraMinProN-W3',serif;writing-mode:vertical-rl;text-orientation:upright;height:300px;width:600px;margin-left:auto;margin-right:auto;padding:20px;overflow:hidden;position:relative;">
      <div style="position:absolute;left:50%;transform:translateX(-50%);width:auto;height:100%;writing-mode:inherit;text-orientation:inherit;">
        <!-- 問題文がここに表示されます -->
      </div>
    </div>
    
    <div id="pronounQuestion" style="font-size:18px;font-weight:bold;margin-bottom:24px;text-align:center;color:#4CAF50;">
      <!-- 質問がここに表示されます -->
    </div>
    
    <div id="pronounOptions" style="display:grid;grid-template-columns:1fr;gap:16px;margin-bottom:32px;max-width:600px;margin-left:auto;margin-right:auto;">
      <!-- 選択肢がここに表示されます -->
    </div>
    
    <div id="pronounFeedback" style="margin-bottom:24px;font-size:16px;padding:16px;border-radius:8px;display:none;">
      <!-- フィードバックがここに表示されます -->
    </div>
  `;
}

// ゲームのイベントハンドラーを設定
function setupGameEventHandlers() {
  const checkAnswerBtn = $('checkAnswerBtn');
  const resetGameBtn = $('resetGameBtn');
  
  if (checkAnswerBtn) {
    checkAnswerBtn.onclick = checkAnswer;
  }
  
  if (resetGameBtn) {
    resetGameBtn.onclick = resetGame;
  }
}

// 具体と抽象ゲームの初期化
function initConcreteAbstractGame() {
  console.log('具体と抽象ゲーム初期化開始');
  
  // 順番に問題を選択（現在の問題インデックスから）
  if (!window.currentProblemIndex) {
    window.currentProblemIndex = 0;
  }
  
  if (!concreteAbstractProblems || concreteAbstractProblems.length === 0) {
    console.error('問題データがありません');
    return;
  }
  
  currentProblem = concreteAbstractProblems[window.currentProblemIndex];
  console.log('現在の問題:', currentProblem);
  
  // ゲーム状態をリセット
  gameState = {
    abstract: null,
    concretes: [null, null, null]
  };
  
  // 問題情報を表示
  updateProblemInfo();
  
  // 発展編かどうかを判定
  if (currentProblemLevel && currentProblemLevel.level === '発展') {
    // 発展編の場合は文章読解+入力欄形式
    initAdvancedMode();
  } else {
    // 基礎編・応用編の場合は従来のドラッグ&ドロップ形式
    // ドロップゾーンをクリア
    clearDropZones();
    
    // 単語カードを生成
    generateWordCards();
  }
  
  // 結果を非表示
  const gameResult = $('gameResult');
  if (gameResult) {
    gameResult.style.display = 'none';
  }
  
  // 解答するボタンとリセットボタンを表示
  const checkAnswerBtn = $('checkAnswerBtn');
  const resetGameBtn = $('resetGameBtn');
  if (checkAnswerBtn) {
    checkAnswerBtn.style.display = 'inline-block';
    checkAnswerBtn.onclick = checkAnswer;
  }
  if (resetGameBtn) {
    resetGameBtn.style.display = 'inline-block';
    resetGameBtn.onclick = resetGame;
  }
  
  console.log('具体と抽象ゲーム初期化完了');
}

// 問題情報を更新
function updateProblemInfo() {
  const problemInfo = $('problemInfo');
  if (problemInfo && currentProblem && currentProblemLevel) {
    const currentNum = (window.currentProblemIndex || 0) + 1;
    const totalNum = concreteAbstractProblems.length;
    problemInfo.innerHTML = `
      <div style="font-size:16px; font-weight:bold; color:#2c3e50; margin-bottom:8px;">
        (${currentProblemLevel.title})
      </div>
      <div style="font-size:14px; color:#666; margin-bottom:8px;">${currentNum}/${totalNum}</div>
      <div style="width: 200px; height: 10px; background: #e0e0e0; border-radius: 5px; margin: 0 auto; position: relative; overflow: hidden;">
        <div style="width: ${(currentNum / totalNum) * 100}%; height: 100%; background: #87CEEB; border-radius: 5px; transition: width 0.3s ease;">
        </div>
      </div>
    `;
  }
}

// 進捗情報を更新（削除）
function updateProgressInfo() {
  // この関数は不要になったため削除
}

// 共通の進捗更新関数
function updateProblemProgress(currentIndex, totalCount, progressTextId) {
  const currentNum = currentIndex + 1;
  
  // 進捗テキストを更新
  const progressText = document.getElementById(progressTextId);
  if (progressText) {
    // テキストと進捗バーのHTMLを生成
    const progressPercentage = (currentNum / totalCount) * 100;
    progressText.innerHTML = `
      <div style="margin-bottom: 8px;">${currentNum}/${totalCount}</div>
      <div style="width: 200px; height: 10px; background: #e0e0e0; border-radius: 5px; margin: 0 auto; position: relative; overflow: hidden;">
        <div style="width: ${progressPercentage}%; height: 100%; background: #87CEEB; border-radius: 5px; transition: width 0.3s ease;">
        </div>
      </div>
    `;
  }
}

// 単語カードを生成
function generateWordCards() {
  const wordCards = $('wordCards');
  const cardTitle = $('cardTitle');
  
  if (!wordCards) {
    console.error('wordCards要素が見つかりません');
    return;
  }
  
  if (!currentProblem) {
    console.error('現在の問題データがありません');
    return;
  }
  
  wordCards.innerHTML = '';
  
  // 応用編かどうかを判定
  const isAdvanced = currentProblemLevel && currentProblemLevel.title.includes('応用編');
  
  // カードタイトルを設定
  if (cardTitle) {
    cardTitle.textContent = isAdvanced ? '文カード' : '単語カード';
  }
  
  // allWordsが存在しない場合は作成
  if (!currentProblem.allWords) {
    if (currentProblem.abstract && currentProblem.concretes) {
      currentProblem.allWords = [
        currentProblem.abstract, 
        ...currentProblem.concretes, 
        ...(currentProblem.distractors || [])
      ];
    } else {
      console.error('問題データの構造が正しくありません', currentProblem);
      return;
    }
  }
  
  // 単語をシャッフル
  const shuffledWords = [...currentProblem.allWords].sort(() => Math.random() - 0.5);
  
  shuffledWords.forEach(word => {
    const card = document.createElement('div');
    // 応用編かどうかを判定してクラスを設定
    card.className = isAdvanced ? 'sentence-card' : 'word-card';
    card.textContent = word;
    card.draggable = true;
    card.dataset.word = word;
    
    // ドラッグイベントリスナーを追加
    card.addEventListener('dragstart', handleDragStart);
    card.addEventListener('dragend', handleDragEnd);
    
    wordCards.appendChild(card);
  });
}

// ドロップゾーンをクリア
function clearDropZones() {
  const dropZones = ['abstractDropZone', 'concreteDropZone1', 'concreteDropZone2', 'concreteDropZone3'];
  dropZones.forEach(zoneId => {
    const zone = $(zoneId);
    if (zone) {
      zone.innerHTML = '';
      // 既存のイベントリスナーを削除
      zone.removeEventListener('dragover', handleDragOver);
      zone.removeEventListener('dragleave', handleDragLeave);
      zone.removeEventListener('drop', handleDrop);
      // 新しいイベントリスナーを追加
      zone.addEventListener('dragover', handleDragOver);
      zone.addEventListener('dragleave', handleDragLeave);
      zone.addEventListener('drop', handleDrop);
    }
  });
}

// ドラッグ開始
function handleDragStart(e) {
  e.dataTransfer.setData('text/plain', e.target.dataset.word);
  e.target.classList.add('dragging');
}

// ドラッグ終了
function handleDragEnd(e) {
  e.target.classList.remove('dragging');
}

// ドラッグオーバー
function handleDragOver(e) {
  e.preventDefault();
  e.currentTarget.classList.add('drag-over');
}

// ドラッグリーブ
function handleDragLeave(e) {
  e.currentTarget.classList.remove('drag-over');
}

// ドロップ
function handleDrop(e) {
  e.preventDefault();
  e.currentTarget.classList.remove('drag-over');
  
  const word = e.dataTransfer.getData('text/plain');
  const dropZone = e.currentTarget;
  
  if (!word || !dropZone) return;
  
  // 既に単語が配置されている場合は戻す
  if (dropZone.children.length > 0) {
    const existingCard = dropZone.children[0];
    // カードを元の場所に戻すときは色をリセット
    existingCard.className = existingCard.className.replace(' in-abstract', '').replace(' in-concrete', '');
    const wordCards = $('wordCards');
    if (wordCards) {
      wordCards.appendChild(existingCard);
    }
  }
  
  // 新しい単語カードを作成
  const newCard = document.createElement('div');
  // 応用編かどうかを判定してクラスを設定
  const isAdvanced = currentProblemLevel && currentProblemLevel.title.includes('応用編');
  let cardClass = isAdvanced ? 'sentence-card' : 'word-card';
  
  // ドロップゾーンに応じて色クラスを追加
  if (dropZone.id === 'abstractDropZone') {
    cardClass += ' in-abstract';
  } else if (dropZone.id.includes('concreteDropZone')) {
    cardClass += ' in-concrete';
  }
  
  newCard.className = cardClass;
  newCard.textContent = word;
  newCard.draggable = true;
  newCard.dataset.word = word;
  newCard.addEventListener('dragstart', handleDragStart);
  newCard.addEventListener('dragend', handleDragEnd);
  
  // ドロップゾーンに配置
  dropZone.appendChild(newCard);
  
  // 元のカードを削除
  const wordCards = $('wordCards');
  if (wordCards) {
    const originalCardClass = isAdvanced ? 'sentence-card' : 'word-card';
    const originalCard = wordCards.querySelector(`.${originalCardClass}[data-word="${word}"]`);
    if (originalCard) {
      originalCard.remove();
    }
  }
  
  // ゲーム状態を更新
  updateGameState();
}

// ゲーム状態を更新
function updateGameState() {
  const abstractZone = $('abstractDropZone');
  const concreteZones = [$('concreteDropZone1'), $('concreteDropZone2'), $('concreteDropZone3')];
  
  // 抽象概念をチェック
  if (abstractZone.children.length > 0) {
    gameState.abstract = abstractZone.children[0].dataset.word;
  } else {
    gameState.abstract = null;
  }
  
  // 具体例をチェック
  concreteZones.forEach((zone, index) => {
    if (zone.children.length > 0) {
      gameState.concretes[index] = zone.children[0].dataset.word;
    } else {
      gameState.concretes[index] = null;
    }
  });
}

// 答えを確認
function checkAnswer() {
  // 発展編の場合は専用の答え合わせ関数を使用
  if (currentProblemLevel && currentProblemLevel.level === '発展') {
    checkAdvancedAnswer();
    return;
  }
  
  // 従来のドラッグ&ドロップ形式の答え合わせ
  updateGameState();
  
  const isCorrect = gameState.abstract === currentProblem.abstract &&
    gameState.concretes.filter(c => c !== null).length === 3 &&
    gameState.concretes.every(c => currentProblem.concretes.includes(c));
  
  const resultDiv = $('gameResult');
  resultDiv.style.display = 'block';
  
  if (isCorrect) {
    resultDiv.className = 'game-result correct';
    
    // ダイヤモンドアニメーションを5個飛ばす
    spawnDiamondsFromElement(resultDiv, 5);
    
          let resultHTML = '正解です！<br>抽象概念と具体例の関係を正しく理解できました。<br><span style="color:#e91e63; font-weight:bold;"><img src="diamond.png" alt="💎" style="display: inline; width: 1em; height: 1em; vertical-align: middle;"> ダイヤモンド5個獲得！</span>';
    
    // 次の問題があるかチェック
    const currentIndex = window.currentProblemIndex || 0;
    if (currentIndex < concreteAbstractProblems.length - 1) {
      resultHTML += '<br><br><button onclick="goToNextProblem()" style="background:#4CAF50; color:white; border:none; padding:10px 20px; border-radius:8px; font-size:16px; cursor:pointer; margin-top:10px;">次の問題へ →</button>';
    } else {
      resultHTML += '<br><br><div style="color:#ff6b35; font-weight:bold; margin-top:10px;">🎊 全問題完了おめでとうございます！ 🎊</div>';
      // 紙吹雪演出を表示
      setTimeout(() => {
        showConfettiCelebration();
      }, 500);
    }
    
    resultDiv.innerHTML = resultHTML;
  } else {
    resultDiv.className = 'game-result incorrect';
    
          let feedback = '惜しいです！<br>';
    
    if (gameState.abstract !== currentProblem.abstract) {
      feedback += `抽象概念は「${currentProblem.abstract}」です。<br>`;
    }
    
    const missingConcretes = currentProblem.concretes.filter(c => !gameState.concretes.includes(c));
    if (missingConcretes.length > 0) {
      feedback += `具体例には「${missingConcretes.join('」「')}」が含まれます。`;
    }
    
    // 不正解の場合は解きなおしオプションを追加
    const currentIndex = window.currentProblemIndex || 0;
    if (currentIndex < concreteAbstractProblems.length - 1) {
      feedback += '<br><br><button onclick="resetGame()" style="background:#16a34a; color:white; border:none; padding:8px 16px; border-radius:6px; font-size:14px; cursor:pointer; margin-top:8px;">解きなおす</button>';
    }
    
    resultDiv.innerHTML = feedback;
  }
  
  // 解答ボタンとリセットボタンを非表示
  const checkAnswerBtn = $('checkAnswerBtn');
  const resetGameBtn = $('resetGameBtn');
  if (checkAnswerBtn) {
    checkAnswerBtn.style.display = 'none';
  }
  if (resetGameBtn) {
    resetGameBtn.style.display = 'none';
  }
}

// スライドアニメーション付きで問題を切り替える汎用関数
function transitionToNextProblem(contentContainer, nextContentCallback) {
  // まずボタンと解説・解答コンテナをフェードアウト
  const allButtons = contentContainer.querySelectorAll('button');
  allButtons.forEach(button => {
    button.style.transition = 'opacity 0.3s ease-out';
    button.style.opacity = '0';
  });
  
  // 解説・解答コンテナもフェードアウト
  const feedbackSelectors = [
    '#grammarFeedback', '#particlesFeedback', '#clauseFeedback', 
    '#modifierFeedback', '#sentenceStructureFeedback', '#subjectPredicateFeedback',
    '#clauseRearrangementFeedback', '#pronounFeedback', '#kanjiVocabFeedback',
    '.game-result', '.clause-feedback', '.pronoun-feedback'
  ];
  
  feedbackSelectors.forEach(selector => {
    const feedbackElement = contentContainer.querySelector(selector);
    if (feedbackElement && feedbackElement.style.display !== 'none') {
      feedbackElement.style.transition = 'opacity 0.3s ease-out';
      feedbackElement.style.opacity = '0';
    }
  });
  
  // ボタンのフェードアウト完了後にスライドアニメーション開始
  setTimeout(() => {
    // 問題表示領域を特定（ボタンエリア以外の最初の大きな要素）
    let slideContainer = contentContainer;
  
  // 各問題タイプに応じて適切なスライド対象を選択
  // 問題表示部分をラップする要素を作成または取得
  if (contentContainer.id === 'grammarProblemContent') {
    // 文法問題：質問と選択肢をまとめてスライド
    const question = contentContainer.querySelector('#grammarQuestion');
    const options = contentContainer.querySelector('#grammarOptions');
    if (question && options) {
      // 既存のラッパーがあるか確認
      let wrapper = contentContainer.querySelector('.slide-wrapper');
      if (!wrapper) {
        wrapper = document.createElement('div');
        wrapper.className = 'slide-wrapper';
        question.parentNode.insertBefore(wrapper, question);
        wrapper.appendChild(question);
        wrapper.appendChild(options);
      }
      slideContainer = wrapper;
    }
  } else if (contentContainer.id === 'clauseProblemContent') {
    slideContainer = contentContainer.querySelector('#clauseCanvasContainer');
  } else if (contentContainer.id === 'particlesProblemContent') {
    slideContainer = contentContainer.querySelector('.particles-game');
  } else if (contentContainer.id === 'subjectPredicateProblemContent') {
    slideContainer = contentContainer.querySelector('#subjectPredicateSentence');
  } else if (contentContainer.id === 'modifierProblemContent') {
    slideContainer = contentContainer.querySelector('#modifierSentence');
  } else if (contentContainer.id === 'clauseRearrangementBox') {
    slideContainer = contentContainer.querySelector('.clause-problem-area');
  } else if (contentContainer.id === 'pronounReferenceGame') {
    slideContainer = contentContainer.querySelector('#pronounText');
  } else if (contentContainer.className && contentContainer.className.includes('kanji-vocab-problem')) {
    // 漢字問題：主要な要素をまとめてスライド
    const meaning = contentContainer.querySelector('#kanjiMeaning');
    const answerArea = contentContainer.querySelector('#kanjiAnswerArea');
    const choices = contentContainer.querySelector('#kanjiChoices');
    if (meaning && answerArea && choices) {
      let wrapper = contentContainer.querySelector('.slide-wrapper');
      if (!wrapper) {
        wrapper = document.createElement('div');
        wrapper.className = 'slide-wrapper';
        meaning.parentNode.insertBefore(wrapper, meaning);
        wrapper.appendChild(meaning);
        wrapper.appendChild(answerArea);
        wrapper.appendChild(choices);
      }
      slideContainer = wrapper;
    }
  } else if (contentContainer.id === 'concreteAbstractGame') {
    slideContainer = contentContainer;
  }
  
  // スライドアニメーションを適用
  if (slideContainer) {
    slideContainer.style.transition = 'transform 0.5s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.5s ease-out';
    slideContainer.style.transform = 'translateX(-100%)';
    slideContainer.style.opacity = '0';
  }
  
  // アニメーション完了後に次のコンテンツを表示
  setTimeout(() => {
    // 次のコンテンツを生成
    nextContentCallback();
    
    // 新しいコンテンツを右からスライドイン
    setTimeout(() => {
      // 新しいスライド対象を再取得
      let newSlideContainer = contentContainer;
      
      if (contentContainer.id === 'grammarProblemContent') {
        newSlideContainer = contentContainer.querySelector('.slide-wrapper');
        if (!newSlideContainer) {
          // 文法問題：質問と選択肢をまとめてスライド
          const question = contentContainer.querySelector('#grammarQuestion');
          const options = contentContainer.querySelector('#grammarOptions');
          if (question && options) {
            const wrapper = document.createElement('div');
            wrapper.className = 'slide-wrapper';
            question.parentNode.insertBefore(wrapper, question);
            wrapper.appendChild(question);
            wrapper.appendChild(options);
            newSlideContainer = wrapper;
          }
        }
      } else if (contentContainer.id === 'clauseProblemContent') {
        newSlideContainer = contentContainer.querySelector('#clauseCanvasContainer');
      } else if (contentContainer.id === 'particlesProblemContent') {
        newSlideContainer = contentContainer.querySelector('.particles-game');
      } else if (contentContainer.id === 'subjectPredicateProblemContent') {
        newSlideContainer = contentContainer.querySelector('#subjectPredicateSentence');
      } else if (contentContainer.id === 'modifierProblemContent') {
        newSlideContainer = contentContainer.querySelector('#modifierSentence');
      } else if (contentContainer.id === 'clauseRearrangementBox') {
        newSlideContainer = contentContainer.querySelector('.clause-problem-area');
      } else if (contentContainer.id === 'pronounReferenceGame') {
        newSlideContainer = contentContainer.querySelector('#pronounText');
      } else if (contentContainer.className && contentContainer.className.includes('kanji-vocab-problem')) {
        newSlideContainer = contentContainer.querySelector('.slide-wrapper');
        if (!newSlideContainer) {
          // 漢字問題：主要な要素をまとめてスライド
          const meaning = contentContainer.querySelector('#kanjiMeaning');
          const answerArea = contentContainer.querySelector('#kanjiAnswerArea');
          const choices = contentContainer.querySelector('#kanjiChoices');
          if (meaning && answerArea && choices) {
            const wrapper = document.createElement('div');
            wrapper.className = 'slide-wrapper';
            meaning.parentNode.insertBefore(wrapper, meaning);
            wrapper.appendChild(meaning);
            wrapper.appendChild(answerArea);
            wrapper.appendChild(choices);
            newSlideContainer = wrapper;
          }
        }
      } else if (contentContainer.id === 'concreteAbstractGame') {
        newSlideContainer = contentContainer;
      }
      
      if (newSlideContainer) {
        // 初期位置を右側に設定
        newSlideContainer.style.transition = 'none';
        newSlideContainer.style.transform = 'translateX(100%)';
        newSlideContainer.style.opacity = '0';
        
        // 少し待ってからアニメーション開始
        setTimeout(() => {
          newSlideContainer.style.transition = 'transform 0.5s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.5s ease-in';
          newSlideContainer.style.transform = 'translateX(0)';
          newSlideContainer.style.opacity = '1';
        }, 50);
      }
      
      // ボタンをフェードイン
      const newButtons = contentContainer.querySelectorAll('button');
      newButtons.forEach(button => {
        button.style.transition = 'opacity 0.3s ease-in 0.3s';
        button.style.opacity = '1';
      });
    }, 50);
  }, 500);
  }, 300); // ボタンフェードアウト完了後
}

// 次の問題へ進む
function goToNextProblem() {
  const currentIndex = window.currentProblemIndex || 0;
  if (currentIndex < concreteAbstractProblems.length - 1) {
    window.currentProblemIndex = currentIndex + 1;
    
    const gameContainer = document.getElementById('concreteAbstractGame');
    transitionToNextProblem(gameContainer, () => {
      initConcreteAbstractGame();
    });
  }
}

// ゲームをリセット
function resetGame() {
  // ゲーム状態をリセット
  gameState = {
    abstract: null,
    concretes: [null, null, null]
  };
  
  // 結果を非表示
  const gameResult = $('gameResult');
  if (gameResult) {
    gameResult.style.display = 'none';
  }
  
  // ドロップゾーンをクリア
  clearDropZones();
  
  // 単語カードを再生成
  generateWordCards();
  
  // ボタンを表示
  const checkAnswerBtn = $('checkAnswerBtn');
  const resetGameBtn = $('resetGameBtn');
  if (checkAnswerBtn) {
    checkAnswerBtn.style.display = 'inline-block';
  }
  if (resetGameBtn) {
    resetGameBtn.style.display = 'inline-block';
  }
}

// 発展編の初期化
function initAdvancedMode() {
  const gameDiv = $('concreteAbstractGame');
  
  // 問題タイプが文章タップ問題の場合
  if (currentProblem.type === 'sentence_tap') {
    initSentenceTapMode(gameDiv);
  } else {
    // 従来の発展編専用のHTML構造を生成（2段階構造）
    gameDiv.innerHTML = `
      <div class="advanced-content">
        <div class="text-section">
          <div class="reading-text">
                      ${currentProblem.text}
          </div>
        </div>
        
        <div class="diagram-section">
          <div class="hierarchy-diagram-advanced">
            <div class="abstract-level-advanced">
              <div class="abstract-box-advanced">
                <span class="label">抽象（まとめ）</span>
                <input type="text" id="abstractInput" class="answer-input" placeholder="文章から抽象的な言葉を入力">
              </div>
            </div>
            
            <div class="middle-level-advanced">
              <span class="label">中間概念（グループ名）</span>
              <div class="middle-boxes-advanced">
                <div class="middle-box-advanced">
                  <input type="text" id="middleInput1" class="answer-input" placeholder="グループ1の名前">
                </div>
                <div class="middle-box-advanced">
                  <input type="text" id="middleInput2" class="answer-input" placeholder="グループ2の名前">
                </div>
              </div>
            </div>
            
            <div class="concrete-level-advanced">
              <span class="label">具体（くわしく）</span>
              <div class="concrete-boxes-advanced">
                <div class="concrete-box-advanced">
                  <input type="text" id="concreteInput1" class="answer-input" placeholder="具体例1">
                </div>
                <div class="concrete-box-advanced">
                  <input type="text" id="concreteInput2" class="answer-input" placeholder="具体例2">
                </div>
                <div class="concrete-box-advanced">
                  <input type="text" id="concreteInput3" class="answer-input" placeholder="具体例3">
                </div>
                <div class="concrete-box-advanced">
                  <input type="text" id="concreteInput4" class="answer-input" placeholder="具体例4">
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    `;
  }
}

// 文章タップ問題の初期化
function initSentenceTapMode(gameDiv) {
  // 文章タップ問題用のHTML構造を生成
  const sentences = currentProblem.sentences.map((sentence, index) => 
    `<p data-sentence-index="${index}">${sentence}</p>`
  ).join('');
  
  gameDiv.innerHTML = `
    <div class="sentence-tap-container">
      <div class="sentence-tap-instructions">
        文章を読んで、<strong>主張（まとめ）の文をタップすると赤色</strong>、<strong>具体例の文をタップすると青色</strong>になります。<br>
        全ての文を正しく分類してください。
      </div>
      
      <div class="sentence-tap-legend">
        <div class="legend-item">
          <div class="legend-color claim"></div>
          <span>主張（まとめ）</span>
        </div>
        <div class="legend-item">
          <div class="legend-color concrete"></div>
          <span>具体例</span>
        </div>
      </div>
      
      <div class="sentence-tap-text" id="sentenceTapText">
        ${sentences}
      </div>
      
      <div style="text-align: center; margin-top: 16px; color: #666; font-size: 14px;">
        ヒント: ${currentProblem.hint}
      </div>
    </div>
  `;
  
  // 文をタップしたときのイベントリスナーを追加
  initSentenceTapEvents();
}

// 文章タップイベントの初期化
function initSentenceTapEvents() {
  const sentences = document.querySelectorAll('#sentenceTapText p');
  
  sentences.forEach((sentence, index) => {
    sentence.addEventListener('click', () => {
      // 現在のクラスを取得
      const currentClasses = sentence.className;
      
      // 既存のクラスをリセット
      sentence.className = '';
      
      // 正解の主張文の場合
      if (index === currentProblem.claim_sentence) {
        // 主張文のスタイルを適用
        if (currentClasses.includes('claim')) {
          // 既に赤色の場合は元に戻す
          sentence.className = '';
        } else {
          // 赤色にする
          sentence.className = 'claim';
        }
      } 
      // 正解の具体例文の場合
      else if (currentProblem.concrete_sentences.includes(index)) {
        // 具体例のスタイルを適用
        if (currentClasses.includes('concrete')) {
          // 既に青色の場合は元に戻す
          sentence.className = '';
        } else {
          // 青色にする
          sentence.className = 'concrete';
        }
      }
      // それ以外の文の場合（このデータ構造では発生しないはず）
      else {
        // クリックしても色は変わらない、またはデフォルト処理
        console.log('この文は主張でも具体例でもありません');
      }
    });
  });
}

// 発展編の答え合わせ（2段階構造対応）
function checkAdvancedAnswer() {
  // 文章タップ問題の場合
  if (currentProblem.type === 'sentence_tap') {
    checkSentenceTapAnswer();
    return;
  }
  
  // 従来の入力欄形式の答え合わせ
  const abstractInput = $('abstractInput');
  const middleInputs = [$('middleInput1'), $('middleInput2')];
  const concreteInputs = [$('concreteInput1'), $('concreteInput2'), $('concreteInput3'), $('concreteInput4')];
  
  const userAbstract = abstractInput.value.trim();
  const userMiddles = middleInputs.map(input => input.value.trim()).filter(val => val);
  const userConcretes = concreteInputs.map(input => input.value.trim()).filter(val => val);
  
  // 正解チェック
  const isAbstractCorrect = userAbstract === currentProblem.abstract_answer;
  
  const correctMiddles = currentProblem.middle_concepts || [];
  const isMiddleCorrect = userMiddles.length === correctMiddles.length && 
    userMiddles.every(answer => correctMiddles.includes(answer));
  
  const correctConcretes = currentProblem.concrete_answers;
  const isConcreteCorrect = userConcretes.length === correctConcretes.length && 
    userConcretes.every(answer => correctConcretes.includes(answer));
  
  const resultDiv = $('gameResult');
  resultDiv.style.display = 'block';
  
  if (isAbstractCorrect && isMiddleCorrect && isConcreteCorrect) {
    resultDiv.className = 'game-result correct';
    
    // 大きな緑の〇を表示
    showBigGreenCircle();
    
    // ダイヤモンドアニメーションを5個飛ばす
    spawnDiamondsFromElement(resultDiv, 5);
    
          let resultHTML = '正解です！<br>文章をよく読んで、2段階の抽象と具体の関係を正しく理解できました。<br><span style="color:#e91e63; font-weight:bold;"><img src="diamond.png" alt="💎" style="display: inline; width: 1em; height: 1em; vertical-align: middle;"> ダイヤモンド5個獲得！</span>';
    
    // 次の問題があるかチェック
    const currentIndex = window.currentProblemIndex || 0;
    if (currentIndex < concreteAbstractProblems.length - 1) {
      resultHTML += '<br><br><button onclick="goToNextProblem()" style="background:#4CAF50; color:white; border:none; padding:10px 20px; border-radius:8px; font-size:16px; cursor:pointer; margin-top:10px;">次の問題へ →</button>';
    } else {
      resultHTML += '<br><br><div style="color:#ff6b35; font-weight:bold; margin-top:10px;">🎊 全問題完了おめでとうございます！ 🎊</div>';
      // 紙吹雪演出を表示
      setTimeout(() => {
        showConfettiCelebration();
      }, 500);
    }
    
    resultDiv.innerHTML = resultHTML;
    
    // 正解の場合、入力欄を青緑色にする
    abstractInput.style.borderColor = '#20B2AA';
    middleInputs.forEach(input => {
      if (input.value.trim()) {
        input.style.borderColor = '#20B2AA';
      }
    });
    concreteInputs.forEach(input => {
      if (input.value.trim()) {
        input.style.borderColor = '#20B2AA';
      }
    });
  } else {
    resultDiv.className = 'game-result incorrect';
    
    // アニメーションなし
    
    let feedback = 'もう一度確認してみましょう！<br>';
    
    if (!isAbstractCorrect) {
      feedback += `抽象的な言葉：「${currentProblem.abstract_answer}」<br>`;
      abstractInput.style.borderColor = '#f44336';
    } else {
      abstractInput.style.borderColor = '#20B2AA';
    }
    
    if (!isMiddleCorrect && correctMiddles.length > 0) {
      feedback += `中間概念：「${correctMiddles.join('」「')}」<br>`;
      middleInputs.forEach((input, index) => {
        if (input.value.trim()) {
          input.style.borderColor = correctMiddles.includes(input.value.trim()) ? '#20B2AA' : '#f44336';
        }
      });
    } else if (correctMiddles.length > 0) {
      middleInputs.forEach(input => {
        if (input.value.trim()) {
          input.style.borderColor = '#20B2AA';
        }
      });
    }
    
    if (!isConcreteCorrect) {
      feedback += `具体例：「${correctConcretes.join('」「')}」`;
      concreteInputs.forEach((input, index) => {
        if (input.value.trim()) {
          input.style.borderColor = correctConcretes.includes(input.value.trim()) ? '#20B2AA' : '#f44336';
        }
      });
    } else {
      concreteInputs.forEach(input => {
        if (input.value.trim()) {
          input.style.borderColor = '#20B2AA';
        }
      });
    }
    
    // 不正解の場合は解きなおしオプションを追加
    const currentIndex = window.currentProblemIndex || 0;
    if (currentIndex < concreteAbstractProblems.length - 1) {
      feedback += '<br><br><button onclick="resetGame()" style="background:#16a34a; color:white; border:none; padding:8px 16px; border-radius:6px; font-size:14px; cursor:pointer; margin-top:8px;">解きなおす</button>';
    }
    
    resultDiv.innerHTML = feedback;
  }
}

// 文章タップ問題の答え合わせ
function checkSentenceTapAnswer() {
  const sentences = document.querySelectorAll('#sentenceTapText p');
  const resultDiv = $('gameResult');
  resultDiv.style.display = 'block';
  
  let correctCount = 0;
  let totalRequiredSelections = 0;
  
  // 主張文がクリックされて赤色になっているかチェック
  const claimSentence = sentences[currentProblem.claim_sentence];
  const isClaimCorrect = claimSentence.classList.contains('claim');
  if (isClaimCorrect) correctCount++;
  totalRequiredSelections++;
  
  // 具体例文がクリックされて青色になっているかチェック
  currentProblem.concrete_sentences.forEach(index => {
    const concreteSentence = sentences[index];
    const isConcreteCorrect = concreteSentence.classList.contains('concrete');
    if (isConcreteCorrect) correctCount++;
    totalRequiredSelections++;
  });
  
  // 間違った分類がないかチェック
  let hasWrongClassification = false;
  sentences.forEach((sentence, index) => {
    if (index === currentProblem.claim_sentence) {
      // 主張文が具体例色になっている場合
      if (sentence.classList.contains('concrete')) {
        hasWrongClassification = true;
      }
    } else if (currentProblem.concrete_sentences.includes(index)) {
      // 具体例文が主張色になっている場合
      if (sentence.classList.contains('claim')) {
        hasWrongClassification = true;
      }
    } else {
      // その他の文に色が付いている場合（このデータ構造では発生しないはず）
      if (sentence.classList.contains('claim') || sentence.classList.contains('concrete')) {
        hasWrongClassification = true;
      }
    }
  });
  
  const isAllCorrect = correctCount === totalRequiredSelections && !hasWrongClassification;
  
  if (isAllCorrect) {
    resultDiv.className = 'game-result correct';
    
    // 大きな緑の〇を表示
    showBigGreenCircle();
    
    // ダイヤモンドアニメーションを5個飛ばす
    spawnDiamondsFromElement(resultDiv, 5);
    
    let resultHTML = '正解です！<br>主張と具体例を正しく分類できました。<br><span style="color:#e91e63; font-weight:bold;"><img src="diamond.png" alt="💎" style="display: inline; width: 1em; height: 1em; vertical-align: middle;"> ダイヤモンド5個獲得！</span>';
    resultHTML += `<br><br><strong>解説：</strong> ${currentProblem.explanation}`;
    
    // 次の問題があるかチェック
    const currentIndex = window.currentProblemIndex || 0;
    if (currentIndex < concreteAbstractProblems.length - 1) {
      resultHTML += '<br><br><button onclick="goToNextProblem()" style="background:#4CAF50; color:white; border:none; padding:10px 20px; border-radius:8px; font-size:16px; cursor:pointer; margin-top:10px;">次の問題へ →</button>';
    } else {
      resultHTML += '<br><br><div style="color:#ff6b35; font-weight:bold; margin-top:10px;">🎊 全問題完了おめでとうございます！ 🎊</div>';
      // 紙吹雪演出を表示
      setTimeout(() => {
        showConfettiCelebration();
      }, 500);
    }
    
    resultDiv.innerHTML = resultHTML;
  } else {
    resultDiv.className = 'game-result incorrect';
    
    // アニメーションなし
    
    let feedback = 'もう一度確認してみましょう！<br>';
    feedback += `<strong>解説：</strong> ${currentProblem.explanation}<br><br>`;
    
    // 正解を表示
    feedback += `<strong>正解：</strong><br>`;
    feedback += `• 主張（赤色）：「${currentProblem.sentences[currentProblem.claim_sentence]}」<br>`;
    feedback += `• 具体例（青色）：<br>`;
    currentProblem.concrete_sentences.forEach(index => {
      feedback += `  - 「${currentProblem.sentences[index]}」<br>`;
    });
    
    // 不正解の場合は解きなおしオプションを追加
    const currentIndex = window.currentProblemIndex || 0;
    if (currentIndex < concreteAbstractProblems.length - 1) {
      feedback += '<br><button onclick="resetGame()" style="background:#16a34a; color:white; border:none; padding:8px 16px; border-radius:6px; font-size:14px; cursor:pointer; margin-top:8px;">解きなおす</button>';
    }
    
    resultDiv.innerHTML = feedback;
  }
}

// ゲームをリセット  
function resetGame() {
  // 現在の問題だけをリセット（進捗は保持）
  initConcreteAbstractGame();
  
  // 解答ボタンとリセットボタンを再表示
  const checkAnswerBtn = $('checkAnswerBtn');
  const resetGameBtn = $('resetGameBtn');
  if (checkAnswerBtn) {
    checkAnswerBtn.style.display = 'inline-block';
  }
  if (resetGameBtn) {
    resetGameBtn.style.display = 'inline-block';
  }
}

// 全体の進捗をリセット
function resetProgress() {
  if (confirm('進捗をリセットして最初の問題から始めますか？')) {
    window.currentProblemIndex = 0;
    initConcreteAbstractGame();
  }
}

// 進捗リセットボタンを追加する関数
function addProgressResetButton() {
  const gameControls = document.querySelector('.game-controls');
  if (gameControls && !document.querySelector('#resetProgressBtn')) {
    const resetProgressBtn = document.createElement('button');
    resetProgressBtn.id = 'resetProgressBtn';
    resetProgressBtn.className = 'logic-reset-btn';
    resetProgressBtn.textContent = '進捗リセット';
    resetProgressBtn.onclick = resetProgress;
    resetProgressBtn.style.marginLeft = '8px';
    gameControls.appendChild(resetProgressBtn);
  }
}
function updateTreasureCounts() {
  if (diamondCountEl) {
    diamondCountEl.innerHTML = '<img src="diamond.png" alt="💎" style="width: 1em; height: 1em;"><span>' + diamonds + '</span>';
  }
  if (dashboardDiamondCountEl) {
    dashboardDiamondCountEl.textContent = diamonds;
  }
  
  // 宝石交換画面の現在のダイヤモンド数も更新
  const currentDiamondCountEl = document.getElementById('currentDiamondCount');
  if (currentDiamondCountEl) {
    currentDiamondCountEl.textContent = diamonds;
  }
  
  // アイテムショップでボタン状態も更新
  if (isBoxActive(gemExchangeBox)) {
    updateShopButtons();
    // loadCustomItems(); // 重複表示の原因なので削除
  }
  
  // 目標達成チェック
  checkGemExchangeGoal();
}


// 新しいメインボタンのイベントハンドラー
goReadingTrainingBtn.onclick = () => {
  showBox(readingTrainingBox);
  renderReadingTrainingMenu();
};
goGrammarTrainingBtn.onclick = () => {
  showBox(grammarTrainingBox);
  renderGrammarMenu();
};

goKanjiVocabBtn.onclick = () => {
  showBox(kanjiVocabTrainingBox);
  renderKanjiVocabMenu();
};

// 音読トレーニング選択画面内のボタンは新しいカードシステムで管理
$('goLogicBtn').onclick = () => {
  showBox(logicTrainingBox);
  renderLogicMenu();
};
readingTrainingHomeBtn.onclick = () => {
  showBox(homeBox);
  renderCalendar();
  renderDashboard();
};
grammarTrainingHomeBtn.onclick = () => {
  showBox(homeBox);
  renderCalendar();
  renderDashboard();
};
grammarSubmenuBackBtn.onclick = () => {
  showBox(grammarTrainingBox);
  renderGrammarMenu();
};
grammarSubmenuHomeBtn.onclick = () => {
  showBox(homeBox);
  renderCalendar();
  renderDashboard();
};
aiGenHomeBtn.onclick = () => {
  showBox(homeBox);
  renderCalendar();
  renderDashboard();
};
logicHomeBtn.onclick = () => {
  showBox(homeBox);
  renderCalendar();
  renderDashboard();
};

// 具体と抽象ゲームのボタンイベント
const concreteAbstractBackBtn = $('concreteAbstractBackBtn');
const concreteAbstractHomeBtn = $('concreteAbstractHomeBtn');
const checkAnswerBtn = $('checkAnswerBtn');
const resetGameBtn = $('resetGameBtn');


if (concreteAbstractBackBtn) {
  concreteAbstractBackBtn.onclick = () => {
    showBox(logicTrainingBox);
    renderLogicMenu();
  };
}

if (concreteAbstractHomeBtn) {
  concreteAbstractHomeBtn.onclick = () => {
    showBox(homeBox);
    renderCalendar();
    renderDashboard();
  };
}

if (checkAnswerBtn) {
  checkAnswerBtn.onclick = checkAnswer;
}

if (resetGameBtn) {
  resetGameBtn.onclick = resetGame;
}

// AI文法問題生成の初期化
function initAiGrammarGenerator() {
  const typeSelect = document.getElementById('aiGrammarType');
  const difficultySelect = document.getElementById('aiGrammarDifficulty');
  const generateBtn = document.getElementById('generateAiGrammarBtn');
  const loadingDiv = document.getElementById('aiGrammarLoading');
  const errorDiv = document.getElementById('aiGrammarError');
  
  // フォームをリセット
  typeSelect.value = '';
  difficultySelect.value = '';
  generateBtn.disabled = true;
  loadingDiv.style.display = 'none';
  errorDiv.style.display = 'none';
  
  // 選択肢が変更されたときの処理
  function checkFormValidity() {
    generateBtn.disabled = !typeSelect.value || !difficultySelect.value;
    generateBtn.style.opacity = generateBtn.disabled ? '0.5' : '1';
    generateBtn.style.cursor = generateBtn.disabled ? 'not-allowed' : 'pointer';
  }
  
  typeSelect.addEventListener('change', checkFormValidity);
  difficultySelect.addEventListener('change', checkFormValidity);
  
  // 問題生成ボタンのクリックイベント
  generateBtn.onclick = async function() {
    if (generateBtn.disabled) return;
    
    const problemType = typeSelect.value;
    const difficulty = difficultySelect.value;
    
    // ローディング表示
    loadingDiv.style.display = 'block';
    errorDiv.style.display = 'none';
    generateBtn.disabled = true;
    generateBtn.style.opacity = '0.5';
    
    try {
      // AI問題生成APIを呼び出し
      const response = await fetch('/api/generate-grammar-problems', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          type: problemType,
          difficulty: difficulty
        })
      });
      
      if (!response.ok) {
        throw new Error(`サーバーエラー: ${response.status}`);
      }
      
      const data = await response.json();
      
      if (!data.success) {
        throw new Error(data.error || '問題の生成に失敗しました');
      }
      
      // 生成された問題を表示
      displayAiGeneratedProblems(data.problems, problemType);
      
    } catch (error) {
      console.error('AI問題生成エラー:', error);
      errorDiv.textContent = `エラー: ${error.message}`;
      errorDiv.style.display = 'block';
      generateBtn.disabled = false;
      generateBtn.style.opacity = '1';
    } finally {
      loadingDiv.style.display = 'none';
    }
  };
}

// AI生成問題を表示
function displayAiGeneratedProblems(problems, problemType) {
  // 問題タイプに応じて適切な画面に遷移
  switch (problemType) {
    case 'particles':
      // 助詞問題として表示
      currentAiProblems = {
        title: "AI生成 助詞問題",
        description: "AIが生成した助詞問題を解いてみましょう！",
        problems: problems
      };
      showBox(particlesBox);
      initAiParticlesProblem();
      break;
      
    case 'subject-predicate':
      // 主語述語問題として表示
      currentAiProblems = {
        title: "AI生成 主語・述語問題",
        description: "AIが生成した主語・述語問題を解いてみましょう！",
        problems: problems
      };
      showBox(subjectPredicateBox);
      initAiSubjectPredicateProblem();
      break;
      
    case 'modifiers':
      // 修飾語問題として表示
      currentAiProblems = {
        title: "AI生成 修飾語問題",
        description: "AIが生成した修飾語問題を解いてみましょう！",
        problems: problems
      };
      showBox(modifierBox);
      initAiModifierProblem();
      break;
      
    case 'clause-division':
      // 文節問題として表示
      currentAiProblems = {
        title: "AI生成 文節問題",
        description: "AIが生成した文節問題を解いてみましょう！",
        problems: problems
      };
      showBox(clauseDivisionBox);
      initAiClauseDivisionProblem();
      break;
      
    default:
      console.error('未対応の問題タイプ:', problemType);
  }
}

// AI生成問題の管理
let currentAiProblems = null;

// 問題セッション管理変数
let particlesSession = null;
let modifierSession = null;
let clauseSession = null;

// AI助詞問題の初期化
function initAiParticlesProblem() {
  if (!currentAiProblems) return;
  
  // タイトルを更新
  document.getElementById('particlesProblemTitle').textContent = currentAiProblems.title;
  
  // 既存の助詞問題処理を流用してAI生成問題を表示
  particlesSession = {
    problems: currentAiProblems.problems,
    currentIndex: 0,
    score: 0,
    startTime: Date.now()
  };
  
  showParticlesProblem();
}

// AI主語述語問題の初期化
function initAiSubjectPredicateProblem() {
  if (!currentAiProblems) return;
  
  // タイトルを更新
  document.getElementById('subjectPredicateProblemTitle').textContent = currentAiProblems.title;
  
  // 既存の主語述語問題処理を流用
  currentSubjectPredicateSession = {
    problems: currentAiProblems.problems,
    currentIndex: 0,
    selectedPredicate: null,
    selectedSubject: null,
    score: 0,
    isChecked: false
  };
  
  showSubjectPredicateProblem();
}

// AI修飾語問題の初期化
function initAiModifierProblem() {
  if (!currentAiProblems) return;
  
  // タイトルを更新
  document.getElementById('modifierProblemTitle').textContent = currentAiProblems.title;
  
  // 既存の修飾語問題処理を流用
  modifierSession = {
    problems: currentAiProblems.problems,
    currentIndex: 0,
    selectedWord: null,
    score: 0,
    isChecked: false
  };
  
  showModifierProblem();
}

// AI文節問題の初期化
function initAiClauseDivisionProblem() {
  if (!currentAiProblems) return;
  
  // タイトルを更新
  document.getElementById('clauseProblemTitle').textContent = currentAiProblems.title;
  
  // 既存の文節問題処理を流用
  clauseSession = {
    problems: currentAiProblems.problems,
    currentIndex: 0,
    score: 0,
    userDivisions: []
  };
  
  showClauseProblem();
}

// 基本的な問題表示関数（既存の関数が見つからない場合のフォールバック）
function showParticlesProblem() {
  if (!particlesSession || !particlesSession.problems) return;
  
  const problem = particlesSession.problems[particlesSession.currentIndex];
  if (!problem) return;
  
  // 進捗表示を更新（削除）
  
  // 問題文を表示
  const sentenceDiv = document.getElementById('particlesSentence');
  if (sentenceDiv) {
    sentenceDiv.innerHTML = problem.sentence.replace(/（　）/g, '<span class="blank-space">（　）</span>');
  }
  
  // 助詞カードを表示
  const cardsDiv = document.getElementById('particlesCards');
  if (cardsDiv) {
    cardsDiv.innerHTML = '';
    problem.cards.forEach(card => {
      const cardElement = document.createElement('div');
      cardElement.className = 'particle-card';
      cardElement.textContent = card;
      cardElement.draggable = true;
      cardElement.style.cssText = `
        display: inline-block;
        background: #FFE0B2;
        border: 2px solid #FF9800;
        border-radius: 8px;
        padding: 8px 16px;
        margin: 4px;
        cursor: move;
        font-size: 18px;
        font-weight: bold;
      `;
      cardsDiv.appendChild(cardElement);
    });
  }
}

function showSubjectPredicateProblem() {
  if (!currentSubjectPredicateSession || !currentSubjectPredicateSession.problems) return;
  
  const problem = currentSubjectPredicateSession.problems[currentSubjectPredicateSession.currentIndex];
  if (!problem) return;
  
  // 進捗表示を更新
  updateProblemProgress(currentSubjectPredicateSession.currentIndex, currentSubjectPredicateSession.problems.length, 'subjectPredicateProblemProgress');
  
  // 問題文を表示
  const sentenceDiv = document.getElementById('subjectPredicateSentence');
  if (sentenceDiv) {
    sentenceDiv.innerHTML = '';
    problem.words.forEach((word, index) => {
      const wordSpan = document.createElement('span');
      wordSpan.textContent = word.text;
      wordSpan.className = 'word-element';
      wordSpan.dataset.position = index;
      wordSpan.style.cssText = `
        display: inline-block;
        margin: 0 4px;
        padding: 4px 8px;
        border: 2px solid transparent;
        border-radius: 4px;
        cursor: pointer;
        font-size: 20px;
      `;
      
      wordSpan.onclick = () => selectSubjectPredicateWord(index, word.type);
      sentenceDiv.appendChild(wordSpan);
    });
  }
}

function showModifierProblem() {
  if (!modifierSession || !modifierSession.problems) return;
  
  const problem = modifierSession.problems[modifierSession.currentIndex];
  if (!problem) return;
  
  // 進捗表示を更新（削除）
  
  // 問題文を表示
  const sentenceDiv = document.getElementById('modifierSentence');
  if (sentenceDiv) {
    sentenceDiv.innerHTML = '';
    problem.words.forEach((word, index) => {
      const wordSpan = document.createElement('span');
      wordSpan.textContent = word.text;
      wordSpan.className = 'word-element';
      wordSpan.dataset.position = index;
      
      // 修飾語の場合は下線を表示
      if (word.isMarked) {
        wordSpan.style.borderBottom = '3px solid #4CAF50';
        wordSpan.style.fontWeight = 'bold';
      }
      
      wordSpan.style.cssText += `
        display: inline-block;
        margin: 0 4px;
        padding: 4px 8px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 20px;
      `;
      
      wordSpan.onclick = () => selectModifierWord(index);
      sentenceDiv.appendChild(wordSpan);
    });
  }
}

function showClauseProblem() {
  if (!clauseSession || !clauseSession.problems) return;
  
  const problem = clauseSession.problems[clauseSession.currentIndex];
  if (!problem) return;
  
  // 進捗表示を更新（削除）
  
  // 簡単な文節問題表示（基本実装）
  const canvas = document.getElementById('clauseCanvas');
  if (canvas) {
    const ctx = canvas.getContext('2d');
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    
    // 文章を縦書きで表示
    ctx.font = '24px serif';
    ctx.fillStyle = '#333';
    
    const text = problem.sentence;
    const x = canvas.width / 2;
    let y = 50;
    
    for (let i = 0; i < text.length; i++) {
      ctx.fillText(text[i], x, y);
      y += 30;
    }
  }
}

// 主語述語選択処理
function selectSubjectPredicateWord(position, type) {
  if (!currentSubjectPredicateSession) return;
  
  const wordElements = document.querySelectorAll('.word-element');
  
  if (type === 'predicate') {
    // 述語を選択
    wordElements.forEach(el => el.style.backgroundColor = '');
    wordElements[position].style.backgroundColor = '#2196F3';
    wordElements[position].style.color = 'white';
    currentSubjectPredicateSession.selectedPredicate = position;
  } else if (type === 'subject') {
    // 主語を選択
    if (currentSubjectPredicateSession.selectedPredicate !== null) {
      wordElements[position].style.backgroundColor = '#f44336';
      wordElements[position].style.color = 'white';
      currentSubjectPredicateSession.selectedSubject = position;
    }
  }
}

// 修飾語選択処理
function selectModifierWord(position) {
  if (!modifierSession) return;
  
  const wordElements = document.querySelectorAll('.word-element');
  
  // 前の選択をクリア
  wordElements.forEach(el => {
    if (!el.style.borderBottom) {
      el.style.backgroundColor = '';
      el.style.color = '';
    }
  });
  
  // 新しい選択
        wordElements[position].style.backgroundColor = '#20B2AA';
  wordElements[position].style.color = 'white';
  modifierSession.selectedWord = position;
}



// 文法トレーニング画面のボタンイベント
const grammarBackBtn = $('grammarBackBtn');
const grammarProblemHomeBtn = $('grammarProblemHomeBtn');
const grammarNextBtn = $('grammarNextBtn');
const grammarFinishBtn = $('grammarFinishBtn');
const grammarResultHomeBtn = $('grammarResultHomeBtn');
const grammarBackToMenuBtn = $('grammarBackToMenuBtn');
const particlesBackBtn = $('particlesBackBtn');
const particlesHomeBtn = $('particlesHomeBtn');

if (grammarBackBtn) {
  grammarBackBtn.onclick = () => {
    showBox(grammarTrainingBox);
    renderGrammarMenu();
  };
}

if (grammarProblemHomeBtn) {
  grammarProblemHomeBtn.onclick = () => {
    showBox(homeBox);
    renderCalendar();
    renderDashboard();
  };
}

if (grammarNextBtn) {
  grammarNextBtn.onclick = goToNextGrammarProblem;
}

if (grammarFinishBtn) {
  grammarFinishBtn.onclick = showGrammarTrainingResult;
}

if (grammarResultHomeBtn) {
  grammarResultHomeBtn.onclick = () => {
    showBox(homeBox);
    renderCalendar();
    renderDashboard();
  };
}

if (grammarBackToMenuBtn) {
  grammarBackToMenuBtn.onclick = () => {
    showBox(grammarTrainingBox);
    renderGrammarMenu();
  };
}

if (particlesBackBtn) {
  particlesBackBtn.onclick = () => {
    showBox(grammarTrainingBox);
    renderGrammarMenu();
  };
}

if (particlesHomeBtn) {
  particlesHomeBtn.onclick = () => {
    showBox(homeBox);
    renderCalendar();
    renderDashboard();
  };
}

// 文節分け画面のボタンイベント
const clauseBackBtn = $('clauseBackBtn');
const clauseHomeBtn = $('clauseHomeBtn');

const clauseCheckBtn = $('clauseCheckBtn');
const clauseResetBtn = $('clauseResetBtn');
const clauseNextBtn = $('clauseNextBtn');
const clauseFinishBtn = $('clauseFinishBtn');

if (clauseBackBtn) {
  clauseBackBtn.onclick = () => {
    showBox(grammarTrainingBox);
    renderGrammarMenu();
  };
}

if (clauseHomeBtn) {
  clauseHomeBtn.onclick = () => {
    showBox(homeBox);
    renderCalendar();
    renderDashboard();
  };
}



if (clauseCheckBtn) {
  clauseCheckBtn.onclick = checkClauseDivision;
}

if (clauseResetBtn) {
  clauseResetBtn.onclick = resetClauseProblem;
}

if (clauseNextBtn) {
  clauseNextBtn.onclick = goToNextClauseProblem;
}

if (clauseFinishBtn) {
  clauseFinishBtn.onclick = showClauseDivisionResult;
}

// 主語・述語画面のボタンイベント
const subjectPredicateBackBtn = $('subjectPredicateBackBtn');
const subjectPredicateHomeBtn = $('subjectPredicateHomeBtn');

if (subjectPredicateBackBtn) {
  subjectPredicateBackBtn.onclick = () => {
    showBox(grammarTrainingBox);
    renderGrammarMenu();
  };
}

if (subjectPredicateHomeBtn) {
  subjectPredicateHomeBtn.onclick = () => {
    showBox(homeBox);
    renderCalendar();
    renderDashboard();
  };
}

// 修飾語画面のボタンイベント
const modifierBackBtn = $('modifierBackBtn');
const modifierHomeBtn = $('modifierHomeBtn');

if (modifierBackBtn) {
  modifierBackBtn.onclick = () => {
    showBox(grammarTrainingBox);
    renderGrammarMenu();
  };
}

if (modifierHomeBtn) {
  modifierHomeBtn.onclick = () => {
    showBox(homeBox);
    renderCalendar();
    renderDashboard();
  };
}

// 漢字・語彙トレーニング画面のボタンイベント
const kanjiVocabTrainingHomeBtn = document.getElementById('kanjiVocabTrainingHomeBtn');
const kanjiVocabBackBtn = document.getElementById('kanjiVocabBackBtn');
const kanjiVocabProblemHomeBtn = document.getElementById('kanjiVocabProblemHomeBtn');
const kanjiVocabResultHomeBtn = document.getElementById('kanjiVocabResultHomeBtn');
const kanjiVocabBackToMenuBtn = document.getElementById('kanjiVocabBackToMenuBtn');

if (kanjiVocabTrainingHomeBtn) {
  kanjiVocabTrainingHomeBtn.onclick = () => {
    showBox(homeBox);
    renderCalendar();
    renderDashboard();
  };
}

if (kanjiVocabBackBtn) {
  kanjiVocabBackBtn.onclick = () => {
    showBox(kanjiVocabTrainingBox);
    renderKanjiVocabMenu();
  };
}

if (kanjiVocabProblemHomeBtn) {
  kanjiVocabProblemHomeBtn.onclick = () => {
    showBox(homeBox);
    renderCalendar();
    renderDashboard();
  };
}

if (kanjiVocabResultHomeBtn) {
  kanjiVocabResultHomeBtn.onclick = () => {
    showBox(homeBox);
    renderCalendar();
    renderDashboard();
  };
}

if (kanjiVocabBackToMenuBtn) {
  kanjiVocabBackToMenuBtn.onclick = () => {
    showBox(kanjiVocabTrainingBox);
    renderKanjiVocabMenu();
  };
}



function toJSTDateString(date) {
  const d = new Date(date.getTime() + 9 * 60 * 60 * 1000);
  return d.toISOString().slice(0, 10);
}
function renderDashboard() {
  let username = "ゲストアカウント";
  $('dashboardUsername').textContent = username;
  const stats = getStats();
  let totalClear = 0, lessonNum = 0;
  for (const key in stats) {
    totalClear += stats[key].count || 0;
    lessonNum += stats[key].best && stats[key].best !== 'E' ? 1 : 0;
  }
  let level = Math.floor(totalClear / 3) + 1;
  // 級表示に変換
  let gradeLevel = '';
  if (level >= 10) {
    gradeLevel = '初段';
  } else if (level >= 9) {
    gradeLevel = '1級';
  } else if (level >= 8) {
    gradeLevel = '2級';
  } else if (level >= 7) {
    gradeLevel = '3級';
  } else if (level >= 6) {
    gradeLevel = '4級';
  } else if (level >= 5) {
    gradeLevel = '5級';
  } else if (level >= 4) {
    gradeLevel = '6級';
  } else if (level >= 3) {
    gradeLevel = '7級';
  } else if (level >= 2) {
    gradeLevel = '8級';
  } else {
    gradeLevel = '9級';
  }
  $('userLevel').textContent = gradeLevel;
  $('statTotal').textContent = totalClear;
  $('statLesson').textContent = lessonNum;
  const grades = getReadGrades();
  let streak = 0;
  let day = new Date();
  let reachedFive = false;
  while (true) {
    let key = toJSTDateString(day);
    if (grades[key]) {
      streak++;
      if (streak === 5) {
        reachedFive = true;
        break;
      }
      day.setDate(day.getDate() - 1);
    } else break;
  }
  // 5日連続達成後、今日も音読していたらstreak=1にリセット
  if (reachedFive) {
    const todayKey = toJSTDateString(new Date());
    if (grades[todayKey]) {
      streak = 1;
    } else {
      streak = 0;
    }
  }
  $('challengeDay').textContent = streak;
  $('challengeProgress').style.width = (streak / 5 * 100) + '%';
  updateTreasureCounts();
}
function startText(id) {
  currentTextID = id;
  // 保存された解答をリセット
  savedQuizAnswers = [];
  // 初回カウントダウンフラグをリセット
  hasShownInitialCountdown = false;
  
  loadText(id).then((success) => {
    if (!success) {
      alert('テキストの読み込みに失敗しました。');
      return;
    }
    loadQuiz(id).then(() => {
      header.style.display = 'none';
      showBox(readerBox);
      pageScores = [];
      showPage(0);
      
      // 音読モードの設定
      finishReadingBtn.style.display = 'block';
      readingLabel.style.display = 'block';
      
      // 確認問題ボタンを非表示（音読モード）
      const checkQuizBtn = document.getElementById('checkQuizBtn');
      if (checkQuizBtn) {
        checkQuizBtn.style.display = 'none';
      }
      
      startPage();
    }).catch(error => {
      console.error('テキストの読み込みエラー:', error);
      alert('テキストの読み込みに失敗しました。');
    });
  }).catch(error => {
    console.error('テキストの読み込みエラー:', error);
    alert('テキストの読み込みに失敗しました。');
  });
}
function prevPage() {
  if (currentPage === 0) return;
  
  // 音読中の場合は音声処理を即座に停止してページ移動
  if (finishReadingBtn.style.display !== 'none') {
    // 音声認識と録音を即座に停止
    if (recognition) {
      try { recognition.stop(); } catch { }
    }
    if (mediaRecorder && mediaRecorder.state === 'recording') {
      try { mediaRecorder.stop(); } catch { }
    }
    
    // ページ移動
    showPage(currentPage - 1);
    
    // 新しいページで音読開始
    setTimeout(() => {
      startPage();
    }, 100);
  } else {
    // 解くモードの場合はそのままページ移動
    showPage(currentPage - 1);
  }
}

prevBtn.onclick = prevPage;
function nextPage() {
  if (currentPage === pagesHTML.length - 1) return;
  
  // 音読中の場合は音声処理を即座に停止してページ移動
  if (finishReadingBtn.style.display !== 'none') {
    // 音声認識と録音を即座に停止
    if (recognition) {
      try { recognition.stop(); } catch { }
    }
    if (mediaRecorder && mediaRecorder.state === 'recording') {
      try { mediaRecorder.stop(); } catch { }
    }
    
    // ページ移動
    showPage(currentPage + 1);
    
    // 新しいページで音読開始
    setTimeout(() => {
      startPage();
    }, 100);
  } else {
    // 解くモードの場合はそのままページ移動
    showPage(currentPage + 1);
  }
}

nextBtn.onclick = nextPage;
function showScore() {
  const score = pageScores[currentPage] || 0;
  let grade, comment;

  if (score >= 95) {
    grade = 'S';
    comment = '完璧な音読でした！';
  } else if (score >= 85) {
    grade = 'A';
    comment = 'とてもよくできました！';
  } else if (score >= 75) {
    grade = 'B';
    comment = 'よくできました！';
  } else if (score >= 65) {
    grade = 'C';
    comment = 'もう少し頑張りましょう！';
  } else if (score >= 55) {
    grade = 'D';
    comment = 'まだまだ練習が必要です。';
  } else {
    grade = 'E';
    comment = '基礎から練習しましょう。';
  }

  // スコアを保存
  const stats = getStats();
  const id = currentTextID;
  if (!stats[id]) stats[id] = { count: 0, best: 'E' };
  stats[id].count++;
  const grades = ['E', 'D', 'C', 'B', 'A', 'S'];
  if (grades.indexOf(grade) > grades.indexOf(stats[id].best)) {
    stats[id].best = grade;
  }
  saveStats(stats);

  // 連続音読チャレンジの更新
  const today = new Date();
  const dateKey = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
  const readGrades = getReadGrades();
  readGrades[dateKey] = true;
  saveReadGrades(readGrades);

  // スコアの表示（初期状態）
  gradeLetterEl.textContent = grade;
  gradeLetterEl.className = `grade-letter grade-${grade}`;
  gradePercent.textContent = `${score}%`;
  gradePercent.style.opacity = '0'; // 初期は非表示
  gradeComment.textContent = comment;
  
  // ゲージを初期状態にリセット
  const gaugeFill = document.getElementById('gaugeFill');
  gaugeFill.style.width = '0%';
  
  scoreOverlay.style.display = 'flex';

  // アニメーション効果（段階的に実行）
  setTimeout(() => {
    // 1. 評価文字のアニメーション
    gradeLetterEl.classList.add('score-pop');
  }, 100);
  
  setTimeout(() => {
    // 2. ゲージのアニメーション
    gaugeFill.style.width = score + '%';
  }, 400);
  
  setTimeout(() => {
    // 3. パーセンテージのアニメーション
    gradePercent.style.opacity = '1';
    gradePercent.classList.add('score-pop');
  }, 800);

  // カレンダーとダッシュボードの更新
  renderCalendar();
  renderDashboard();
}

finishReadingBtn.onclick = async () => {
  await finishPage();
  showScore();
};
// 確認問題ボタンのクリックイベント
const checkQuizBtn = $('checkQuizBtn');
checkQuizBtn.onclick = () => {
  showQuiz();
};
scoreCloseBtn.onclick = () => {
  // スコアオーバーレイを閉じる
  scoreOverlay.style.display = 'none';
  
  // アニメーションクラスをリセット
  gradeLetterEl.classList.remove('score-pop');
  gradePercent.classList.remove('score-pop');
  
  // ホーム画面に戻る
  showBox(homeBox);
  header.style.display = '';
  
  // 音声関連のクリーンアップ
  if (recognition) {
    try { recognition.stop(); } catch { }
    recognition = undefined;
  }
  if (mediaRecorder) {
    try { mediaRecorder.stop(); } catch { }
    mediaRecorder = undefined;
  }
  if (window.currentStream) {
    window.currentStream.getTracks().forEach(track => track.stop());
    window.currentStream = null;
  }
  
  // UI要素のリセット
  readingLabel.style.display = 'none';
  const checkQuizBtn = document.getElementById('checkQuizBtn');
  if (checkQuizBtn) {
    checkQuizBtn.style.display = 'none';
  }
  
  // データの更新
  renderCalendar();
  renderDashboard();
  renderCards();
};
document.addEventListener('DOMContentLoaded', () => {
  renderCalendar();
  renderDashboard();
  updateTreasureCounts();
  showTreasureBox(false);
  

  

});
const selectHomeBtn = document.getElementById('selectHomeBtn');
if (selectHomeBtn) {
  selectHomeBtn.onclick = () => {
    showBox(homeBox);
    renderCalendar();
    renderDashboard();
  };
}

// 戻るボタンのイベントハンドラーを追加
const selectBackBtn = document.getElementById('selectBackBtn');
if (selectBackBtn) {
  selectBackBtn.onclick = () => {
    showBox(homeBox);
    renderCalendar();
    renderDashboard();
  };
}

const aiGenBackBtn = document.getElementById('aiGenBackBtn');
if (aiGenBackBtn) {
  aiGenBackBtn.onclick = () => {
    showBox(homeBox);
    renderCalendar();
    renderDashboard();
  };
}
const homeBtn = $('homeBtn');
homeBtn.onclick = () => {
  // 音声認識と録音を停止
  if (recognition) {
    try { recognition.stop(); } catch { }
    recognition = undefined;
  }
  if (mediaRecorder) {
    try { mediaRecorder.stop(); } catch { }
    mediaRecorder = undefined;
  }
  if (window.currentStream) {
    window.currentStream.getTracks().forEach(track => track.stop());
    window.currentStream = null;
  }
  
  // 画面表示を更新
  showBox(homeBox);
  header.style.display = '';
  renderCalendar();
  renderDashboard();
  readingLabel.style.display = 'none';
  
  // 確認問題ボタンを非表示
  const checkQuizBtn = document.getElementById('checkQuizBtn');
  if (checkQuizBtn) {
    checkQuizBtn.style.display = 'none';
  }
};
aiGenBtn.onclick = async function() {
  const grade = aiGenGrade.value;
  const type = aiGenType.value;
  const genre = aiGenGenre.value;
  const detail = aiGenDetail.value;

  aiErr.textContent = '';
  if (!grade || !type || !genre || !detail) {
    aiErr.textContent = '全て選択してください。';
    return;
  }

  aiLoading.textContent = 'AIが文章を生成中…(最大20秒)';
  aiGenBtn.disabled = true;

  const charCountByGrade = {
    1: 200,
    2: 300,
    3: 400,
    4: 500,
    5: 700,
    6: 800,
    10: 1500  // 中学受験対策は文字数を増やして、より深い内容を扱えるようにする
  };
  const charCount = charCountByGrade[parseInt(grade)];

  const prompt = `
あなたは中学受験対策の国語教材作成のプロフェッショナルです。以下の条件に合わせて、読解力と思考力を鍛えるための文章を生成してください。

【条件】
・難易度：${grade <= 6 ? `レベル${grade}` : '中学受験対策'}
・文章タイプ：${type}
・ジャンル：${genre}
・話題の掘り下げ：${detail === "1" ? "掘り下げる" : "掘り下げない"}

【必ず守ってほしいこと】
・冒頭に『タイトル』を1行で入れてください（例：「川とわたし」）
${grade === 10 ? `・中学受験対策として、以下の要素を必ず含めてください：

【文章構成】
- 序論・本論・結論の明確な構造
- 複数の具体例と抽象的な概念の組み合わせ
- 対比や比較を効果的に使用した展開
- 因果関係や論理的な推論を含む

【語彙と表現】
- 漢語・難語を積極的に使用（例：抽象、概念、本質、普遍、相対的、絶対的、等）
- 中学受験頻出の四字熟語を適切に使用（例：温故知新、一石二鳥、因果応報、等）
- 抽象度の高い表現や比喩表現を多用
- 文語的な表現を適度に取り入れる

【内容の深さ】
- 中学受験で頻出のテーマを扱う：
  * 自然と人間の共生
  * 科学技術と倫理
  * 伝統と革新
  * 個人と社会
  * 環境と開発
  * 文化と国際化
- 複数の視点からの考察を含める
- 現代社会の問題提起と解決の糸口
- 普遍的な価値観や人生観の探求

【読解力育成要素】
- 文脈から意味を推測させる難語の配置
- 指示語や接続語を効果的に使用
- 段落の要旨を把握させる構成
- 筆者の主張を読み取らせる工夫

【難易度調整】
- 文章全体の抽象度を高く保つ
- 論理的な展開を重視
- 複雑な文構造を含める
- 読者の思考を促す問いかけを含める

【実際の受験問題の特徴を反映】
- 以下のような特徴を持つ文章を生成してください：

1. 文章の特徴：
   - 開成中学、麻布中学、武蔵中学などの難関校の過去問を参考にした構成
   - 灘中学、桜蔭中学などの入試問題でよく出題される論理展開
   - 慶應義塾中等部、早稲田実業学校中等部などの出題傾向を意識した内容

2. 出題パターンに合わせた要素：
   - 指示語の指す内容を問う問題に対応できる指示語の配置
   - 接続語の適切な選択を問う問題に対応できる接続語の使用
   - 段落の要旨を問う問題に対応できる段落構成
   - 筆者の主張を問う問題に対応できる主張の明確な提示
   - 具体例と抽象概念の関係を問う問題に対応できる具体例の配置

3. 難易度の調整：
   - 難関校レベル：高度な抽象概念と複雑な論理展開
   - 中堅校レベル：基本的な論理展開と適度な抽象度
   - 基礎レベル：具体的な例示と明確な主張

4. 出題傾向に合わせた内容：
   - 環境問題と科学技術
   - 伝統文化と現代社会
   - 国際化と日本文化
   - 情報化社会と人間関係
   - 自然と人間の共生
   - 科学技術と倫理
   - 教育と社会
   - 文化と多様性

5. 読解問題の作成を意識した要素：
   - 文脈から意味を推測させる難語の配置
   - 指示語の適切な使用
   - 接続語による論理関係の明確化
   - 段落の要旨を把握しやすい構成
   - 筆者の主張を読み取りやすい展開` : `・本文は${grade <= 6 ? `小${grade}年` : `中${grade - 6}年`}の教科書レベルに準拠した表現・語彙にしてください`}
・文字数は【約${charCount}字】としてください
・文章の内容は、読解力を育てるために適切なものにしてください
・返答はすべて「|漢字《ふりがな》」の形式でふりがなをふってください
${detail === "1" ? "・選んだジャンルの中の1つの話題に焦点を当て、詳しく掘り下げた内容にしてください" : ""}

【重要：ランダム性と多様性について】
・同じジャンルでも、毎回異なる話題や視点で文章を生成してください
・以下のジャンル別の例を参考に、多様な話題からランダムに選んでください：

【偉人】の場合：
- 科学者：アインシュタイン、キュリー夫人、ニュートン、ダーウィン、ガリレオ
- 発明家：エジソン、ライト兄弟、ベル、テスラ、スティーブ・ジョブズ
- 芸術家：ピカソ、モーツァルト、ベートーヴェン、ゴッホ、ダ・ヴィンチ
- 探検家：コロンブス、マゼラン、アムンゼン、スコット、マルコ・ポーロ
- 社会活動家：マザー・テレサ、ガンジー、キング牧師、ナイチンゲール
- 日本の偉人：野口英世、福沢諭吉、伊能忠敬、北里柴三郎、渋沢栄一
などから、毎回異なる人物を選んでください

【未来・テクノロジー】の場合：
- 1回目：AIと人間の共生
- 2回目：宇宙開発の最前線
- 3回目：スマートシティの実現
- 4回目：ロボット技術の進化
- 5回目：バーチャルリアリティの可能性
のように、毎回異なる切り口で書いてください

【動物】の場合：
- 哺乳類：イルカ、ゾウ、チンパンジー、コアラ、パンダ
- 鳥類：ペンギン、フクロウ、ハチドリ、オウム、タカ
- 海洋生物：クジラ、タコ、クラゲ、サメ、カメ
- 昆虫：アリ、チョウ、カブトムシ、ミツバチ、カマキリ
などから、毎回異なる動物を選んでください

【宇宙】の場合：
- 惑星：火星、木星、土星、金星、水星
- 天体現象：ブラックホール、超新星、流星群、オーロラ
- 宇宙開発：月面基地、火星探査、人工衛星、宇宙ステーション
- 宇宙の謎：暗黒物質、重力波、宇宙の始まり、地球外生命
などから、毎回異なる話題を選んでください

・他のジャンルも同様に、そのジャンル内で多様な話題をランダムに選んでください
・ただし、選んだ話題は必ずそのジャンルの範疇内に収めてください
・同じ人物や話題が連続して選ばれないようにしてください
`;

  document.getElementById('aiLoadingOverlay').style.display = 'flex';
  aiErr.textContent = '';
  try {
    const res = await fetch(`${API_BASE_URL}/chat/completions`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": `Bearer ${OPENAI_API_KEY}`
      },
      body: JSON.stringify({
        model: "gpt-4o",
        messages: [{ role: "user", content: prompt }],
        max_tokens: 1000,
        temperature: 0.8,
      }),
    });
    
    if (!res.ok) {
      throw new Error(`API Error: ${res.status} ${res.statusText}`);
    }

    const data = await res.json();
    console.log("レスポンス:", data);
    let txt = data.choices?.[0]?.message?.content || '';
    if (!txt) throw new Error("AI生成に失敗しました");

    let rubyHtml = rubyToHTML(txt.trim());
    pagesHTML = [rubyHtml];
    pagesPlain = [stripRuby(txt.trim()).replace(/\s+/g, '')];
    currentPage = 0;
    currentTextID = "ai_gen_" + Date.now();
    pageScores = [];
    header.style.display = 'none';
    showBox(readerBox);
    showPage(0);
    startPage();
  } catch (e) {
    console.error(e);
    aiErr.textContent = '生成またはAPI通信に失敗しました。再試行してください。';
  } finally {
    aiLoading.textContent = '';
    aiGenBtn.disabled = false;
    document.getElementById('aiLoadingOverlay').style.display = 'none';
  }
};

// ふりがな除去関数（再掲）
function getSelectedTextWithoutRubyRT() {
  const selection = window.getSelection();
  if (!selection.rangeCount) return "";
  const range = selection.getRangeAt(0);
  if (!textDisplay.contains(range.commonAncestorContainer)) return "";

  const frag = range.cloneContents();
  const rts = frag.querySelectorAll("rt");
  rts.forEach(rt => rt.parentNode.removeChild(rt));
  let text = frag.textContent || "";
  return text
    .replace(/《.*?》/g, "")
    .replace(/[\s\u200B-\u200D\uFEFF\n\r]/g, "");
}


// 文法トレーニングの状態管理
let currentGrammarSession = {
  category: null,
  problems: [],
  currentIndex: 0,
  score: 0,
  selectedAnswer: null
};

// 文節分けの状態管理
let currentClauseSession = {
  problems: [],
  currentIndex: 0,
  score: 0,
  userLines: [], // ユーザーが引いた線の軌跡
  canvas: null,
  ctx: null,
  isDrawing: false,
  lastX: 0,
  lastY: 0,
  currentStroke: [] // 現在描画中の線の軌跡
};

// 助詞問題データ
let particlesProblems = [];

// 助詞問題の状態管理
let currentParticlesSession = {
  problems: [],
  currentIndex: 0,
  score: 0,
  userAnswers: {} // {position: particle}
};

// 文節分け問題データ
let clauseDivisionProblems = [];

// 助詞問題をJSONから読み込む
async function loadParticlesProblems() {
  try {
    const response = await fetch('particles_problems.json');
    if (!response.ok) {
      throw new Error(`助詞問題データの読み込みに失敗しました: ${response.status}`);
    }
    const problemData = await response.json();
    
    particlesProblems = problemData.problems || [];
    
    console.log(`助詞問題データを読み込みました:`, particlesProblems.length + '問');
    
    return true;
  } catch (error) {
    console.error('助詞問題データの読み込みエラー:', error);
    
    // フォールバック用のデータ
    particlesProblems = [
      {
        id: 1,
        sentence: '私（　）友達（　）公園（　）行った。',
        blanks: [
          {position: 1, correct: 'は'},
          {position: 2, correct: 'と'}, 
          {position: 3, correct: 'に'}
        ],
        cards: ['は', 'と', 'に'],
        explanation: '主語を表すときは「は」、一緒にという意味では「と」、目的地を表すときは「に」を使います。',
        hint: '誰が、誰と、どこに、という関係を考えてみましょう。'
      }
    ];
    
    return false;
  }
}

// 助詞問題を初期化
async function initParticlesProblem() {
  // ローディング表示
  const gameDiv = document.getElementById('particlesProblemContent');
          gameDiv.innerHTML = '<div style="text-align:center;padding:40px;"><div style="font-size:18px;color:#16a34a;">助詞問題を読み込んでいます...</div></div>';
  
  // 問題データを読み込み
  const loaded = await loadParticlesProblems();
  
  if (particlesProblems.length === 0) {
    gameDiv.innerHTML = '<div style="text-align:center;padding:40px;color:#f44336;">助詞の問題が見つかりません。</div>';
    return;
  }
  
  // 元のHTML構造を復元
  restoreParticlesGameHTML();
  
  currentParticlesSession = {
    problems: particlesProblems,
    currentIndex: 0,
    score: 0,
    userAnswers: {}
  };
  
  // 最初の問題を表示
  displayCurrentParticlesProblem();
  
  // ボタンイベントを設定
  setupParticlesButtons();
}

// 助詞ゲームのHTML構造を復元
function restoreParticlesGameHTML() {
  const gameDiv = document.getElementById('particlesProblemContent');
  gameDiv.innerHTML = `
    <div class="particles-game">
      <!-- 問題ヘッダー -->
      <div class="problem-header" style="margin-bottom:16px;">
        <div class="problem-header-title">問題</div>
        <div class="problem-header-progress" id="particlesProblemProgress">
          <div style="margin-bottom: 8px;">1/10</div>
          <div style="width: 200px; height: 10px; background: #e0e0e0; border-radius: 5px; margin: 0 auto; position: relative; overflow: hidden;">
            <div style="width: 10%; height: 100%; background: #87CEEB; border-radius: 5px; transition: width 0.3s ease;">
            </div>
          </div>
        </div>
      </div>
      
      <div style="text-align:center;margin-bottom:24px;color:#666;font-size:14px;">
        助詞カードを文の（　）にあてはめて正しい文を作りなさい。
      </div>
      
      <!-- 文章表示エリア -->
      <div id="particlesSentence" style="font-size:20px;font-weight:bold;margin-bottom:32px;padding:24px;line-height:2;font-family:'Tsukushi Mincho','Yu Mincho','YuMincho','MS Mincho',serif;writing-mode:vertical-rl;text-orientation:upright;width:fit-content;max-width:300px;min-height:200px;max-height:400px;margin:0 auto 32px auto;border-radius:12px;background:#ffffff;text-align:left;overflow:visible;">
        問題文がここに表示されます
      </div>
      
      <!-- 助詞カードエリア -->
      <div class="particles-cards-area" style="margin-bottom:32px;">
                  <h3 style="text-align:center;margin-bottom:16px;color:#16a34a;">助詞カード</h3>
        <div id="particlesCards" style="display:flex;justify-content:center;gap:16px;flex-wrap:wrap;">
          <!-- 助詞カードがここに表示されます -->
        </div>
      </div>
      

      
      <div id="particlesFeedback" style="margin-bottom:24px;font-size:16px;padding:16px;border-radius:8px;display:none;">
        <!-- フィードバックがここに表示されます -->
      </div>
      
      <div class="particles-controls" style="text-align:center;margin-top:24px;">

        <button id="particlesCheckBtn" class="logic-check-btn">解答する</button>
        <button id="particlesResetBtn" class="logic-reset-btn">リセット</button>
        <button id="particlesNextBtn" class="grammar-next-btn" style="display:none;">次の問題へ</button>
        <button id="particlesFinishBtn" class="grammar-finish-btn" style="display:none;">結果を見る</button>
      </div>
    </div>
  `;
}

// 文節分け問題をJSONから読み込む
async function loadClauseDivisionProblems() {
  try {
    const response = await fetch('clause_division_problems.json');
    if (!response.ok) {
      throw new Error(`文節分け問題データの読み込みに失敗しました: ${response.status}`);
    }
    const problemData = await response.json();
    
    clauseDivisionProblems = problemData.problems || [];
    
    console.log(`文節分け問題データを読み込みました:`, clauseDivisionProblems.length + '問');
    
    return true;
  } catch (error) {
    console.error('文節分け問題データの読み込みエラー:', error);
    
    // フォールバック用のデータ
    clauseDivisionProblems = [
      {
        id: 1,
        sentence: '桜の花が美しく咲いている。',
        clauses: ['桜の', '花が', '美しく', '咲いている。'],
        divisions: [2, 4, 7],
        hint: '「〜の」「〜が」「〜く」などの境目で分けてみましょう。'
      }
    ];
    
    return false;
  }
}

// 主語・述語問題をJSONから読み込む
async function loadSubjectPredicateProblems() {
  try {
    const response = await fetch('subject_predicate_problems.json');
    if (!response.ok) {
      throw new Error(`主語・述語問題データの読み込みに失敗しました: ${response.status}`);
    }
    const problemData = await response.json();
    
    subjectPredicateProblems = problemData.problems || [];
    
    console.log(`主語・述語問題データを読み込みました:`, subjectPredicateProblems.length + '問');
    
    return true;
  } catch (error) {
    console.error('主語・述語問題データの読み込みエラー:', error);
    
    // フォールバック用のデータ
    subjectPredicateProblems = [
      {
        id: 1,
        sentence: '桜の花が美しく咲いている。',
        words: [
          {text: '桜の', type: 'modifier', position: 0},
          {text: '花が', type: 'subject', position: 1},
          {text: '美しく', type: 'adverb', position: 2},
          {text: '咲いている', type: 'predicate', position: 3}
        ],
        correct_predicate: 3,
        correct_subject: 1,
        explanation: '「咲いている」が述語（動作を表す）で、「花が」が主語（何が〜する）です。',
        hint: '何が何をしているかを考えてみましょう。'
      }
    ];
    
    return false;
  }
}

// 修飾語問題をJSONから読み込む
async function loadModifierProblems() {
  try {
    const response = await fetch('modifier_problems.json');
    if (!response.ok) {
      throw new Error(`修飾語問題データの読み込みに失敗しました: ${response.status}`);
    }
    const problemData = await response.json();
    
    modifierProblems = problemData.problems || [];
    
    console.log(`修飾語問題データを読み込みました:`, modifierProblems.length + '問');
    
    return true;
  } catch (error) {
    console.error('修飾語問題データの読み込みエラー:', error);
    
    // フォールバック用のデータ
    modifierProblems = [
      {
        id: 1,
        sentence: '美しい花が咲いている。',
        words: [
          {text: '美しい', type: 'modifier', position: 0, isMarked: true},
          {text: '花が', type: 'noun', position: 1},
          {text: '咲いている', type: 'predicate', position: 2}
        ],
        marked_modifier: 0,
        correct_modified: 1,
        explanation: '「美しい」が修飾語で、「花」を修飾しています。',
        hint: '修飾語「美しい」は何を詳しく説明しているでしょうか？'
      }
    ];
    
    return false;
  }
}

// 文の構造問題をJSONから読み込む
async function loadSentenceStructureProblems() {
  try {
    const response = await fetch('sentence_structure_problems.json');
    if (!response.ok) {
      throw new Error(`文の構造問題データの読み込みに失敗しました: ${response.status}`);
    }
    const problemData = await response.json();
    
    sentenceStructureProblems = problemData.problems || [];
    
    console.log(`文の構造問題データを読み込みました:`, sentenceStructureProblems.length + '問');
    
    return true;
  } catch (error) {
    console.error('文の構造問題データの読み込みエラー:', error);
    
    // フォールバック用のデータ
    sentenceStructureProblems = [
      {
        id: 1,
        level: 'intro',
        sentence: '白い車は急に動き出した。',
        bunsetsu: ['白い', '車は', '急に', '動き出した'],
        correct_placement: {
          subject: '車は',
          predicate: '動き出した',
          modifier1: '白い',
          modifier2: '急に'
        },
        explanation: '「車は」が主語、「動き出した」が述語です。「白い」は「車」を修飾し、「急に」は「動き出した」を修飾します。',
        hint: 'まず「何が・どうした」を見つけて、太い枠に入れましょう。'
      }
    ];
    
    return false;
  }
}

// 主語・述語問題を初期化
async function initSubjectPredicateProblem(levelId = null) {
  // ローディング表示
  const gameDiv = document.getElementById('subjectPredicateProblemContent');
          gameDiv.innerHTML = '<div style="text-align:center;padding:40px;"><div style="font-size:18px;color:#16a34a;">主語・述語問題を読み込んでいます...</div></div>';
  
  // 問題データを読み込み
  const loaded = await loadSubjectPredicateProblems();
  
  if (subjectPredicateProblems.length === 0) {
    gameDiv.innerHTML = '<div style="text-align:center;padding:40px;color:#f44336;">主語・述語の問題が見つかりません。</div>';
    return;
  }
  
  // レベル別に問題をフィルタリング
  let filteredProblems = subjectPredicateProblems;
  if (levelId) {
    let targetLevel = '';
    if (levelId.includes('intro')) {
      targetLevel = 'intro';
    } else if (levelId.includes('basic')) {
      targetLevel = 'basic';
    } else if (levelId.includes('advanced')) {
      targetLevel = 'advanced';
    }
    
    if (targetLevel) {
      filteredProblems = subjectPredicateProblems.filter(problem => 
        problem.level && problem.level.startsWith(targetLevel)
      );
    }
  }
  
  if (filteredProblems.length === 0) {
    gameDiv.innerHTML = '<div style="text-align:center;padding:40px;color:#f44336;">このレベルの問題が見つかりません。</div>';
    return;
  }
  
  // 元のHTML構造を復元
  restoreSubjectPredicateGameHTML();
  
  currentSubjectPredicateSession = {
    problems: filteredProblems,
    currentIndex: 0,
    selectedPredicate: null,
    selectedSubject: null,
    score: 0,
    isChecked: false,
    levelId: levelId || 'basic'
  };
  
  // 最初の問題を表示
  displayCurrentSubjectPredicateProblem();
  
  // ボタンイベントを設定
  setupSubjectPredicateButtons();
}

// 主語・述語ゲームのHTML構造を復元
function restoreSubjectPredicateGameHTML() {
  const gameDiv = document.getElementById('subjectPredicateProblemContent');
  gameDiv.innerHTML = `
    <!-- 問題ヘッダー -->
    <div class="problem-header" style="margin-bottom:16px;width:100%;display:flex;justify-content:space-between;align-items:flex-start;">
      <div class="problem-header-title">問題</div>
      <div class="problem-header-progress" id="subjectPredicateProblemProgress" style="text-align:center;font-size:16px;color:#666;">
        <div style="margin-bottom: 8px;">1/10</div>
        <div style="width: 200px; height: 10px; background: #e0e0e0; border-radius: 5px; margin: 0 auto; position: relative; overflow: hidden;">
          <div style="width: 10%; height: 100%; background: #87CEEB; border-radius: 5px; transition: width 0.3s ease;">
          </div>
        </div>
      </div>
    </div>
    
    <div style="font-size:14px;color:#666;margin-bottom:20px;text-align:center;">
      次の文の主語と述語を答えなさい。</br>まず【述語】をタップし、次に【主語】をタップしなさい。
    </div>
    
    <div id="subjectPredicateSentence" style="font-size:24px;padding:24px;line-height:2.5;width:fit-content;writing-mode:vertical-rl;text-orientation:upright;font-family:'Tsukushi Mincho','Yu Mincho','YuMincho','MS Mincho',serif;height:400px;max-height:400px;overflow:visible;">
      <!-- 文章と単語がここに表示されます -->
    </div>
    

    
    <div id="subjectPredicateFeedback" style="margin-bottom:24px;font-size:16px;padding:16px;border-radius:8px;display:none;">
      <!-- フィードバックがここに表示されます -->
    </div>
    
    <div class="subject-predicate-controls" style="text-align:center;margin-bottom:20px;">

      <button id="subjectPredicateCheckBtn" style="background:#20B2AA;color:white;border:none;padding:10px 20px;border-radius:8px;font-size:14px;cursor:pointer;margin-right:10px;">解答する</button>
      <button id="subjectPredicateResetBtn" style="background:#495057;color:white;border:none;padding:10px 20px;border-radius:8px;font-size:14px;cursor:pointer;">リセット</button>
    </div>
    
    <div class="grammar-controls" style="text-align:center;">
      <button id="subjectPredicateNextBtn" class="grammar-next-btn" style="display:none;">次の問題へ</button>
      <button id="subjectPredicateFinishBtn" class="grammar-finish-btn" style="display:none;">結果を見る</button>
    </div>
  `;
}

// 現在の主語・述語問題を表示
function displayCurrentSubjectPredicateProblem() {
  const session = currentSubjectPredicateSession;
  const problem = session.problems[session.currentIndex];
  
  // 進捗を更新
  updateProblemProgress(session.currentIndex, session.problems.length, 'subjectPredicateProblemProgress');
  
  // 選択状態をリセット
  session.selectedPredicate = null;
  session.selectedSubject = null;
  session.isChecked = false;
  
  // 文章と単語を表示
  displaySubjectPredicateSentence(problem);
  
  // すべてのラベルを削除
  document.querySelectorAll('.word-label').forEach(label => {
    label.remove();
  });
  
  // フィードバックとボタンを非表示
  document.getElementById('subjectPredicateFeedback').style.display = 'none';
  document.getElementById('subjectPredicateNextBtn').style.display = 'none';
  document.getElementById('subjectPredicateFinishBtn').style.display = 'none';
  
  // 解答するボタンとリセットボタンを表示
  document.getElementById('subjectPredicateCheckBtn').style.display = 'inline-block';
  document.getElementById('subjectPredicateResetBtn').style.display = 'inline-block';
}

// 主語・述語問題の文章と単語を表示
function displaySubjectPredicateSentence(problem) {
  const sentenceDiv = document.getElementById('subjectPredicateSentence');
  
  // 単語をクリック可能な要素として表示
  const wordsHTML = problem.words.map(word => 
    `<span class="subject-predicate-word" data-position="${word.position}" data-type="${word.type}">${word.text}</span>`
  ).join('');
  
  // 最後に句点を追加（クリック不可能）
  sentenceDiv.innerHTML = wordsHTML + '<span class="punctuation" style="display: inline; font-size: 20px; color: #2c3e50;">。</span>';
  
  // 単語クリックイベントを追加
  const wordElements = sentenceDiv.querySelectorAll('.subject-predicate-word');
  wordElements.forEach(element => {
    element.addEventListener('click', handleSubjectPredicateWordClick);
  });
}

// 単語クリック処理
function handleSubjectPredicateWordClick(event) {
  const session = currentSubjectPredicateSession;
  
  // 既に答え合わせ済みの場合は何もしない
  if (session.isChecked) return;
  
  const position = parseInt(event.target.dataset.position);
  
  // 1回目のクリック（述語選択）
  if (session.selectedPredicate === null) {
    session.selectedPredicate = position;
    event.target.classList.add('selected-predicate');
    
    // 他の単語の選択状態をリセット
    document.querySelectorAll('.subject-predicate-word').forEach(word => {
      if (parseInt(word.dataset.position) !== position) {
        word.classList.remove('selected-predicate', 'selected-subject');
      }
    });
    
    // 述語ラベルを表示
    updateSubjectPredicateLabels();
  }
  // 2回目のクリック（主語選択）
  else if (session.selectedSubject === null && position !== session.selectedPredicate) {
    session.selectedSubject = position;
    event.target.classList.add('selected-subject');
    
    // 主語ラベルを表示
    updateSubjectPredicateLabels();
  }
  // 同じ単語をクリックした場合（選択解除）
  else if (position === session.selectedPredicate) {
    session.selectedPredicate = null;
    event.target.classList.remove('selected-predicate');
    
    // ラベルを更新
    updateSubjectPredicateLabels();
  }
  else if (position === session.selectedSubject) {
    session.selectedSubject = null;
    event.target.classList.remove('selected-subject');
    
    // ラベルを更新
    updateSubjectPredicateLabels();
  }
}

// 主語・述語ラベルの表示を更新
function updateSubjectPredicateLabels() {
  const session = currentSubjectPredicateSession;
  
  console.log('updateSubjectPredicateLabels called', session.selectedPredicate, session.selectedSubject);
  
  // 既存のラベルをすべて削除
  document.querySelectorAll('.word-label').forEach(label => {
    label.remove();
  });
  
  // 述語ラベルの追加
  if (session.selectedPredicate !== null) {
    const predicateWord = document.querySelector(`.subject-predicate-word[data-position="${session.selectedPredicate}"]`);
    console.log('Predicate word found:', predicateWord);
    if (predicateWord) {
      // relativeまたはabsoluteのpositionに設定
      if (getComputedStyle(predicateWord).position === 'static') {
        predicateWord.style.position = 'relative';
      }
      
      const label = document.createElement('div');
      label.className = 'word-label predicate-label';
      label.textContent = '述語';
      label.style.cssText = `
        display: block !important;
        position: absolute;
        left: 100%;
        top: 50%;
        transform: translateY(-50%);
        font-size: 14px;
        font-weight: bold;
        white-space: nowrap;
        z-index: 100;
        margin-left: -3px;
        color: #1976d2;
        opacity: 1;
        writing-mode: vertical-rl;
        text-orientation: upright;
      `;
      predicateWord.appendChild(label);
      console.log('Predicate label added');
    }
  }
  
  // 主語ラベルの追加
  if (session.selectedSubject !== null) {
    const subjectWord = document.querySelector(`.subject-predicate-word[data-position="${session.selectedSubject}"]`);
    console.log('Subject word found:', subjectWord);
    if (subjectWord) {
      // relativeまたはabsoluteのpositionに設定
      if (getComputedStyle(subjectWord).position === 'static') {
        subjectWord.style.position = 'relative';
      }
      
      const label = document.createElement('div');
      label.className = 'word-label subject-label';
      label.textContent = '主語';
      label.style.cssText = `
        display: block !important;
        position: absolute;
        left: 100%;
        top: 50%;
        transform: translateY(-50%);
        font-size: 14px;
        font-weight: bold;
        white-space: nowrap;
        z-index: 100;
        margin-left: -3px;
        color: #d32f2f;
        opacity: 1;
        writing-mode: vertical-rl;
        text-orientation: upright;
      `;
      subjectWord.appendChild(label);
      console.log('Subject label added');
    }
  }
}

// 主語・述語問題のボタンイベントを設定
function setupSubjectPredicateButtons() {

  
  // 答え確認ボタン
  document.getElementById('subjectPredicateCheckBtn').onclick = checkSubjectPredicateAnswer;
  
  // リセットボタン
  document.getElementById('subjectPredicateResetBtn').onclick = resetSubjectPredicateProblem;
  
  // 次の問題ボタン
  document.getElementById('subjectPredicateNextBtn').onclick = goToNextSubjectPredicateProblem;
  
  // 結果表示ボタン
  document.getElementById('subjectPredicateFinishBtn').onclick = showSubjectPredicateResult;
}

// 主語・述語問題の答え合わせ
function checkSubjectPredicateAnswer() {
  const session = currentSubjectPredicateSession;
  const problem = session.problems[session.currentIndex];
  
  if (session.selectedPredicate === null || session.selectedSubject === null) {
    alert('述語と主語の両方を選択してください。');
    return;
  }
  
  session.isChecked = true;
  
  const predicateCorrect = session.selectedPredicate === problem.correct_predicate;
  const subjectCorrect = session.selectedSubject === problem.correct_subject;
  const isCorrect = predicateCorrect && subjectCorrect;
  
  if (isCorrect) {
    session.score++;
    
    // 大きな緑の〇を表示
    showBigGreenCircle();
  } else {
    // アニメーションなし
  }
  
  // 単語に正解・不正解の色をつける
  document.querySelectorAll('.subject-predicate-word').forEach(word => {
    const position = parseInt(word.dataset.position);
    word.classList.add('disabled');
    
    if (position === problem.correct_predicate) {
      word.classList.add('correct');
      word.classList.remove('selected-predicate', 'incorrect');
    } else if (position === problem.correct_subject) {
      word.classList.add('correct');
      word.classList.remove('selected-subject', 'incorrect');
    } else if (position === session.selectedPredicate && !predicateCorrect) {
      word.classList.add('incorrect');
      // 間違えた述語を赤くして×ラベルを追加
      word.style.background = '#f44336';
      word.style.color = 'white';
      word.style.borderColor = '#d32f2f';
      addIncorrectLabel(word);
    } else if (position === session.selectedSubject && !subjectCorrect) {
      word.classList.add('incorrect');
      // 間違えた主語を赤くして×ラベルを追加
      word.style.background = '#f44336';
      word.style.color = 'white';
      word.style.borderColor = '#d32f2f';
      addIncorrectLabel(word);
    }
  });
  
  // フィードバック表示
  const feedbackDiv = document.getElementById('subjectPredicateFeedback');
  feedbackDiv.style.display = 'block';
  feedbackDiv.style.opacity = '1';
  
  if (isCorrect) {
    feedbackDiv.style.background = '#e0f2f1';
    feedbackDiv.style.color = '#00695c';
    feedbackDiv.style.border = '1px solid #4db6ac';
    feedbackDiv.innerHTML = `
      <div style="font-weight:bold;margin-bottom:8px;">✅ 正解！</div>
      <div>${problem.explanation}</div>
    `;
  } else {
    feedbackDiv.style.background = '#fce4ec';
    feedbackDiv.style.color = '#880e4f';
    feedbackDiv.style.border = '1px solid #f06292';
    feedbackDiv.innerHTML = `
      <div style="font-weight:bold;margin-bottom:8px;">❌ 不正解</div>
      <div>${problem.explanation}</div>
    `;
  }
  
  // 解答ボタンとリセットボタンを非表示
  document.getElementById('subjectPredicateCheckBtn').style.display = 'none';
  document.getElementById('subjectPredicateResetBtn').style.display = 'none';
  
  // ボタンの表示制御（正解・不正解で分ける）
  if (isCorrect) {
    // 正解の場合は次の問題へ
    if (session.currentIndex < session.problems.length - 1) {
      document.getElementById('subjectPredicateNextBtn').style.display = 'inline-block';
    } else {
      document.getElementById('subjectPredicateFinishBtn').style.display = 'inline-block';
    }
  } else {
    // 不正解の場合は解きなおし
    // 解きなおしボタンを動的に作成
    const resetBtn = document.createElement('button');
    resetBtn.textContent = '解きなおす';
    resetBtn.className = 'grammar-next-btn';
    resetBtn.style.background = '#ff9800';
    resetBtn.onclick = () => resetSubjectPredicateProblem();
    
    // フィードバックエリアにボタンを追加
    const feedbackDiv = document.getElementById('subjectPredicateFeedback');
    feedbackDiv.appendChild(resetBtn);
  }
}

// 主語・述語問題をリセット
function resetSubjectPredicateProblem() {
  // 現在の問題を再表示して完全にリセット
  displayCurrentSubjectPredicateProblem();
}

// 次の主語・述語問題へ
function goToNextSubjectPredicateProblem() {
  const session = currentSubjectPredicateSession;
  
  if (session.currentIndex < session.problems.length - 1) {
    session.currentIndex++;
    
    const contentContainer = document.getElementById('subjectPredicateProblemContent');
    transitionToNextProblem(contentContainer, () => {
      displayCurrentSubjectPredicateProblem();
    });
  }
}

// 主語・述語問題の結果表示
function showSubjectPredicateResult() {
  const session = currentSubjectPredicateSession;
  
  // 紙吹雪演出を表示
  showConfettiCelebration();
  
  // 進捗を更新（現在のレベルの問題数を記録）
  updateGrammarProgressAfterCompletion('subject-predicate', session.levelId, session.score, session.problems.length);
  
  // 4秒後にメニューに戻る
  setTimeout(() => {
    showBox(grammarTrainingBox);
    renderGrammarMenu();
  }, 4000);
}

// 修飾語問題を初期化
async function initModifierProblem() {
  // ローディング表示
  const gameDiv = document.getElementById('modifierProblemContent');
          gameDiv.innerHTML = '<div style="text-align:center;padding:40px;"><div style="font-size:18px;color:#16a34a;">修飾語問題を読み込んでいます...</div></div>';
  
  // 問題データを読み込み
  const loaded = await loadModifierProblems();
  
  if (modifierProblems.length === 0) {
    gameDiv.innerHTML = '<div style="text-align:center;padding:40px;color:#f44336;">修飾語の問題が見つかりません。</div>';
    return;
  }
  
  // 元のHTML構造を復元
  restoreModifierGameHTML();
  
  currentModifierSession = {
    problems: modifierProblems,
    currentIndex: 0,
    selectedModified: null,
    score: 0,
    isChecked: false
  };
  
  // 最初の問題を表示
  displayCurrentModifierProblem();
  
  // ボタンイベントを設定
  setupModifierButtons();
}

// 修飾語問題のセッション管理
let currentModifierSession = {
  problems: [],
  currentIndex: 0,
  selectedModified: null,
  score: 0,
  isChecked: false
};

// 修飾語ゲームのHTML構造を復元
function restoreModifierGameHTML() {
  const gameDiv = document.getElementById('modifierProblemContent');
  gameDiv.innerHTML = `
    <!-- 問題ヘッダー -->
    <div class="problem-header" style="margin-bottom:16px;">
      <div class="problem-header-title">問題</div>
      <div class="problem-header-progress" id="modifierProblemProgress">
        <div style="margin-bottom: 8px;">1/10</div>
        <div style="width: 200px; height: 10px; background: #e0e0e0; border-radius: 5px; margin: 0 auto; position: relative; overflow: hidden;">
          <div style="width: 10%; height: 100%; background: #87CEEB; border-radius: 5px; transition: width 0.3s ease;">
          </div>
        </div>
      </div>
    </div>
    
    <div style="font-size:14px;color:#666;margin-bottom:20px;text-align:center;">
      緑の線が引かれた修飾語が、どの語を修飾しているかタップして答えなさい。
    </div>
    
    <div id="modifierSentence" class="modifier-sentence-vertical" style="text-align:center;margin:40px auto;width:fit-content;">
      <!-- 文章と単語がここに表示されます -->
    </div>
    
    <div id="modifierFeedback" style="margin-bottom:24px;font-size:16px;padding:16px;border-radius:8px;display:none;">
      <!-- フィードバックがここに表示されます -->
    </div>
    
    <div class="modifier-controls" style="text-align:center;margin-bottom:20px;">
      <button id="modifierCheckBtn" style="background:#20B2AA;color:white;border:none;padding:10px 20px;border-radius:8px;font-size:14px;cursor:pointer;margin-right:10px;">解答する</button>
      <button id="modifierResetBtn" style="background:#495057;color:white;border:none;padding:10px 20px;border-radius:8px;font-size:14px;cursor:pointer;">リセット</button>
    </div>
    
    <div class="grammar-controls" style="text-align:center;">
      <button id="modifierNextBtn" class="grammar-next-btn" style="display:none;">次の問題へ</button>
      <button id="modifierFinishBtn" class="grammar-finish-btn" style="display:none;">結果を見る</button>
    </div>
  `;
}

// 現在の修飾語問題を表示
function displayCurrentModifierProblem() {
  const session = currentModifierSession;
  const problem = session.problems[session.currentIndex];
  
  // 進捗を更新
  updateProblemProgress(session.currentIndex, session.problems.length, 'modifierProblemProgress');
  
  // 選択状態をリセット
  session.selectedModified = null;
  session.isChecked = false;
  
  // 文章と単語を表示
  displayModifierSentence(problem);
  
  // フィードバックとボタンを非表示
  document.getElementById('modifierFeedback').style.display = 'none';
  document.getElementById('modifierNextBtn').style.display = 'none';
  document.getElementById('modifierFinishBtn').style.display = 'none';
  
  // 解答するボタンとリセットボタンを表示
  document.getElementById('modifierCheckBtn').style.display = 'inline-block';
  document.getElementById('modifierResetBtn').style.display = 'inline-block';
}

// 修飾語問題の文章と単語を表示
function displayModifierSentence(problem) {
  const sentenceDiv = document.getElementById('modifierSentence');
  
  // 単語をクリック可能な要素として表示
  const wordsHTML = problem.words.map(word => {
    let className = 'modifier-word';
    if (word.isMarked) {
      className += ' marked-modifier';
    }
    return `<span class="${className}" data-position="${word.position}" data-type="${word.type}">${word.text}</span>`;
  }).join('');
  
  // 最後に句点を追加（クリック不可能）
  sentenceDiv.innerHTML = wordsHTML + '<span class="punctuation" style="display: inline; font-size: 20px; color: #2c3e50;">。</span>';
  
  // 修飾語ラベルを表示
  updateModifierLabels();
  
  // 単語クリックイベントを追加（修飾語以外のみ）
  const wordElements = sentenceDiv.querySelectorAll('.modifier-word:not(.marked-modifier)');
  wordElements.forEach(element => {
    element.addEventListener('click', handleModifierWordClick);
  });
}

// 単語クリック処理
function handleModifierWordClick(event) {
  const session = currentModifierSession;
  
  // 既に答え合わせ済みの場合は何もしない
  if (session.isChecked) return;
  
  const position = parseInt(event.target.dataset.position);
  
  // 他の単語の選択状態をリセット
  document.querySelectorAll('.modifier-word').forEach(word => {
    word.classList.remove('selected-modified');
  });
  
  // 選択された単語をハイライト
  session.selectedModified = position;
  event.target.classList.add('selected-modified');
  
  // ラベルを更新
  updateModifierLabels();
}

// 修飾語ラベルの表示を更新
function updateModifierLabels() {
  const session = currentModifierSession;
  const problem = session.problems[session.currentIndex];
  
  // 既存のラベルをすべて削除
  document.querySelectorAll('.word-label').forEach(label => {
    label.remove();
  });
  
  // 修飾語ラベルの追加（マークされた修飾語に）
  const markedModifiers = document.querySelectorAll('.modifier-word.marked-modifier');
  markedModifiers.forEach(modifierWord => {
    // relativeまたはabsoluteのpositionに設定
    if (getComputedStyle(modifierWord).position === 'static') {
      modifierWord.style.position = 'relative';
    }
    
    const label = document.createElement('div');
    label.className = 'word-label modifier-label';
    label.textContent = '修飾語';
    label.style.cssText = `
      display: block !important;
      position: absolute;
      left: 100%;
      top: 50%;
      transform: translateY(-50%);
      font-size: 14px;
      font-weight: bold;
      white-space: nowrap;
      z-index: 100;
      margin-left: 8px;
      color: #4CAF50;
      opacity: 1;
      writing-mode: horizontal-tb;
      text-orientation: mixed;
    `;
    modifierWord.appendChild(label);
  });
  
  // 選択された語に修飾される語ラベルを表示（ユーザーが選択した場合のみ）
  if (session.selectedModified !== null) {
    const selectedModifiedWord = document.querySelector(`.modifier-word[data-position="${session.selectedModified}"]`);
    if (selectedModifiedWord) {
      // relativeまたはabsoluteのpositionに設定
      if (getComputedStyle(selectedModifiedWord).position === 'static') {
        selectedModifiedWord.style.position = 'relative';
      }
      
      const label = document.createElement('div');
      label.className = 'word-label modified-label';
      label.textContent = '修飾される語';
      label.style.cssText = `
        display: block !important;
        position: absolute;
        left: 100%;
        top: 50%;
        transform: translateY(-50%);
        font-size: 14px;
        font-weight: bold;
        white-space: nowrap;
        z-index: 100;
        margin-left: 8px;
        color: #4CAF50;
        opacity: 1;
        writing-mode: horizontal-tb;
        text-orientation: mixed;
      `;
      selectedModifiedWord.appendChild(label);
    }
  }
}

// 修飾語問題の答え合わせ
function checkModifierAnswer() {
  const session = currentModifierSession;
  const problem = session.problems[session.currentIndex];
  
  if (session.selectedModified === null) {
    alert('修飾先となる語を選択してください。');
    return;
  }
  
  session.isChecked = true;
  
  const isCorrect = session.selectedModified === problem.correct_modified;
  
  if (isCorrect) {
    session.score++;
    
    // 大きな緑の〇を表示
    showBigGreenCircle();
  } else {
    // アニメーションなし
  }
  
  // 単語に正解・不正解の色をつける
  document.querySelectorAll('.modifier-word').forEach(word => {
    const position = parseInt(word.dataset.position);
    word.classList.add('disabled');
    
    if (position === problem.correct_modified) {
      word.classList.add('correct-modified');
      word.classList.remove('selected-modified', 'incorrect-modified');
    } else if (position === session.selectedModified && !isCorrect) {
      word.classList.add('incorrect-modified');
      // 間違えた修飾される語を赤くして×ラベルを追加
      word.style.background = '#f44336';
      word.style.color = 'white';
      word.style.borderColor = '#d32f2f';
      addIncorrectLabel(word);
    }
  });
  
  // 答え合わせ後のラベルを更新
  updateModifierLabelsAfterCheck(problem);
  
  // フィードバック表示
  const feedbackDiv = document.getElementById('modifierFeedback');
  feedbackDiv.style.display = 'block';
  feedbackDiv.style.opacity = '1';
  
  if (isCorrect) {
    feedbackDiv.style.background = '#e0f2f1';
    feedbackDiv.style.color = '#00695c';
    feedbackDiv.style.border = '1px solid #4db6ac';
    feedbackDiv.innerHTML = `
      <div style="font-weight:bold;margin-bottom:8px;">🎉 正解！</div>
      <div>${problem.explanation}</div>
    `;
  } else {
    feedbackDiv.style.background = '#fce4ec';
    feedbackDiv.style.color = '#880e4f';
    feedbackDiv.style.border = '1px solid #f06292';
    feedbackDiv.innerHTML = `
      <div style="font-weight:bold;margin-bottom:8px;">❌ 不正解</div>
      <div>${problem.explanation}</div>
    `;
  }
  
  // 解答ボタンとリセットボタンを非表示
  document.getElementById('modifierCheckBtn').style.display = 'none';
  document.getElementById('modifierResetBtn').style.display = 'none';
  
  // ボタンの表示制御（正解・不正解で分ける）
  if (isCorrect) {
    // 正解の場合は次の問題へ
    if (session.currentIndex < session.problems.length - 1) {
      document.getElementById('modifierNextBtn').style.display = 'inline-block';
    } else {
      document.getElementById('modifierFinishBtn').style.display = 'inline-block';
    }
  } else {
    // 不正解の場合は解きなおし
    // 解きなおしボタンを動的に作成
    const resetBtn = document.createElement('button');
    resetBtn.textContent = '解きなおす';
    resetBtn.className = 'grammar-next-btn';
    resetBtn.style.background = '#ff9800';
    resetBtn.onclick = () => resetModifierProblem();
    
    // フィードバックエリアにボタンを追加
    const feedbackDiv = document.getElementById('modifierFeedback');
    feedbackDiv.appendChild(resetBtn);
  }
}

// 答え合わせ後の修飾語ラベルを更新
function updateModifierLabelsAfterCheck(problem) {
  // 既存のラベルをすべて削除
  document.querySelectorAll('.word-label').forEach(label => {
    label.remove();
  });
  
  // 修飾語ラベルの追加（マークされた修飾語に）
  const markedModifiers = document.querySelectorAll('.modifier-word.marked-modifier');
  markedModifiers.forEach(modifierWord => {
    // relativeまたはabsoluteのpositionに設定
    if (getComputedStyle(modifierWord).position === 'static') {
      modifierWord.style.position = 'relative';
    }
    
    const label = document.createElement('div');
    label.className = 'word-label modifier-label';
    label.textContent = '修飾語';
    label.style.cssText = `
      display: block !important;
      position: absolute;
      left: 100%;
      top: 50%;
      transform: translateY(-50%);
      font-size: 14px;
      font-weight: bold;
      white-space: nowrap;
      z-index: 100;
      margin-left: 8px;
      color: #4CAF50;
      opacity: 1;
      writing-mode: horizontal-tb;
      text-orientation: mixed;
    `;
    modifierWord.appendChild(label);
  });
  
  // 正解の修飾される語ラベルの追加
  const correctModifiedWord = document.querySelector(`.modifier-word[data-position="${problem.correct_modified}"]`);
  if (correctModifiedWord) {
    // relativeまたはabsoluteのpositionに設定
    if (getComputedStyle(correctModifiedWord).position === 'static') {
      correctModifiedWord.style.position = 'relative';
    }
    
    const label = document.createElement('div');
    label.className = 'word-label modified-label';
    label.textContent = '修飾される語';
    label.style.cssText = `
      display: block !important;
      position: absolute;
      left: 100%;
      top: 50%;
      transform: translateY(-50%);
      font-size: 14px;
      font-weight: bold;
      white-space: nowrap;
      z-index: 100;
      margin-left: 8px;
      color: #4CAF50;
      opacity: 1;
      writing-mode: horizontal-tb;
      text-orientation: mixed;
    `;
    correctModifiedWord.appendChild(label);
  }
}

// 修飾語問題をリセット
function resetModifierProblem() {
  const session = currentModifierSession;
  
  session.selectedModified = null;
  session.isChecked = false;
  
  // 単語の表示をリセット
  document.querySelectorAll('.modifier-word').forEach(word => {
    word.classList.remove('selected-modified', 'correct-modified', 'incorrect-modified', 'disabled');
    // 既存の×ラベルも削除
    const existingLabel = word.querySelector('.incorrect-label');
    if (existingLabel) {
      existingLabel.remove();
    }
    // スタイルもリセット
    word.style.background = '';
    word.style.color = '';
    word.style.borderColor = '';
  });
  
  // 修飾される語のラベルを削除（修飾語ラベルは残す）
  document.querySelectorAll('.modified-label').forEach(label => {
    label.remove();
  });
  
  // フィードバックとヒントを非表示
  document.getElementById('modifierFeedback').style.display = 'none';
  document.getElementById('modifierNextBtn').style.display = 'none';
  document.getElementById('modifierFinishBtn').style.display = 'none';
  
  // 解答ボタンとリセットボタンを再表示
  document.getElementById('modifierCheckBtn').style.display = 'inline-block';
  document.getElementById('modifierResetBtn').style.display = 'inline-block';
}

// 次の修飾語問題へ
function goToNextModifierProblem() {
  const session = currentModifierSession;
  
  if (session.currentIndex < session.problems.length - 1) {
    session.currentIndex++;
    
    const contentContainer = document.getElementById('modifierProblemContent');
    transitionToNextProblem(contentContainer, () => {
      displayCurrentModifierProblem();
    });
  }
}

// 修飾語問題の結果表示
function showModifierResult() {
  const session = currentModifierSession;
  
  // 紙吹雪演出を表示
  showConfettiCelebration();
  
  // 4秒後にメニューに戻る
  setTimeout(() => {
    showBox(grammarTrainingBox);
    renderGrammarMenu();
  }, 4000);
}

// 修飾語問題のボタンイベントを設定
function setupModifierButtons() {
  // 戻るボタン
  document.getElementById('modifierBackBtn').onclick = () => {
    showBox(grammarTrainingBox);
    renderGrammarMenu();
  };
  
  // ホームボタン
  document.getElementById('modifierHomeBtn').onclick = () => showBox(homeBox);
  
  // 答え確認ボタン
  document.getElementById('modifierCheckBtn').onclick = checkModifierAnswer;
  
  // リセットボタン
  document.getElementById('modifierResetBtn').onclick = resetModifierProblem;
  
  // 次の問題ボタン
  document.getElementById('modifierNextBtn').onclick = goToNextModifierProblem;
  
  // 結果表示ボタン
  document.getElementById('modifierFinishBtn').onclick = showModifierResult;
}

// 文の構造問題を初期化
async function initSentenceStructureProblem(levelId = null) {
  // ローディング表示
  const gameDiv = document.getElementById('sentenceStructureProblemContent');
          gameDiv.innerHTML = '<div style="text-align:center;padding:40px;"><div style="font-size:18px;color:#16a34a;">文の構造問題を読み込んでいます...</div></div>';
  
  // 問題データを読み込み
  const loaded = await loadSentenceStructureProblems();
  
  if (sentenceStructureProblems.length === 0) {
    gameDiv.innerHTML = '<div style="text-align:center;padding:40px;color:#f44336;">文の構造問題が見つかりません。</div>';
    return;
  }
  
  // レベル別に問題をフィルタリング
  let filteredProblems = sentenceStructureProblems;
  if (levelId) {
    let targetLevel = '';
    if (levelId.includes('intro')) {
      targetLevel = 'intro';
    } else if (levelId.includes('basic')) {
      targetLevel = 'basic';
    } else if (levelId.includes('advanced')) {
      targetLevel = 'advanced';
    } else if (levelId.includes('expert')) {
      targetLevel = 'expert';
    } else if (levelId.includes('exam')) {
      targetLevel = 'exam';
    }
    
    if (targetLevel) {
      filteredProblems = sentenceStructureProblems.filter(problem => problem.level === targetLevel);
    }
  }
  
  if (filteredProblems.length === 0) {
    gameDiv.innerHTML = '<div style="text-align:center;padding:40px;color:#f44336;">このレベルの問題が見つかりません。</div>';
    return;
  }
  
  // 元のHTML構造を復元
  restoreSentenceStructureGameHTML();
  
  currentSentenceStructureSession = {
    problems: filteredProblems,
    currentIndex: 0,
    placement: {},
    score: 0,
    isChecked: false,
    levelId: levelId || 'intro'
  };
  
  // 最初の問題を表示
  displayCurrentSentenceStructureProblem();
  
  // ボタンイベントを設定
  setupSentenceStructureButtons();
}

// 文の構造ゲームのHTML構造を復元
function restoreSentenceStructureGameHTML() {
  const gameDiv = document.getElementById('sentenceStructureProblemContent');
  gameDiv.innerHTML = `
    <!-- 問題ヘッダー -->
    <div class="problem-header" style="margin-bottom:16px;">
      <div class="problem-header-title">問題</div>
      <div class="problem-header-progress" id="sentenceStructureProblemProgress">
        <div style="margin-bottom: 8px;">1/10</div>
        <div style="width: 200px; height: 10px; background: #e0e0e0; border-radius: 5px; margin: 0 auto; position: relative; overflow: hidden;">
          <div style="width: 10%; height: 100%; background: #87CEEB; border-radius: 5px; transition: width 0.3s ease;">
          </div>
        </div>
      </div>
    </div>
    
    <div style="font-size:14px;color:#666;margin-bottom:20px;text-align:center;">
      次の文を文節に分けて、下の図に当てはめなさい。<br>
      太い枠には主語と述語を、その他の枠には修飾語を入れなさい。
    </div>
    
    <div id="sentenceStructureSentence" style="font-size:22px;margin-bottom:30px;text-align:center;padding:16px;background:#f8f9fa;border-radius:8px;line-height:1.8;">
      <!-- 文章がここに表示されます -->
    </div>
    
    <div id="sentenceStructureDiagram" style="width:100%;max-width:800px;margin:0 auto;padding:20px;">
      <!-- 図解がここに表示されます -->
    </div>
    
    <div id="sentenceStructureFeedback" style="margin:24px 0;font-size:16px;padding:16px;border-radius:8px;display:none;">
      <!-- フィードバックがここに表示されます -->
    </div>
    
    <div class="sentence-structure-controls" style="text-align:center;margin-bottom:20px;">
      <button id="sentenceStructureCheckBtn" style="background:#20B2AA;color:white;border:none;padding:10px 20px;border-radius:8px;font-size:14px;cursor:pointer;margin-right:10px;">解答する</button>
      <button id="sentenceStructureResetBtn" style="background:#495057;color:white;border:none;padding:10px 20px;border-radius:8px;font-size:14px;cursor:pointer;">リセット</button>
    </div>
    
    <div class="grammar-controls" style="text-align:center;">
      <button id="sentenceStructureNextBtn" class="grammar-next-btn" style="display:none;">次の問題へ</button>
      <button id="sentenceStructureFinishBtn" class="grammar-finish-btn" style="display:none;">結果を見る</button>
    </div>
  `;
}

// 現在の文の構造問題を表示
function displayCurrentSentenceStructureProblem() {
  const session = currentSentenceStructureSession;
  const problem = session.problems[session.currentIndex];
  
  // 進捗を更新
  updateProblemProgress(session.currentIndex, session.problems.length, 'sentenceStructureProblemProgress');
  
  // 選択状態をリセット
  session.placement = {};
  session.isChecked = false;
  
  // 文章を表示
  document.getElementById('sentenceStructureSentence').textContent = problem.sentence;
  
  // 文節と図を表示
  displaySentenceStructureDiagram(problem);
  
  // フィードバックとボタンを非表示
  document.getElementById('sentenceStructureFeedback').style.display = 'none';
  document.getElementById('sentenceStructureNextBtn').style.display = 'none';
  document.getElementById('sentenceStructureFinishBtn').style.display = 'none';
  
  // 解答するボタンとリセットボタンを表示
  document.getElementById('sentenceStructureCheckBtn').style.display = 'inline-block';
  document.getElementById('sentenceStructureResetBtn').style.display = 'inline-block';
}

// 文の構造図を表示
function displaySentenceStructureDiagram(problem) {
  const diagramDiv = document.getElementById('sentenceStructureDiagram');
  
  // 文節アイテムを表示
  const bunsetsuHTML = `
    <div class="bunsetsu-container">
      ${problem.bunsetsu.map((text, index) => 
        `<div class="bunsetsu-item" draggable="true" data-text="${text}" data-index="${index}">${text}</div>`
      ).join('')}
    </div>
  `;
  
  // 構造図を作成
  let diagramHTML = '';
  
  if (problem.structure.type === 'simple') {
    // シンプルな構造の場合
    diagramHTML = `
      <div class="sentence-structure-diagram">
        <div class="sentence-structure-row">
          <div class="structure-box modifier-box" data-role="modifier1"></div>
          <span class="structure-arrow">→</span>
          <div class="structure-box main-box" data-role="subject"></div>
        </div>
        <div class="sentence-structure-row">
          <div class="structure-box modifier-box" data-role="modifier2"></div>
          <span class="structure-arrow">→</span>
          <div class="structure-box main-box" data-role="predicate"></div>
        </div>
      </div>
    `;
  } else if (problem.structure.type === 'complex') {
    // 複雑な構造の場合
    diagramHTML = `
      <div class="sentence-structure-diagram">
        <div class="sentence-structure-row">
          <div class="structure-box modifier-box" data-role="modifier1"></div>
          <div class="structure-box modifier-box" data-role="modifier2"></div>
          <span class="structure-arrow">→</span>
          <div class="structure-box main-box" data-role="subject"></div>
        </div>
        <div class="sentence-structure-row">
          <div class="structure-box modifier-box" data-role="modifier3"></div>
          <div class="structure-box modifier-box" data-role="modifier4"></div>
          <span class="structure-arrow">→</span>
          <div class="structure-box main-box" data-role="predicate"></div>
        </div>
      </div>
    `;
  }
  
  diagramDiv.innerHTML = bunsetsuHTML + diagramHTML;
  
  // ドラッグ&ドロップイベントを設定
  setupDragAndDrop();
}

// ドラッグ&ドロップの設定
function setupDragAndDrop() {
  const bunsetsuItems = document.querySelectorAll('.bunsetsu-item');
  const structureBoxes = document.querySelectorAll('.structure-box');
  
  // ドラッグ開始
  bunsetsuItems.forEach(item => {
    item.addEventListener('dragstart', (e) => {
      e.dataTransfer.setData('text', e.target.dataset.text);
      e.target.classList.add('dragging');
    });
    
    item.addEventListener('dragend', (e) => {
      e.target.classList.remove('dragging');
    });
  });
  
  // ドロップゾーン
  structureBoxes.forEach(box => {
    box.addEventListener('dragover', (e) => {
      e.preventDefault();
      box.classList.add('drag-over');
    });
    
    box.addEventListener('dragleave', () => {
      box.classList.remove('drag-over');
    });
    
    box.addEventListener('drop', (e) => {
      e.preventDefault();
      box.classList.remove('drag-over');
      
      const text = e.dataTransfer.getData('text');
      const role = box.dataset.role;
      
      // 既に配置されている場合は入れ替え
      if (box.textContent) {
        const oldText = box.textContent;
        // 元の場所に戻す
        const oldItem = document.querySelector(`.bunsetsu-item[data-text="${oldText}"]`);
        if (oldItem) {
          oldItem.style.display = 'inline-block';
        }
      }
      
      // 新しいテキストを配置
      box.textContent = text;
      box.classList.add('filled');
      
      // 配置情報を保存
      currentSentenceStructureSession.placement[role] = text;
      
      // 元の文節アイテムを非表示
      const draggedItem = document.querySelector(`.bunsetsu-item[data-text="${text}"]`);
      if (draggedItem) {
        draggedItem.style.display = 'none';
      }
    });
    
    // クリックで削除
    box.addEventListener('click', () => {
      if (box.textContent && !currentSentenceStructureSession.isChecked) {
        const text = box.textContent;
        const role = box.dataset.role;
        
        // 配置を削除
        delete currentSentenceStructureSession.placement[role];
        box.textContent = '';
        box.classList.remove('filled');
        
        // 元の文節アイテムを表示
        const item = document.querySelector(`.bunsetsu-item[data-text="${text}"]`);
        if (item) {
          item.style.display = 'inline-block';
        }
      }
    });
  });
}

// 文の構造問題の答え合わせ
function checkSentenceStructureAnswer() {
  const session = currentSentenceStructureSession;
  const problem = session.problems[session.currentIndex];
  
  // すべての枠が埋まっているか確認
  const boxes = document.querySelectorAll('.structure-box');
  let allFilled = true;
  boxes.forEach(box => {
    if (!box.textContent) {
      allFilled = false;
    }
  });
  
  if (!allFilled) {
    alert('すべての枠に文節を入れてください。');
    return;
  }
  
  session.isChecked = true;
  
  // 答え合わせ
  let correctCount = 0;
  const totalBoxes = Object.keys(problem.correct_placement).length;
  
  boxes.forEach(box => {
    const role = box.dataset.role;
    const userAnswer = box.textContent;
    const correctAnswer = problem.correct_placement[role];
    
    if (userAnswer === correctAnswer) {
      box.classList.add('correct');
      correctCount++;
    } else {
      box.classList.add('incorrect');
    }
  });
  
  const isCorrect = correctCount === totalBoxes;
  
  if (isCorrect) {
    session.score++;
    showBigGreenCircle();
  }
  
  // フィードバック表示
  const feedbackDiv = document.getElementById('sentenceStructureFeedback');
  feedbackDiv.style.display = 'block';
  feedbackDiv.style.opacity = '1';
  
  if (isCorrect) {
    feedbackDiv.style.background = '#e0f2f1';
    feedbackDiv.style.color = '#00695c';
    feedbackDiv.style.border = '1px solid #4db6ac';
    feedbackDiv.innerHTML = `
      <div style="font-weight:bold;margin-bottom:8px;">🎉 正解！</div>
      <div>${problem.explanation}</div>
    `;
  } else {
    feedbackDiv.style.background = '#fce4ec';
    feedbackDiv.style.color = '#880e4f';
    feedbackDiv.style.border = '1px solid #f06292';
    feedbackDiv.innerHTML = `
      <div style="font-weight:bold;margin-bottom:8px;">❌ 不正解</div>
      <div>${problem.explanation}</div>
      <div style="margin-top:8px;">正解は：主語「${problem.correct_placement.subject}」、述語「${problem.correct_placement.predicate}」</div>
    `;
  }
  
  // ボタンの表示制御
  document.getElementById('sentenceStructureCheckBtn').style.display = 'none';
  document.getElementById('sentenceStructureResetBtn').style.display = 'none';
  
  if (session.currentIndex < session.problems.length - 1) {
    document.getElementById('sentenceStructureNextBtn').style.display = 'inline-block';
  } else {
    document.getElementById('sentenceStructureFinishBtn').style.display = 'inline-block';
  }
}

// 文の構造問題をリセット
function resetSentenceStructureProblem() {
  displayCurrentSentenceStructureProblem();
}

// 次の文の構造問題へ
function goToNextSentenceStructureProblem() {
  const session = currentSentenceStructureSession;
  
  if (session.currentIndex < session.problems.length - 1) {
    session.currentIndex++;
    
    const contentContainer = document.getElementById('sentenceStructureProblemContent');
    transitionToNextProblem(contentContainer, () => {
      displayCurrentSentenceStructureProblem();
    });
  }
}

// 文の構造問題の結果表示
function showSentenceStructureResult() {
  const session = currentSentenceStructureSession;
  
  // 紙吹雪演出を表示
  showConfettiCelebration();
  
  // 4秒後にメニューに戻る
  setTimeout(() => {
    showBox(grammarTrainingBox);
    renderGrammarMenu();
  }, 4000);
}

// 文の構造問題のボタンイベントを設定
function setupSentenceStructureButtons() {
  // 戻るボタン
  document.getElementById('sentenceStructureBackBtn').onclick = () => {
    showBox(grammarTrainingBox);
    renderGrammarMenu();
  };
  
  // ホームボタン
  document.getElementById('sentenceStructureHomeBtn').onclick = () => showBox(homeBox);
  
  // 答え確認ボタン
  document.getElementById('sentenceStructureCheckBtn').onclick = checkSentenceStructureAnswer;
  
  // リセットボタン
  document.getElementById('sentenceStructureResetBtn').onclick = resetSentenceStructureProblem;
  
  // 次の問題ボタン
  document.getElementById('sentenceStructureNextBtn').onclick = goToNextSentenceStructureProblem;
  
  // 結果表示ボタン
  document.getElementById('sentenceStructureFinishBtn').onclick = showSentenceStructureResult;
}

// 現在の助詞問題を表示
function displayCurrentParticlesProblem() {
  const session = currentParticlesSession;
  const problem = session.problems[session.currentIndex];
  
  // 進捗を更新
  updateProblemProgress(session.currentIndex, session.problems.length, 'particlesProblemProgress');
  
  // ユーザーの回答をリセット
  session.userAnswers = {};
  
  // 文章を表示（（　）をドロップゾーンに変換）
  displaySentenceWithBlanks(problem);
  
  // 助詞カードを生成
  generateParticleCards(problem.cards);
  
  // フィードバックとボタンを非表示
  const feedbackDiv = document.getElementById('particlesFeedback');
  feedbackDiv.style.display = 'none';
  feedbackDiv.innerHTML = ''; // フィードバックエリアの内容をクリア
  document.getElementById('particlesNextBtn').style.display = 'none';
  document.getElementById('particlesFinishBtn').style.display = 'none';
  
  // 解答するボタンとリセットボタンを表示
  document.getElementById('particlesCheckBtn').style.display = 'inline-block';
  document.getElementById('particlesResetBtn').style.display = 'inline-block';
  document.getElementById('particlesResetBtn').textContent = 'リセット';
  document.getElementById('particlesResetBtn').style.background = '#495057';
}

// 文章を（　）をドロップゾーンに変換して表示
function displaySentenceWithBlanks(problem) {
  const sentenceDiv = document.getElementById('particlesSentence');
  let html = problem.sentence;
  
  // （　）をドロップゾーンに置き換え
  let blankIndex = 0;
  html = html.replace(/（　）/g, () => {
    blankIndex++;
    
    // 対応する正解の助詞の文字数を確認
    const correctParticle = problem.blanks.find(blank => blank.position === blankIndex)?.correct || '';
    const isMultiChar = correctParticle.length >= 2;
    
    return `<span class="particle-blank${isMultiChar ? ' multi-char' : ''}" data-position="${blankIndex}"></span>`;
  });
  
  // 長い文章の場合、適切な位置で改行を挿入
  html = insertLineBreaksForParticles(html);
  
  sentenceDiv.innerHTML = html;
  
  // ドロップゾーンのイベントリスナーを設定
  const blanks = sentenceDiv.querySelectorAll('.particle-blank');
  blanks.forEach(blank => {
    blank.addEventListener('dragover', handleParticleDragOver);
    blank.addEventListener('dragleave', handleParticleDragLeave);
    blank.addEventListener('drop', handleParticleDrop);
  });
}

// 助詞問題用の改行挿入関数
function insertLineBreaksForParticles(html) {
  // HTML要素を考慮してテキスト長を計算
  const tempDiv = document.createElement('div');
  tempDiv.innerHTML = html;
  const textContent = tempDiv.textContent || tempDiv.innerText || '';
  
  // 文章が20文字未満の場合はそのまま返す
  if (textContent.length < 20) {
    return html;
  }
  
  let result = html;
  
  // 文章の約半分の位置で改行を挿入（適切な区切り位置を探す）
  const halfLength = Math.floor(textContent.length / 2);
  let insertPosition = -1;
  
  // 助詞の空欄の後で改行する場合
  const blankMatches = [...html.matchAll(/<span class="particle-blank"[^>]*><\/span>/g)];
  if (blankMatches.length > 1) {
    // 真ん中付近の空欄の後に改行を挿入
    const middleBlankIndex = Math.floor(blankMatches.length / 2);
    const middleBlank = blankMatches[middleBlankIndex];
    const afterBlankIndex = middleBlank.index + middleBlank[0].length;
    result = result.slice(0, afterBlankIndex) + '<br>' + result.slice(afterBlankIndex);
  }
  
  return result;
}

// 助詞カードを生成
function generateParticleCards(cards) {
  const cardsContainer = document.getElementById('particlesCards');
  cardsContainer.innerHTML = '';
  
  // カードをシャッフル
  const shuffledCards = [...cards].sort(() => Math.random() - 0.5);
  
  shuffledCards.forEach(particle => {
    const card = document.createElement('div');
    card.className = 'particle-card';
    
    // 二文字・三文字の助詞の場合はマルチ文字クラスを追加
    if (particle.length >= 2) {
      card.classList.add('multi-char');
    }
    
    card.textContent = particle;
    card.draggable = true;
    card.dataset.particle = particle;
    
    // ドラッグイベントリスナーを追加
    card.addEventListener('dragstart', handleParticleCardDragStart);
    card.addEventListener('dragend', handleParticleCardDragEnd);
    
    cardsContainer.appendChild(card);
  });
}

// 助詞カードのドラッグ開始
function handleParticleCardDragStart(e) {
  e.dataTransfer.setData('text/plain', e.target.dataset.particle);
  e.target.classList.add('dragging');
}

// 助詞カードのドラッグ終了
function handleParticleCardDragEnd(e) {
  e.target.classList.remove('dragging');
}

// ドロップゾーンのドラッグオーバー
function handleParticleDragOver(e) {
  e.preventDefault();
  e.currentTarget.classList.add('drag-over');
}

// ドロップゾーンのドラッグリーブ
function handleParticleDragLeave(e) {
  e.currentTarget.classList.remove('drag-over');
}

// ドロップゾーンのドロップ
function handleParticleDrop(e) {
  e.preventDefault();
  e.currentTarget.classList.remove('drag-over');
  
  const particle = e.dataTransfer.getData('text/plain');
  const dropZone = e.currentTarget;
  const position = parseInt(dropZone.dataset.position);
  
  // 既にカードが配置されている場合は戻す
  if (dropZone.children.length > 0) {
    const existingCard = dropZone.children[0];
    returnCardToArea(existingCard.dataset.particle);
    dropZone.removeChild(existingCard);
  }
  
  // 新しいカードを作成してドロップゾーンに配置
  const newCard = document.createElement('div');
  newCard.className = 'particle-card';
  
  // 二文字・三文字の助詞の場合はマルチ文字クラスを追加
  if (particle.length >= 2) {
    newCard.classList.add('multi-char');
  }
  
  newCard.textContent = particle;
  newCard.dataset.particle = particle;
  newCard.draggable = true;
  
  // ドラッグイベントを追加
  newCard.addEventListener('dragstart', handleParticleCardDragStart);
  newCard.addEventListener('dragend', handleParticleCardDragEnd);
  
  dropZone.appendChild(newCard);
  
  // 元のカードを削除
  const originalCard = document.querySelector(`#particlesCards .particle-card[data-particle="${particle}"]`);
  if (originalCard) {
    originalCard.remove();
  }
  
  // ユーザーの回答を記録
  currentParticlesSession.userAnswers[position] = particle;
}

// カードをカードエリアに戻す
function returnCardToArea(particle) {
  const cardsContainer = document.getElementById('particlesCards');
  
  // 既にカードエリアに同じカードがあるかチェック
  const existingCard = cardsContainer.querySelector(`[data-particle="${particle}"]`);
  if (existingCard) return;
  
  const card = document.createElement('div');
  card.className = 'particle-card';
  
  // 二文字・三文字の助詞の場合はマルチ文字クラスを追加
  if (particle.length >= 2) {
    card.classList.add('multi-char');
  }
  
  card.textContent = particle;
  card.draggable = true;
  card.dataset.particle = particle;
  
  card.addEventListener('dragstart', handleParticleCardDragStart);
  card.addEventListener('dragend', handleParticleCardDragEnd);
  
  cardsContainer.appendChild(card);
}

// 助詞問題の答え合わせ
function checkParticlesAnswer() {
  const session = currentParticlesSession;
  const problem = session.problems[session.currentIndex];
  
  console.log('checkParticlesAnswer called');
  console.log('ユーザーの回答:', session.userAnswers);
  console.log('問題データ:', problem);
  
  let correctCount = 0;
  let totalCount = problem.blanks.length;
  
  // 各空欄をチェック
  problem.blanks.forEach(blank => {
    const userAnswer = session.userAnswers[blank.position];
    console.log(`空欄${blank.position}: ユーザー回答="${userAnswer}", 正解="${blank.correct}"`);
    if (userAnswer === blank.correct) {
      correctCount++;
    }
  });
  
  const isCorrect = correctCount === totalCount;
  console.log(`判定結果: ${correctCount}/${totalCount} 正解, isCorrect=${isCorrect}`);
  
  if (isCorrect) {
    session.score++;
    
    // 爽快なアニメーションを表示
    showSuccessAnimation('正解です！');
  } else {
    // アニメーションなし
  }
  
  // フィードバックを表示
  const feedbackDiv = document.getElementById('particlesFeedback');
  if (!feedbackDiv) {
    console.error('particlesFeedbackエリアが見つかりません');
    return;
  }
  
  // フィードバックメッセージとボタンをまとめて生成
  let feedbackHTML = `
    <div style="color: ${isCorrect ? '#00695c' : '#880e4f'}; font-weight: bold; margin-bottom: 12px;">
      ${isCorrect ? '正解です！' : `${correctCount}/${totalCount} 問正解です。`}
    </div>
    <div style="color: #666; background: #f5f5f5; padding: 12px; border-radius: 8px;">
      ${problem.explanation}
    </div>
  `;
  
  // ボタンを追加
  if (isCorrect) {
    // 正解の場合
    if (session.currentIndex < session.problems.length - 1) {
      feedbackHTML += `
        <div style="text-align: center; margin-top: 16px;">
          <button onclick="goToNextParticlesProblem()" style="background: #17a2b8; color: white; border: none; border-radius: 25px; padding: 12px 32px; font-size: 16px; font-weight: bold; cursor: pointer;">
            次の問題へ
          </button>
        </div>
      `;
    } else {
      feedbackHTML += `
        <div style="text-align: center; margin-top: 16px;">
          <button onclick="showParticlesResult()" style="background: #17a2b8; color: white; border: none; border-radius: 25px; padding: 12px 32px; font-size: 16px; font-weight: bold; cursor: pointer;">
            結果を見る
          </button>
        </div>
      `;
    }
  } else {
    // 不正解の場合
    feedbackHTML += `
      <div style="text-align: center; margin-top: 16px;">
        <button onclick="resetParticlesProblem()" style="background: #ff9800; color: white; border: none; border-radius: 25px; padding: 12px 32px; font-size: 16px; font-weight: bold; cursor: pointer;">
          解きなおす
        </button>
      </div>
    `;
  }
  
  feedbackDiv.innerHTML = feedbackHTML;
  feedbackDiv.style.display = 'block';
  feedbackDiv.style.opacity = '1';
  feedbackDiv.style.backgroundColor = '#f5f5f5';
  feedbackDiv.style.border = '1px solid #ddd';
  console.log('フィードバックエリアを表示しました:', feedbackDiv);
  
  // 正解を表示
  showCorrectParticles(problem);
  
  // 解答ボタンとリセットボタンを非表示
  const checkBtn = document.getElementById('particlesCheckBtn');
  const resetBtn = document.getElementById('particlesResetBtn');
  
  if (checkBtn) {
    checkBtn.style.display = 'none';
  }
  
  if (resetBtn) {
    resetBtn.style.display = 'none';
  }
  
  // 次へボタンと結果ボタンも非表示（フィードバックエリア内に移動したため）
  const nextBtn = document.getElementById('particlesNextBtn');
  const finishBtn = document.getElementById('particlesFinishBtn');
  
  if (nextBtn) {
    nextBtn.style.display = 'none';
  }
  
  if (finishBtn) {
    finishBtn.style.display = 'none';
  }
}

// 正解の助詞を表示
function showCorrectParticles(problem) {
  const blanks = document.querySelectorAll('.particle-blank');
  
  problem.blanks.forEach(blank => {
    const blankElement = Array.from(blanks).find(b => 
      parseInt(b.dataset.position) === blank.position
    );
    
    if (blankElement && blankElement.children.length > 0) {
      const card = blankElement.children[0];
      const userAnswer = card.dataset.particle;
      
      // 正解か不正解かで色を変更
      if (userAnswer === blank.correct) {
        card.style.background = '#20B2AA';
        card.style.border = '3px solid #00695C';
        card.style.color = 'white';
        card.style.transform = 'scale(1.1)';
        card.style.zIndex = '10';
      } else {
        card.style.background = '#DC143C';
        card.style.border = '3px solid #B22222';
        card.style.color = 'white';
        card.style.transform = 'scale(1.1)';
        card.style.zIndex = '10';
        
        // 間違えた選択肢に×ラベルを追加
        addIncorrectLabel(card);
      }
    }
  });
}

// 次の助詞問題へ
function goToNextParticlesProblem() {
  const session = currentParticlesSession;
  if (session.currentIndex < session.problems.length - 1) {
    session.currentIndex++;
    
    const contentContainer = document.getElementById('particlesProblemContent');
    transitionToNextProblem(contentContainer, () => {
      // フィードバックエリアを確実にクリア
      const feedbackDiv = document.getElementById('particlesFeedback');
      if (feedbackDiv) {
        feedbackDiv.style.display = 'none';
        feedbackDiv.innerHTML = '';
        feedbackDiv.style.backgroundColor = '';
        feedbackDiv.style.border = '';
      }
      
      displayCurrentParticlesProblem();
      
      // ボタンイベントを再設定
      setupParticlesButtons();
    });
  }
}

// 助詞問題をリセット
function resetParticlesProblem() {
  // フィードバックエリアを完全にクリア
  const feedbackDiv = document.getElementById('particlesFeedback');
  if (feedbackDiv) {
    feedbackDiv.style.display = 'none';
    feedbackDiv.innerHTML = '';
  }
  
  displayCurrentParticlesProblem();
  
  // ボタンイベントを再設定
  setupParticlesButtons();
  
  // 解答ボタンとリセットボタンを明示的に再表示
  setTimeout(() => {
    const checkBtn = document.getElementById('particlesCheckBtn');
    const resetBtn = document.getElementById('particlesResetBtn');
    
    if (checkBtn) {
      checkBtn.style.display = 'inline-block';
    }
    if (resetBtn) {
      resetBtn.style.display = 'inline-block';
      resetBtn.textContent = 'リセット';
      resetBtn.style.background = '#495057';
    }
  }, 10); // わずかに遅延させてDOM更新を確実にする
}

// 助詞問題のヒントを表示


// 助詞問題の結果を表示
function showParticlesResult() {
  const session = currentParticlesSession;
  const percentage = Math.round((session.score / session.problems.length) * 100);
  
  let grade, comment;
  if (percentage >= 90) {
    grade = '優秀';
    comment = '素晴らしい助詞の理解力です！';
  } else if (percentage >= 70) {
    grade = '良好';
    comment = 'よく理解できています！';
  } else if (percentage >= 50) {
    grade = '普通';
    comment = 'もう少し練習しましょう。';
  } else {
    grade = '要復習';
    comment = '基礎から復習しましょう。';
  }
  
  // 結果画面に遷移
  showBox(grammarResultBox);
  
  // 結果を表示
  const resultContainer = document.getElementById('grammarResultContent');
  resultContainer.innerHTML = `
    <div style="font-size: 48px; margin: 20px 0; color: #FF9800;">${grade}</div>
    <div style="font-size: 24px; margin: 20px 0;">${session.score} / ${session.problems.length} 問正解</div>
    <div style="font-size: 20px; margin: 20px 0; color: #FF9800; font-weight: bold;">${percentage}%</div>
    <div style="font-size: 16px; margin: 20px 0; color: #666; padding: 16px; background: #fff3e0; border-radius: 8px;">
      ${comment}
    </div>
  `;
}

// 助詞問題ボタンイベントを設定
function setupParticlesButtons() {
  const particlesCheckBtn = document.getElementById('particlesCheckBtn');
const particlesResetBtn = document.getElementById('particlesResetBtn');
const particlesNextBtn = document.getElementById('particlesNextBtn');
const particlesFinishBtn = document.getElementById('particlesFinishBtn');

  if (particlesCheckBtn) {
    particlesCheckBtn.onclick = checkParticlesAnswer;
  }

  if (particlesResetBtn) {
    particlesResetBtn.onclick = resetParticlesProblem;
  }

  if (particlesNextBtn) {
    particlesNextBtn.onclick = goToNextParticlesProblem;
  }

  if (particlesFinishBtn) {
    particlesFinishBtn.onclick = showParticlesResult;
  }
}

// 文法トレーニング問題を初期化
function initGrammarProblem(itemId) {
  const problems = grammarProblems[itemId];
  if (!problems) {
    alert('この分野の問題は準備中です。');
    return;
  }
  
  currentGrammarSession = {
    category: itemId,
    problems: problems.problems,
    currentIndex: 0,
    score: 0,
    selectedAnswer: null
  };
  
  displayCurrentGrammarProblem();
}

// 現在の問題を表示
function displayCurrentGrammarProblem() {
  const session = currentGrammarSession;
  const problem = session.problems[session.currentIndex];
  
  // 進捗を更新
  document.getElementById('grammarProblemProgress').textContent = 
    `問題 ${session.currentIndex + 1} / ${session.problems.length}`;
  
  // 問題文を表示
  document.getElementById('grammarQuestion').textContent = problem.question;
  
  // 選択肢を生成
  const optionsContainer = document.getElementById('grammarOptions');
  optionsContainer.innerHTML = '';
  
  problem.options.forEach((option, index) => {
    const button = document.createElement('button');
    button.className = 'grammar-option-btn';
    button.textContent = `${index + 1}. ${option}`;
    button.onclick = () => selectGrammarAnswer(index);
    button.disabled = false; // ボタンを有効化
    optionsContainer.appendChild(button);
  });
  
  // フィードバックとボタンを非表示
  document.getElementById('grammarFeedback').style.display = 'none';
  document.getElementById('grammarNextBtn').style.display = 'none';
  document.getElementById('grammarFinishBtn').style.display = 'none';
  
  // 選択状態をリセット
  session.selectedAnswer = null;
}

// 回答を選択
function selectGrammarAnswer(answerIndex) {
  const session = currentGrammarSession;
  const problem = session.problems[session.currentIndex];
  
  if (session.selectedAnswer !== null) return; // 既に選択済み
  
  session.selectedAnswer = answerIndex;
  
  // 全ボタンを無効化
  const buttons = document.querySelectorAll('.grammar-option-btn');
  buttons.forEach(btn => btn.disabled = true);
  
  // 正解/不正解の判定
  const isCorrect = answerIndex === problem.correct;
  if (isCorrect) {
    session.score++;
    // 爽快なアニメーションを表示
    showSuccessAnimation('正解です！');
  }
  
  // 選択されたボタンのスタイルを変更
  buttons[answerIndex].classList.add(isCorrect ? 'correct' : 'incorrect');
  
  // 間違えた場合は選択肢を赤くして×ラベルを追加
  if (!isCorrect) {
    buttons[answerIndex].style.background = '#f44336';
    buttons[answerIndex].style.color = 'white';
    buttons[answerIndex].style.borderColor = '#d32f2f';
    addIncorrectLabel(buttons[answerIndex]);
    
    // 正解ボタンを緑色に
    buttons[problem.correct].classList.add('correct');
  }
  
  // フィードバックを表示
  const feedbackDiv = document.getElementById('grammarFeedback');
  feedbackDiv.innerHTML = `
    <div style="color: ${isCorrect ? '#00695c' : '#880e4f'}; font-weight: bold; margin-bottom: 12px;">
      ${isCorrect ? '正解です！' : '不正解です。'}
    </div>
    <div style="color: #666; background: #f5f5f5; padding: 12px; border-radius: 8px;">
      ${problem.explanation}
    </div>
  `;
  feedbackDiv.style.display = 'block';
  feedbackDiv.style.opacity = '1';
  
  // ボタンの表示制御（正解・不正解で分ける）
  if (isCorrect) {
    // 正解の場合は次の問題へ
    if (session.currentIndex < session.problems.length - 1) {
      document.getElementById('grammarNextBtn').style.display = 'inline-block';
    } else {
      document.getElementById('grammarFinishBtn').style.display = 'inline-block';
    }
  } else {
    // 不正解の場合は解きなおし
    // 解きなおしボタンを動的に作成
    const resetBtn = document.createElement('button');
    resetBtn.textContent = '解きなおす';
    resetBtn.className = 'grammar-next-btn';
    resetBtn.style.background = '#ff9800';
    resetBtn.onclick = () => displayCurrentGrammarProblem();
    
    // フィードバックエリアにボタンを追加
    const feedbackDiv = document.getElementById('grammarFeedback');
    feedbackDiv.appendChild(resetBtn);
  }
}

// 次の問題へ
function goToNextGrammarProblem() {
  const session = currentGrammarSession;
  if (session.currentIndex < session.problems.length - 1) {
    session.currentIndex++;
    
    const contentContainer = document.getElementById('grammarProblemContent');
    transitionToNextProblem(contentContainer, () => {
      displayCurrentGrammarProblem();
    });
  }
}

// 結果を表示
function showGrammarTrainingResult() {
  const session = currentGrammarSession;
  
  // 紙吹雪演出を表示
  showConfettiCelebration();
  
  // 4秒後にメニューに戻る
  setTimeout(() => {
    showBox(grammarTrainingBox);
    renderGrammarMenu();
  }, 4000);
}

// 文節分け問題を初期化
async function initClauseDivisionProblem() {
  // ローディング表示
  const gameDiv = document.getElementById('clauseProblemContent');
          gameDiv.innerHTML = '<div style="text-align:center;padding:40px;"><div style="font-size:18px;color:#16a34a;">文節分け問題を読み込んでいます...</div></div>';
  
  // 問題データを読み込み
  const loaded = await loadClauseDivisionProblems();
  
  if (clauseDivisionProblems.length === 0) {
    gameDiv.innerHTML = '<div style="text-align:center;padding:40px;color:#f44336;">文節分けの問題が見つかりません。</div>';
    return;
  }
  
  // 元のHTML構造を復元
  restoreClauseGameHTML();
  
  currentClauseSession = {
    problems: clauseDivisionProblems,
    currentIndex: 0,
    score: 0,
    userLines: [],
    canvas: document.getElementById('clauseCanvas'),
    ctx: null,
    isDrawing: false,
    lastX: 0,
    lastY: 0,
    currentStroke: []
  };
  
  // 高DPI対応のキャンバス設定
  setupHighDPICanvas(currentClauseSession.canvas);
  currentClauseSession.ctx = currentClauseSession.canvas.getContext('2d');
  
  // キャンバスイベントを設定
  setupCanvasEvents();
  
  // 最初の問題を表示
  displayCurrentClauseProblem();
}

// 文節分けゲームのHTML構造を復元
function restoreClauseGameHTML() {
  const gameDiv = document.getElementById('clauseProblemContent');
  gameDiv.innerHTML = `
    <!-- 問題ヘッダー -->
    <div class="problem-header" style="margin-bottom:16px;">
      <div class="problem-header-title">問題</div>
      <div class="problem-header-progress" id="clauseProblemProgress">
        <div style="margin-bottom: 8px;">1/10</div>
        <div style="width: 200px; height: 10px; background: #e0e0e0; border-radius: 5px; margin: 0 auto; position: relative; overflow: hidden;">
          <div style="width: 10%; height: 100%; background: #87CEEB; border-radius: 5px; transition: width 0.3s ease;">
          </div>
        </div>
      </div>
    </div>
    
    <div style="text-align:center;margin-bottom:16px;color:#666;font-size:14px;">
      マウスやタッチで文節の境目に、まっすぐ横線を描きなさい。
    </div>
    
    <div id="clauseCanvasContainer" style="display:flex;justify-content:center;margin-bottom:24px;">
      <canvas id="clauseCanvas" width="400" height="650" style="width:400px;height:650px;background:#ffffff;cursor:crosshair;"></canvas>
    </div>
    

    
    <div id="clauseFeedback" style="margin-bottom:24px;font-size:16px;padding:16px;border-radius:8px;display:none;">
      <!-- フィードバックがここに表示されます -->
    </div>
    
    <div class="clause-controls" style="text-align:center;margin-top:24px;">

      <button id="clauseCheckBtn" class="logic-check-btn">解答する</button>
      <button id="clauseResetBtn" class="logic-reset-btn">リセット</button>
      <button id="clauseNextBtn" class="grammar-next-btn" style="display:none;">次の問題へ</button>
      <button id="clauseFinishBtn" class="grammar-finish-btn" style="display:none;">結果を見る</button>
    </div>
  `;
  
  // ボタンイベントを再設定
  setupClauseButtons();
}

// 現在の文節分け問題を表示
function displayCurrentClauseProblem() {
  const session = currentClauseSession;
  const problem = session.problems[session.currentIndex];
  
  // 進捗を更新
  document.getElementById('clauseProblemProgress').textContent = 
    `${session.currentIndex + 1}/${session.problems.length}`;
  
  // ユーザーの線をリセット
  session.userLines = [];
  session.currentStroke = [];
  session.isDrawing = false;
  
  // キャンバスをクリア
  session.ctx.clearRect(0, 0, session.canvas.width, session.canvas.height);
  
  // CSSサイズを基準にした中央座標を計算
  const rect = session.canvas.getBoundingClientRect();
  const centerX = rect.width / 2;
  const startY = 30;
  
  // 縦書きで文章を描画
  drawVerticalText(session.ctx, problem.sentence, centerX, startY);
  
  // フィードバックとボタンを非表示
  document.getElementById('clauseFeedback').style.display = 'none';
  document.getElementById('clauseNextBtn').style.display = 'none';
  document.getElementById('clauseFinishBtn').style.display = 'none';
  
  // 解答するボタンとリセットボタンを表示
  document.getElementById('clauseCheckBtn').style.display = 'inline-block';
  document.getElementById('clauseResetBtn').style.display = 'inline-block';
}

// 高DPI対応のキャンバス設定
function setupHighDPICanvas(canvas) {
  const dpr = window.devicePixelRatio || 1;
  const rect = canvas.getBoundingClientRect();
  
  // CSSサイズを維持しながら、実際のピクセル数を増やす
  canvas.width = rect.width * dpr;
  canvas.height = rect.height * dpr;
  
  const ctx = canvas.getContext('2d');
  ctx.scale(dpr, dpr);
  
  // CSSサイズを設定
  canvas.style.width = rect.width + 'px';
  canvas.style.height = rect.height + 'px';
}

// 縦書きで文字を描画
function drawVerticalText(ctx, text, x, y) {
  ctx.font = '22px "UD Digi Kyokasho N-R", "UD デジタル 教科書体 N-R", "Klee", "HiraMinProN-W3", serif';
  ctx.fillStyle = '#2c3e50';
  ctx.textAlign = 'center';
  ctx.textBaseline = 'top';
  
  const lineHeight = 26;
  let currentY = y;
  
  for (let i = 0; i < text.length; i++) {
    const char = text[i];
    
    // 句点の場合は右下に配置
    if (char === '。' || char === '、') {
      ctx.save();
      ctx.textAlign = 'left';
      ctx.fillText(char, x + 8, currentY + 6); // 右下にオフセット
      ctx.restore();
    } else {
      ctx.fillText(char, x, currentY);
    }
    
    currentY += lineHeight;
  }
}

// キャンバスイベントを設定
function setupCanvasEvents() {
  const canvas = currentClauseSession.canvas;
  
  // マウスイベント
  canvas.addEventListener('mousedown', startDrawing);
  canvas.addEventListener('mousemove', draw);
  canvas.addEventListener('mouseup', stopDrawing);
  canvas.addEventListener('mouseout', stopDrawing);
  
  // タッチイベント
  canvas.addEventListener('touchstart', handleTouch);
  canvas.addEventListener('touchmove', handleTouch);
  canvas.addEventListener('touchend', stopDrawing);
}

// 描画開始
function startDrawing(e) {
  currentClauseSession.isDrawing = true;
  const rect = currentClauseSession.canvas.getBoundingClientRect();
  const x = e.clientX - rect.left;
  const y = e.clientY - rect.top;
  
  currentClauseSession.lastX = x;
  currentClauseSession.lastY = y;
  currentClauseSession.currentStroke = [{x, y}];
}

// 描画
function draw(e) {
  if (!currentClauseSession.isDrawing) return;
  
  const rect = currentClauseSession.canvas.getBoundingClientRect();
  const x = e.clientX - rect.left;
  const y = e.clientY - rect.top;
  
  // 前の位置から現在の位置まで線を描画
  const ctx = currentClauseSession.ctx;
  ctx.strokeStyle = '#FF6B35';
  ctx.lineWidth = 4;
  ctx.lineCap = 'round';
  ctx.lineJoin = 'round';
  
  ctx.beginPath();
  ctx.moveTo(currentClauseSession.lastX, currentClauseSession.lastY);
  ctx.lineTo(x, y);
  ctx.stroke();
  
  // 線の軌跡を記録
  currentClauseSession.currentStroke.push({x, y});
  
  currentClauseSession.lastX = x;
  currentClauseSession.lastY = y;
}

// 描画停止
function stopDrawing() {
  if (currentClauseSession.isDrawing && currentClauseSession.currentStroke.length > 0) {
    // 現在の線の軌跡を保存
    currentClauseSession.userLines.push([...currentClauseSession.currentStroke]);
    currentClauseSession.currentStroke = [];
  }
  currentClauseSession.isDrawing = false;
}

// タッチイベント処理
function handleTouch(e) {
  e.preventDefault();
  const touch = e.touches[0];
  const mouseEvent = new MouseEvent(e.type === 'touchstart' ? 'mousedown' : 
                                   e.type === 'touchmove' ? 'mousemove' : 'mouseup', {
    clientX: touch.clientX,
    clientY: touch.clientY
  });
  currentClauseSession.canvas.dispatchEvent(mouseEvent);
}

// 線が文節境界を横切っているかを判定
function checkLineIntersection(stroke, boundaryY, tolerance = 15) {
  const canvas = currentClauseSession.canvas;
  const rect = canvas.getBoundingClientRect();
  const textCenterX = rect.width / 2;
  const textLeftX = textCenterX - 60; // 文字エリアの左端（少し広めに）
  const textRightX = textCenterX + 60; // 文字エリアの右端（句点オフセット考慮）
  
  for (let i = 0; i < stroke.length - 1; i++) {
    const point1 = stroke[i];
    const point2 = stroke[i + 1];
    
    // 線分が文字エリア内を通っているかチェック
    const minX = Math.min(point1.x, point2.x);
    const maxX = Math.max(point1.x, point2.x);
    const minY = Math.min(point1.y, point2.y);
    const maxY = Math.max(point1.y, point2.y);
    
    // 線分が文字エリアと重なり、かつ境界位置を横切っているかチェック
    if (maxX >= textLeftX && minX <= textRightX && 
        minY <= boundaryY + tolerance && maxY >= boundaryY - tolerance) {
      return true;
    }
  }
  return false;
}

// 描いた線から文節境界を抽出（すべての可能な境界をチェック）
function extractAllBoundariesFromStrokes() {
  const session = currentClauseSession;
  const problem = session.problems[session.currentIndex];
  const sentence = problem.sentence;
  const foundBoundaries = [];
  
  // 文章のすべての文字境界をチェック（最初と最後は除く）
  for (let i = 1; i < sentence.length; i++) {
    const boundaryY = 30 + i * 26;
    
    // 各線について、この境界を横切っているかチェック
    for (const stroke of session.userLines) {
      if (checkLineIntersection(stroke, boundaryY)) {
        if (!foundBoundaries.includes(i)) {
          foundBoundaries.push(i);
        }
        break;
      }
    }
  }
  
  return foundBoundaries.sort((a, b) => a - b); // 昇順でソート
}

// 文節分けの答え合わせ
function checkClauseDivision() {
  const session = currentClauseSession;
  const problem = session.problems[session.currentIndex];
  const correctDivisions = problem.divisions;
  const foundBoundaries = extractAllBoundariesFromStrokes();
  
  // 正解判定：引いた線の境界が正解の境界と完全に一致するかチェック
  const isCorrect = foundBoundaries.length === correctDivisions.length && 
                   foundBoundaries.every(found => correctDivisions.includes(found)) &&
                   correctDivisions.every(correct => foundBoundaries.includes(correct));
  
  if (isCorrect) {
    session.score++;
    
    // 大きな緑の〇を表示
    showBigGreenCircle();
  } else {
    // アニメーションなし
  }
  
  // 正解の線を表示
  showCorrectLines(correctDivisions);
  
  // フィードバックを表示
  const feedbackDiv = document.getElementById('clauseFeedback');
  
  feedbackDiv.innerHTML = `
    <div style="color: ${isCorrect ? '#00695c' : '#880e4f'}; font-weight: bold; margin-bottom: 12px;">
      ${isCorrect ? '正解です！' : '不正解です。正しい文節分けを確認してください。'}
    </div>
    <div style="color: #666; background: #f5f5f5; padding: 12px; border-radius: 8px;">
      正解: ${problem.clauses.join(' / ')}
    </div>
  `;
  feedbackDiv.style.display = 'block';
  feedbackDiv.style.opacity = '1';
  
  // 解答ボタンとリセットボタンを非表示
  document.getElementById('clauseCheckBtn').style.display = 'none';
  document.getElementById('clauseResetBtn').style.display = 'none';
  
  // ボタンの表示制御（正解・不正解で分ける）
  if (isCorrect) {
    // 正解の場合は次の問題へ
    if (session.currentIndex < session.problems.length - 1) {
      document.getElementById('clauseNextBtn').style.display = 'inline-block';
    } else {
      document.getElementById('clauseFinishBtn').style.display = 'inline-block';
    }
  } else {
    // 不正解の場合は解きなおし
    // 解きなおしボタンを動的に作成
    const resetBtn = document.createElement('button');
    resetBtn.textContent = '解きなおす';
    resetBtn.className = 'grammar-next-btn';
    resetBtn.style.background = '#ff9800';
    resetBtn.onclick = () => resetClauseProblem();
    
    // フィードバックエリアにボタンを追加
    const feedbackDiv = document.getElementById('clauseFeedback');
    feedbackDiv.appendChild(resetBtn);
  }
}

// 正解の線を表示
function showCorrectLines(divisions) {
  const ctx = currentClauseSession.ctx;
  const canvas = currentClauseSession.canvas;
  const rect = canvas.getBoundingClientRect();
  const centerX = rect.width / 2;
  
  ctx.strokeStyle = '#20B2AA';
  ctx.lineWidth = 3;
  ctx.lineCap = 'round';
  
  for (const division of divisions) {
    const y = 30 + division * 26;
    ctx.beginPath();
    // 正解の線を短めに描画
    ctx.moveTo(centerX - 45, y);
    ctx.lineTo(centerX + 45, y);
    ctx.stroke();
  }
}

// 間違った線を表示
function showIncorrectLines(foundBoundaries, correctDivisions) {
  const ctx = currentClauseSession.ctx;
  const canvas = currentClauseSession.canvas;
  const rect = canvas.getBoundingClientRect();
  const centerX = rect.width / 2;
  
  // 間違った境界を抽出（正解に含まれない境界）
  const incorrectBoundaries = foundBoundaries.filter(found => !correctDivisions.includes(found));
  
  if (incorrectBoundaries.length > 0) {
    ctx.strokeStyle = '#f44336';
    ctx.lineWidth = 3;
    ctx.lineCap = 'round';
    
    for (const boundary of incorrectBoundaries) {
      const y = 30 + boundary * 26;
      ctx.beginPath();
      // 間違った線を短めに描画（正解の線と同じ長さ）
      ctx.moveTo(centerX - 45, y);
      ctx.lineTo(centerX + 45, y);
      ctx.stroke();
    }
  }
}

// 次の文節分け問題へ
function goToNextClauseProblem() {
  const session = currentClauseSession;
  if (session.currentIndex < session.problems.length - 1) {
    session.currentIndex++;
    
    const contentContainer = document.getElementById('clauseProblemContent');
    transitionToNextProblem(contentContainer, () => {
      displayCurrentClauseProblem();
    });
  }
}

// 文節分けの結果を表示
function showClauseDivisionResult() {
  const session = currentClauseSession;
  
  // 紙吹雪演出を表示
  showConfettiCelebration();
  
  // 4秒後にメニューに戻る
  setTimeout(() => {
    showBox(grammarTrainingBox);
    renderGrammarMenu();
  }, 4000);
}

// 文節分け問題をリセット
function resetClauseProblem() {
  displayCurrentClauseProblem();
  
  // 解答ボタンとリセットボタンを再表示
  document.getElementById('clauseCheckBtn').style.display = 'inline-block';
  document.getElementById('clauseResetBtn').style.display = 'inline-block';
}



// 文節分けボタンイベントを設定
function setupClauseButtons() {

  const clauseCheckBtn = document.getElementById('clauseCheckBtn');
  const clauseResetBtn = document.getElementById('clauseResetBtn');
  const clauseNextBtn = document.getElementById('clauseNextBtn');
  const clauseFinishBtn = document.getElementById('clauseFinishBtn');



  if (clauseCheckBtn) {
    clauseCheckBtn.onclick = checkClauseDivision;
  }

  if (clauseResetBtn) {
    clauseResetBtn.onclick = resetClauseProblem;
  }

  if (clauseNextBtn) {
    clauseNextBtn.onclick = goToNextClauseProblem;
  }

  if (clauseFinishBtn) {
    clauseFinishBtn.onclick = showClauseDivisionResult;
  }
}

// 画面切り替え（boxの管理に追加）
const shopBox = document.getElementById('shopBox');
const shopHomeBtn = document.getElementById('shopHomeBtn');
const openShopBtn = document.getElementById('openShopBtn');

// 漢字・語彙トレーニング用変数
let currentKanjiVocabSession = null;
let kanjiVocabProblems = {};

// 類義語トレーニング用変数
let synonymProblems = [];

// 対義語トレーニング用変数
let antonymProblems = [];

// ことわざトレーニング用変数
let kotowazaProblems = [];
let currentKotowazaSession = null;

// 漢字・語彙トレーニング用のBox要素は上部で定義済み

// box切り替え関数を利用
openShopBtn.onclick = () => {
  [homeBox, selectBox, readerBox, aiGenerateBox, readingTrainingBox, grammarTrainingBox, kanjiVocabTrainingBox, kanjiVocabProblemBox, kanjiVocabResultBox, logicTrainingBox, concreteAbstractBox, grammarProblemBox, grammarResultBox, particlesBox, clauseDivisionBox, clauseRearrangementBox, shopBox].forEach(b => b && b.classList.remove('show'));
  shopBox.classList.add('show');
  renderShopItems();
};

shopHomeBtn.onclick = () => {
  [homeBox, selectBox, readerBox, aiGenerateBox, readingTrainingBox, grammarTrainingBox, kanjiVocabTrainingBox, kanjiVocabProblemBox, kanjiVocabResultBox, logicTrainingBox, concreteAbstractBox, grammarProblemBox, grammarResultBox, particlesBox, clauseDivisionBox, clauseRearrangementBox, shopBox].forEach(b => b && b.classList.remove('show'));
  homeBox.classList.add('show');
};

aiGenType.onchange = function() {
  const genreSelect = aiGenGenre;
  const selectedType = this.value;
  
  // すべてのオプションを非表示
  Array.from(genreSelect.options).forEach(option => {
    if (option.value === '') return; // デフォルトの「ジャンルを選択」は常に表示
    option.style.display = 'none';
  });
  
  // 選択されたタイプに応じたジャンルを表示
  if (selectedType === '物語文') {
    Array.from(genreSelect.options).forEach(option => {
      if (option.classList.contains('fiction')) {
        option.style.display = '';
      }
    });
  } else if (selectedType === '説明文' || selectedType === '論説文') {
    Array.from(genreSelect.options).forEach(option => {
      if (option.classList.contains('non-fiction')) {
        option.style.display = '';
      }
    });
  }
  
  // ジャンルをリセット
  genreSelect.value = '';
};

// 初期化時にジャンルを非表示
document.addEventListener('DOMContentLoaded', () => {
  Array.from(aiGenGenre.options).forEach(option => {
    if (option.value !== '') {
      option.style.display = 'none';
    }
  });
});

// 穴埋め問題を表示する関数
function displayFillinQuestion(question) {
    const questionContainer = document.getElementById('question-container');
    questionContainer.innerHTML = '';

    const questionText = question.q;
    const answers = question.answer.split(',');
    
    // 問題文を分割して穴埋め部分を特定
    const parts = questionText.split('（　）');
    
    // 問題文を表示
    const questionElement = document.createElement('div');
    questionElement.className = 'question-text';
    
    // 各部分を表示し、穴埋め部分には入力フィールドを配置
    parts.forEach((part, index) => {
        questionElement.appendChild(document.createTextNode(part));
        if (index < parts.length - 1) {
            const input = document.createElement('input');
            input.type = 'text';
            input.className = 'fillin-input';
            input.dataset.answer = answers[index];
            questionElement.appendChild(input);
        }
    });
    
    questionContainer.appendChild(questionElement);

    // 回答ボタンを追加
    const checkButton = document.createElement('button');
    checkButton.textContent = '回答を確認';
    checkButton.onclick = () => checkFillinAnswer(answers);
    questionContainer.appendChild(checkButton);
}

// 穴埋め問題の回答をチェックする関数
function checkFillinAnswer(correctAnswers) {
    const inputs = document.getElementsByClassName('fillin-input');
    let allCorrect = true;
    
    Array.from(inputs).forEach((input, index) => {
        if (input.value.trim() === correctAnswers[index].trim()) {
            input.style.backgroundColor = '#90EE90'; // 正解は緑色
        } else {
            input.style.backgroundColor = '#FFB6C1'; // 不正解は赤色
            allCorrect = false;
        }
    });

    // 結果を表示
    const resultElement = document.createElement('div');
    resultElement.className = 'result-message';
    resultElement.textContent = allCorrect ? '正解です！' : '不正解です。もう一度挑戦してください。';
    document.getElementById('question-container').appendChild(resultElement);
}

// 問題を読み込む関数を修正
async function loadQuestion() {
    try {
        const response = await fetch('gongitsune_quiz.json');
        const questions = await response.json();
        
        // ランダムに問題を選択
        const randomIndex = Math.floor(Math.random() * questions.length);
        const question = questions[randomIndex];
        
        if (question.type === 'fillin') {
            displayFillinQuestion(question);
        }
    } catch (error) {
        console.error('問題の読み込みに失敗しました:', error);
    }
}

// ページ読み込み時に問題を表示
document.addEventListener('DOMContentLoaded', () => {
    loadQuestion();
});

/* --- オンスクリーンキーボード --- */
(() => {
  const overlay = document.createElement('div');
  overlay.id = 'keyboardOverlay';
  overlay.className = 'keyboard-overlay';
  overlay.style.display = 'none';
  overlay.innerHTML = '<div class="keyboard-box"></div>';
  document.body.appendChild(overlay);

  const kb = overlay.firstElementChild;
  const keys = ['あ','い','う','え','お','か','き','く','け','こ','さ','し','す','せ','そ','た','ち','つ','て','と','な','に','ぬ','ね','の','は','ひ','ふ','へ','ほ','ま','み','む','め','も','や','ゆ','よ','ら','り','る','れ','ろ','わ','を','ん','ー','←','閉じる'];
  keys.forEach(k => {
    const btn = document.createElement('button');
    btn.textContent = k;
    btn.dataset.key = k;
    if (k === '←' || k === '閉じる') btn.classList.add('control');
    kb.appendChild(btn);
  });

  let currentInput = null;
  document.addEventListener('focusin', e => {
    if (e.target.classList.contains('blankInput')) {
      currentInput = e.target;
      overlay.style.display = 'flex';
    }
  });

  overlay.addEventListener('click', e => {
    if (e.target.tagName !== 'BUTTON') return;
    const key = e.target.dataset.key;
    if (key === '閉じる') {
      overlay.style.display = 'none';
      currentInput = null;
      return;
    }
    if (!currentInput) return;
    if (key === '←') {
      currentInput.value = currentInput.value.slice(0, -1);
    } else {
      currentInput.value += key;
    }
  });
})();

// 漢字・語彙トレーニングのボタンを設定
function setupKanjiVocabButtons() {
  const kanjiCheckBtn = document.getElementById('kanjiCheckBtn');
  const kanjiResetBtn = document.getElementById('kanjiResetBtn');
  const kanjiNextBtn = document.getElementById('kanjiNextBtn');
  const kanjiFinishBtn = document.getElementById('kanjiFinishBtn');

  if (kanjiCheckBtn) {
    kanjiCheckBtn.onclick = checkKanjiVocabAnswer;
  }

  if (kanjiResetBtn) {
    kanjiResetBtn.onclick = resetKanjiVocabProblem;
  }

  if (kanjiNextBtn) {
    kanjiNextBtn.onclick = goToNextKanjiVocabProblem;
  }

  if (kanjiFinishBtn) {
    kanjiFinishBtn.onclick = showKanjiVocabResult;
  }
}

// 漢字・語彙問題の答え合わせ
function checkKanjiVocabAnswer() {
  const session = currentKanjiVocabSession;
  if (!session || session.isChecked) return;
  
  const problem = session.problems[session.currentIndex];
  if (!problem) return;
  
  if (session.selectedKanji.length !== 2) {
    alert('漢字を2文字選択してください。');
    return;
  }
  
  // 選択した漢字が正解と一致するかチェック
  // 類義語問題では順番が重要なので、ソートしない
  let userAnswer, correctAnswer;
  if (session.grade === 'synonym') {
    userAnswer = session.selectedKanji.join('');
    correctAnswer = Array.isArray(problem.answer) ? problem.answer.join('') : problem.answer;
  } else {
    userAnswer = session.selectedKanji.sort().join('');
    correctAnswer = Array.isArray(problem.answer) ? problem.answer.sort().join('') : problem.answer.sort().join('');
  }
  const isCorrect = userAnswer === correctAnswer;
  
  if (isCorrect) {
    session.score++;
    
    // 大きな緑の〇を表示
    showBigGreenCircle();
  } else {
    // アニメーションなし
  }
  
  // 選択肢の色を更新
  const choices = document.querySelectorAll('.kanji-choice');
  choices.forEach(choice => {
    const kanji = choice.dataset.kanji;
    const answerArray = Array.isArray(problem.answer) ? problem.answer : [problem.answer];
    if (answerArray.includes(kanji)) {
      choice.classList.add('correct');
    } else if (session.selectedKanji.includes(kanji)) {
      choice.classList.add('incorrect');
      // 間違えた選択肢を赤くして×ラベルを追加
      choice.style.background = '#f44336';
      choice.style.color = 'white';
      choice.style.borderColor = '#d32f2f';
      if (typeof addIncorrectLabel === 'function') {
        addIncorrectLabel(choice);
      }
    }
    choice.style.pointerEvents = 'none'; // クリック無効化
  });
  
  // フィードバックを表示
  const feedbackDiv = document.getElementById('kanjiFeedback');
  feedbackDiv.className = `kanji-feedback ${isCorrect ? 'correct' : 'incorrect'}`;
  
  // 類義語問題かどうかを判定
  const isSynonym = session.grade === 'synonym';
  const answerDisplay = Array.isArray(problem.answer) ? problem.answer.join('') : problem.answer;
  
  feedbackDiv.innerHTML = `
    <div style="font-size:18px;margin-bottom:12px;">
      ${isCorrect ? '正解です！' : '不正解です。'}
    </div>
    <div style="font-size:16px;margin-bottom:8px; font-family: 'Tsukushi Mincho', 'Yu Mincho', 'YuMincho', 'MS Mincho', serif;">
      正解: ${answerDisplay}
    </div>
    <div style="font-size:14px;color:#666;background:#f5f5f5;padding:12px;border-radius:8px;">
      ${isSynonym ? 
        `「${problem.meaning}」と「${answerDisplay}」は類義語（似た意味の言葉）です。` : 
        (problem.explanation || '')}
    </div>
    ${problem.hint ? `<div style="font-size:12px;color:#888;margin-top:8px;">ヒント: ${problem.hint}</div>` : ''}
  `;
  feedbackDiv.style.display = 'block';
  feedbackDiv.style.opacity = '1';
  
  // 解答ボタンとリセットボタンを非表示
  document.getElementById('kanjiCheckBtn').style.display = 'none';
  document.getElementById('kanjiResetBtn').style.display = 'none';
  
  // ボタンの表示制御（正解・不正解で分ける）
  if (isCorrect) {
    // 正解の場合は次の問題へ
    if (session.currentIndex < session.problems.length - 1) {
      document.getElementById('kanjiNextBtn').style.display = 'inline-block';
    } else {
      document.getElementById('kanjiFinishBtn').style.display = 'inline-block';
    }
  } else {
    // 不正解の場合は解きなおし
    // 解きなおしボタンを動的に作成
    const resetBtn = document.createElement('button');
    resetBtn.textContent = '解きなおす';
    resetBtn.className = 'kanji-btn';
    resetBtn.style.background = '#ff9800';
    resetBtn.onclick = () => resetKanjiVocabProblem();
    
    // フィードバックエリアにボタンを追加
    const feedbackDiv = document.getElementById('kanjiFeedback');
    feedbackDiv.appendChild(resetBtn);
  }
  
  session.isChecked = true;
}

// 漢字・語彙問題をリセット
function resetKanjiVocabProblem() {
  const session = currentKanjiVocabSession;
  
  // 類義語問題かどうかで分岐
  if (session && session.grade === 'synonym') {
    displayCurrentSynonymProblem();
    
    // 問題表示後に選択状態をクリア
    setTimeout(() => {
      // 全ての選択肢のスタイルをリセット
      const choices = document.querySelectorAll('.kanji-choice');
      choices.forEach(choice => {
        choice.classList.remove('selected');
        choice.style.background = '#fff';
        choice.style.borderColor = '#ddd';
        choice.style.color = '#000000';
        choice.style.opacity = '1';
        choice.style.pointerEvents = 'auto';
      });
      
      // 選択状態をクリア
      session.selectedKanji = [];
      session.isChecked = false;
    }, 10);
  } else if (session && session.grade === 'antonym') {
    displayCurrentAntonymProblem();
    
    // 問題表示後に選択状態をクリア
    setTimeout(() => {
      // 全ての選択肢のスタイルをリセット
      const choices = document.querySelectorAll('.kanji-choice');
      choices.forEach(choice => {
        choice.classList.remove('selected');
        choice.style.background = '#fff';
        choice.style.borderColor = '#ddd';
        choice.style.color = '#000000';
        choice.style.opacity = '1';
        choice.style.pointerEvents = 'auto';
      });
      
      // 選択状態をクリア
      session.selectedKanji = [];
      session.isChecked = false;
    }, 10);
  } else {
    displayCurrentKanjiVocabProblem();
  }
  
  // 解答ボタンとリセットボタンを再表示
  document.getElementById('kanjiCheckBtn').style.display = 'inline-block';
  document.getElementById('kanjiResetBtn').style.display = 'inline-block';
}

// 次の漢字・語彙問題へ
function goToNextKanjiVocabProblem() {
  const session = currentKanjiVocabSession;
  if (session.currentIndex < session.problems.length - 1) {
    session.currentIndex++;
    
    const contentContainer = document.querySelector('.kanji-vocab-problem');
    transitionToNextProblem(contentContainer, () => {
      // 類義語問題かどうかで分岐
      if (session && session.grade === 'synonym') {
        displayCurrentSynonymProblem();
      } else if (session && session.grade === 'antonym') {
        displayCurrentAntonymProblem();
      } else {
        displayCurrentKanjiVocabProblem();
      }
    });
  }
}

// 漢字・語彙トレーニングの結果を表示
function showKanjiVocabResult() {
  const session = currentKanjiVocabSession;
  const percentage = Math.round((session.score / session.problems.length) * 100);
  
  let grade, comment;
  const isSynonym = session.grade === 'synonym';
  const isAntonym = session.grade === 'antonym';
  
  if (percentage >= 90) {
    grade = '優秀';
    comment = isSynonym ? 
      '素晴らしい語彙力です！類義語の理解も完璧ですね。' : 
      isAntonym ?
      '素晴らしい語彙力です！対義語の理解も完璧ですね。' :
      '素晴らしい漢字力です！語彙も豊富ですね。';
  } else if (percentage >= 70) {
    grade = '良好';
    comment = isSynonym ? 
      'よく理解できています！類義語の感覚が身についてきましたね。' : 
      isAntonym ?
      'よく理解できています！対義語の感覚が身についてきましたね。' :
      'よく理解できています！この調子で続けましょう。';
  } else if (percentage >= 50) {
    grade = '普通';
    comment = isSynonym ? 
      'もう少し練習して類義語の感覚を鍛えましょう。' : 
      isAntonym ?
      'もう少し練習して対義語の感覚を鍛えましょう。' :
      'もう少し練習して語彙を増やしましょう。';
  } else {
    grade = '要復習';
    comment = isSynonym ? 
      '基礎からしっかり復習して、類義語の理解を深めましょう。' : 
      isAntonym ?
      '基礎からしっかり復習して、対義語の理解を深めましょう。' :
      '基礎からしっかり復習して、漢字に慣れ親しみましょう。';
  }
  
  // 結果画面に遷移
  showBox(kanjiVocabResultBox);
  
  // 結果を表示
  const resultContainer = document.getElementById('kanjiVocabResultContent');
  resultContainer.innerHTML = `
    <div style="font-size: 48px; margin: 20px 0; color: #9C27B0;">${grade}</div>
    <div style="font-size: 24px; margin: 20px 0;">${session.score} / ${session.problems.length} 問正解</div>
    <div style="font-size: 20px; margin: 20px 0; color: #9C27B0; font-weight: bold;">${percentage}%</div>
    <div style="font-size: 16px; margin: 20px 0; color: #666; padding: 16px; background: #f3e5f5; border-radius: 8px;">
      ${comment}
    </div>
  `;
}

// ===== ことわざトレーニング関数 =====

// ことわざ問題データを読み込み
async function loadKotowazaProblems() {
  try {
    const response = await fetch('kotowaza_problems.json');
    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }
    const data = await response.json();
    kotowazaProblems = data;
    return true;
  } catch (error) {
    console.error('ことわざ問題の読み込みエラー:', error);
    return false;
  }
}

// ことわざ暗記編を開始
async function startKotowazaStudy() {
  console.log('ことわざ暗記編を開始します');
  const loaded = await loadKotowazaProblems();
  if (!loaded) {
    alert('ことわざ問題の読み込みに失敗しました。');
    return;
  }
  
  currentKotowazaSession = {
    problems: kotowazaProblems,
    currentIndex: 0,
    mode: 'study'
  };
  
  console.log('kotowazaStudyBoxに遷移します', kotowazaStudyBox);
  showBox(kotowazaStudyBox);
  displayCurrentKotowazaStudy();
  setupKotowazaStudyButtons();
}

// ことわざ問題編を開始
async function startKotowazaTest() {
  console.log('ことわざ問題編を開始します');
  const loaded = await loadKotowazaProblems();
  if (!loaded) {
    alert('ことわざ問題の読み込みに失敗しました。');
    return;
  }
  
  currentKotowazaSession = {
    problems: kotowazaProblems,
    currentIndex: 0,
    mode: 'test',
    score: 0,
    answers: {
      fill: null,
      meaning: null
    },
    isChecked: false
  };
  
  console.log('kotowazaTestBoxに遷移します', kotowazaTestBox);
  showBox(kotowazaTestBox);
  displayCurrentKotowazaTest();
  setupKotowazaTestButtons();
}

// ことわざ暗記編の問題を表示
function displayCurrentKotowazaStudy() {
  const session = currentKotowazaSession;
  const problem = session.problems[session.currentIndex];
  
  // 進捗を更新
  document.getElementById('kotowazaProgress').textContent = `${session.currentIndex + 1} / ${session.problems.length}`;
  
  // 意味を表示（縦書きで改行ありで表示）
  const meaningDiv = document.getElementById('kotowazaMeaning');
  
  // 意味をふりがな付きで取得
  const meaningRuby = problem.meaning_ruby || problem.meaning;
  
  // 縦書きで適切に改行を入れる（句読点や文節で区切り）
  let formattedText = meaningRuby
    .replace(/。/g, '。<br>')  // 文の終わりで改行
    .replace(/、/g, '、<br>')  // 読点でも改行
    .replace(/という意味/g, '<br>という意味')  // 「という意味」の前で改行
    .replace(/ことがある/g, '<br>ことがある')  // 「ことがある」の前で改行
    .replace(/であるという/g, '<br>であるという')  // 接続部分で改行
    .replace(/を意味する/g, '<br>を意味する')  // 「を意味する」の前で改行
    .replace(/ということ/g, '<br>ということ');  // 「ということ」の前で改行
  
  // 連続する改行を整理
  formattedText = formattedText.replace(/<br><br>/g, '<br>');
  // 最後の改行を削除
  formattedText = formattedText.replace(/<br>$/, '');
  
  // 縦書きで表示
  meaningDiv.className = '';
  meaningDiv.innerHTML = formattedText;
  console.log('縦書きで意味を表示（改行あり）:', meaningRuby.length + '文字');
  
  // ことわざを表示（穴抜き部分はクリック可能、ふりがな付き）
  const kotowazaText = document.getElementById('kotowazaText');
  const fullTextRuby = problem.kotowaza_ruby || problem.kotowaza;
  
  // 複数空欄対応
  if (Array.isArray(problem.missing)) {
    console.log('暗記編：複数空欄問題を処理中:', problem);
    let displayText = fullTextRuby;
    
    // 各空欄文字を順番に置換
    problem.missing.forEach((missingPart, index) => {
      console.log(`暗記編：空欄${index+1}: "${missingPart}" を置換中`);
      
      // 空欄のHTMLを作成
      const missingLength = missingPart.length;
      let blanksHtml = '';
      for (let i = 0; i < missingLength; i++) {
        blanksHtml += `<span class="kotowaza-blank" onclick="revealFullAnswer('${problem.kotowaza}', 0)" style="background:#e5d5ff;cursor:pointer;color:#333;font-weight:bold;width:28px;height:28px;display:inline-block;text-align:center;line-height:28px;margin:1px;"></span>`;
      }
      
      let replaced = false;
      
      // 特別なケース：分割されたルビタグの場合
      if (missingPart === '七転び') {
        displayText = displayText.replace(/<ruby>七転<rt>[^<]*<\/rt><\/ruby>び/g, (match) => {
          console.log(`暗記編：特別ケースマッチ(七転び): "${match}"`);
          replaced = true;
          return blanksHtml;
        });
      } else if (missingPart === '八起き') {
        displayText = displayText.replace(/<ruby>八起<rt>[^<]*<\/rt><\/ruby>き/g, (match) => {
          console.log(`暗記編：特別ケースマッチ(八起き): "${match}"`);
          replaced = true;
          return blanksHtml;
        });
      }
      
      if (!replaced) {
        // ルビタグ全体での置換パターンを試す
        const rubyPattern = new RegExp(`<ruby>${missingPart.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')}<rt>[^<]*</rt></ruby>`, 'g');
        
        // まずルビタグ全体での置換を試す
        displayText = displayText.replace(rubyPattern, (match) => {
          console.log(`暗記編：ルビタグマッチ: "${match}"`);
          replaced = true;
          return blanksHtml;
        });
        
        // ルビタグでの置換がされなかった場合、単純な文字置換
        if (!replaced) {
          const regex = new RegExp(missingPart.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'g');
          let replacementCount = 0;
          
          displayText = displayText.replace(regex, (match) => {
            replacementCount++;
            console.log(`暗記編：単純マッチ${replacementCount}: "${match}"`);
            // 最初の出現のみ置換
            if (replacementCount === 1) {
              replaced = true;
              return blanksHtml;
            }
            return match;
          });
        }
      }
      
      console.log(`暗記編：置換後のテキスト: ${displayText}`);
    });
    
    kotowazaText.innerHTML = displayText;
  } else {
    // 従来の単一空欄処理
    const missingPart = problem.missing;
    const fullText = problem.kotowaza;
    const missingIndex = fullText.indexOf(missingPart);
    
    if (missingIndex !== -1) {
      // ふりがな付きテキストから空欄部分を処理
      const beforeAfterRuby = createBlankInRubyText(fullTextRuby, missingPart, missingIndex);
      
      kotowazaText.innerHTML = beforeAfterRuby;
    } else {
      kotowazaText.innerHTML = fullTextRuby;
    }
  }
}

// ふりがな付きテキストで空欄を作成
function createBlankInRubyText(rubyText, missingPart, missingIndex) {
  console.log(`空欄作成処理開始: missingPart="${missingPart}", rubyText="${rubyText}"`);
  
  // 空欄のHTMLを作成
  const missingLength = missingPart.length;
  let blanksHtml = '';
  for (let i = 0; i < missingLength; i++) {
    blanksHtml += `<span class="kotowaza-blank" onclick="revealFullAnswer('${missingPart}', ${missingIndex})" style="background:#e5d5ff;cursor:pointer;color:#333;font-weight:bold;width:28px;height:28px;display:inline-block;text-align:center;line-height:28px;margin:1px;"></span>`;
  }
  
  let result = rubyText;
  
  // 1. まず、missingPartを含むrubyタグを動的に検索・置換
  const rubyPattern = new RegExp(`<ruby>${missingPart}<rt>[^<]*</rt></ruby>`, 'g');
  const matches = result.match(rubyPattern);
  console.log(`ルビタグ検索結果:`, matches);
  
  if (matches && matches.length > 0) {
    result = result.replace(rubyPattern, blanksHtml);
    console.log(`ルビタグで置換成功: ${missingPart}`);
  } else {
    console.log(`ルビタグが見つからないため、特別処理を実行: ${missingPart}`);
    
    // 2. 特別なケース：複合語や部分置換
    if (missingPart === '一期') {
      // 一期一会の場合
      result = result.replace(/<ruby>一期一会<rt>いちごいちえ<\/rt><\/ruby>/g, `<ruby>${blanksHtml}一会<rt>いちえ</rt></ruby>`);
      console.log('一期一会の特別処理を実行');
    } else if (missingPart === '八起き') {
      // 七転び八起きの場合
      result = result.replace(/<ruby>八起<rt>やお<\/rt><\/ruby>き/g, `${blanksHtml}き`);
      console.log('八起きの特別処理を実行');
    } else {
      // 3. フォールバック：単純にテキストを置き換え
      const simplePattern = new RegExp(missingPart, 'g');
      const beforeReplace = result;
      result = result.replace(simplePattern, blanksHtml);
      console.log(`フォールバック処理: "${beforeReplace}" → "${result}"`);
    }
  }
  
  console.log(`最終結果: "${result}"`);
  return result;
}

// ことわざ問題編の問題を表示
function displayCurrentKotowazaTest() {
  const session = currentKotowazaSession;
  const problem = session.problems[session.currentIndex];
  
  // 進捗を更新
  const progressDiv = document.querySelector('#kotowazaTestProgress > div');
  const totalProblems = Math.min(10, session.problems.length); // 最大10問まで
  progressDiv.textContent = `${session.currentIndex + 1}/${totalProblems}`;
  const progressBar = document.querySelector('#kotowazaTestProgress div div');
  progressBar.style.width = `${((session.currentIndex + 1) / totalProblems) * 100}%`;
  
  // 右側に意味を問題形式で表示
  const meaningDiv = document.getElementById('kotowazaTestMeaning');
  const meaningRuby = problem.meaning_ruby || problem.meaning;
  
  // 縦書きで適切に改行を入れる（句読点や文節で区切り）
  let formattedText = meaningRuby
    .replace(/。/g, '。<br>')
    .replace(/、/g, '、<br>')
    .replace(/という意味/g, '<br>という意味')
    .replace(/ことがある/g, '<br>ことがある')
    .replace(/であるという/g, '<br>であるという')
    .replace(/を意味する/g, '<br>を意味する')
    .replace(/ということ/g, '<br>ということ');
  
  // 連続する改行を整理
  formattedText = formattedText.replace(/<br><br>/g, '<br>');
  formattedText = formattedText.replace(/<br>$/, '');
  
  // 「問」を先頭に追加
  meaningDiv.innerHTML = `<span style="color:#9333ea;font-weight:bold;font-size:20px;">問</span><br>${formattedText}`;
  
  // 左側にことわざを表示（空欄部分は入力フィールド）
  const kotowazaQuestionText = document.getElementById('kotowazaQuestionText');
  
  // 複数空欄対応
  if (Array.isArray(problem.missing)) {
    console.log('問題編：複数空欄問題を処理中:', problem);
    // 問題編ではふりがななしのテキストを使用（答えがバレないように）
    let displayText = problem.kotowaza;
    console.log('問題編：元のテキスト:', displayText);
    const missingParts = problem.missing;
    
    // 各空欄文字を順番に入力フィールドに置換
    missingParts.forEach((missingPart, index) => {
      console.log(`問題編：空欄${index+1}: "${missingPart}" を置換中`);
      
      let replaced = false;
      
      // 入力フィールドのHTML 四角形式 - 縦書き対応
      const inputField = `<span style="position: relative; display: inline-block; vertical-align: baseline; margin: 0 0 0 2px;">
        <input type="text" 
          id="kotowazaInput${index}" 
          data-answer="${missingPart}" 
          style="
            writing-mode: vertical-rl;
            text-orientation: upright;
            width: 32px;
            height: ${missingPart.length * 32}px;
            font-size: 28px;
            font-weight: bold;
            text-align: center;
            border: 2px solid #9333ea;
            background: #fff;
            font-family: 'Tsukushi Mincho','Yu Mincho','YuMincho','MS Mincho',serif;
            outline: none;
            padding: 0;
            margin: 0;
            line-height: 2;
            border-radius: 4px;
            vertical-align: baseline;
          " 
          maxlength="${missingPart.length}">
      </span>`;
      
      // ふりがななしテキストでの文字置換（最優先）
      const regex = new RegExp(missingPart.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'g');
      let replacementCount = 0;
      
      displayText = displayText.replace(regex, (match) => {
        replacementCount++;
        console.log(`問題編：文字マッチ${replacementCount}: "${match}"`);
        if (replacementCount === 1) {
          replaced = true;
          return inputField;
        }
        return match;
      });
      
      // もし置換されなかった場合、特別ケースも試す（念のため）
      if (!replaced) {
        if (missingPart === '七転び') {
          displayText = displayText.replace(/七転び/g, (match) => {
            console.log(`問題編：特別ケースマッチ(七転び): "${match}"`);
            replaced = true;
            return inputField;
          });
        } else if (missingPart === '八起き') {
          displayText = displayText.replace(/八起き/g, (match) => {
            console.log(`問題編：特別ケースマッチ(八起き): "${match}"`);
            replaced = true;
            return inputField;
          });
        }
      }
      
      console.log(`問題編：置換後のテキスト: ${displayText}`);
    });
    
    kotowazaQuestionText.innerHTML = displayText;
    
    // 入力フィールドのイベントリスナーを追加（プレースホルダーの表示/非表示）
    setTimeout(() => {
      missingParts.forEach((missingPart, index) => {
        const input = document.getElementById(`kotowazaInput${index}`);
        const placeholder = document.getElementById(`placeholder${index}`);
        if (input && placeholder) {
          input.addEventListener('input', () => {
            placeholder.style.display = input.value ? 'none' : 'block';
          });
          input.addEventListener('focus', () => {
            placeholder.style.display = 'none';
          });
          input.addEventListener('blur', () => {
            if (!input.value) {
              placeholder.style.display = 'block';
            }
          });
        }
      });
    }, 10);
  } else {
    // 従来の単一空欄の場合
    const missingPart = problem.missing;
    // 問題編ではふりがななしのテキストを使用
    let displayText = problem.kotowaza;
    
    // 入力フィールドのHTML 四角形式 - 縦書き対応
    const inputField = `<span style="position: relative; display: inline-block; vertical-align: baseline; margin: 0 0 0 2px;">
      <input type="text" 
        id="kotowazaInput0" 
        data-answer="${missingPart}" 
        style="
          writing-mode: vertical-rl;
          text-orientation: upright;
          width: 32px;
          height: ${missingPart.length * 32}px;
          font-size: 28px;
          font-weight: bold;
          text-align: center;
          border: 2px solid #9333ea;
          background: #fff;
          font-family: 'Tsukushi Mincho','Yu Mincho','YuMincho','MS Mincho',serif;
          outline: none;
          padding: 0;
          margin: 0;
          line-height: 2;
          border-radius: 4px;
          vertical-align: baseline;
        " 
        maxlength="${missingPart.length}">
    </span>`;
    
    const regex = new RegExp(missingPart.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'g');
    let replacementCount = 0;
    
    displayText = displayText.replace(regex, (match) => {
      replacementCount++;
      if (replacementCount === 1) {
        return inputField;
      }
      return match;
    });
    
    kotowazaQuestionText.innerHTML = displayText;
  }
  
  // 状態をリセット
  session.answers = { fillInputs: [], meaning: null };
  session.isChecked = false;
  
  // ボタンをリセット
  document.getElementById('kotowazaCheckBtn').style.display = 'inline-block';
  document.getElementById('kotowazaTestNextBtn').style.display = 'none';
  document.getElementById('kotowazaTestFinishBtn').style.display = 'none';
  document.getElementById('kotowazaTestFeedback').style.display = 'none';
}

// 穴抜きの答えを表示（暗記編）
function revealAnswer(element, answer) {
  element.textContent = answer;
  element.style.background = 'transparent';
  element.style.color = '#333';
  element.style.fontFamily = "'Tsukushi Mincho','Yu Mincho','YuMincho','MS Mincho',serif";
  element.style.cursor = 'default';
  element.onclick = null;
}

// 複数文字の答えを一度に表示（暗記編）
function revealFullAnswer(fullAnswer, startIndex) {
  const kotowazaText = document.getElementById('kotowazaText');
  const session = currentKotowazaSession;
  const problem = session.problems[session.currentIndex];
  
  // 完全版のふりがな付きテキストを表示
  kotowazaText.innerHTML = problem.kotowaza_ruby || problem.kotowaza;
}

// ことわざ穴抜き選択肢を選択（単一空欄）- 使用されていません
function selectKotowazaChoice(choice, element) {
  // 新しい入力フィールド形式では使用されません
}

// ことわざ穴抜き選択肢を選択（複数空欄）- 使用されていません
function selectMultipleKotowazaChoice(choice, element, groupIndex) {
  // 新しい入力フィールド形式では使用されません
}

// ことわざ意味選択肢を選択 - 使用されていません
function selectKotowazaMeaning(meaning, element) {
  // 新しい入力フィールド形式では使用されません
}

// ことわざ問題の答えをチェック
function checkKotowazaAnswer() {
  const session = currentKotowazaSession;
  const problem = session.problems[session.currentIndex];
  
  // 入力値を取得
  const inputFields = document.querySelectorAll('[id^="kotowazaInput"]');
  const userAnswers = [];
  
  // すべての入力フィールドから値を取得
  let hasEmptyField = false;
  inputFields.forEach((input, index) => {
    const value = input.value.trim();
    if (!value) {
      hasEmptyField = true;
    } else {
      userAnswers.push(value);
    }
  });
  
  if (hasEmptyField || userAnswers.length === 0) {
    alert('すべての空欄を入力してください。');
    return;
  }
  
  // 正解チェック
  let fillCorrect = false;
  
  if (Array.isArray(problem.missing)) {
    // 複数空欄の場合
    fillCorrect = problem.missing.every((correctAnswer, index) => {
      return userAnswers[index] === correctAnswer;
    });
  } else {
    // 単一空欄の場合
    fillCorrect = userAnswers[0] === problem.missing;
  }
  
  session.isChecked = true;
  
  // 入力フィールドの色を更新
  inputFields.forEach((input, index) => {
    const correctAnswer = Array.isArray(problem.missing) ? problem.missing[index] : problem.missing;
    const userAnswer = input.value.trim();
    
    if (userAnswer === correctAnswer) {
      input.style.background = '#e8f5e8';
      input.style.color = '#2e7d32';
    } else {
      input.style.background = '#fce4ec';
      input.style.color = '#c62828';
    }
    input.disabled = true; // 入力を無効化
  });
  
  if (fillCorrect) {
    session.score += 1; // 正解で1点
    showBigGreenCircle();
  }
  
  // フィードバックを表示
  const feedbackDiv = document.getElementById('kotowazaTestFeedback');
  let feedbackText = '';
  
  if (fillCorrect) {
    feedbackText = '正解です！素晴らしい！';
    feedbackDiv.style.background = '#e0f7fa';
    feedbackDiv.style.borderColor = '#00BCD4';
    feedbackDiv.style.border = '2px solid #00BCD4';
    feedbackDiv.style.color = '#006064';
  } else {
    feedbackText = '不正解です。正解を確認して覚えましょう。';
    feedbackDiv.style.background = '#ffebee';
    feedbackDiv.style.borderColor = '#FF4444';
    feedbackDiv.style.border = '2px solid #FF4444';
    feedbackDiv.style.color = '#d32f2f';
  }
  
  // 正解表示
  let correctAnswerText = '';
  if (Array.isArray(problem.missing)) {
    correctAnswerText = `正解: ${problem.kotowaza} (空欄: ${problem.missing.join('、')})`;
  } else {
    correctAnswerText = `正解: ${problem.kotowaza}`;
  }
  
  feedbackDiv.innerHTML = `
    <div style="font-weight:bold;margin-bottom:8px;">${feedbackText}</div>
    <div style="color:#666;">${correctAnswerText}</div>
  `;
  feedbackDiv.style.display = 'block';
  
  // ボタンを更新
  document.getElementById('kotowazaCheckBtn').style.display = 'none';
  
  const maxProblems = Math.min(10, session.problems.length);
  if (session.currentIndex < maxProblems - 1) {
    document.getElementById('kotowazaTestNextBtn').style.display = 'inline-block';
  } else {
    document.getElementById('kotowazaTestFinishBtn').style.display = 'inline-block';
  }
}

// 次のことわざ問題へ（暗記編）
function nextKotowazaStudy() {
  const session = currentKotowazaSession;
  if (session.currentIndex < session.problems.length - 1) {
    session.currentIndex++;
    displayCurrentKotowazaStudy();
  } else {
    // 全て終了 - 完了画面を表示
    showKotowazaStudyComplete();
  }
}

// ことわざ暗記編完了画面を表示
function showKotowazaStudyComplete() {
  showBox(kotowazaStudyCompleteBox);
  
  // 完了画面のボタンイベントを設定
  setupKotowazaStudyCompleteButtons();
}

// ことわざ暗記編完了画面のボタンイベントを設定
function setupKotowazaStudyCompleteButtons() {
  // ホームボタン
  const homeBtn = document.getElementById('kotowazaStudyCompleteHomeBtn');
  if (homeBtn) {
    homeBtn.onclick = () => showBox(homeBox);
  }
  
  // もう一度始めからボタン
  const restartBtn = document.getElementById('kotowazaStudyRestartBtn');
  if (restartBtn) {
    restartBtn.onclick = () => {
      // セッションをリセットして最初から開始
      if (currentKotowazaSession) {
        currentKotowazaSession.currentIndex = 0;
      }
      startKotowazaStudy();
    };
  }
  
  // メニューに戻るボタン
  const backBtn = document.getElementById('kotowazaStudyCompleteBackBtn');
  if (backBtn) {
    backBtn.onclick = () => showBox(kotowazaMenuBox);
  }
}

// 次のことわざ問題へ（問題編）
function nextKotowazaTest() {
  const session = currentKotowazaSession;
  const maxProblems = Math.min(10, session.problems.length); // 最大10問まで
  if (session.currentIndex < maxProblems - 1) {
    session.currentIndex++;
    displayCurrentKotowazaTest();
  } else {
    // 最後の問題の場合は結果を表示
    showKotowazaResult();
  }
}

// ことわざ問題編の結果を表示
function showKotowazaResult() {
  const session = currentKotowazaSession;
  const totalProblems = Math.min(10, session.problems.length); // 最大10問まで
  const maxScore = totalProblems; // 各問題1点満点
  const percentage = Math.round((session.score / maxScore) * 100);
  
  let grade, comment;
  if (percentage >= 90) {
    grade = '優秀';
    comment = 'ことわざマスターですね！素晴らしい知識です。';
  } else if (percentage >= 70) {
    grade = '良好';
    comment = 'よく覚えています！この調子で続けましょう。';
  } else if (percentage >= 50) {
    grade = '普通';
    comment = 'もう少し練習してことわざを覚えましょう。';
  } else {
    grade = '要復習';
    comment = '暗記編で復習してからもう一度挑戦してみましょう。';
  }
  
  // 結果画面に遷移
  showBox(kotowazaResultBox);
  
  // 結果を表示
  const resultContainer = document.getElementById('kotowazaResultContent');
  resultContainer.innerHTML = `
    <div style="font-size: 48px; margin: 20px 0; color: #9333ea;">${grade}</div>
    <div style="font-size: 24px; margin: 20px 0;">${session.score} / ${maxScore} 点</div>
    <div style="font-size: 20px; margin: 20px 0; color: #9333ea; font-weight: bold;">${percentage}%</div>
    <div style="font-size: 16px; margin: 20px 0; color: #666; padding: 16px; background: #f3e5f5; border-radius: 8px;">
      ${comment}
    </div>
  `;
}

// ことわざトレーニングボタンセットアップ（暗記編）
function setupKotowazaStudyButtons() {
  // 戻るボタン
  document.getElementById('kotowazaStudyBackBtn').onclick = () => showBox(kotowazaMenuBox);
  
  // ホームボタン
  document.getElementById('kotowazaStudyHomeBtn').onclick = () => showBox(homeBox);
  
  // 次のことわざボタン
  document.getElementById('kotowazaNextBtn').onclick = nextKotowazaStudy;
}

// ことわざトレーニングボタンセットアップ（問題編）
function setupKotowazaTestButtons() {
  // 戻るボタン
  document.getElementById('kotowazaTestBackBtn').onclick = () => showBox(kotowazaMenuBox);
  
  // ホームボタン
  document.getElementById('kotowazaTestHomeBtn').onclick = () => showBox(homeBox);
  
  // 答えを確認ボタン
  document.getElementById('kotowazaCheckBtn').onclick = checkKotowazaAnswer;
  
  // 次の問題ボタン
  document.getElementById('kotowazaTestNextBtn').onclick = nextKotowazaTest;
  
  // 結果を見るボタン
  document.getElementById('kotowazaTestFinishBtn').onclick = showKotowazaResult;
}

// ことわざメニューのボタンイベントを設定
function setupKotowazaMenuButtons() {
  console.log('ことわざメニューボタンイベントを設定します');
  
  // 暗記編ボタン
  const kotowazaStudyBtn = document.getElementById('kotowazaStudyBtn');
  console.log('kotowazaStudyBtn:', kotowazaStudyBtn);
  if (kotowazaStudyBtn) {
    kotowazaStudyBtn.onclick = startKotowazaStudy;
    kotowazaStudyBtn.addEventListener('mouseenter', () => {
      kotowazaStudyBtn.style.background = '#e5e7eb';
      kotowazaStudyBtn.style.transform = 'scale(1.05)';
    });
    kotowazaStudyBtn.addEventListener('mouseleave', () => {
      kotowazaStudyBtn.style.background = '#f8f9fa';
      kotowazaStudyBtn.style.transform = 'scale(1)';
    });
  }

  // 問題編ボタン
  const kotowazaTestBtn = document.getElementById('kotowazaTestBtn');
  console.log('kotowazaTestBtn:', kotowazaTestBtn);
  if (kotowazaTestBtn) {
    kotowazaTestBtn.onclick = startKotowazaTest;
    kotowazaTestBtn.addEventListener('mouseenter', () => {
      kotowazaTestBtn.style.background = '#e5e7eb';
      kotowazaTestBtn.style.transform = 'scale(1.05)';
    });
    kotowazaTestBtn.addEventListener('mouseleave', () => {
      kotowazaTestBtn.style.background = '#f8f9fa';
      kotowazaTestBtn.style.transform = 'scale(1)';
    });
  }

  // 戻るボタン
  const kotowazaMenuBackBtn = document.getElementById('kotowazaMenuBackBtn');
  if (kotowazaMenuBackBtn) {
    kotowazaMenuBackBtn.onclick = () => showBox(kanjiVocabTrainingBox);
  }

  // ホームボタン
  const kotowazaMenuHomeBtn = document.getElementById('kotowazaMenuHomeBtn');
  if (kotowazaMenuHomeBtn) {
    kotowazaMenuHomeBtn.onclick = () => showBox(homeBox);
  }

  // 結果画面の戻るボタン
  const kotowazaBackToMenuBtn = document.getElementById('kotowazaBackToMenuBtn');
  if (kotowazaBackToMenuBtn) {
    kotowazaBackToMenuBtn.onclick = () => showBox(kotowazaMenuBox);
  }

  // 結果画面のホームボタン
  const kotowazaResultHomeBtn = document.getElementById('kotowazaResultHomeBtn');
  if (kotowazaResultHomeBtn) {
    kotowazaResultHomeBtn.onclick = () => showBox(homeBox);
  }
}

// 指示語問題のゲームを初期化
function initPronounReferenceGame() {
  if (!pronounReferenceProblems || pronounReferenceProblems.length === 0) {
    console.error('指示語問題データがありません');
    return;
  }
  
  // セッションを初期化
  currentPronounSession = {
    problems: [...pronounReferenceProblems],
    currentIndex: 0,
    selectedAnswer: null,
    score: 0,
    isChecked: false
  };
  
  // イベントハンドラーを設定
  setupPronounEventHandlers();
  
  // 最初の問題を表示
  displayCurrentPronounProblem();
}

// 指示語問題のイベントハンドラーを設定
function setupPronounEventHandlers() {
  // 戻るボタン
  const backBtn = $('pronounReferenceBackBtn');
  if (backBtn) {
    backBtn.onclick = () => showBox(logicTrainingBox);
  }
  
  // ホームボタン
  const homeBtn = $('pronounReferenceHomeBtn');
  if (homeBtn) {
    homeBtn.onclick = () => showBox(homeBox);
  }
  
  // リセットボタン
  const resetBtn = $('pronounResetBtn');
  if (resetBtn) {
    resetBtn.onclick = resetPronounProblem;
  }
  
  // 次の問題ボタン
  const nextBtn = $('pronounNextBtn');
  if (nextBtn) {
    nextBtn.onclick = nextPronounProblem;
  }
  
  // 結果を見るボタン
  const finishBtn = $('pronounFinishBtn');
  if (finishBtn) {
    finishBtn.onclick = showPronounResults;
  }
}

// 現在の指示語問題を表示
function displayCurrentPronounProblem() {
  const session = currentPronounSession;
  if (!session || !session.problems || session.problems.length === 0) {
    console.error('指示語問題セッションデータがありません');
    return;
  }
  
  const problem = session.problems[session.currentIndex];
  if (!problem) {
    console.error('問題が見つかりません:', session.currentIndex);
    return;
  }
  
  // 進捗を更新
  updateProblemProgress(session.currentIndex, session.problems.length, 'pronounProgress');
  
  // 問題文を表示（指示語をハイライト）
  const textEl = $('pronounText');
  if (textEl) {
    const text = problem.text;
    const start = problem.pronoun_position.start;
    const end = problem.pronoun_position.end;
    
    // 縦書きに対応したハイライト表示
    let highlightedText = '';
    for (let i = 0; i < text.length; i++) {
      const char = text[i];
      if (i >= start && i < end) {
        highlightedText += `<span class="pronoun-highlight">${char}</span>`;
      } else {
        highlightedText += char;
      }
    }
    
    // 内側のdiv要素に文章を表示
    const innerDiv = textEl.querySelector('div');
    if (innerDiv) {
      innerDiv.innerHTML = highlightedText;
    }
  }
  
  // 質問を表示
  const questionEl = $('pronounQuestion');
  if (questionEl) {
    questionEl.textContent = `「${problem.pronoun}」は何を指していますか？`;
  }
  
  // 選択肢を表示
  const optionsEl = $('pronounOptions');
  if (optionsEl) {
    optionsEl.innerHTML = '';
    
    problem.options.forEach((option, index) => {
      const optionEl = document.createElement('div');
      optionEl.className = 'pronoun-option';
      optionEl.textContent = option;
      optionEl.dataset.answer = option;
      
      optionEl.addEventListener('click', () => selectPronounAnswer(option, optionEl));
      
      optionsEl.appendChild(optionEl);
    });
  }
  
  // 状態をリセット
  session.selectedAnswer = null;
  session.isChecked = false;
  
  // ボタンを初期状態に戻す
  const checkBtn = $('pronounCheckBtn');
  const nextBtn = $('pronounNextBtn');
  const finishBtn = $('pronounFinishBtn');
  const feedbackEl = $('pronounFeedback');
  const resetBtn = $('pronounResetBtn');
  
  if (checkBtn) checkBtn.style.display = 'none';
  if (nextBtn) nextBtn.style.display = 'none';
  if (finishBtn) finishBtn.style.display = 'none';
  if (feedbackEl) feedbackEl.style.display = 'none';
  
  // 解答時はチェックボタンのみ表示、リセットボタンは表示
  if (resetBtn) resetBtn.style.display = 'inline-block';
}

// 指示語問題の答えを選択
function selectPronounAnswer(answer, element) {
  const session = currentPronounSession;
  
  if (session.isChecked) return; // 回答済みの場合は選択不可
  
  // 以前の選択を解除
  const options = document.querySelectorAll('.pronoun-option');
  options.forEach(option => option.classList.remove('selected'));
  
  // 新しい選択を設定
  element.classList.add('selected');
  session.selectedAnswer = answer;
  
  // 確認ボタンを表示
  const checkBtn = $('pronounCheckBtn');
  if (checkBtn) {
    checkBtn.style.display = 'inline-block';
    checkBtn.onclick = checkPronounAnswer;
  }
}

// 指示語問題の答えをチェック
function checkPronounAnswer() {
  const session = currentPronounSession;
  const problem = session.problems[session.currentIndex];
  
  if (!session.selectedAnswer) {
    alert('答えを選択してください。');
    return;
  }
  
  session.isChecked = true;
  
  const isCorrect = session.selectedAnswer === problem.correct_answer;
  if (isCorrect) {
    session.score++;
    // 爽快なアニメーションを表示
    showSuccessAnimation('正解です！');
  } else {
    // アニメーションなし
  }
  
  // 選択肢の色を更新
  const options = document.querySelectorAll('.pronoun-option');
  options.forEach(option => {
    option.classList.add('disabled');
    const answer = option.dataset.answer;
    
    if (answer === problem.correct_answer) {
      option.classList.add('correct');
    } else if (answer === session.selectedAnswer && !isCorrect) {
      option.classList.add('incorrect');
      // 間違えた選択肢を赤くして×ラベルを追加
      option.style.background = '#f44336';
      option.style.color = 'white';
      option.style.borderColor = '#d32f2f';
      addIncorrectLabel(option);
    }
  });
  
  // フィードバックを表示
  const feedbackEl = $('pronounFeedback');
  if (feedbackEl) {
    feedbackEl.style.display = 'block';
    feedbackEl.style.opacity = '1';
    feedbackEl.className = `pronoun-feedback ${isCorrect ? 'correct' : 'incorrect'}`;
          feedbackEl.style.backgroundColor = isCorrect ? '#e0f2f1' : '#fce4ec';
      feedbackEl.style.color = isCorrect ? '#00695c' : '#880e4f';
      feedbackEl.style.border = `2px solid ${isCorrect ? '#4db6ac' : '#f06292'}`;
    
    let feedbackText = isCorrect ? 
      '正解です！' : 
      `不正解です。正解は「${problem.correct_answer}」です。`;
    
    if (problem.hint) {
      feedbackText += `<br><br>ヒント: ${problem.hint}`;
    }
    
    feedbackEl.innerHTML = feedbackText;
  }
  
  // ボタンを更新
  const checkBtn = $('pronounCheckBtn');
  const resetBtn = $('pronounResetBtn');
  const nextBtn = $('pronounNextBtn');
  const finishBtn = $('pronounFinishBtn');
  
  if (checkBtn) checkBtn.style.display = 'none';
  if (resetBtn) resetBtn.style.display = 'none';
  
  // ボタンの表示制御（正解・不正解で分ける）
  if (isCorrect) {
    // 正解の場合は次の問題へ
    if (session.currentIndex < session.problems.length - 1) {
      if (nextBtn) nextBtn.style.display = 'inline-block';
    } else {
      if (finishBtn) finishBtn.style.display = 'inline-block';
    }
  } else {
    // 不正解の場合は解きなおし
    // 解きなおしボタンを動的に作成
    const resetBtn = document.createElement('button');
    resetBtn.textContent = '解きなおす';
    resetBtn.className = 'logic-check-btn';
    resetBtn.style.background = '#ff9800';
    resetBtn.onclick = () => resetPronounProblem();
    
    // フィードバックエリアにボタンを追加
    const feedbackEl = $('pronounFeedback');
    if (feedbackEl) {
      feedbackEl.appendChild(resetBtn);
    }
  }
}

// 指示語問題をリセット
function resetPronounProblem() {
  const session = currentPronounSession;
  
  // 選択状態をリセット
  const options = document.querySelectorAll('.pronoun-option');
  options.forEach(option => {
    option.classList.remove('selected', 'correct', 'incorrect', 'disabled');
    // 既存の×ラベルも削除
    const existingLabel = option.querySelector('.incorrect-label');
    if (existingLabel) {
      existingLabel.remove();
    }
    // スタイルもリセット
    option.style.background = '';
    option.style.color = '';
    option.style.borderColor = '';
  });
  
  // 状態をリセット
  session.selectedAnswer = null;
  session.isChecked = false;
  
  // ボタンとフィードバックを非表示
  const checkBtn = $('pronounCheckBtn');
  const resetBtn = $('pronounResetBtn');
  const nextBtn = $('pronounNextBtn');
  const finishBtn = $('pronounFinishBtn');
  const feedbackEl = $('pronounFeedback');
  
  if (checkBtn) checkBtn.style.display = 'none';
  if (resetBtn) resetBtn.style.display = 'inline-block';
  if (nextBtn) nextBtn.style.display = 'none';
  if (finishBtn) finishBtn.style.display = 'none';
  if (feedbackEl) feedbackEl.style.display = 'none';
}

// 次の指示語問題へ
function nextPronounProblem() {
  const session = currentPronounSession;
  
  if (session.currentIndex < session.problems.length - 1) {
    session.currentIndex++;
    
    const contentContainer = document.getElementById('pronounReferenceGame');
    transitionToNextProblem(contentContainer, () => {
      displayCurrentPronounProblem();
    });
  }
}

// 指示語問題の結果を表示
function showPronounResults() {
  const session = currentPronounSession;
  const totalProblems = session.problems.length;
  const correctAnswers = session.score;
  const percentage = Math.round((correctAnswers / totalProblems) * 100);
  
  let grade = 'C';
  let comment = 'もう一度チャレンジしてみましょう！';
  
  if (percentage >= 90) {
    grade = 'S';
    comment = '素晴らしい！指示語の理解が完璧です！';
  } else if (percentage >= 80) {
    grade = 'A';
    comment = 'とても良くできました！指示語をよく理解しています。';
  } else if (percentage >= 70) {
    grade = 'B';
    comment = 'よくできました！もう少し練習すれば完璧です。';
  } else if (percentage >= 60) {
    grade = 'C';
    comment = 'もう少し頑張りましょう！指示語の基本を復習してみてください。';
  }
  
  const resultEl = $('pronounGameResult');
  if (resultEl) {
    resultEl.style.display = 'block';
    resultEl.innerHTML = `
      <div style="text-align:center;padding:32px;background:#f8f9fa;border-radius:12px;margin-top:24px;">
        <h3 style="color:#20B2AA;margin-bottom:16px;">結果発表</h3>
        <div style="font-size:48px;color:#20B2AA;margin-bottom:16px;">${grade}</div>
        <div style="font-size:24px;margin-bottom:16px;">${correctAnswers} / ${totalProblems} 問正解</div>
        <div style="font-size:18px;color:#666;margin-bottom:24px;">${percentage}%</div>
        <div style="font-size:16px;color:#333;margin-bottom:24px;">${comment}</div>
                  <button onclick="showBox(logicTrainingBox)" style="background:#20B2AA;color:white;border:none;padding:12px 24px;border-radius:8px;font-size:16px;cursor:pointer;">
          メニューに戻る
        </button>
      </div>
    `;
  }
}

// プロ品質の爽快なアニメーション（正解時）
function showBigGreenCircle() {
  showSuccessAnimation();
}

// 爽快な正解アニメーション
function showSuccessAnimation(message = '正解！') {
  const container = document.getElementById('successAnimationContainer');
  const particlesContainer = document.getElementById('successParticles');
  const messageElement = document.getElementById('successMessage');
  
  if (!container) return;
  
  // メッセージを設定
  messageElement.textContent = message;
  
  // コンテナを表示
  container.style.display = 'block';
  
  // パーティクルを生成
  createSuccessParticles(particlesContainer);
  
  // 星を追加
  createSuccessStars(container);
  
  // 1.5秒後にフェードアウト開始
  setTimeout(() => {
    container.style.opacity = '0';
    container.style.transition = 'opacity 0.5s ease-out';
  }, 1500);
  
  // 2秒後に完全に非表示
  setTimeout(() => {
    container.style.display = 'none';
    container.style.opacity = '1';
    container.style.transition = '';
    
    // パーティクルと星をクリア
    particlesContainer.innerHTML = '';
    container.querySelectorAll('.success-star').forEach(star => star.remove());
    container.querySelectorAll('.success-big-star').forEach(star => star.remove());
    container.querySelectorAll('.shooting-star').forEach(star => star.remove());
  }, 2000);
}

// キラキラパーティクルを生成
function createSuccessParticles(container) {
  const particleCount = 60; // パーティクル数も大幅増量
  const colors = ['#20B2AA', '#48D1CC', '#40E0D0', '#66CDAA', '#ffd700', '#fff'];
  
  for (let i = 0; i < particleCount; i++) {
    const particle = document.createElement('div');
    particle.className = 'particle';
    
    // ランダムな位置と色
    const x = Math.random() * 100;
    const y = Math.random() * 100;
    const color = colors[Math.floor(Math.random() * colors.length)];
    const size = Math.random() * 6 + 4; // 4-10px
    const delay = Math.random() * 0.5;
    
    particle.style.left = `${x}%`;
    particle.style.top = `${y}%`;
    particle.style.backgroundColor = color;
    particle.style.width = `${size}px`;
    particle.style.height = `${size}px`;
    particle.style.animationDelay = `${delay}s`;
    
    // ランダムな方向に飛ばす
    const angle = Math.random() * Math.PI * 2;
    const distance = Math.random() * 200 + 100;
    particle.style.setProperty('--end-x', `${Math.cos(angle) * distance}px`);
    particle.style.setProperty('--end-y', `${Math.sin(angle) * distance}px`);
    
    container.appendChild(particle);
  }
}

// ☆と★アニメーションを生成
function createSuccessStars(container) {
  const starCount = 50; // 大幅に増量！
  const starTypes = ['☆', '★']; // テキストベースの星のみ
  const colors = ['#FFD700', '#00CED1']; // 黄色と水色のみ
  
  for (let i = 0; i < starCount; i++) {
    const star = document.createElement('div');
    star.className = 'success-star';
    star.textContent = starTypes[Math.floor(Math.random() * starTypes.length)];
    
    // ランダムな色とサイズ
    const color = colors[Math.floor(Math.random() * colors.length)];
    const size = Math.random() * 30 + 15; // 15-45px
    const rotation = Math.random() * 360;
    
    star.style.cssText = `
      position: absolute;
      font-size: ${size}px;
      color: ${color};
      opacity: 0.9;
      font-weight: bold;
             animation: starTwinkle ${Math.random() * 1 + 1}s ease-out;
       transform: rotate(${rotation}deg);
    `;
    
    // ランダムな位置
    const x = Math.random() * 100; // 0-100%
    const y = Math.random() * 100; // 0-100%
    const delay = Math.random() * 1.2;
    
    star.style.left = `${x}%`;
    star.style.top = `${y}%`;
    star.style.animationDelay = `${delay}s`;
    
    container.appendChild(star);
  }
  
  // 追加の大きな星エフェクト
  createBigStars(container);
  
  // 流れ星エフェクト
  createShootingStars(container);
}

// 大きな星のエフェクト
function createBigStars(container) {
  const bigStarCount = 12; // さらに増量
  const bigStarTypes = ['☆', '★'];
  const starColors = ['#FFD700', '#00CED1']; // 黄色と水色のみ
  
  for (let i = 0; i < bigStarCount; i++) {
    const star = document.createElement('div');
    star.className = 'success-big-star';
    star.textContent = bigStarTypes[Math.floor(Math.random() * bigStarTypes.length)];
    
    const color = starColors[Math.floor(Math.random() * starColors.length)];
    const size = Math.random() * 50 + 40; // 40-90px
    
    star.style.cssText = `
      position: absolute;
      font-size: ${size}px;
      color: ${color};
      opacity: 0;
      font-weight: bold;
             animation: bigStarBurst ${Math.random() * 0.7 + 1.3}s ease-out;
       z-index: 1000;
    `;
    
    // 中央付近にランダム配置
    const x = Math.random() * 70 + 15; // 15-85%
    const y = Math.random() * 70 + 15; // 15-85%
    const delay = Math.random() * 1.2;
    
    star.style.left = `${x}%`;
    star.style.top = `${y}%`;
    star.style.animationDelay = `${delay}s`;
    
    container.appendChild(star);
  }
}

// 流れ星エフェクト
function createShootingStars(container) {
  const shootingStarCount = 5;
  const shootingColors = ['#FFD700', '#00CED1']; // 黄色と水色のみ
  
  for (let i = 0; i < shootingStarCount; i++) {
    const star = document.createElement('div');
    star.className = 'shooting-star';
    star.textContent = '★';
    
    const color = shootingColors[Math.floor(Math.random() * shootingColors.length)];
    
    star.style.cssText = `
      position: absolute;
      font-size: 24px;
      color: ${color};
      opacity: 0;
      animation: shootingStar 2s ease-out;
    `;
    
    // 画面の端からスタート
    const startSide = Math.floor(Math.random() * 4); // 0:上 1:右 2:下 3:左
    const delay = Math.random() * 1.5;
    
    switch(startSide) {
      case 0: // 上から
        star.style.left = `${Math.random() * 100}%`;
        star.style.top = '-5%';
        star.style.setProperty('--end-x', `${(Math.random() - 0.5) * 200}%`);
        star.style.setProperty('--end-y', '105%');
        break;
      case 1: // 右から
        star.style.left = '105%';
        star.style.top = `${Math.random() * 100}%`;
        star.style.setProperty('--end-x', '-5%');
        star.style.setProperty('--end-y', `${(Math.random() - 0.5) * 200}%`);
        break;
      case 2: // 下から
        star.style.left = `${Math.random() * 100}%`;
        star.style.top = '105%';
        star.style.setProperty('--end-x', `${(Math.random() - 0.5) * 200}%`);
        star.style.setProperty('--end-y', '-5%');
        break;
      case 3: // 左から
        star.style.left = '-5%';
        star.style.top = `${Math.random() * 100}%`;
        star.style.setProperty('--end-x', '105%');
        star.style.setProperty('--end-y', `${(Math.random() - 0.5) * 200}%`);
        break;
    }
    
    star.style.animationDelay = `${delay}s`;
    container.appendChild(star);
  }
}

// パーティクルの軌道をCSSカスタムプロパティで制御
const style = document.createElement('style');
style.textContent = `
  .particle {
    --end-x: 0px;
    --end-y: 0px;
  }
  
  .shooting-star {
    --end-x: 0px;
    --end-y: 0px;
  }
  
  @keyframes particleFloat {
    0% {
      opacity: 1;
      transform: translateY(0) translateX(0) scale(0);
    }
    10% {
      transform: translateY(-20px) translateX(0) scale(1);
    }
    100% {
      opacity: 0;
      transform: translateY(var(--end-y)) translateX(var(--end-x)) scale(0.5);
    }
  }
  
  @keyframes starTwinkle {
    0% {
      opacity: 0;
      transform: scale(0) rotate(0deg);
    }
    20% {
      opacity: 1;
      transform: scale(1.2) rotate(72deg);
    }
    40% {
      transform: scale(1) rotate(144deg);
    }
    60% {
      transform: scale(1.1) rotate(216deg);
    }
    80% {
      transform: scale(0.9) rotate(288deg);
    }
    100% {
      opacity: 0;
      transform: scale(0) rotate(360deg);
    }
  }
  
  @keyframes bigStarBurst {
    0% {
      opacity: 0;
      transform: scale(0) rotate(0deg);
    }
    15% {
      opacity: 1;
      transform: scale(1.5) rotate(180deg);
    }
    30% {
      transform: scale(1.2) rotate(360deg);
    }
    50% {
      transform: scale(1.3) rotate(540deg);
    }
    70% {
      transform: scale(1.1) rotate(720deg);
    }
    100% {
      opacity: 0;
      transform: scale(0) rotate(900deg);
    }
  }
  
  @keyframes shootingStar {
    0% {
      opacity: 0;
      transform: translateX(0) translateY(0) scale(0);
    }
    10% {
      opacity: 1;
      transform: translateX(0) translateY(0) scale(1);
    }
    90% {
      opacity: 0.5;
      transform: translateX(var(--end-x)) translateY(var(--end-y)) scale(0.5);
    }
    100% {
      opacity: 0;
      transform: translateX(var(--end-x)) translateY(var(--end-y)) scale(0);
    }
  }
`;
document.head.appendChild(style);

// 紙吹雪演出とクリア表示
function showConfettiCelebration() {
  // クリア！メッセージと波紋効果のコンテナを作成
  const clearContainer = document.createElement('div');
  clearContainer.className = 'clear-animation-container';
  clearContainer.style.cssText = `
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    pointer-events: none;
    z-index: 10001;
    display: block;
  `;
  
  // 波紋リングを追加
  const ring1 = document.createElement('div');
  ring1.className = 'clear-ring';
  ring1.style.cssText = `
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    border: 4px solid;
    border-color: #FF6B35 transparent #FF8E53 transparent;
    border-radius: 50%;
    width: 100px;
    height: 100px;
    opacity: 0;
         animation: clearRingExpand 0.6s ease-out forwards;
     animation-delay: 0s;
  `;
  
  const ring2 = document.createElement('div');
  ring2.className = 'clear-ring';
  ring2.style.cssText = `
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    border: 4px solid;
    border-color: #FF6B35 transparent #FF8E53 transparent;
    border-radius: 50%;
    width: 150px;
    height: 150px;
    opacity: 0;
         animation: clearRingExpand 0.6s ease-out forwards;
     animation-delay: 0.1s;
  `;
  
  const ring3 = document.createElement('div');
  ring3.className = 'clear-ring';
  ring3.style.cssText = `
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    border: 4px solid;
    border-color: #FF6B35 transparent #FF8E53 transparent;
    border-radius: 50%;
    width: 200px;
    height: 200px;
    opacity: 0;
         animation: clearRingExpand 0.6s ease-out forwards;
     animation-delay: 0.2s;
  `;
  
  // クリア！メッセージを表示
  const clearMessage = document.createElement('div');
  clearMessage.className = 'confetti-clear-message';
  clearMessage.textContent = 'クリア！';
  
  clearContainer.appendChild(ring1);
  clearContainer.appendChild(ring2);
  clearContainer.appendChild(ring3);
  clearContainer.appendChild(clearMessage);
  document.body.appendChild(clearContainer);
  
  // 紙吹雪コンテナを作成
  const confettiContainer = document.createElement('div');
  confettiContainer.className = 'confetti-container';
  document.body.appendChild(confettiContainer);
  

  
  // カラフルで鮮やかな色の紙吹雪を生成
  const colors = [
    '#FF0000', '#FF4500', '#FF8C00', '#FFD700', '#FFFF00',
    '#ADFF2F', '#00FF00', '#00FF7F', '#00FFFF', '#1E90FF',
    '#0000FF', '#8A2BE2', '#9400D3', '#FF00FF', '#FF1493',
    '#FF69B4', '#FF6347', '#FF4500', '#FFA500', '#FFD700',
    '#32CD32', '#00CED1', '#4169E1', '#8B008B', '#DC143C',
    '#FF8C00', '#FF0000', '#00FF00', '#0000FF', '#FF00FF',
    '#00FFFF', '#FFFF00', '#FFA500', '#FF69B4', '#9400D3',
    '#32CD32', '#FF4500', '#1E90FF', '#FF1493', '#FFD700',
    '#00FF7F', '#8A2BE2', '#FF6347', '#00CED1', '#ADFF2F',
    '#FF8C00', '#0000FF', '#FF00FF', '#00FFFF', '#FFFF00'
  ];
  
  const confettiCount = 400; // 数を大幅に増加
  
  // 短時間で集中的に紙吹雪を放出
  for (let i = 0; i < confettiCount; i++) {
    // 3秒間で集中的に落とす
    const randomDelay = Math.random() * 3000; // 0〜3秒の間でランダム
    setTimeout(() => {
      createConfettiPiece(confettiContainer, colors);
    }, randomDelay);
  }
  
  // キラキラ効果を追加
  for (let i = 0; i < 30; i++) {
    setTimeout(() => {
      createSparkleEffect(confettiContainer);
    }, Math.random() * 2500);
  }
  
  // 60秒後にクリーンアップ（クリアメッセージをとても長く表示）
  setTimeout(() => {
    clearContainer.remove();
    confettiContainer.remove();
  }, 60000);
}

function createConfettiPiece(container, colors) {
  const piece = document.createElement('div');
  piece.className = 'confetti-piece';
  
  // ランダムな色
  const color = colors[Math.floor(Math.random() * colors.length)];
  piece.style.backgroundColor = color;
  
  // ランダムな開始位置（画面上部）
  const startX = Math.random() * 100;
  piece.style.left = startX + '%';
  piece.style.top = '-50px';
  
  // ランダムなサイズと形（四角形と長方形のみ）
  const size = Math.random() * 8 + 6; // 6-14px
  const shape = Math.random();
  
  if (shape < 0.5) {
    // 四角形
    piece.style.width = size + 'px';
    piece.style.height = size + 'px';
    piece.style.borderRadius = '0';
  } else {
    // 長方形
    piece.style.width = size + 'px';
    piece.style.height = (size * 2) + 'px';
    piece.style.borderRadius = '2px';
  }
  
  // ランダムな落下速度と回転（高速落下）
  const duration = Math.random() * 1.5 + 1; // 1-2.5秒で高速落下
  const rotation = Math.random() * 360;
  const delay = Math.random() * 2;
  
  piece.style.animation = `confetti-fall ${duration}s linear ${delay}s forwards`;
  piece.style.transform = `rotate(${rotation}deg)`;
  
  container.appendChild(piece);
  
  // アニメーション完了後に削除
  setTimeout(() => {
    if (piece.parentNode) {
      piece.parentNode.removeChild(piece);
    }
  }, (duration + delay) * 1000);
}

function createSparkleEffect(container) {
  const sparkle = document.createElement('div');
  sparkle.className = 'sparkle-effect';
  sparkle.textContent = '*'; // 星記号
  
  // ランダムな位置
  sparkle.style.left = Math.random() * 100 + '%';
  sparkle.style.top = Math.random() * 100 + '%';
  
  // ランダムなサイズ
  const size = Math.random() * 20 + 12;
  sparkle.style.fontSize = size + 'px';
  
  // ランダムな遅延
  const delay = Math.random() * 0.5;
  sparkle.style.animationDelay = delay + 's';
  
  container.appendChild(sparkle);
  
  // アニメーション完了後に削除
  setTimeout(() => {
    if (sparkle.parentNode) {
      sparkle.parentNode.removeChild(sparkle);
    }
  }, (1.2 + delay) * 1000);
}

// 間違えた選択肢に×ラベルを追加する汎用関数
function addIncorrectLabel(element) {
  // 既存の×ラベルがあれば削除
  const existingLabel = element.querySelector('.incorrect-label');
  if (existingLabel) {
    existingLabel.remove();
  }
  
  // ×ラベルを作成
  const label = document.createElement('span');
  label.className = 'incorrect-label';
  label.textContent = '×';
  
  // 主語・述語問題の場合は上側に配置
  const isSubjectPredicate = element.classList.contains('subject-predicate-word');
  
  if (isSubjectPredicate) {
    label.style.cssText = `
      position: absolute;
      left: -30px;
      top: 50%;
      transform: translateY(-50%);
      background: #f44336;
      color: white;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      font-weight: bold;
      z-index: 10;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    `;
  } else {
    label.style.cssText = `
      position: absolute;
      right: -30px;
      top: 50%;
      transform: translateY(-50%);
      background: #f44336;
      color: white;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      font-weight: bold;
      z-index: 10;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    `;
  }
  
  // 要素の位置を相対位置に設定
  if (getComputedStyle(element).position === 'static') {
    element.style.position = 'relative';
  }
  
  element.appendChild(label);
}

function showBigRedCross() {
  // 既存の×があれば削除
  const existingCross = document.querySelector('.simple-cross');
  if (existingCross) {
    existingCross.remove();
  }
  
  // 赤い×を作成
  const cross = document.createElement('div');
  cross.className = 'simple-cross';
  cross.textContent = '×';
  cross.style.cssText = `
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 200px;
    font-weight: bold;
    color: #f44336;
    z-index: 10000;
    pointer-events: none;
    text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    animation: showCircle 2s ease-out;
  `;
  
  // bodyに追加
  document.body.appendChild(cross);
  
  // 2秒後に削除
  setTimeout(() => {
    if (cross && cross.parentNode) {
      cross.parentNode.removeChild(cross);
    }
  }, 2000);
}

// 文節並び替え問題の初期化
async function initClauseRearrangementProblem() {
  try {
    // 問題データを読み込み
    const response = await fetch('clause_rearrangement_problems.json');
    if (!response.ok) {
      throw new Error('問題データの読み込みに失敗しました');
    }
    const data = await response.json();
    
    // 入門編の問題のみを使用
    clauseRearrangementProblems = data.problems.filter(p => p.level === 'intro');
    
    // セッションを初期化
    currentClauseRearrangementSession = {
      problems: clauseRearrangementProblems,
      currentIndex: 0,
      userOrder: [],
      score: 0,
      isChecked: false
    };
    
    // 最初の問題を表示
    displayCurrentClauseRearrangementProblem();
    
    // ボタンイベントを設定
    setupClauseRearrangementButtons();
    
  } catch (error) {
    console.error('文節並び替え問題の初期化エラー:', error);
    alert('問題の読み込みに失敗しました。');
  }
}

// 現在の文節並び替え問題を表示
function displayCurrentClauseRearrangementProblem() {
  const session = currentClauseRearrangementSession;
  const problem = session.problems[session.currentIndex];
  
  // 進捗を更新
  const progressEl = document.getElementById('clauseRearrangementProblemProgress');
  if (progressEl) {
    const progressBar = progressEl.querySelector('div:last-child > div');
    const progressText = progressEl.querySelector('div:first-child');
    const progress = ((session.currentIndex + 1) / session.problems.length) * 100;
    
    progressText.textContent = `${session.currentIndex + 1}/${session.problems.length}`;
    progressBar.style.width = `${progress}%`;
  }
  
  // 既存のスロットがあれば色をリセット
  const existingSlots = document.querySelectorAll('.clause-input-slot');
  existingSlots.forEach(slot => {
    slot.classList.remove('correct', 'incorrect', 'filled');
    const card = slot.querySelector('.clause-card');
    if (card) {
      card.style.pointerEvents = 'auto';
    }
  });
  
  // 入力スロットを作成
  createInputSlots(problem.correct_order.length);
  
  // 文節カードを作成
  createClauseCards(problem.scrambled_bunsetsu);
  
  // 状態をリセット
  session.userOrder = [];
  session.isChecked = false;
  
  // フィードバックを非表示
  const feedbackEl = document.getElementById('clauseRearrangementFeedback');
  if (feedbackEl) {
    feedbackEl.style.display = 'none';
  }
  
  // ボタンを初期状態に戻す
  const checkBtn = document.getElementById('clauseRearrangementCheckBtn');
  const resetBtn = document.getElementById('clauseRearrangementResetBtn');
  const nextBtn = document.getElementById('clauseRearrangementNextBtn');
  const finishBtn = document.getElementById('clauseRearrangementFinishBtn');
  
  if (checkBtn) checkBtn.style.display = 'inline-block';
  if (resetBtn) resetBtn.style.display = 'inline-block';
  if (nextBtn) nextBtn.style.display = 'none';
  if (finishBtn) finishBtn.style.display = 'none';
}

// 入力スロットを作成
function createInputSlots(count) {
  const session = currentClauseRearrangementSession;
  const problem = session.problems[session.currentIndex];
  const slotsContainer = document.getElementById('clauseInputSlots');
  slotsContainer.innerHTML = '';
  
  for (let i = 0; i < count; i++) {
    const slot = document.createElement('div');
    slot.className = 'clause-input-slot';
    slot.dataset.index = i;
    
    // 対応する正解文節の文字数に応じたクラスを追加
    if (problem && problem.correct_order && problem.correct_order[i]) {
      const correctText = problem.correct_order[i];
      const charCount = correctText.length;
      if (charCount === 1) {
        slot.classList.add('char-1');
      } else if (charCount === 2) {
        slot.classList.add('char-2');
      } else if (charCount === 3) {
        slot.classList.add('char-3');
      } else if (charCount === 4) {
        slot.classList.add('char-4');
      } else {
        slot.classList.add('char-5-plus');
      }
    }
    
    // ドラッグ&ドロップイベント
    slot.addEventListener('dragover', handleDragOver);
    slot.addEventListener('drop', handleDrop);
    slot.addEventListener('dragleave', handleDragLeave);
    
    slotsContainer.appendChild(slot);
  }
}

// 文節カードを作成
function createClauseCards(bunsetsu) {
  const cardsContainer = document.getElementById('clauseCards');
  cardsContainer.innerHTML = '';
  
  // カードをシャッフル
  const shuffledBunsetsu = [...bunsetsu].sort(() => Math.random() - 0.5);
  
  shuffledBunsetsu.forEach((text, index) => {
    const card = document.createElement('div');
    card.className = 'clause-card';
    card.textContent = text;
    card.draggable = true;
    card.dataset.text = text;
    card.dataset.originalIndex = index;
    
    // 文字数に応じたクラスを追加
    const charCount = text.length;
    if (charCount === 1) {
      card.classList.add('char-1');
    } else if (charCount === 2) {
      card.classList.add('char-2');
    } else if (charCount === 3) {
      card.classList.add('char-3');
    } else if (charCount === 4) {
      card.classList.add('char-4');
    } else {
      card.classList.add('char-5-plus');
    }
    
    // ドラッグイベント
    card.addEventListener('dragstart', handleDragStart);
    card.addEventListener('dragend', handleDragEnd);
    
    cardsContainer.appendChild(card);
  });
}

// ドラッグ開始
function handleDragStart(e) {
  e.dataTransfer.setData('text/plain', e.target.dataset.text);
  e.target.classList.add('dragging');
}

// ドラッグ終了
function handleDragEnd(e) {
  e.target.classList.remove('dragging');
}

// ドラッグオーバー
function handleDragOver(e) {
  e.preventDefault();
  e.currentTarget.classList.add('drag-over');
}

// ドラッグリーブ
function handleDragLeave(e) {
  e.currentTarget.classList.remove('drag-over');
}

// ドロップ
function handleDrop(e) {
  e.preventDefault();
  const slot = e.currentTarget;
  const draggedText = e.dataTransfer.getData('text/plain');
  const draggedCard = document.querySelector(`.clause-card[data-text="${draggedText}"]`);
  
  slot.classList.remove('drag-over');
  
  if (!draggedCard) return;
  
  // 既にカードが入っている場合は元の場所に戻す
  const existingCard = slot.querySelector('.clause-card');
  if (existingCard) {
    // 既存のカードを元の場所に戻す
    returnCardToOriginalPlace(existingCard);
  }
  
  // 新しいカードをスロットに配置
  const clonedCard = draggedCard.cloneNode(true);
  clonedCard.style.opacity = '0';
  clonedCard.style.transform = 'scale(0.8)';
  
  // 文字数に応じたクラスを継承
  const text = draggedText;
  const charCount = text.length;
  clonedCard.className = 'clause-card';
  if (charCount === 1) {
    clonedCard.classList.add('char-1');
  } else if (charCount === 2) {
    clonedCard.classList.add('char-2');
  } else if (charCount === 3) {
    clonedCard.classList.add('char-3');
  } else if (charCount === 4) {
    clonedCard.classList.add('char-4');
  } else {
    clonedCard.classList.add('char-5-plus');
  }
  
  // 配置時の初期スタイル（透明）を設定
  clonedCard.style.background = 'transparent';
  clonedCard.style.border = 'none';
  clonedCard.style.color = '#333';
  clonedCard.style.position = 'absolute';
  clonedCard.style.top = '0';
  clonedCard.style.left = '0';
  clonedCard.style.width = '100%';
  clonedCard.style.height = '100%';
  clonedCard.style.margin = '0';
  clonedCard.style.padding = '12px 8px';
  clonedCard.style.boxSizing = 'border-box';
  
  slot.appendChild(clonedCard);
  slot.classList.add('filled');
  
  // スムーズなアニメーション
  setTimeout(() => {
    clonedCard.style.transition = 'all 0.3s ease';
    clonedCard.style.opacity = '1';
    clonedCard.style.transform = 'scale(1)';
  }, 10);
  
  // 元のカードを非表示
  draggedCard.style.display = 'none';
  
  // 配置されたカードにクリックイベントを追加（取り除くため）
  clonedCard.addEventListener('click', () => {
    // クリック時のフィードバック
    clonedCard.style.transform = 'scale(0.95)';
    setTimeout(() => {
      returnCardToOriginalPlace(clonedCard);
      slot.classList.remove('filled');
    }, 100);
  });
}

// カードを元の場所に戻す
function returnCardToOriginalPlace(card) {
  const text = card.textContent;
  const originalCard = document.querySelector(`#clauseCards .clause-card[data-text="${text}"][style*="display: none"]`);
  
  if (originalCard) {
    // 元のカードを表示する際のアニメーション
    originalCard.style.opacity = '0';
    originalCard.style.transform = 'scale(0.8)';
    originalCard.style.display = 'flex';
    
    // 文字数クラスを復元
    const charCount = text.length;
    originalCard.className = 'clause-card';
    if (charCount === 1) {
      originalCard.classList.add('char-1');
    } else if (charCount === 2) {
      originalCard.classList.add('char-2');
    } else if (charCount === 3) {
      originalCard.classList.add('char-3');
    } else if (charCount === 4) {
      originalCard.classList.add('char-4');
    } else {
      originalCard.classList.add('char-5-plus');
    }
    
    // 元のカードのスタイルを復元
    originalCard.style.background = '#fff';
    originalCard.style.border = '2px solid #FF9800';
    originalCard.style.color = '#333';
    originalCard.style.pointerEvents = 'auto';
    
    setTimeout(() => {
      originalCard.style.transition = 'all 0.3s ease';
      originalCard.style.opacity = '1';
      originalCard.style.transform = 'scale(1)';
    }, 10);
  }
  
  // 配置されたカードをフェードアウト
  card.style.transition = 'all 0.2s ease';
  card.style.opacity = '0';
  card.style.transform = 'scale(0.8)';
  
  setTimeout(() => {
    card.remove();
  }, 200);
}

// 文節並び替え問題の答えをチェック
function checkClauseRearrangementAnswer() {
  const session = currentClauseRearrangementSession;
  const problem = session.problems[session.currentIndex];
  
  // 現在の配置を取得
  const slots = document.querySelectorAll('.clause-input-slot');
  const userOrder = [];
  
  slots.forEach(slot => {
    const card = slot.querySelector('.clause-card');
    if (card) {
      userOrder.push(card.textContent);
    } else {
      userOrder.push('');
    }
  });
  
  // 空のスロットがあるかチェック
  if (userOrder.includes('')) {
    alert('すべての入力欄に文節カードを配置してください。');
    return;
  }
  
  session.userOrder = userOrder;
  session.isChecked = true;
  
  // 正解チェック
  const isCorrect = JSON.stringify(userOrder) === JSON.stringify(problem.correct_order);
  
  // 各スロットの正解・不正解を判定して色を変更
  slots.forEach((slot, index) => {
    const userText = userOrder[index];
    const correctText = problem.correct_order[index];
    const card = slot.querySelector('.clause-card');
    
    if (userText === correctText) {
      slot.classList.add('correct');
      slot.classList.remove('incorrect');
      
      // カードのスタイルを直接設定して確実に適用
      if (card) {
        card.style.background = '#20B2AA';
        card.style.color = 'white';
        card.style.border = '3px solid #00695C';
        card.style.transform = 'scale(1.1)';
        card.style.zIndex = '10';
        card.style.pointerEvents = 'none';
      }
    } else {
      slot.classList.add('incorrect');
      slot.classList.remove('correct');
      
      // カードのスタイルを直接設定して確実に適用
      if (card) {
        card.style.background = '#DC143C';
        card.style.color = 'white';
        card.style.border = '3px solid #B22222';
        card.style.transform = 'scale(1.1)';
        card.style.zIndex = '10';
        card.style.pointerEvents = 'none';
      }
    }
  });
  
  if (isCorrect) {
    session.score++;
    showSuccessAnimation('正解です！');
  }
  
  // フィードバックを表示
  showClauseRearrangementFeedback(isCorrect, problem);
  
  // ボタンを更新
  updateClauseRearrangementButtons(isCorrect);
}

// フィードバックを表示
function showClauseRearrangementFeedback(isCorrect, problem) {
  const feedbackEl = document.getElementById('clauseRearrangementFeedback');
  if (!feedbackEl) return;
  
  feedbackEl.style.display = 'block';
  feedbackEl.style.opacity = '1';
  feedbackEl.className = `clause-feedback ${isCorrect ? 'correct' : 'incorrect'}`;
  feedbackEl.style.backgroundColor = isCorrect ? '#e0f2f1' : '#fce4ec';
  feedbackEl.style.color = isCorrect ? '#00695c' : '#880e4f';
  feedbackEl.style.border = `2px solid ${isCorrect ? '#4db6ac' : '#f06292'}`;
  
  let feedbackText = isCorrect ? 
    '正解です！' : 
    `不正解です。正解は「${problem.correct_sentence}」です。`;
  
  if (problem.explanation) {
    feedbackText += `<br><br>解説: ${problem.explanation}`;
  }
  
  if (problem.hint && !isCorrect) {
    feedbackText += `<br><br>ヒント: ${problem.hint}`;
  }
  
  feedbackEl.innerHTML = feedbackText;
}

// ボタンを更新
function updateClauseRearrangementButtons(isCorrect) {
  const session = currentClauseRearrangementSession;
  const checkBtn = document.getElementById('clauseRearrangementCheckBtn');
  const resetBtn = document.getElementById('clauseRearrangementResetBtn');
  const nextBtn = document.getElementById('clauseRearrangementNextBtn');
  const finishBtn = document.getElementById('clauseRearrangementFinishBtn');
  
  if (checkBtn) checkBtn.style.display = 'none';
  if (resetBtn) resetBtn.style.display = 'none';
  
  if (isCorrect) {
    // 正解の場合は次の問題へ
    if (session.currentIndex < session.problems.length - 1) {
      if (nextBtn) nextBtn.style.display = 'inline-block';
    } else {
      if (finishBtn) finishBtn.style.display = 'inline-block';
    }
  } else {
    // 不正解の場合はリセットボタンを表示
    if (resetBtn) resetBtn.style.display = 'inline-block';
  }
}

// 文節並び替え問題をリセット
function resetClauseRearrangementProblem() {
  const session = currentClauseRearrangementSession;
  
  // すべての配置されたカードを元に戻す
  const slots = document.querySelectorAll('.clause-input-slot');
  slots.forEach(slot => {
    const card = slot.querySelector('.clause-card');
    if (card) {
      // カードのクリック機能を復活
      card.style.pointerEvents = 'auto';
      returnCardToOriginalPlace(card);
      slot.classList.remove('filled');
    }
    
    // 正解・不正解のクラスを削除
    slot.classList.remove('correct', 'incorrect');
  });
  
  // 状態をリセット
  session.userOrder = [];
  session.isChecked = false;
  
  // フィードバックを非表示
  const feedbackEl = document.getElementById('clauseRearrangementFeedback');
  if (feedbackEl) {
    feedbackEl.style.display = 'none';
  }
  
  // ボタンを初期状態に戻す
  const checkBtn = document.getElementById('clauseRearrangementCheckBtn');
  const resetBtn = document.getElementById('clauseRearrangementResetBtn');
  const nextBtn = document.getElementById('clauseRearrangementNextBtn');
  const finishBtn = document.getElementById('clauseRearrangementFinishBtn');
  
  if (checkBtn) checkBtn.style.display = 'inline-block';
  if (resetBtn) resetBtn.style.display = 'inline-block';
  if (nextBtn) nextBtn.style.display = 'none';
  if (finishBtn) finishBtn.style.display = 'none';
}

// 次の文節並び替え問題へ
function nextClauseRearrangementProblem() {
  const session = currentClauseRearrangementSession;
  
  if (session.currentIndex < session.problems.length - 1) {
    session.currentIndex++;
    
    const contentContainer = document.getElementById('clauseRearrangementBox');
    transitionToNextProblem(contentContainer, () => {
      displayCurrentClauseRearrangementProblem();
    });
  }
}

// 文節並び替え問題の結果を表示
function showClauseRearrangementResults() {
  const session = currentClauseRearrangementSession;
  const totalProblems = session.problems.length;
  const correctAnswers = session.score;
  const percentage = Math.round((correctAnswers / totalProblems) * 100);
  
  let grade = 'C';
  let comment = 'もう一度チャレンジしてみましょう！';
  
  if (percentage >= 90) {
    grade = 'S';
    comment = '素晴らしい！文節の並び替えが完璧です！';
  } else if (percentage >= 80) {
    grade = 'A';
    comment = 'とても良くできました！文の構造をよく理解しています。';
  } else if (percentage >= 70) {
    grade = 'B';
    comment = 'よくできました！もう少し練習すれば完璧です。';
  } else if (percentage >= 60) {
    grade = 'C';
    comment = 'もう少し頑張りましょう！文節の順序を復習してみてください。';
  }
  
  // 結果画面に遷移
  showBox(grammarResultBox);
  
  const resultEl = document.getElementById('grammarResultContent');
  if (resultEl) {
    resultEl.innerHTML = `
      <div style="text-align:center;padding:32px;">
        <h3 style="color:#16a34a;margin-bottom:16px;">文節並び替え問題 結果</h3>
        <div style="font-size:48px;color:#16a34a;margin-bottom:16px;">${grade}</div>
        <div style="font-size:24px;margin-bottom:16px;">${correctAnswers} / ${totalProblems} 問正解</div>
        <div style="font-size:18px;color:#666;margin-bottom:24px;">${percentage}%</div>
        <div style="font-size:16px;color:#333;margin-bottom:24px;">${comment}</div>
      </div>
    `;
  }
}

// 文節並び替え問題のボタンイベントを設定
function setupClauseRearrangementButtons() {
  const checkBtn = document.getElementById('clauseRearrangementCheckBtn');
  const resetBtn = document.getElementById('clauseRearrangementResetBtn');
  const nextBtn = document.getElementById('clauseRearrangementNextBtn');
  const finishBtn = document.getElementById('clauseRearrangementFinishBtn');
  const backBtn = document.getElementById('clauseRearrangementBackBtn');
  const homeBtn = document.getElementById('clauseRearrangementHomeBtn');
  
  if (checkBtn) {
    checkBtn.onclick = checkClauseRearrangementAnswer;
  }
  
  if (resetBtn) {
    resetBtn.onclick = resetClauseRearrangementProblem;
  }
  
  if (nextBtn) {
    nextBtn.onclick = nextClauseRearrangementProblem;
  }
  
  if (finishBtn) {
    finishBtn.onclick = showClauseRearrangementResults;
  }
  
  if (backBtn) {
    backBtn.onclick = () => showBox(grammarSubmenuBox);
  }
  
  if (homeBtn) {
    homeBtn.onclick = () => showBox(homeBox);
  }
}

// アイテムショップ機能
function showGemExchangeScreen() {
  console.log('===== showGemExchangeScreen開始 =====');
  
  showBox(gemExchangeBox);
  updateTreasureCounts();
  updateShopButtons();
  
  console.log('宝石交換所のボックスを表示しました');
  
  // 即座にカスタムアイテムを表示（強制実行）
  console.log('即座にloadCustomItems実行');
  loadCustomItems();
  
  // 複数のタイミングでカスタムアイテムを確実に表示
  setTimeout(() => {
    console.log('50ms後にloadCustomItems実行');
    loadCustomItems();
  }, 50);
  
  setTimeout(() => {
    console.log('200ms後にloadCustomItems実行');
    loadCustomItems();
  }, 200);
  
  setTimeout(() => {
    console.log('500ms後にloadCustomItems実行');
    loadCustomItems();
  }, 500);
  
  setTimeout(() => {
    console.log('1000ms後にloadCustomItems実行');
    loadCustomItems();
  }, 1000);
  
  // 宝石交換所表示中は定期的にカスタムアイテムをチェック
  startCustomItemsWatcher();
  
  console.log('===== showGemExchangeScreen完了 =====');
}

// カスタムアイテム表示の監視機能
let customItemsWatcherInterval = null;

function startCustomItemsWatcher() {
  // 既存の監視を停止
  if (customItemsWatcherInterval) {
    clearInterval(customItemsWatcherInterval);
  }
  
  // 宝石交換所が表示されている間、2秒ごとにカスタムアイテムをチェック
  customItemsWatcherInterval = setInterval(() => {
    if (isBoxActive(gemExchangeBox)) {
      const container = document.getElementById('customItemsList');
      const customItems = getCustomItems();
      
      // コンテナが存在し、カスタムアイテムがあるのに表示されていない場合
      if (container && customItems.length > 0 && container.children.length === 0) {
        console.log('カスタムアイテムが表示されていないため、再表示します');
        loadCustomItems();
      }
    } else {
      // 宝石交換所が表示されていない場合は監視を停止
      clearInterval(customItemsWatcherInterval);
      customItemsWatcherInterval = null;
    }
  }, 2000);
}

// 固定アイテムの購入
function buyItem(itemId, itemName, price) {
  if (diamonds < price) {
    alert(`宝石が足りません。あと${price - diamonds}個必要です。`);
    return;
  }
  
  const confirmPurchase = confirm(`「${itemName}」を<img src="diamond.png" alt="💎" style="display: inline; width: 1em; height: 1em; vertical-align: middle;">${price}個で購入しますか？`);
  if (!confirmPurchase) return;
  
  // 宝石を減らす
  diamonds -= price;
  updateTreasureCounts();
  updateShopButtons();
  
  // お祝いアニメーション
  showConfettiCelebration();
  
  // 成功メッセージ
  showSuccessMessage(`🎉「${itemName}」を購入しました！\nおうちの人にお知らせしてね！`);
  
  // 購入履歴を保存
  savePurchaseHistory({
    id: itemId,
    name: itemName,
    price: price
  });
}

// カスタムアイテムの追加
function addCustomItem() {
  const name = document.getElementById('customItemName').value.trim();
  const price = parseInt(document.getElementById('customItemPrice').value);
  
  if (!name) {
    alert('アイテム名を入力してください');
    return;
  }
  
  if (!price || price < 1) {
    alert('正しい宝石数を入力してください');
    return;
  }
  
  // カスタムアイテムを保存
  const customItems = getCustomItems();
  const newItem = {
    id: Date.now().toString(),
    name: name,
    price: price,
    created: new Date().toISOString()
  };
  
  customItems.push(newItem);
  saveCustomItems(customItems);
  
  // 入力フィールドをクリア
  document.getElementById('customItemName').value = '';
  document.getElementById('customItemPrice').value = '';
  
  // 新しいアイテムのみを追加（全体を再描画しない）
  addSingleCustomItem(newItem);
  
  showSuccessMessage(`「${name}」をアイテムリストに追加しました！`);
}

// 単一のカスタムアイテムを追加する関数
function addSingleCustomItem(item) {
  console.log('新しいアイテムを個別に追加:', item);
  
  const container = document.getElementById('customItemsList');
  if (!container) {
    console.log('コンテナが見つからないため、loadCustomItemsで全体更新');
    loadCustomItems();
    return;
  }
  
  // 新しいアイテムのHTMLを作成
  const itemHTML = `
    <div class="shop-item" data-custom-item="${item.id}">
      <div class="item-info">
        <div class="item-icon">✨</div>
        <div class="item-name">${item.name}</div>
      </div>
      <div class="item-price">
        <span class="price-gems"><img src="diamond.png" alt="💎" style="display: inline; width: 1em; height: 1em; vertical-align: middle;"> ${item.price}</span>
        <button class="buy-btn" onclick="buyCustomItem('${item.id}')">
          購入
        </button>
      </div>
    </div>
  `;
  
  // 新しいアイテムを最上部に追加
  container.insertAdjacentHTML('afterbegin', itemHTML);
  
  console.log('新しいアイテムを追加しました。現在の子要素数:', container.children.length);
}

// カスタムアイテムの管理
function getCustomItems() {
  try {
    return JSON.parse(localStorage.getItem('customItems') || '[]');
  } catch {
    return [];
  }
}

function saveCustomItems(items) {
  localStorage.setItem('customItems', JSON.stringify(items));
}

function loadCustomItems() {
  console.log('loadCustomItems開始');
  
  const customItems = getCustomItems();
  console.log('取得したカスタムアイテム:', customItems.length + '個', customItems);
  
  const container = document.getElementById('customItemsList');
  console.log('コンテナ要素:', container);
  
  // コンテナが見つからない場合は少し待ってから再試行
  if (!container) {
    console.log('コンテナが見つからないため、100ms後に再試行');
    setTimeout(() => loadCustomItems(), 100);
    return;
  }
  
  // 既存のカスタムアイテムを全てクリア（重複防止）
  console.log('既存のカスタムアイテムをクリア');
  container.innerHTML = '';
  
  if (customItems.length === 0) {
    console.log('カスタムアイテムがないため、空のまま');
    return;
  }
  
  // 新しいアイテムが上に来るように配列を逆順にする
  const reversedItems = [...customItems].reverse();
  
  const itemsHTML = reversedItems.map(item => `
    <div class="shop-item" data-custom-item="${item.id}">
      <div class="item-info">
        <div class="item-icon">✨</div>
        <div class="item-name">${item.name}</div>
      </div>
      <div class="item-price">
        <span class="price-gems"><img src="diamond.png" alt="💎" style="display: inline; width: 1em; height: 1em; vertical-align: middle;"> ${item.price}</span>
        <button class="buy-btn" onclick="buyCustomItem('${item.id}')">
          購入
        </button>
      </div>
    </div>
  `).join('');
  
  console.log('生成されたHTML:', itemsHTML.substring(0, 200) + '...');
  container.innerHTML = itemsHTML;
  
  console.log('カスタムアイテムを表示しました:', customItems.length + '個');
  console.log('コンテナの子要素数:', container.children.length);
}

function buyCustomItem(itemId) {
  const customItems = getCustomItems();
  const item = customItems.find(i => i.id === itemId);
  
  if (!item) {
    alert('アイテムが見つかりません');
    return;
  }
  
  buyItem(item.id, item.name, item.price);
  // loadCustomItems(); // 重複表示の原因なので削除
}

function removeCustomItem(itemId) {
  const customItems = getCustomItems();
  const item = customItems.find(i => i.id === itemId);
  
  if (!item) return;
  
  const confirmRemove = confirm(`「${item.name}」をリストから削除しますか？`);
  if (!confirmRemove) return;
  
  const filteredItems = customItems.filter(i => i.id !== itemId);
  saveCustomItems(filteredItems);
  loadCustomItems();
  
  showSuccessMessage(`「${item.name}」をリストから削除しました`);
}

// ショップボタンの状態更新
function updateShopButtons() {
  // 固定アイテムのボタン状態を更新
  const items = [
    { selector: '[data-item="ice-cream"] .buy-btn', price: 10 },
    { selector: '[data-item="toy"] .buy-btn', price: 25 },
    { selector: '[data-item="snack"] .buy-btn', price: 15 },
    { selector: '[data-item="book"] .buy-btn', price: 20 },
    { selector: '[data-item="game"] .buy-btn', price: 30 },
    { selector: '[data-item="movie"] .buy-btn', price: 50 }
  ];
  
  items.forEach(item => {
    const button = document.querySelector(item.selector);
    if (button) {
      if (diamonds < item.price) {
        button.disabled = true;
        button.textContent = '不足';
      } else {
        button.disabled = false;
        button.textContent = '購入';
      }
    }
  });
}

function savePurchaseHistory(item) {
  try {
    const history = JSON.parse(localStorage.getItem('purchaseHistory') || '[]');
    history.push({
      itemId: item.id,
      itemName: item.name,
      price: item.price,
      date: new Date().toISOString()
    });
    // 最新50件まで保持
    if (history.length > 50) {
      history.splice(0, history.length - 50);
    }
    localStorage.setItem('purchaseHistory', JSON.stringify(history));
  } catch {
    // エラーは無視
  }
}

// アイテムショップの初期化
function initGemExchange() {
  try {
    // 戻るボタンとホームボタンのイベントリスナー
    const gemExchangeBackBtn = document.getElementById('gemExchangeBackBtn');
    if (gemExchangeBackBtn) {
      gemExchangeBackBtn.onclick = () => showBox(homeBox);
    }
    
    const gemExchangeHomeBtn = document.getElementById('gemExchangeHomeBtn');
    if (gemExchangeHomeBtn) {
      gemExchangeHomeBtn.onclick = () => showBox(homeBox);
    }
    
    console.log('アイテムショップの初期化完了');
  } catch (error) {
    console.error('アイテムショップの初期化エラー:', error);
  }
}

function showSuccessMessage(message) {
  const messageDiv = document.createElement('div');
  messageDiv.style.cssText = `
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
    color: white;
    padding: 20px 30px;
    border-radius: 15px;
    font-size: 18px;
    font-weight: bold;
    z-index: 10000;
    box-shadow: 0 8px 32px rgba(0,0,0,0.3);
    animation: fadeInOut 3s ease-in-out;
  `;
  messageDiv.textContent = message;
  document.body.appendChild(messageDiv);
  
  setTimeout(() => {
    messageDiv.remove();
  }, 3000);
}

// ページ読み込み時に設定を復元
function initGemExchange() {
  const settings = loadGemExchangeSettings();
  
  const targetGemCountEl = document.getElementById('targetGemCount');
  const rewardDescriptionEl = document.getElementById('rewardDescription');
  const parentMemoEl = document.getElementById('parentMemo');
  
  if (settings.targetCount && targetGemCountEl) {
    targetGemCountEl.value = settings.targetCount;
  }
  if (settings.reward && rewardDescriptionEl) {
    rewardDescriptionEl.value = settings.reward;
  }
  if (settings.memo && parentMemoEl) {
    parentMemoEl.value = settings.memo;
  }
  
  displayCurrentPromise();
}

// 追加のCSS
const additionalCSS = document.createElement('style');
additionalCSS.textContent = `
  @keyframes fadeInOut {
    0%, 100% { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
    10%, 90% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
  }
`;
document.head.appendChild(additionalCSS);

// アプリケーション初期化
document.addEventListener('DOMContentLoaded', async () => {
  console.log('アプリケーション初期化開始');
  
  // 宝石交換機能を早期に初期化
  setTimeout(() => {
    initGemExchange();
    console.log('DOMContentLoaded内で宝石交換機能を初期化');
    
    // カスタムアイテムも初期化時にロード
    setTimeout(() => {
      loadCustomItems();
      console.log('DOMContentLoaded内でカスタムアイテムを初期化');
    }, 100);
  }, 10);
  
  // 文法トレーニングメニューの色をオレンジ系に変更（最強制版）
  const grammarColorStyle = document.createElement('style');
  grammarColorStyle.id = 'force-grammar-orange';
  grammarColorStyle.textContent = `
    /* 文法トレーニングメニューの色をオレンジ系に完全強制変更 */
    .grammar-item,
    .grammar-item[style],
    div.grammar-item {
      background: linear-gradient(135deg, #fff 0%, #fff7ed 100%) !important;
      box-shadow: 0 4px 12px rgba(234, 88, 12, 0.15) !important;
      border: 2px solid #fed7aa !important;
      border-color: #fed7aa !important;
    }
    
    .grammar-item:hover,
    .grammar-item[style]:hover,
    div.grammar-item:hover {
      background: linear-gradient(135deg, #fff 0%, #fff7ed 100%) !important;
      box-shadow: 0 8px 20px rgba(234, 88, 12, 0.25) !important;
      border-color: #ea580c !important;
      transform: translateY(-4px) !important;
    }
    
    .grammar-item:hover::after,
    .grammar-item[style]:hover::after,
    div.grammar-item:hover::after {
      content: '' !important;
      position: absolute !important;
      top: 0 !important;
      left: 0 !important;
      width: 8px !important;
      height: 100% !important;
      background: #ea580c !important;
      border-top-left-radius: 16px !important;
      border-bottom-left-radius: 16px !important;
      z-index: 2 !important;
    }
    
    .grammar-item::before,
    .grammar-item[style]::before,
    div.grammar-item::before {
      content: '' !important;
      position: absolute !important;
      top: 0 !important;
      left: 0 !important;
      right: 0 !important;
      height: 4px !important;
      background: linear-gradient(90deg, #3b82f6, #60a5fa) !important;
      border-top-left-radius: 16px !important;
      border-top-right-radius: 16px !important;
      z-index: 1 !important;
    }
    
    .grammar-item-title,
    .grammar-item .grammar-item-title,
    div.grammar-item .grammar-item-title {
      color: #1e40af !important;
    }
    
    .progress-numbers.low-progress,
    .grammar-item .progress-numbers.low-progress {
      background: linear-gradient(135deg, #eff6ff, #dbeafe) !important;
      color: #1e40af !important;
      border-color: rgba(59, 130, 246, 0.2) !important;
    }
    
    .progress-numbers.high-progress,
    .grammar-item .progress-numbers.high-progress {
      background: linear-gradient(135deg, #eff6ff, #dbeafe) !important;
      color: #1e40af !important;
      border-color: rgba(59, 130, 246, 0.2) !important;
    }
    
    .progress-fill,
    .grammar-item .progress-fill {
      background: #3b82f6 !important;
    }
    
    .grammar-item:hover .progress-fill {
      background: #60a5fa !important;
    }
    
    .grammar-item:hover .progress-bar {
      border-color: #3b82f6 !important;
    }
    
    .grammar-item-badge,
    .grammar-item .grammar-item-badge {
      background: #3b82f6 !important;
    }
    
    .grammar-item-badge.coming-soon,
    .grammar-item .grammar-item-badge.coming-soon {
      background: #60a5fa !important;
    }
    
    /* 文法トレーニング内の画面の色もオレンジに統一 */
    h3[style*="#16a34a"], h3[style*="color:#16a34a"] {
      color: #ea580c !important;
    }
    
    div[style*="color:#16a34a"] {
      color: #ea580c !important;
    }
    
    div[style*="color:#22c55e"] {
      color: #f97316 !important;
    }
    
    button[style*="background:#16a34a"] {
      background: #ea580c !important;
    }
    
    button[style*="background-color:#16a34a"] {
      background: #ea580c !important;
    }
    
    /* ロード画面の文字色も変更 */
    div[style*="font-size:18px;color:#16a34a"] {
      color: #ea580c !important;
    }
    
    /* ふりがな（ruby）のスタイル */
ruby {
  ruby-position: over;
}

rt {
  font-size: 0.6em;
  line-height: 1;
}

/* 縦書きでの意味のふりがな */
#kotowazaMeaning ruby {
  ruby-position: over;
}

#kotowazaMeaning rt {
  font-size: 0.5em;
  writing-mode: horizontal-tb;
  text-orientation: mixed;
  line-height: 1;
}

/* 意味表示の縦書き改善 */
#kotowazaMeaning {
  line-break: strict;
  word-break: keep-all;
  overflow-wrap: normal;
}

/* 縦書きでの改行対応 */
#kotowazaMeaning br {
  display: block;
  margin-left: 1em;
  content: "";
}

/* 横書きモード用のスタイル */
#kotowazaMeaning.horizontal-mode {
  writing-mode: horizontal-tb !important;
  text-orientation: mixed !important;
  text-align: left !important;
  height: auto !important;
  max-height: 300px !important;
  overflow-x: visible !important;
  overflow-y: auto !important;
  white-space: normal !important;
  display: block !important;
  padding: 20px !important;
  line-height: 1.8 !important;
  align-items: flex-start !important;
  justify-content: flex-start !important;
}

/* 横書きモードでのふりがな調整 */
#kotowazaMeaning.horizontal-mode ruby {
  ruby-position: over;
}

#kotowazaMeaning.horizontal-mode rt {
  font-size: 0.6em;
  line-height: 1;
}

/* 縦書きでのふりがな調整 */
#kotowazaText ruby {
  ruby-position: over;
}

#kotowazaText rt {
  font-size: 0.5em;
  writing-mode: horizontal-tb;
  text-orientation: mixed;
}

/* CSS内の静的な色も変更 */
    .grammar-submenu-item[data-level="intro"] {
      background: linear-gradient(135deg, #fb923c 0%, #fdba74 100%) !important;
      border-color: #ea580c !important;
    }
    
    .grammar-submenu-item[data-level="basic"] {
      background: linear-gradient(135deg, #fb923c 0%, #fdba74 100%) !important;
      border-color: #ea580c !important;
    }
    
    .grammar-submenu-item[data-level="advanced"] {
      background: linear-gradient(135deg, #fb923c 0%, #fdba74 100%) !important;
      border-color: #ea580c !important;
    }
    
    .grammar-submenu-item[data-level="expert"] {
      background: linear-gradient(135deg, #fb923c 0%, #fdba74 100%) !important;
      border-color: #ea580c !important;
    }
    
    .grammar-submenu-item[data-level="exam"] {
      background: linear-gradient(135deg, #fb923c 0%, #fdba74 100%) !important;
      border-color: #ea580c !important;
    }
  `;
  document.head.appendChild(grammarColorStyle);
  
  // 動的に色を変更する追加処理
  setTimeout(() => {
    // 文法関連の要素の色を直接変更
    const replaceColors = () => {
      // 文法トレーニング画面のタイトルの色を変更
      document.querySelectorAll('div[style*="color:#0891b2"]').forEach(el => {
        el.style.color = '#ea580c';
      });
      
      // 文法トレーニング画面のローディング文字色を変更
      document.querySelectorAll('div[style*="color:#16a34a"]').forEach(el => {
        el.style.color = '#ea580c';
      });
      
      // ボタンの背景色を変更
      document.querySelectorAll('button[style*="background:#16a34a"]').forEach(el => {
        el.style.background = '#ea580c';
      });
      
      document.querySelectorAll('button[style*="background-color:#16a34a"]').forEach(el => {
        el.style.backgroundColor = '#ea580c';
      });
      
      // h3タグの色を変更
      document.querySelectorAll('h3[style*="color:#16a34a"]').forEach(el => {
        el.style.color = '#ea580c';
      });
    };
    
    // 初回実行
    replaceColors();
    
    // 定期的に色を確認・変更（画面遷移時のため）
    setInterval(replaceColors, 500);
  }, 1000);
  
  // 文法トレーニングメニューのCSS内の緑色を強制的にオレンジ色に変更
  const overrideGrammarColors = () => {
    // スタイルタグを作成してより強力に色を上書き
    const styleOverride = document.createElement('style');
    styleOverride.id = 'grammar-color-override';
    styleOverride.innerHTML = `
      /* 文法トレーニングメニューの新しいプロフェッショナルデザイン */
      .grammar-item {
        background: #ffffff !important;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08) !important;
        border: 1px solid #e5e7eb !important;
        border-radius: 12px !important;
        padding: 24px !important;
        transition: all 0.2s ease !important;
      }
      
      .grammar-item:hover {
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.12) !important;
        border-color: #ea580c !important;
        transform: none !important;
      }
      
      .grammar-item:hover::after {
        display: none !important;
      }
      
      .grammar-item::before {
        display: none !important;
      }
      
      .grammar-item-title {
        color: #1f2937 !important;
        font-weight: 600 !important;
      }
      
      .progress-numbers.low-progress {
        background: linear-gradient(135deg, #fef7ec, #fed7aa) !important;
        color: #c2410c !important;
        border-color: rgba(234, 88, 12, 0.2) !important;
      }
      
      .progress-fill {
        background: #ea580c !important;
      }
      
      .grammar-item:hover .progress-fill {
        background: #fb923c !important;
      }
      
      .grammar-item:hover .progress-bar {
        border-color: #ea580c !important;
      }
      
      .grammar-item-badge {
        background: #ea580c !important;
      }
      
      .grammar-item-badge.coming-soon {
        background: #fb923c !important;
      }
      
      /* 全ての緑色系を強制的にオレンジ色に変更 */
      *[style*="#16a34a"] {
        color: #ea580c !important;
        background-color: #ea580c !important;
        background: #ea580c !important;
        border-color: #ea580c !important;
      }
      
      *[style*="#22c55e"] {
        color: #fb923c !important;
        background-color: #fb923c !important;  
        background: #fb923c !important;
        border-color: #fb923c !important;
      }
      
      *[style*="#15803d"] {
        color: #c2410c !important;
      }
      
      *[style*="#f0fdf4"] {
        background: #fef7ec !important;
        background-color: #fef7ec !important;
      }
      
      *[style*="#dcfce7"] {
        border-color: #fed7aa !important;
        background-color: #fed7aa !important;
        background: #fed7aa !important;
      }
      
      *[style*="rgba(22, 163, 74"] {
        box-shadow: 0 4px 12px rgba(234, 88, 12, 0.15) !important;
      }
      
      /* 文法トレーニング内画面の色も強制変更 */
      h3[style*="color:#16a34a"] {
        color: #ea580c !important;
      }
      
      div[style*="color:#16a34a"] {
        color: #ea580c !important;
      }
      
      button[style*="background:#16a34a"] {
        background: #ea580c !important;
      }
    `;
    
    // 既存のオーバーライドスタイルを削除
    const existingOverride = document.getElementById('grammar-color-override');
    if (existingOverride) {
      existingOverride.remove();
    }
    
    // 新しいオーバーライドスタイルを追加
    document.head.appendChild(styleOverride);
  };
  
  // 即座に実行
  overrideGrammarColors();
  
  // DOM変更時にも実行
  const observer = new MutationObserver(overrideGrammarColors);
  observer.observe(document.body, { childList: true, subtree: true });
  
  // より確実にCSSを書き換える最終手段（超強化版）
  const forceGrammarColorsOrange = () => {
    console.log('文法トレーニングの色を強制的にオレンジに変更中...');
    
    // 既存のstyleシートを直接書き換え
    for (let sheet of document.styleSheets) {
      try {
        const rules = sheet.cssRules || sheet.rules;
        if (rules) {
          for (let i = 0; i < rules.length; i++) {
            const rule = rules[i];
            if (rule.selectorText && rule.selectorText.includes('grammar-item')) {
              if (rule.style) {
                // 背景色を強制変更
                if (rule.style.background && rule.style.background.includes('#f0fdf4')) {
                  rule.style.background = rule.style.background.replace('#f0fdf4', '#fff7ed');
                }
                if (rule.style.background && rule.style.background.includes('#dcfce7')) {
                  rule.style.background = rule.style.background.replace('#dcfce7', '#fed7aa');
                }
                // ボックスシャドウを強制変更
                if (rule.style.boxShadow && rule.style.boxShadow.includes('22, 163, 74')) {
                  rule.style.boxShadow = rule.style.boxShadow.replace(/rgba?\(22, 163, 74[^)]*\)/g, 'rgba(234, 88, 12, 0.15)');
                }
                // 枠線色を強制変更
                if (rule.style.borderColor && rule.style.borderColor.includes('#16a34a')) {
                  rule.style.borderColor = '#ea580c';
                }
                if (rule.style.border && rule.style.border.includes('#dcfce7')) {
                  rule.style.border = rule.style.border.replace('#dcfce7', '#fed7aa');
                }
                // 色を強制変更
                if (rule.style.color && rule.style.color.includes('#15803d')) {
                  rule.style.color = '#c2410c';
                }
                if (rule.style.background && rule.style.background.includes('#16a34a')) {
                  rule.style.background = rule.style.background.replace('#16a34a', '#ea580c');
                }
                if (rule.style.background && rule.style.background.includes('#22c55e')) {
                  rule.style.background = rule.style.background.replace('#22c55e', '#f97316');
                }
              }
            }
          }
        }
      } catch (e) {
        // クロスオリジンエラーなどを無視
      }
    }
    
    // DOM要素の色も直接変更（超強力版）
    document.querySelectorAll('.grammar-item').forEach((item, index) => {
      console.log(`文法アイテム${index}の色を変更中...`);
      
      // シンプルでプロフェッショナルなスタイル
      item.style.setProperty('background', '#ffffff', 'important');
      item.style.setProperty('box-shadow', '0 2px 8px rgba(0, 0, 0, 0.08)', 'important');
      item.style.setProperty('border', '1px solid #e5e7eb', 'important');
      item.style.setProperty('border-radius', '12px', 'important');
      item.style.setProperty('padding', '24px', 'important');
      
      // シンプルなホバー効果用のイベントリスナー追加
      item.addEventListener('mouseenter', function() {
        this.style.setProperty('background', '#ffffff', 'important');
        this.style.setProperty('box-shadow', '0 4px 16px rgba(0, 0, 0, 0.12)', 'important');
        this.style.setProperty('border-color', '#ea580c', 'important');
        this.style.setProperty('transform', 'none', 'important');
      });
      
      item.addEventListener('mouseleave', function() {
        this.style.setProperty('background', '#ffffff', 'important');
        this.style.setProperty('box-shadow', '0 2px 8px rgba(0, 0, 0, 0.08)', 'important');
        this.style.setProperty('border-color', '#e5e7eb', 'important');
        this.style.setProperty('transform', 'none', 'important');
      });
    });
    
    // タイトルの色変更
    document.querySelectorAll('.grammar-item-title').forEach(title => {
      title.style.setProperty('color', '#1f2937', 'important');
      title.style.setProperty('font-weight', '600', 'important');
    });
    
    // 進捗バーの色変更
    document.querySelectorAll('.progress-fill').forEach(fill => {
      fill.style.setProperty('background', '#ea580c', 'important');
    });
    
    // バッジの色変更
    document.querySelectorAll('.grammar-item-badge').forEach(badge => {
      badge.style.setProperty('background', '#ea580c', 'important');
      badge.style.setProperty('background-color', '#ea580c', 'important');
    });
    
    document.querySelectorAll('.grammar-item-badge.coming-soon').forEach(badge => {
      badge.style.setProperty('background', '#f97316', 'important');
      badge.style.setProperty('background-color', '#f97316', 'important');
    });
    
    // 進捗数字の色も変更
    document.querySelectorAll('.progress-numbers').forEach(progress => {
      progress.style.setProperty('background', '#f9fafb', 'important');
      progress.style.setProperty('color', '#374151', 'important');
      progress.style.setProperty('border', '1px solid #e5e7eb', 'important');
      progress.style.setProperty('border-radius', '6px', 'important');
      progress.style.setProperty('padding', '4px 8px', 'important');
    });
    
    document.querySelectorAll('.progress-numbers.high-progress').forEach(progress => {
      progress.style.setProperty('background', '#fef3f2', 'important');
      progress.style.setProperty('color', '#ea580c', 'important');
      progress.style.setProperty('border-color', '#fed7aa', 'important');
    });
    
    // 追加のホバー効果のCSSルールを動的に作成
    let existingHoverStyle = document.getElementById('grammar-hover-override');
    if (existingHoverStyle) {
      existingHoverStyle.remove();
    }
    
    const hoverStyle = document.createElement('style');
    hoverStyle.id = 'grammar-hover-override';
    hoverStyle.innerHTML = `
      .grammar-item:hover {
        background: #ffffff !important;
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.12) !important;
        border-color: #ea580c !important;
        transform: none !important;
      }
      .grammar-item:hover::after {
        display: none !important;
      }
      .grammar-item::before {
        display: none !important;
      }
      .grammar-item:hover .progress-fill {
        background: #ea580c !important;
      }
      .grammar-item:hover .progress-bar {
        background: #f3f4f6 !important;
      }
    `;
    document.head.appendChild(hoverStyle);
    
    console.log('文法トレーニングの色変更完了');
  };
  
  // 初回実行（複数回）
  setTimeout(forceGrammarColorsOrange, 50);
  setTimeout(forceGrammarColorsOrange, 200);
  setTimeout(forceGrammarColorsOrange, 500);
  setTimeout(forceGrammarColorsOrange, 1000);
  
  // 定期的に実行（より頻繁に）
  setInterval(forceGrammarColorsOrange, 300);
  
  // ページが完全に読み込まれた後にも実行
  window.addEventListener('load', () => {
    setTimeout(forceGrammarColorsOrange, 100);
    setTimeout(forceGrammarColorsOrange, 500);
    setTimeout(forceGrammarColorsOrange, 1000);
  });
  
  // 文法トレーニングボタンクリック時にも色変更を実行
  document.addEventListener('click', (event) => {
    if (event.target && (
        event.target.id === 'goGrammarTrainingBtn' ||
        event.target.textContent?.includes('文法') ||
        event.target.closest('#goGrammarTrainingBtn')
    )) {
      console.log('文法トレーニングボタンがクリックされました。色変更を実行します。');
      setTimeout(forceGrammarColorsOrange, 50);
      setTimeout(forceGrammarColorsOrange, 200);
      setTimeout(forceGrammarColorsOrange, 500);
      setTimeout(forceGrammarColorsOrange, 1000);
    }
  });
  
  try {
    // 統合された論理トレーニング問題データを読み込み
    const loaded = await loadLogicTrainingProblems();
    if (loaded) {
      console.log('統合された論理トレーニング問題データの読み込み完了');
    } else {
      console.warn('統合された論理トレーニング問題データの読み込みに失敗しました。個別ファイルから読み込みます。');
    }
    
    // 宝石交換機能を初期化（複数回実行して確実に）
    initGemExchange();
    setTimeout(() => {
      initGemExchange();
    }, 100);
    setTimeout(() => {
      initGemExchange();
    }, 500);
    
  } catch (error) {
    console.error('初期化エラー:', error);
  }
  
  console.log('アプリケーション初期化完了');
  
  // ことわざトレーニングメニューボタンイベントは動的に設定
  // （ボタンが動的に生成されるため、ここでは設定しない）
    });
  
  // 類義語縦書きレイアウトとアニメーションのCSSを動的に追加
  const synonymGridStyle = document.createElement('style');
  synonymGridStyle.innerHTML = `
    /* 類義語縦書きレイアウトスタイル */
    #synonymAnswer {
      transition: all 0.3s ease;
    }

    #synonymAnswer:hover {
      transform: scale(1.02);
    }

    #synonymAnswerContent {
      writing-mode: vertical-rl !important;
      text-orientation: upright !important;
      font-size: 56px !important;
      font-weight: bold !important;
      font-family: 'Tsukushi Mincho', 'Yu Mincho', 'YuMincho', 'MS Mincho', serif !important;
      color: #000000 !important;
      line-height: 1.2 !important;
      letter-spacing: 0.1em;
    }

    /* 飛んでいくアニメーション用 */
    .flying-kanji-animated {
      animation: flyingEffect 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
      border: none !important;
      box-shadow: none !important;
      opacity: 0.6 !important;
    }

    @keyframes flyingEffect {
      0% {
        transform: scale(1);
        filter: brightness(1);
        opacity: 0.6;
      }
      50% {
        transform: scale(1.02);
        filter: brightness(1.1);
        opacity: 0.7;
      }
      100% {
        transform: scale(0.95);
        filter: brightness(1);
        opacity: 0.5;
      }
    }

    .kanji-choice.flying {
      opacity: 0.3;
      pointer-events: none;
    }

         /* 漢字選択肢グリッドレイアウト */
     #kanjiChoices.grid-layout {
       display: grid !important;
       grid-template-columns: repeat(4, 1fr) !important;
       grid-template-rows: repeat(3, 1fr) !important;
       gap: 16px !important;
       width: 100% !important;
       max-width: 600px !important;
       margin: 16px auto !important;
       padding: 20px !important;
     }

     #kanjiChoices.grid-layout .kanji-choice {
       font-size: 32px !important;
       aspect-ratio: 1 !important;
       display: flex !important;
       align-items: center !important;
       justify-content: center !important;
       border: 3px solid #3B82F6 !important;
       border-radius: 12px !important;
       background: linear-gradient(145deg, #ffffff, #f8fafc) !important;
       box-shadow: 
         0 4px 16px rgba(0, 0, 0, 0.08),
         0 2px 8px rgba(0, 0, 0, 0.04),
         inset 0 1px 0 rgba(255, 255, 255, 0.8) !important;
       cursor: pointer !important;
       transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1) !important;
       font-weight: 600 !important;
       color: #2d3748 !important;
       position: relative !important;
       overflow: hidden !important;
     }

     #kanjiChoices.grid-layout .kanji-choice:hover {
       transform: translateY(-2px) scale(1.02) !important;
       box-shadow: 
         0 8px 32px rgba(0, 0, 0, 0.12),
         0 4px 16px rgba(0, 0, 0, 0.08),
         inset 0 1px 0 rgba(255, 255, 255, 0.9) !important;
       background: linear-gradient(145deg, #ffffff, #f1f5f9) !important;
       color: #1a202c !important;
     }

     #kanjiChoices.grid-layout .kanji-choice:active {
       transform: translateY(0) scale(0.98) !important;
       box-shadow: 
         0 2px 8px rgba(0, 0, 0, 0.06),
         inset 0 2px 4px rgba(0, 0, 0, 0.04) !important;
     }

     #kanjiChoices.grid-layout .kanji-choice::before {
       content: '' !important;
       position: absolute !important;
       top: 0 !important;
       left: -100% !important;
       width: 100% !important;
       height: 100% !important;
       background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.6), transparent) !important;
       transition: left 0.5s ease !important;
     }

     #kanjiChoices.grid-layout .kanji-choice:hover::before {
       left: 100% !important;
     }

     /* レスポンシブ対応 */
     @media (max-width: 768px) {
       #synonymAnswer {
         min-width: 50px !important;
         min-height: 100px !important;
         font-size: 36px !important;
         padding: 15px 8px !important;
       }
       
       #synonymAnswerContent {
         font-size: 36px !important;
         min-width: 36px !important;
       }
       
       #synonymAnswer span {
         font-size: 36px !important;
       }
       
       #synonymAnswer + div {
         font-size: 28px !important;
       }
       
       #synonymAnswer + div + div {
         font-size: 36px !important;
       }

       /* 小さい画面では3列に変更 */
       #kanjiChoices.grid-layout {
         grid-template-columns: repeat(3, 1fr) !important;
         grid-template-rows: repeat(4, 1fr) !important;
         max-width: 450px !important;
         gap: 12px !important;
         padding: 15px !important;
       }

       #kanjiChoices.grid-layout .kanji-choice {
         font-size: 28px !important;
         aspect-ratio: 1 !important;
         border: 3px solid #3B82F6 !important;
         border-radius: 10px !important;
         box-shadow: 
           0 3px 12px rgba(0, 0, 0, 0.06),
           0 1px 6px rgba(0, 0, 0, 0.03),
           inset 0 1px 0 rgba(255, 255, 255, 0.8) !important;
       }

       #kanjiChoices.grid-layout .kanji-choice:hover {
         transform: translateY(-1px) scale(1.01) !important;
         box-shadow: 
           0 6px 24px rgba(0, 0, 0, 0.1),
           0 3px 12px rgba(0, 0, 0, 0.06),
           inset 0 1px 0 rgba(255, 255, 255, 0.9) !important;
       }
     }

     @media (max-width: 480px) {
       /* さらに小さい画面では2列に変更 */
       #kanjiChoices.grid-layout {
         grid-template-columns: repeat(2, 1fr) !important;
         grid-template-rows: repeat(6, 1fr) !important;
         max-width: 320px !important;
         gap: 10px !important;
         padding: 10px !important;
       }

       #kanjiChoices.grid-layout .kanji-choice {
         font-size: 24px !important;
         aspect-ratio: 1 !important;
         border: 3px solid #3B82F6 !important;
         border-radius: 8px !important;
         box-shadow: 
           0 2px 8px rgba(0, 0, 0, 0.05),
           0 1px 4px rgba(0, 0, 0, 0.02),
           inset 0 1px 0 rgba(255, 255, 255, 0.8) !important;
       }

       #kanjiChoices.grid-layout .kanji-choice:hover {
         transform: translateY(-1px) scale(1.005) !important;
         box-shadow: 
           0 4px 16px rgba(0, 0, 0, 0.08),
           0 2px 8px rgba(0, 0, 0, 0.04),
           inset 0 1px 0 rgba(255, 255, 255, 0.9) !important;
       }
     }

    /* アニメーション強化 */
    .synonym-answer-appear {
      animation: appearEffect 0.3s ease-out;
    }

    @keyframes appearEffect {
      0% {
        opacity: 0;
        transform: scale(0.8);
      }
      50% {
        opacity: 0.7;
        transform: scale(1.1);
      }
      100% {
        opacity: 1;
        transform: scale(1);
      }
    }
  `;
  document.head.appendChild(synonymGridStyle);

  // 類義語専用の漢字選択CSSを追加
  const synonymKanjiStyle = document.createElement('style');
  synonymKanjiStyle.innerHTML = `
    /* 類義語問題専用の漢字選択スタイル（プロフェッショナルデザイン） */
    .synonym-problem .kanji-choice {
      background: linear-gradient(145deg, #ffffff, #f8fafc) !important;
      border: 3px solid #3B82F6 !important;
      border-radius: 16px !important;
      font-size: 32px !important;
      box-shadow: 
        0 6px 20px rgba(0, 0, 0, 0.08),
        0 3px 10px rgba(0, 0, 0, 0.04),
        inset 0 1px 0 rgba(255, 255, 255, 0.9) !important;
      position: relative !important;
      overflow: hidden !important;
      transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1) !important;
    }

    .synonym-problem .kanji-choice::before {
      content: '' !important;
      position: absolute !important;
      top: 0 !important;
      left: -100% !important;
      width: 100% !important;
      height: 100% !important;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.6), transparent) !important;
      transition: left 0.5s ease !important;
    }

    .synonym-problem .kanji-choice:hover {
      background: linear-gradient(145deg, #ffffff, #f1f5f9) !important;
      transform: translateY(-3px) scale(1.02) !important;
      box-shadow: 
        0 12px 40px rgba(0, 0, 0, 0.12),
        0 6px 20px rgba(0, 0, 0, 0.08),
        inset 0 1px 0 rgba(255, 255, 255, 0.95) !important;
      color: #1a202c !important;
    }

    .synonym-problem .kanji-choice:hover::before {
      left: 100% !important;
    }

    .synonym-problem .kanji-choice:active {
      transform: translateY(-1px) scale(0.98) !important;
      box-shadow: 
        0 4px 16px rgba(0, 0, 0, 0.08),
        inset 0 2px 4px rgba(0, 0, 0, 0.04) !important;
    }

    .synonym-problem .kanji-choice.selected {
      background: linear-gradient(145deg, #9C27B0, #7B1FA2) !important;
      color: white !important;
      box-shadow: 
        0 8px 32px rgba(156, 39, 176, 0.3),
        0 4px 16px rgba(156, 39, 176, 0.2),
        inset 0 1px 0 rgba(255, 255, 255, 0.2) !important;
    }

    .synonym-problem .kanji-choice.correct {
      background: linear-gradient(145deg, #20B2AA, #00695C) !important;
      color: white !important;
      box-shadow: 
        0 8px 32px rgba(32, 178, 170, 0.3),
        0 4px 16px rgba(32, 178, 170, 0.2),
        inset 0 1px 0 rgba(255, 255, 255, 0.2) !important;
    }

    .synonym-problem .kanji-choice.incorrect {
      background: linear-gradient(145deg, #f44336, #c62828) !important;
      color: white !important;
      box-shadow: 
        0 8px 32px rgba(244, 67, 54, 0.3),
        0 4px 16px rgba(244, 67, 54, 0.2),
        inset 0 1px 0 rgba(255, 255, 255, 0.2) !important;
    }
  `;
  document.head.appendChild(synonymKanjiStyle);

  // 類義語問題の漢字選択ボタンに強制的にプロフェッショナルスタイルを適用
  function forceKanjiChoiceStyle() {
    const kanjiChoices = document.querySelectorAll('.kanji-choice');
    kanjiChoices.forEach(choice => {
      // 青いボーダーを適用し、プロフェッショナルなデザインを適用
      choice.style.setProperty('border', '3px solid #3B82F6', 'important');
      choice.style.setProperty('font-size', '48px', 'important');
      choice.style.setProperty('background', 'linear-gradient(145deg, #ffffff, #f8fafc)', 'important');
      choice.style.setProperty('border-radius', '16px', 'important');
      choice.style.setProperty('box-shadow', '0 6px 20px rgba(0, 0, 0, 0.08), 0 3px 10px rgba(0, 0, 0, 0.04), inset 0 1px 0 rgba(255, 255, 255, 0.9)', 'important');
      choice.style.setProperty('transition', 'all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1)', 'important');
      choice.style.setProperty('position', 'relative', 'important');
      choice.style.setProperty('overflow', 'hidden', 'important');
      
      // 光沢エフェクト用の擬似要素を追加
      if (!choice.querySelector('.shine-effect')) {
        const shineEffect = document.createElement('div');
        shineEffect.className = 'shine-effect';
        shineEffect.style.cssText = `
          position: absolute;
          top: 0;
          left: -100%;
          width: 100%;
          height: 100%;
          background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.6), transparent);
          transition: left 0.5s ease;
          pointer-events: none;
        `;
        choice.appendChild(shineEffect);
      }
      
      // ホバーイベントを追加
      choice.addEventListener('mouseenter', function() {
        if (!this.classList.contains('selected') && !this.classList.contains('correct') && !this.classList.contains('incorrect')) {
          this.style.setProperty('background', 'linear-gradient(145deg, #ffffff, #f1f5f9)', 'important');
          this.style.setProperty('transform', 'translateY(-3px) scale(1.02)', 'important');
          this.style.setProperty('box-shadow', '0 12px 40px rgba(0, 0, 0, 0.12), 0 6px 20px rgba(0, 0, 0, 0.08), inset 0 1px 0 rgba(255, 255, 255, 0.95)', 'important');
          this.style.setProperty('color', '#1a202c', 'important');
          
          // 光沢エフェクト
          const shine = this.querySelector('.shine-effect');
          if (shine) {
            shine.style.left = '100%';
          }
        }
      });
      
      choice.addEventListener('mouseleave', function() {
        if (!this.classList.contains('selected') && !this.classList.contains('correct') && !this.classList.contains('incorrect')) {
          this.style.setProperty('background', 'linear-gradient(145deg, #ffffff, #f8fafc)', 'important');
          this.style.setProperty('transform', 'translateY(0) scale(1)', 'important');
          this.style.setProperty('box-shadow', '0 6px 20px rgba(0, 0, 0, 0.08), 0 3px 10px rgba(0, 0, 0, 0.04), inset 0 1px 0 rgba(255, 255, 255, 0.9)', 'important');
          this.style.setProperty('color', '#000000', 'important');
          
          // 光沢エフェクトをリセット
          const shine = this.querySelector('.shine-effect');
          if (shine) {
            shine.style.left = '-100%';
          }
        }
      });
      
      choice.addEventListener('mousedown', function() {
        if (!this.classList.contains('selected') && !this.classList.contains('correct') && !this.classList.contains('incorrect')) {
          this.style.setProperty('transform', 'translateY(-1px) scale(0.98)', 'important');
          this.style.setProperty('box-shadow', '0 4px 16px rgba(0, 0, 0, 0.08), inset 0 2px 4px rgba(0, 0, 0, 0.04)', 'important');
        }
      });
      
      choice.addEventListener('mouseup', function() {
        if (!this.classList.contains('selected') && !this.classList.contains('correct') && !this.classList.contains('incorrect')) {
          this.style.setProperty('transform', 'translateY(-3px) scale(1.02)', 'important');
          this.style.setProperty('box-shadow', '0 12px 40px rgba(0, 0, 0, 0.12), 0 6px 20px rgba(0, 0, 0, 0.08), inset 0 1px 0 rgba(255, 255, 255, 0.95)', 'important');
        }
      });
    });
  }

  // 類義語問題が表示されたときにスタイルを適用
  function applyKanjiStyleOnDisplay() {
    const observer = new MutationObserver((mutations) => {
      mutations.forEach((mutation) => {
        if (mutation.type === 'childList') {
          mutation.addedNodes.forEach((node) => {
            if (node.nodeType === Node.ELEMENT_NODE) {
              if (node.classList && node.classList.contains('kanji-choice')) {
                setTimeout(forceKanjiChoiceStyle, 50);
              } else if (node.querySelector && node.querySelector('.kanji-choice')) {
                setTimeout(forceKanjiChoiceStyle, 50);
              }
            }
          });
        }
      });
    });
    
    observer.observe(document.body, {
      childList: true,
      subtree: true
    });
    
    // 初回実行
    setTimeout(forceKanjiChoiceStyle, 100);
    setTimeout(forceKanjiChoiceStyle, 500);
    setTimeout(forceKanjiChoiceStyle, 1000);
  }

  // 類義語問題の表示を監視
  applyKanjiStyleOnDisplay();

  // 類義語問題の漢字選択ボタンを強制的にスタイル変更するCSS
  const forceKanjiStyle = document.createElement('style');
  forceKanjiStyle.innerHTML = `
    /* 類義語問題の漢字選択ボタンの強制スタイル - 既存スタイルを上書き */
    .kanji-choice {
      border: 3px solid #3B82F6 !important;
      font-size: 48px !important;
    }
    
    @media (max-width: 768px) {
      .kanji-choice {
        font-size: 42px !important;
      }
    }
    
    @media (max-width: 480px) {
      .kanji-choice {
        font-size: 36px !important;
      }
    }
  `;
  document.head.appendChild(forceKanjiStyle);

  // ダッシュボードのダイヤモンド表示を横並びに修正するCSS
  const treasureHorizontalStyle = document.createElement('style');
  treasureHorizontalStyle.innerHTML = `
    /* タイトル画面のダッシュボードの獲得した報酬を横並びに */
    .treasure-card {
      display: flex !important;
      flex-direction: row !important;
      align-items: center !important;
      gap: 8px !important;
    }
    
    .treasure-icon {
      margin-bottom: 0 !important;
      margin-top: 0 !important;
    }
  `;
  document.head.appendChild(treasureHorizontalStyle);

  console.log('ダッシュボードのダイヤモンド表示を横並びに修正しました');

  // ダッシュボードのダイヤモンド表示を強制的に横並びにする関数
  function fixTreasureCardLayout() {
    const treasureCards = document.querySelectorAll('.treasure-card');
    treasureCards.forEach(card => {
      card.style.setProperty('display', 'flex', 'important');
      card.style.setProperty('flex-direction', 'row', 'important');
      card.style.setProperty('align-items', 'center', 'important');
      card.style.setProperty('gap', '8px', 'important');
    });
    
    // treasure-iconのマージンも調整
    const treasureIcons = document.querySelectorAll('.treasure-icon');
    treasureIcons.forEach(icon => {
      icon.style.setProperty('margin-bottom', '0', 'important');
      icon.style.setProperty('margin-top', '0', 'important');
    });
    
    console.log('treasure-cardのレイアウトを強制的に横並びに変更しました');
  }

  // ページ読み込み時に実行
  fixTreasureCardLayout();
  
  // DOMの変更を監視して常に横並びを保つ
  const treasureObserver = new MutationObserver(() => {
    fixTreasureCardLayout();
  });
  
  // body の変更を監視
  if (document.body) {
    treasureObserver.observe(document.body, {
      childList: true,
      subtree: true,
      attributes: true,
      attributeFilter: ['style', 'class']
    });
  }
  
  // 定期的にもチェック
  setInterval(fixTreasureCardLayout, 2000);

  // === iPadタッチイベント対応 ===
  console.log('iPadタッチイベント対応を初期化');
  
  // タッチデバイスかどうかを判定
  const isTouchDevice = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
  
  if (isTouchDevice) {
    console.log('タッチデバイスを検出しました');
    
    // 全体的なタッチイベント最適化
    document.addEventListener('touchstart', function() {}, {passive: true});
    
    // SVGサークル要素のタッチイベント対応
    const setupCircleTouchEvents = () => {
      const circles = document.querySelectorAll('circle[onclick]');
      circles.forEach(circle => {
        // タッチデバイスではmouseoverとmouseoutを削除
        circle.removeAttribute('onmouseover');
        circle.removeAttribute('onmouseout');
        
        // ボタンIDとの対応マップ
        const buttonMap = {
          'venn-reading': 'goReadingTrainingBtn',
          'venn-grammar': 'goGrammarTrainingBtn',
          'venn-kanji': 'goKanjiVocabBtn',
          'venn-logic': 'goLogicBtn'
        };
        
        // タッチイベントハンドラーを追加
        const handleTouch = (e) => {
          e.preventDefault();
          e.stopPropagation();
          
          // 対応するボタンを取得してクリック
          const circleId = circle.getAttribute('id');
          const buttonId = buttonMap[circleId];
          console.log('Circle touched:', circleId, '-> Button:', buttonId);
          
          if (buttonId) {
            console.log('Handling touch for:', circleId, '-> Button:', buttonId);
            
            // ボタンのonclickイベントを直接実行
            const button = document.getElementById(buttonId);
            if (button && button.onclick) {
              console.log('Executing button onclick:', buttonId);
              button.onclick();
            } else {
              // フォールバック：IDで要素を取得して直接画面遷移
              const boxMap = {
                'goReadingTrainingBtn': 'readingTrainingBox',
                'goGrammarTrainingBtn': 'grammarTrainingBox',
                'goKanjiVocabBtn': 'kanjiVocabTrainingBox',
                'goLogicBtn': 'logicTrainingBox'
              };
              
              const boxId = boxMap[buttonId];
              if (boxId) {
                const box = document.getElementById(boxId);
                if (box && window.showBox) {
                  console.log('Direct showBox call:', boxId);
                  window.showBox(box);
                  
                  // 対応するレンダリング関数を実行
                  if (boxId === 'readingTrainingBox' && window.renderReadingTrainingMenu) {
                    window.renderReadingTrainingMenu();
                  } else if (boxId === 'grammarTrainingBox' && window.renderGrammarMenu) {
                    window.renderGrammarMenu();
                  } else if (boxId === 'kanjiVocabTrainingBox' && window.renderKanjiVocabMenu) {
                    window.renderKanjiVocabMenu();
                  } else if (boxId === 'logicTrainingBox' && window.renderLogicMenu) {
                    window.renderLogicMenu();
                  }
                }
              }
            }
          }
        };
        
        // タッチとクリックの両方に対応
        circle.addEventListener('touchstart', handleTouch, {passive: false});
        circle.addEventListener('click', (e) => {
          if (!isTouchDevice) {
            handleTouch(e);
          }
        });
        
        // CSSでタッチフィードバックを改善
        circle.style.setProperty('-webkit-tap-highlight-color', 'transparent');
        circle.style.setProperty('touch-action', 'manipulation');
        circle.style.setProperty('cursor', 'pointer');
        
        // タッチ時のビジュアルフィードバック
        circle.addEventListener('touchstart', (e) => {
          circle.setAttribute('r', '105');
          circle.setAttribute('stroke-width', '4');
          // タッチスタート時にフラグを設定
          circle.dataset.touchStarted = 'true';
        });
        
        circle.addEventListener('touchend', (e) => {
          circle.setAttribute('r', '95');
          circle.setAttribute('stroke-width', '3');
          
          // タッチエンドでも念のため処理を実行
          if (circle.dataset.touchStarted === 'true') {
            circle.dataset.touchStarted = 'false';
            handleTouch(e);
          }
        });
      });
    };
    
    // 全てのボタンにタッチイベント対応を追加
    const setupButtonTouchEvents = () => {
      const buttons = document.querySelectorAll('button');
      buttons.forEach(button => {
        // タッチイベント最適化のCSSを追加
        button.style.setProperty('-webkit-tap-highlight-color', 'transparent');
        button.style.setProperty('touch-action', 'manipulation');
        button.style.setProperty('-webkit-touch-callout', 'none');
        button.style.setProperty('-webkit-user-select', 'none');
        button.style.setProperty('user-select', 'none');
        
        // onclickがある場合はtouchstartも追加
        if (button.onclick || button.hasAttribute('onclick')) {
          let isHandling = false;
          button.addEventListener('touchstart', function(e) {
            if (!isHandling) {
              isHandling = true;
              e.preventDefault();
              // クリックイベントを発火
              this.click();
              setTimeout(() => { isHandling = false; }, 300);
            }
          }, {passive: false});
        }
      });
    };
    
    // 動的に追加される要素にも対応
    const setupTouchForDynamicElements = () => {
      // ボタンとSVGサークルの再セットアップ
      setupCircleTouchEvents();
      setupButtonTouchEvents();
      
      // 特定のクラスを持つ要素にもタッチイベントを追加
      const touchableElements = document.querySelectorAll('.kanji-choice, .start-btn, .small-btn, .audio-btn, .buy-btn, .logic-check-btn, .logic-reset-btn');
      touchableElements.forEach(element => {
        element.style.setProperty('-webkit-tap-highlight-color', 'transparent');
        element.style.setProperty('touch-action', 'manipulation');
        
        if (!element.hasAttribute('data-touch-enabled')) {
          element.setAttribute('data-touch-enabled', 'true');
          element.addEventListener('touchstart', function(e) {
            e.preventDefault();
            this.click();
          }, {passive: false});
        }
      });
    };
    
    // 初期セットアップ（複数回実行して確実に設定）
    const setupAllTouchEvents = () => {
      setupCircleTouchEvents();
      setupButtonTouchEvents();
      setupTouchForDynamicElements();
    };
    
    // 複数のタイミングで実行
    setTimeout(setupAllTouchEvents, 100);
    setTimeout(setupAllTouchEvents, 500);
    setTimeout(setupAllTouchEvents, 1000);
    
    // ページが完全に読み込まれた後にも実行
    window.addEventListener('load', setupAllTouchEvents);
    
    // DOMの変更を監視して動的要素にも対応
    const touchObserver = new MutationObserver(() => {
      setupTouchForDynamicElements();
    });
    
    touchObserver.observe(document.body, {
      childList: true,
      subtree: true
    });
    
    // iOS Safari用の追加最適化
    if (/iPad|iPhone|iPod/.test(navigator.userAgent)) {
      console.log('iOS端末を検出しました - 追加最適化を適用');
      
      // ビューポートのスケーリングを防ぐ
      let lastTouchEnd = 0;
      document.addEventListener('touchend', function(event) {
        const now = Date.now();
        if (now - lastTouchEnd <= 300) {
          event.preventDefault();
        }
        lastTouchEnd = now;
      }, false);
      
      // スクロール時のバウンス効果を制御
      document.body.style.webkitOverflowScrolling = 'touch';
    }
  }
  
  console.log('iPadタッチイベント対応の初期化が完了しました');
  
  </script>
 </html>